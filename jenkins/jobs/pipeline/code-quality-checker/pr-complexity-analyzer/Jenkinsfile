@Library('jenkins-shared-lib') _

/**
 * PRè¤‡é›‘åº¦è§£æãƒ»ã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
 * rust-code-analysisã¨OpenAI APIã‚’ä½¿ç”¨ã—ã¦PRã®è¤‡é›‘åº¦ã‚’åˆ†æã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆãƒ»æŠ•ç¨¿ã—ã¾ã™
 */

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°
def CONSTANTS = [
    RUST_CODE_ANALYSIS_VERSION: '0.0.25',
    DOCKER_IMAGE: 'rust:1.76-slim',
    VENV_PATH: '/venv',
    MAX_ARTIFACT_SIZE: 10485760 // 10MB
]

// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
def DIRECTORIES = [
    ANALYSIS: 'complexity-analysis',
    SOURCE: 'pr-source-code', 
    CONFIG: 'complexity-config'
]

pipeline {
    agent {
        label params.AGENT_LABEL ?: 'ec2-fleet-small'
    }
        
    environment {
        // OpenAI APIè¨­å®š
        OPENAI_API_KEY = credentials('openai-api-key')
        OPENAI_MODEL = "gpt-4.1"
        // GIT_INFRASTRUCTURE_REPO_BRANCH = "main"  // é–‹ç™ºæ™‚ã«å¿…è¦ãªå ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ä½¿ç”¨
        
        // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        ANALYSIS_DIR = "${DIRECTORIES.ANALYSIS}"
        SOURCE_DIR = "${DIRECTORIES.SOURCE}"
        CONFIG_DIR = "${DIRECTORIES.CONFIG}"
                
        // ãƒ„ãƒ¼ãƒ«ã®ãƒ‘ã‚¹
        PROJECT_BASE_DIR = "jenkins/jobs/pipeline/code-quality-checker/pr-complexity-analyzer"
        PYTHON_PROJECT_DIR = "${CONFIG_DIR}/${PROJECT_BASE_DIR}/src"
        
        // rust-code-analysisè¨­å®š
        RUST_CODE_ANALYSIS_VERSION = "${CONSTANTS.RUST_CODE_ANALYSIS_VERSION}"
        VENV_PATH = "${CONSTANTS.VENV_PATH}"
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        TIME_STAMP = sh(script: 'TZ="Asia/Tokyo" date "+%Y/%m/%d %H:%M:%S"', returnStdout: true).trim()
    }
    
    stages {
        stage('æº–å‚™ã¨æ¤œè¨¼') {
            steps {
                script {
                    echo "\nğŸ“‹ åˆæœŸåŒ–ã¨PRè§£æã‚’é–‹å§‹ã—ã¾ã™..."
                    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
                    validateParameters()
                    
                    // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®ç¢ºèª
                    checkExistingComments()
                    
                    if (env.SKIP_ANALYSIS == 'false') {
                        // PRæƒ…å ±ã¨å·®åˆ†ã®å–å¾—
                        fetchPRInformation()
                        
                        // è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
                        checkAnalyzableFiles()
                    }
                }
            }
        }
        
        stage('ãƒªãƒã‚¸ãƒˆãƒªæº–å‚™') {
            when {
                expression { env.SKIP_ANALYSIS == 'false' && env.HAS_CODE_FILES == 'true' }
            }
            steps {
                script {
                    echo "\nğŸ”§ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¾ã™..."
                    
                    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
                    createDirectories()
                    
                    // Gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆDockerå¤–ã§é †æ¬¡å®Ÿè¡Œï¼‰
                    echo "\nğŸ“¦ å¿…è¦ãªãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­..."
                    
                    // Jenkinsãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                    checkoutJenkinsRepo()
                    
                    // ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                    checkoutSourceRepo()
                    
                    // å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
                    verifyRequiredFiles()
                }
            }
        }

        stage('Dockerç’°å¢ƒã§ã®è§£æå®Ÿè¡Œ') {
            agent {
                docker {
                    label params.AGENT_LABEL ?: 'ec2-fleet-small'
                    image CONSTANTS.DOCKER_IMAGE
                    args "--entrypoint='' -v ${WORKSPACE}:/workspace -w /workspace -u root"
                    reuseNode true
                }
            }
            when {
                expression { env.SKIP_ANALYSIS == 'false' && env.HAS_CODE_FILES == 'true' }
            }
            stages {
                stage('ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—') {
                    steps {
                        script {
                            echo "\nğŸ³ Dockerç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
                            // ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                            installSystemPackages()
                            
                            // Pythonç’°å¢ƒã¨Rustãƒ„ãƒ¼ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                            setupPythonEnvironment()
                            installRustTools()
                        }
                    }
                }
                
                stage('è¤‡é›‘åº¦è§£æ') {
                    steps {
                        script {
                            echo "\nğŸ” ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦ã‚’è§£æä¸­..."
                            // è¤‡é›‘åº¦è§£æã®å®Ÿè¡Œ
                            analyzeComplexity()
                        }
                    }
                }
                
                stage('AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ') {
                    steps {
                        script {
                            echo "\nğŸ’¬ AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­..."
                            // è§£æçµæœã«åŸºã¥ã„ã¦AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
                            generatePRComment()
                        }
                    }
                }
            }
        }
        
        stage('PRã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿') {
            when {
                expression { env.SKIP_ANALYSIS == 'false' && env.HAS_CODE_FILES == 'true' }
            }
            steps {
                script {
                    echo "\nğŸ’¬ PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’é–‹å§‹ã—ã¾ã™..."
                    postPRComment()
                }
            }
        }
        
        stage('Jenkinså†å®Ÿè¡Œãƒªãƒ³ã‚¯ã®æŠ•ç¨¿') {
            steps {
                script {
                    echo "\nğŸ”„ Jenkinså†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚’æŠ•ç¨¿ã—ã¾ã™..."
                    postJenkinsRerunLink()
                }
            }
        }
    }
    
    post {
        always {
            script {
                postProcessing()
            }
        }
        
        success {
            echo "PRè¤‡é›‘åº¦è§£æãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
        }
        
        failure {
            echo "PRè¤‡é›‘åº¦è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        }
        
        cleanup {
            cleanWs()
        }
    }
}

// ====================== ã‚¹ãƒ†ãƒ¼ã‚¸é–¢æ•°ã®å®šç¾© ======================

def validateParameters() {
    // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã®è¨­å®š
    def (repoOwner, repoName) = gitUtils.extractRepoInfo(params.REPO_URL)
    env.REPO_OWNER = repoOwner
    env.REPO_NAME = repoName
    
    if (!env.REPO_OWNER?.trim() || !env.REPO_NAME?.trim()) {
        error "ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"
    }
    
    // PRç•ªå·ã®æ¤œè¨¼ã¨è¨­å®š
    def prNumber = env.CHANGE_ID?.trim() ?: params.PR_NUMBER?.trim()
    
    if (!prNumber) {
        error "PRç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    }
    
    // "Latest"ã®å ´åˆã¯æœ€æ–°ã®PRã‚’å–å¾—
    if (prNumber.equalsIgnoreCase('Latest')) {
        prNumber = getLatestPRNumber()
    }
    
    // PRç•ªå·ãŒæ•°å€¤ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    try {
        env.PR_NUMBER = prNumber
        Integer.parseInt(prNumber)
    } catch (NumberFormatException e) {
        error "PRç•ªå·ã¯æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: ${prNumber}"
    }
}

def getLatestPRNumber() {
    try {
        def latestPR = gitUtils.getLatestPullRequest([
            repoOwner: env.REPO_OWNER,
            repoName: env.REPO_NAME,
            state: 'open'
        ])
        
        if (!latestPR) {
            error "ã‚ªãƒ¼ãƒ—ãƒ³ãªPRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        }
        
        echo "æœ€æ–°ã®PR: #${latestPR.number} - ${latestPR.title}"
        return latestPR.number.toString()
        
    } catch (Exception e) {
        error "æœ€æ–°ã®PRæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
    }
}

def checkExistingComments() {
    env.SKIP_ANALYSIS = 'false'
    
    try {
        // PRä¸Šã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
        def existingComments = gitUtils.getPullRequestComments(
            env.PR_NUMBER as Integer,
            [
                repoOwner: env.REPO_OWNER,
                repoName: env.REPO_NAME
            ]
        )
        
        echo "æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${existingComments?.size() ?: 0}"
        
        // è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
        def autoGenComment = findAutoGeneratedComment(existingComments)
        
        if (autoGenComment && !params.FORCE_ANALYSIS) {
            echo "â„¹ï¸  æ—¢å­˜ã®è¤‡é›‘åº¦è§£æã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆID: ${autoGenComment.id}ï¼‰"
            echo "   FORCE_ANALYSISãŒfalseã®ãŸã‚ã€ä»¥é™ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            
            env.SKIP_ANALYSIS = 'true'
            env.EXISTING_COMMENT_ID = autoGenComment.id.toString()
        } else if (autoGenComment && params.FORCE_ANALYSIS) {
            echo "â„¹ï¸  æ—¢å­˜ã®è¤‡é›‘åº¦è§£æã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆID: ${autoGenComment.id}ï¼‰"
            echo "   FORCE_ANALYSISãŒtrueã®ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã™"
            env.EXISTING_COMMENT_ID = autoGenComment.id.toString()
        } else {
            echo "âœ“ æ—¢å­˜ã®è¤‡é›‘åº¦è§£æã‚³ãƒ¡ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        }
    } catch (Exception e) {
        echo "âš ï¸  æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}"
        echo "   å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™"
    }
}

def findAutoGeneratedComment(comments) {
    return comments?.findAll { comment ->
        comment.body?.contains('<!-- auto-generated-complexity-comment')
    }?.sort { it.created_at }?.reverse()?.find()
}

def fetchPRInformation() {
    try {
        echo "\nğŸ“‹ PRæƒ…å ±ã‚’å–å¾—ä¸­..."
        
        // PRæƒ…å ±ã®å–å¾—
        def prInfo = gitUtils.getPullRequestInfo(
            env.PR_NUMBER as Integer,
            [
                repoOwner: env.REPO_OWNER,
                repoName: env.REPO_NAME
            ]
        )

        // PRå·®åˆ†ã®å–å¾—
        def prDiff = gitUtils.getPullRequestDiff(
            env.PR_NUMBER as Integer,
            [
                repoOwner: env.REPO_OWNER,
                repoName: env.REPO_NAME
            ]
        )

        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
        writeJSON(file: "pr_info.json", json: prInfo, pretty: 4)
        writeJSON(file: "pr_diff.json", json: prDiff, pretty: 4)
                                
        // PRæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
        env.PR_HEAD_REF = prInfo.head.ref
        env.PR_HEAD_SHA = prInfo.head.sha
        env.PR_BASE_REF = prInfo.base.ref
        env.PR_BASE_SHA = prInfo.base.sha
        
        // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æŠ½å‡º
        def changedFiles = prDiff.collect { it.filename }
        env.CHANGED_FILES = changedFiles.join('\n')
        env.CHANGED_FILES_COUNT = changedFiles.size().toString()
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
        printPRInfo(prInfo, changedFiles)
        
    } catch (Exception e) {
        error "PRæƒ…å ±ãƒ»å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
    }
}

def checkAnalyzableFiles() {
    """è§£æå¯¾è±¡ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
    
    def changedFiles = env.CHANGED_FILES?.split('\n') ?: []
    
    // è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã‚’ç¢ºèª
    def codeFiles = changedFiles.findAll { file ->
        file.endsWith('.py') || file.endsWith('.js') || file.endsWith('.ts') || 
        file.endsWith('.java') || file.endsWith('.go') || file.endsWith('.rs') ||
        file.endsWith('.cpp') || file.endsWith('.c') || file.endsWith('.jsx') ||
        file.endsWith('.tsx') || file.endsWith('.rb') || file.endsWith('.php') ||
        file.endsWith('.cs') || file.endsWith('.swift') || file.endsWith('.kt') ||
        file.endsWith('.scala') || file.endsWith('.m') || file.endsWith('.h')
    }
    
    env.CODE_FILES_COUNT = codeFiles.size().toString()
    env.HAS_CODE_FILES = (codeFiles.size() > 0).toString()
    
    echo "\nğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«è§£æçµæœ:"
    echo "  - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ç·æ•°: ${changedFiles.size()}"
    echo "  - è§£æå¯¾è±¡ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«: ${codeFiles.size()}"
    
    if (codeFiles.size() == 0) {
        echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ â„¹ï¸  è§£æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ã“ã®PRã«ã¯è¤‡é›‘åº¦è§£æã®å¯¾è±¡ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒ
â•‘ å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
â•‘ 
â•‘ å¤‰æ›´å†…å®¹:
â•‘ - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãªã©
â•‘ 
â•‘ å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """.stripIndent()
        
        // å¿…è¦ã«å¿œã˜ã¦PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        if (params.FORCE_ANALYSIS || !env.EXISTING_COMMENT_ID) {
            postNoCodeFilesComment()
        }
    } else {
        echo "\nè§£æå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«:"
        if (codeFiles.size() <= 20) {
            codeFiles.each { file ->
                def ext = file.substring(file.lastIndexOf('.'))
                echo "  â€¢ ${file} (${getLanguageFromExtension(ext)})"
            }
        } else {
            // è¨€èªåˆ¥ã«é›†è¨ˆ
            def langCount = [:]
            codeFiles.each { file ->
                def ext = file.substring(file.lastIndexOf('.'))
                def lang = getLanguageFromExtension(ext)
                langCount[lang] = (langCount[lang] ?: 0) + 1
            }
            
            echo "  è¨€èªåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
            langCount.each { lang, count ->
                echo "    - ${lang}: ${count}å€‹"
            }
            echo "  åˆè¨ˆ: ${codeFiles.size()}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«"
        }
    }
}

def getLanguageFromExtension(ext) {
    def langMap = [
        '.py': 'Python',
        '.js': 'JavaScript',
        '.jsx': 'JavaScript/React',
        '.ts': 'TypeScript',
        '.tsx': 'TypeScript/React',
        '.java': 'Java',
        '.go': 'Go',
        '.rs': 'Rust',
        '.cpp': 'C++',
        '.c': 'C',
        '.rb': 'Ruby',
        '.php': 'PHP',
        '.cs': 'C#',
        '.swift': 'Swift',
        '.kt': 'Kotlin',
        '.scala': 'Scala',
        '.m': 'Objective-C',
        '.h': 'C/C++/Obj-C Header'
    ]
    return langMap[ext] ?: 'Unknown'
}

def postNoCodeFilesComment() {
    """ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿"""
    
    def comment = """
<!-- auto-generated-complexity-comment
timestamp: ${env.TIME_STAMP}
jenkins-job: ${env.JOB_NAME}
build-number: ${env.BUILD_NUMBER}
-->

# ğŸ“‹ è¤‡é›‘åº¦è§£æã‚¹ã‚­ãƒƒãƒ—

ã“ã®PRã«ã¯è¤‡é›‘åº¦è§£æã®å¯¾è±¡ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

## å¤‰æ›´å†…å®¹
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${env.CHANGED_FILES_COUNT}
- è§£æå¯¾è±¡ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«: 0

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®å¤‰æ›´ã®ã¿ã®ãŸã‚ã€è¤‡é›‘åº¦è§£æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚
    """.stripIndent()
    
    try {
        if (env.EXISTING_COMMENT_ID) {
            // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
            gitUtils.updatePullRequestComment(
                env.EXISTING_COMMENT_ID,
                comment,
                [
                    repoOwner: env.REPO_OWNER,
                    repoName: env.REPO_NAME
                ]
            )
            echo "âœ“ æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ"
        } else {
            // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            gitUtils.createPullRequestComment(
                env.PR_NUMBER as Integer,
                comment,
                [
                    repoOwner: env.REPO_OWNER,
                    repoName: env.REPO_NAME
                ]
            )
            echo "âœ“ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
        }
    } catch (Exception e) {
        echo "âš ï¸  ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
    }
}

def printPRInfo(prInfo, changedFiles) {
    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ PRæƒ…å ±
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ PRç•ªå·: #${env.PR_NUMBER}
â•‘ ã‚¿ã‚¤ãƒˆãƒ«: ${prInfo.title}
â•‘ ãƒ–ãƒ©ãƒ³ãƒ: ${env.PR_BASE_REF} â† ${env.PR_HEAD_REF}
â•‘ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${env.CHANGED_FILES_COUNT}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """.stripIndent()
    
    if (changedFiles.size() <= 10) {
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        changedFiles.each { file ->
            echo "  â€¢ ${file}"
        }
    } else {
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${changedFiles.size()}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€åˆã®10å€‹ã‚’è¡¨ç¤ºï¼‰"
        changedFiles.take(10).each { file ->
            echo "  â€¢ ${file}"
        }
        echo "  ... ä»– ${changedFiles.size() - 10} ãƒ•ã‚¡ã‚¤ãƒ«"
    }
}

// setupEnvironmentãƒ¡ã‚½ãƒƒãƒ‰ã¯å‰Šé™¤ï¼ˆå€‹åˆ¥ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç›´æ¥å‘¼ã³å‡ºã™ãŸã‚ï¼‰

def installSystemPackages() {
    echo "ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    sh """
        # å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        apt-get update -qq && apt-get install -qq -y \\
            build-essential \\
            pkg-config \\
            libssl-dev \\
            openssh-client \\
            python3 \\
            python3-pip \\
            python3-venv \\
            curl \\
            jq > /dev/null 2>&1
        echo "âœ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
    """
}

def createDirectories() {
    sh """
        mkdir -p ${ANALYSIS_DIR} ${SOURCE_DIR} ${CONFIG_DIR}
    """
    echo "âœ“ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
}

def checkoutJenkinsRepo() {
    echo "Jenkinsãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­..."
    dir(CONFIG_DIR) {
        gitUtils.checkoutRepository(
            env.GIT_INFRASTRUCTURE_REPO_URL,
            env.GIT_INFRASTRUCTURE_REPO_BRANCH,
            env.GITHUB_APP_CREDENTIALS_ID
        )
    }
    echo "âœ“ Jenkinsãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
}

def checkoutSourceRepo() {
    echo "PRå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­... (${env.PR_HEAD_REF})"
    dir(SOURCE_DIR) {
        gitUtils.checkoutRepository(
            params.REPO_URL,
            env.PR_HEAD_REF,
            params.GIT_SOURCE_REPO_CREDENTIALS_ID
        )
        
        // ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå¾Œã®ç°¡æ˜“ç¢ºèª
        def currentBranch = sh(
            script: 'git branch --show-current',
            returnStdout: true
        ).trim()
        
        def latestCommit = sh(
            script: 'git log -1 --oneline',
            returnStdout: true
        ).trim()
        
        echo "âœ“ ãƒ–ãƒ©ãƒ³ãƒ '${currentBranch}' ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
        echo "  æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: ${latestCommit}"
    }
}

def verifyRequiredFiles() {
    // é™ã‹ã«æ¤œè¨¼ã‚’å®Ÿè¡Œ
    def pythonScriptsExist = sh(
        script: "find ${CONFIG_DIR} -name '*.py' -type f | head -1",
        returnStatus: true
    ) == 0
    
    def sourceFilesExist = sh(
        script: "find ${SOURCE_DIR} -type f \\( -name '*.rs' -o -name '*.py' -o -name '*.js' \\) | head -1",
        returnStatus: true
    ) == 0
    
    if (!pythonScriptsExist) {
        error "å¿…è¦ãªPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    }
    
    if (!sourceFilesExist) {
        echo "âš ï¸  ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç©ºã®PRã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
    }
}

def setupPythonEnvironment() {
    echo "Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
    sh """
        # ä»®æƒ³ç’°å¢ƒã®ä½œæˆï¼ˆè©³ç´°ãƒ­ã‚°ã‚’æŠ‘åˆ¶ï¼‰
        python3 -m venv ${VENV_PATH} > /dev/null 2>&1
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆè©³ç´°ãƒ­ã‚°ã‚’æŠ‘åˆ¶ï¼‰
        set +x
        . ${VENV_PATH}/bin/activate
        pip install --upgrade pip --quiet
        
        # requirements.txt ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install -r ${PYTHON_PROJECT_DIR}/requirements.txt --no-cache-dir --quiet
        set -x
        
        # ä¸»è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª
        echo "  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèªä¸­..."
        if pip list 2>/dev/null | grep -qE "(openai|PyGithub|pandas)"; then
            echo "  âœ“ å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ"
            echo "    - openai (OpenAI APIç”¨)"
            echo "    - PyGithub (GitHub APIç”¨)"
            echo "    - pandas (ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨)"
        else
            echo "  âš ï¸  ä¸€éƒ¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            pip list | grep -E "(openai|PyGithub|pandas)" || true
        fi
    """
}

def installRustTools() {
    echo "Rustãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    sh """
        # CARGO_HOMEã‚’ç¢ºèªã—ã¦é©åˆ‡ãªPATHã‚’è¨­å®š
        if [ -n "\${CARGO_HOME}" ]; then
            export PATH="\${CARGO_HOME}/bin:\$PATH"
        else
            export PATH="\$HOME/.cargo/bin:/root/.cargo/bin:\$PATH"
        fi
        
        # rust-code-analysisãŒã™ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if command -v rust-code-analysis-cli > /dev/null 2>&1; then
            INSTALLED_VERSION=\$(rust-code-analysis-cli --version | cut -d' ' -f2)
            
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹å ´åˆã¯å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            if [ "\${INSTALLED_VERSION}" != "${RUST_CODE_ANALYSIS_VERSION}" ]; then
                echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹ãŸã‚å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
                echo "  ç¾åœ¨: v\${INSTALLED_VERSION}"
                echo "  å¿…è¦: v${RUST_CODE_ANALYSIS_VERSION}"
                cargo install rust-code-analysis-cli --version ${RUST_CODE_ANALYSIS_VERSION} --locked --force --quiet
                echo "âœ“ rust-code-analysis-cli v${RUST_CODE_ANALYSIS_VERSION} ã«æ›´æ–°ã—ã¾ã—ãŸ"
            else
                echo "âœ“ rust-code-analysis-cli v\${INSTALLED_VERSION} ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™"
            fi
        else
            echo "rust-code-analysis-cliã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            echo "CARGO_HOME: \${CARGO_HOME:-æœªè¨­å®š}"
            echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆ: \${CARGO_HOME:-\$HOME/.cargo}/bin"
            
            # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œ
            cargo install rust-code-analysis-cli --version ${RUST_CODE_ANALYSIS_VERSION} --locked --quiet
            
            echo "âœ“ rust-code-analysis-cli v${RUST_CODE_ANALYSIS_VERSION} ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ"
        fi
    """
}

def finalEnvironmentCheck() {
    echo "âœ“ ç’°å¢ƒæº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ"
}

def analyzeComplexity() {
    try {
        // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆæœ€å¾Œã«æ”¹è¡Œã‚’è¿½åŠ ï¼‰
        writeFile file: 'changed_files.txt', text: env.CHANGED_FILES + '\n'
        
        // è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        runComplexityAnalysisScript()
        
        // è§£æå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
        def metricsSize = sh(
            script: "wc -c < ${ANALYSIS_DIR}/complexity_metrics.json 2>/dev/null || echo 0",
            returnStdout: true
        ).trim() as Integer
        
        if (metricsSize < 10) {
            echo "âš ï¸  è§£æå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "   ï¼ˆéã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å¤‰æ›´ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
            
            // ç©ºã®çµæœã‚’ä½œæˆ
            writeJSON file: "${ANALYSIS_DIR}/analysis_result.json", json: [
                pr_number: env.PR_NUMBER,
                pr_title: 'N/A',
                total_files_analyzed: 0,
                total_functions: 0,
                high_complexity_functions_cyclomatic: 0,
                high_complexity_functions_cognitive: 0,
                thresholds: [
                    cyclomatic: params.CYCLOMATIC_THRESHOLD as Integer,
                    cognitive: params.COGNITIVE_THRESHOLD as Integer
                ],
                file_analyses: [:],
                high_complexity_functions: []
            ]
        } else {
            // Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è§£æçµæœã‚’å‡¦ç†
            processAnalysisResults()
        }
        
    } catch (Exception e) {
        error "è¤‡é›‘åº¦è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
    }
}

def runComplexityAnalysisScript() {
    echo "è¤‡é›‘åº¦è§£æã‚’å®Ÿè¡Œä¸­..."
    
    // å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’äº‹å‰ã«ç¢ºèª
    def fileCount = sh(
        script: "wc -l < changed_files.txt",
        returnStdout: true
    ).trim()
    
    echo "è§£æå¯¾è±¡: ${fileCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«"
    
    // è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆæ¨™æº–å‡ºåŠ›ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼‰
    sh """
        # CARGO_HOMEã‚’ç¢ºèªã—ã¦é©åˆ‡ãªPATHã‚’è¨­å®š
        if [ -n "\${CARGO_HOME}" ]; then
            export PATH="\${CARGO_HOME}/bin:\$PATH"
        else
            export PATH="\$HOME/.cargo/bin:/root/.cargo/bin:\$PATH"
        fi
        
        # rust-code-analysis-cliã®å­˜åœ¨ç¢ºèª
        if ! command -v rust-code-analysis-cli > /dev/null 2>&1; then
            echo "ã‚¨ãƒ©ãƒ¼: rust-code-analysis-cliãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "PATH: \$PATH"
            echo "CARGO_HOME: \${CARGO_HOME:-æœªè¨­å®š}"
            exit 1
        fi
        
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
        chmod +x ${CONFIG_DIR}/${PROJECT_BASE_DIR}/scripts/analyze_complexity.sh
        
        # è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        ${CONFIG_DIR}/${PROJECT_BASE_DIR}/scripts/analyze_complexity.sh \\
            "${SOURCE_DIR}" \\
            "${ANALYSIS_DIR}" \\
            "changed_files.txt"
    """
    
    // çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’ç¢ºèª
    def resultSize = sh(
        script: "wc -c < ${ANALYSIS_DIR}/complexity_metrics.json 2>/dev/null || echo 0",
        returnStdout: true
    ).trim()
    
    echo "âœ“ è§£æçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${resultSize} bytes"
}

def processAnalysisResults() {
    echo "è§£æçµæœã‚’å‡¦ç†ä¸­..."
    echo "  rust-code-analysisã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã—ã¾ã™..."
    
    def output = sh(
        script: """
            # ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆï¼ˆè©³ç´°ãƒ­ã‚°ã‚’æŠ‘åˆ¶ï¼‰
            set +x
            . ${VENV_PATH}/bin/activate
            set -x
            
            # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
            echo "  çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œä¸­..."
            python ${PYTHON_PROJECT_DIR}/integrate_complexity_analysis.py \\
                --metrics-file ${ANALYSIS_DIR}/complexity_metrics.json \\
                --pr-info pr_info.json \\
                --pr-diff pr_diff.json \\
                --output ${ANALYSIS_DIR}/analysis_result.json \\
                --cyclomatic-threshold ${params.CYCLOMATIC_THRESHOLD} \\
                --cognitive-threshold ${params.COGNITIVE_THRESHOLD}
        """,
        returnStdout: true
    ).trim()
    
    if (output) {
        // é‡è¦ãªæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
        def importantLines = output.split('\n').findAll { line ->
            line.contains('Total functions') || 
            line.contains('Analysis complete:') ||
            line.contains('Files analyzed:') ||
            line.contains('High complexity functions')
        }
        
        if (importantLines) {
            echo importantLines.join('\n')
        }
    }
    
    // è§£æçµæœã®æ¦‚è¦ã‚’è¡¨ç¤º
    if (fileExists("${ANALYSIS_DIR}/analysis_result.json")) {
        def result = readJSON file: "${ANALYSIS_DIR}/analysis_result.json"
        echo "  âœ“ è§£æå®Œäº†: ${result.total_files_analyzed}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€${result.total_functions ?: 0}å€‹ã®é–¢æ•°ã‚’å‡¦ç†"
        
        // é«˜è¤‡é›‘åº¦é–¢æ•°ã®è©³ç´°ã‚’è¡¨ç¤º
        def highComplexityFuncs = result.high_complexity_functions ?: []
        if (highComplexityFuncs.size() > 0) {
            echo "\n  âš ï¸  é«˜è¤‡é›‘åº¦é–¢æ•°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
            highComplexityFuncs.take(5).each { func ->
                echo "    â€¢ ${func.name}"
                echo "      èªçŸ¥çš„: ${func.cognitive} (é–¾å€¤: ${params.COGNITIVE_THRESHOLD})"
                echo "      å¾ªç’°çš„: ${func.cyclomatic} (é–¾å€¤: ${params.CYCLOMATIC_THRESHOLD})"
                echo "      å ´æ‰€: ${func.file}:${func.start_line}-${func.end_line}"
            }
            if (highComplexityFuncs.size() > 5) {
                echo "    ... ä»– ${highComplexityFuncs.size() - 5}å€‹ã®é«˜è¤‡é›‘åº¦é–¢æ•°"
            }
        } else {
            echo "  âœ… ã™ã¹ã¦ã®é–¢æ•°ãŒè¤‡é›‘åº¦ã®é–¾å€¤å†…ã«åã¾ã£ã¦ã„ã¾ã™"
        }
    }
}

def generatePRComment() {
    try {
        withCredentials([
            usernamePassword(credentialsId: env.GITHUB_APP_CREDENTIALS_ID , 
                            usernameVariable: 'GITHUB_APP_ID',
                            passwordVariable: 'GITHUB_ACCESS_TOKEN'),
            string(credentialsId: 'openai-api-key', 
                variable: 'OPENAI_API_KEY')
        ]) {
            withEnv(['GITHUB_AUTH_METHOD=app']) {
                runCommentGeneratorScript()
            }
        }
        
        echo "è¤‡é›‘åº¦è§£æã‚³ãƒ¡ãƒ³ãƒˆã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
    } catch (Exception e) {
        error "OpenAIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
    }
}

def runCommentGeneratorScript() {
    echo "AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­..."
    
    // OpenAI APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ˜ç¤º
    echo "  OpenAI APIã‚’å‘¼ã³å‡ºã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™..."
    
    sh """
        # ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆï¼ˆè©³ç´°ãƒ­ã‚°ã‚’æŠ‘åˆ¶ï¼‰
        set +x
        . ${VENV_PATH}/bin/activate
        set -x
        
        # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å ´æ‰€ã‚’ç¢ºèª
        SCRIPT_PATH="${PYTHON_PROJECT_DIR}/pr_complexity_comment_generator.py"
        if [ ! -f "\${SCRIPT_PATH}" ]; then
            echo "Error: Python script not found at \${SCRIPT_PATH}"
            exit 1
        fi
        
        # ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆ--save-promptã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
        echo "  è§£æçµæœã‚’åŸºã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­..."
        python \${SCRIPT_PATH} \\
            --analysis-result ${ANALYSIS_DIR}/analysis_result.json \\
            --output ${ANALYSIS_DIR}/pr_comment.json \\
            --save-prompt
    """
    
    // ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ¦‚è¦ã‚’è¡¨ç¤º
    if (fileExists("${ANALYSIS_DIR}/pr_comment.json")) {
        def commentData = readJSON file: "${ANALYSIS_DIR}/pr_comment.json"
        def commentLength = commentData.comment?.length() ?: 0
        echo "  âœ“ ${commentLength}æ–‡å­—ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ã‚‚è¡¨ç¤º
        def metadata = commentData.generation_metadata
        if (metadata) {
            echo "  ğŸ“‹ ç”Ÿæˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿:"
            echo "    - ãƒ¢ãƒ‡ãƒ«: ${metadata.model ?: 'N/A'}"
            echo "    - Temperature: ${metadata.temperature ?: 'N/A'}"
            echo "    - æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°: ${metadata.max_tokens ?: 'N/A'}"
            if (metadata.prompt_length) {
                echo "    - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·: ${metadata.prompt_length}æ–‡å­— (æ¨å®š${metadata.estimated_prompt_tokens ?: 'N/A'}ãƒˆãƒ¼ã‚¯ãƒ³)"
            }
        }
    }
    
    // ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«å«ã‚ã‚‹
    sh """
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
        if ls openai_prompt_*.txt 1> /dev/null 2>&1; then
            mv openai_prompt_*.txt ${ANALYSIS_DIR}/
            echo "  âœ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
        fi
    """
}

def postPRComment() {
    try {
        // ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿
        def commentResult = readJSON file: "${ANALYSIS_DIR}/pr_comment.json"
        def comment = commentResult.comment
        
        // è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ã®ä½œæˆ
        def autoGenTag = createAutoGeneratedTag()
        
        // ã‚¿ã‚°ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã®å…ˆé ­ã«è¿½åŠ 
        comment = autoGenTag + comment
        
        // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
        if (env.EXISTING_COMMENT_ID) {
            updateExistingComment(comment)
        } else {
            createNewComment(comment)
        }
    } catch (Exception e) {
        error "PRã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
    }
}

def createAutoGeneratedTag() {
    return """
        <!-- auto-generated-complexity-comment
        timestamp: ${env.TIME_STAMP}
        jenkins-job: ${env.JOB_NAME}
        build-number: ${env.BUILD_NUMBER}
        -->
        
    """.stripIndent()
}

def updateExistingComment(comment) {
    echo "æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆID: ${env.EXISTING_COMMENT_ID}ï¼‰ã‚’æ›´æ–°ä¸­..."
    gitUtils.updatePullRequestComment(
        env.EXISTING_COMMENT_ID,
        comment,
        [
            repoOwner: env.REPO_OWNER,
            repoName: env.REPO_NAME
        ]
    )
    echo "âœ“ PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ"
}

def createNewComment(comment) {
    echo "æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆä¸­..."
    gitUtils.createPullRequestComment(
        env.PR_NUMBER as Integer,
        comment,
        [
            repoOwner: env.REPO_OWNER,
            repoName: env.REPO_NAME
        ]
    )
    echo "âœ“ PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
}

def postJenkinsRerunLink() {
    try {
        def rebuildUrl = "${env.BUILD_URL}rebuild/parameterized"
        def buildUrl = env.BUILD_URL
        
        def rerunTag = """
            <!-- jenkins-complexity-analyzer-rerun-link
            timestamp: ${env.TIME_STAMP}
            jenkins-job: ${env.JOB_NAME}
            -->
        """.stripIndent()
        
        def rerunComment = rerunTag + """
            ## ğŸ”„ Jenkins ã‚¸ãƒ§ãƒ–å†å®Ÿè¡Œ
            
            ã“ã®PRã®è¤‡é›‘åº¦è§£æã‚’å†å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
            
            ğŸš€ **[è¤‡é›‘åº¦è§£æã‚’å†å®Ÿè¡Œã™ã‚‹](${rebuildUrl})**
            
            å¿…è¦ã«å¿œã˜ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã§ãã¾ã™ï¼š
            - `FORCE_ANALYSIS`: æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã£ã¦ã‚‚å†åˆ†æã‚’å¼·åˆ¶å®Ÿè¡Œ
            - `CYCLOMATIC_THRESHOLD`: å¾ªç’°çš„è¤‡é›‘åº¦ã®é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰
            - `COGNITIVE_THRESHOLD`: èªçŸ¥çš„è¤‡é›‘åº¦ã®é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15ï¼‰
            
            ğŸ“Š [ãƒ“ãƒ«ãƒ‰ã®è©³ç´°ã‚’ç¢ºèª](${buildUrl})
            
            > **æ³¨æ„**: ãƒ“ãƒ«ãƒ‰å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã‚‹ã¨ã€å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚
        """.stripIndent()
        
        def existingComments = gitUtils.getPullRequestComments(
            env.PR_NUMBER as Integer,
            [
                repoOwner: env.REPO_OWNER,
                repoName: env.REPO_NAME
            ]
        )
        
        def rerunLinkComment = existingComments?.find { comment ->
            comment.body?.contains('<!-- jenkins-complexity-analyzer-rerun-link')
        }
        
        if (rerunLinkComment) {
            echo "æ—¢å­˜ã®å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã™: ã‚³ãƒ¡ãƒ³ãƒˆID ${rerunLinkComment.id}"
            gitUtils.updatePullRequestComment(
                rerunLinkComment.id.toString(),
                rerunComment,
                [
                    repoOwner: env.REPO_OWNER,
                    repoName: env.REPO_NAME
                ]
            )
            echo "å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ"
        } else {
            echo "æ–°è¦å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™"
            gitUtils.createPullRequestComment(
                env.PR_NUMBER as Integer,
                rerunComment,
                [
                    repoOwner: env.REPO_OWNER,
                    repoName: env.REPO_NAME
                ]
            )
            echo "å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ"
        }
    } catch (Exception e) {
        echo "å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
        echo "ã“ã®å‡¦ç†ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªãŸã‚ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç¶™ç¶šã—ã¾ã™"
    }
}

def postProcessing() {
    // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
    if (env.ANALYSIS_DIR && env.HAS_CODE_FILES == 'true') {
        archiveArtifacts artifacts: """
            ${ANALYSIS_DIR}/*.json,
            ${ANALYSIS_DIR}/openai_prompt_*.txt
        """, allowEmptyArchive: true
    }
    
    // çµæœã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
    if (env.SKIP_ANALYSIS == 'true') {
        displaySkippedAnalysisSummary()
    } else if (env.HAS_CODE_FILES == 'false') {
        displayNoCodeFilesSummary()
    } else if (env.ANALYSIS_DIR) {
        displayAnalysisSummary()
    }
}

def displaySkippedAnalysisSummary() {
    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ â„¹ï¸  PRè¤‡é›‘åº¦è§£æã‚¹ã‚­ãƒƒãƒ—
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ PRç•ªå·: #${env.PR_NUMBER}
â•‘ ç†ç”±: æ—¢å­˜ã®è¤‡é›‘åº¦è§£æã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™
â•‘ 
â•‘ â€»å†åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ FORCE_ANALYSIS ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’
â•‘   æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """.stripIndent()
}

def displayNoCodeFilesSummary() {
    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ â„¹ï¸  PRè¤‡é›‘åº¦è§£æã‚¹ã‚­ãƒƒãƒ—
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ PRç•ªå·: #${env.PR_NUMBER}
â•‘ ç†ç”±: è§£æå¯¾è±¡ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“
â•‘ 
â•‘ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${env.CHANGED_FILES_COUNT ?: 'N/A'}
â•‘ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 0
â•‘ 
â•‘ â€»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´ã§ã™
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """.stripIndent()
}

def displayAnalysisSummary() {
    def analysisFile = "${ANALYSIS_DIR}/analysis_result.json"
    if (fileExists(analysisFile)) {
        def result = readJSON file: analysisFile
        
        def cycloComplexFuncs = result.high_complexity_functions_cyclomatic ?: 0
        def cognComplexFuncs = result.high_complexity_functions_cognitive ?: 0
        
        echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“Š PRè¤‡é›‘åº¦è§£æçµæœ
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ PRç•ªå·: #${env.PR_NUMBER}
â•‘ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${env.CHANGED_FILES_COUNT ?: 'N/A'}
â•‘ è§£æã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${env.CODE_FILES_COUNT ?: 'N/A'}
â•‘ è§£æã•ã‚ŒãŸé–¢æ•°æ•°: ${result.total_functions ?: 0}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ é«˜è¤‡é›‘åº¦é–¢æ•°:
â•‘   â€¢ å¾ªç’°çš„è¤‡é›‘åº¦ > ${params.CYCLOMATIC_THRESHOLD}: ${cycloComplexFuncs}å€‹
â•‘   â€¢ èªçŸ¥çš„è¤‡é›‘åº¦ > ${params.COGNITIVE_THRESHOLD}: ${cognComplexFuncs}å€‹
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """.stripIndent()
        
        if (cycloComplexFuncs > 0 || cognComplexFuncs > 0) {
            echo "âš ï¸  é«˜è¤‡é›‘åº¦ã®é–¢æ•°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚PRã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        } else {
            echo "âœ… ã™ã¹ã¦ã®é–¢æ•°ã®è¤‡é›‘åº¦ãŒé©åˆ‡ãªç¯„å›²å†…ã§ã™ã€‚"
        }
    }
}
