@Library('jenkins-shared-lib') _

pipeline {

    agent { 
        label 'ec2-fleet' 
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    echo "=== GitHub Deploy Key Test Pipeline ==="
                    echo "Test Type: ${params.TEST_TYPE}"
                    echo "Dry Run: ${params.DRY_RUN}"
                    echo "Cleanup: ${params.CLEANUP_AFTER_TEST}"
                    
                    // Gitæƒ…å ±ã‚’å–å¾—
                    def repoInfo = gitUtils.extractRepoInfo(params.REPO_URL)
                    env.REPO_OWNER = repoInfo[0]
                    env.REPO_NAME = repoInfo[1]
                    
                    echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
                    
                    // GitHubã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    def connectionTest = gitUtils.testGitHubAppConnection()
                    if (connectionTest.success) {
                        echo "âœ… GitHubæ¥ç¶šãƒ†ã‚¹ãƒˆ: æˆåŠŸ"
                        echo "Rate Limit: ${connectionTest.rate_limit.remaining}/${connectionTest.rate_limit.limit}"
                    } else {
                        error "âŒ GitHubæ¥ç¶šãƒ†ã‚¹ãƒˆ: å¤±æ•—"
                    }
                }
            }
        }
        
        stage('List Deploy Keys') {
            when {
                anyOf {
                    expression { params.TEST_TYPE == 'ALL' }
                    expression { params.TEST_TYPE == 'LIST_ONLY' }
                }
            }
            steps {
                script {
                    try {
                        echo "=== æ—¢å­˜Deploy Keyä¸€è¦§ ==="
                        def deployKeys = gitUtils.listDeployKeys([ repoUrl: params.REPO_URL ])
                        
                        if (deployKeys && deployKeys.size() > 0) {
                            deployKeys.each { key ->
                                echo "ID: ${key.id}"
                                echo "  Title: ${key.title}"
                                echo "  Key: ${key.key?.take(50)}..."
                                echo "  Read Only: ${key.read_only}"
                                echo "  Created: ${key.created_at}"
                                echo "  Verified: ${key.verified}"
                                echo "---"
                            }
                            echo "åˆè¨ˆ: ${deployKeys.size()}å€‹ã®Deploy Key"
                        } else {
                            echo "æ—¢å­˜ã®Deploy Keyã¯ã‚ã‚Šã¾ã›ã‚“"
                        }
                    } catch (Exception e) {
                        echo "âŒ Deploy Keyä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}"
                        if (!params.DRY_RUN) {
                            throw e
                        }
                    }
                }
            }
        }
        
        stage('Create & Update Tests') {
            when {
                allOf {
                    anyOf {
                        expression { params.TEST_TYPE == 'ALL' }
                        expression { params.TEST_TYPE == 'CREATE_UPDATE' }
                    }
                    expression { !params.DRY_RUN }
                }
            }
            steps {
                script {
                    echo "=== Deploy Keyä½œæˆãƒ»å–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹ ==="
                    
                    try {
                        // ãƒ†ã‚¹ãƒˆç”¨SSHéµãƒšã‚¢ç”Ÿæˆ
                        echo "1. ãƒ†ã‚¹ãƒˆç”¨SSHéµç”Ÿæˆ"
                        sh '''
                            # ãƒ†ã‚¹ãƒˆç”¨ã®ä¸€æ™‚çš„ãªSSHéµãƒšã‚¢ã‚’ç”Ÿæˆ
                            ssh-keygen -t ed25519 -f ./test_key -N "" -C "jenkins-test@example.com"
                            chmod 600 ./test_key*
                        '''
                        
                        def publicKey = readFile('./test_key.pub').trim()
                        echo "âœ… ãƒ†ã‚¹ãƒˆç”¨SSHéµç”Ÿæˆå®Œäº†"
                        echo "   å…¬é–‹éµ: ${publicKey.take(50)}..."
                        
                        // 2. Deploy Keyä½œæˆãƒ†ã‚¹ãƒˆ
                        echo "2. Deploy Keyä½œæˆãƒ†ã‚¹ãƒˆ"
                        def deployKeyResult = gitUtils.createDeployKey(
                            params.DEPLOY_KEY_TITLE,
                            publicKey,
                            true, // read-only
                            [ repoUrl: params.REPO_URL ]
                        )
                        
                        env.TEST_DEPLOY_KEY_ID = deployKeyResult.id.toString()
                        echo "âœ… Deploy Keyä½œæˆæˆåŠŸ:"
                        echo "   ID: ${env.TEST_DEPLOY_KEY_ID}"
                        echo "   Title: ${deployKeyResult.title}"
                        echo "   Read Only: ${deployKeyResult.read_only}"
                        echo "   Verified: ${deployKeyResult.verified}"
                        
                        // 3. ä½œæˆã—ãŸDeploy Keyã®å–å¾—ãƒ†ã‚¹ãƒˆ
                        echo "3. Deploy Keyå–å¾—ãƒ†ã‚¹ãƒˆ"
                        def getKeyResult = gitUtils.getDeployKey(
                            env.TEST_DEPLOY_KEY_ID,
                            [ repoUrl: params.REPO_URL ]
                        )
                        echo "âœ… Deploy Keyå–å¾—æˆåŠŸ:"
                        echo "   Title: ${getKeyResult.title}"
                        echo "   Created: ${getKeyResult.created_at}"
                        
                        // 4. æ›¸ãè¾¼ã¿å¯èƒ½ãªDeploy Keyä½œæˆãƒ†ã‚¹ãƒˆ
                        echo "4. æ›¸ãè¾¼ã¿å¯èƒ½Deploy Keyä½œæˆãƒ†ã‚¹ãƒˆ"
                        sh '''
                            ssh-keygen -t ed25519 -f ./test_key_rw -N "" -C "jenkins-test-rw@example.com"
                            chmod 600 ./test_key_rw*
                        '''
                        
                        def publicKeyRW = readFile('./test_key_rw.pub').trim()
                        def deployKeyRWResult = gitUtils.createDeployKey(
                            "${params.DEPLOY_KEY_TITLE} (Read-Write)",
                            publicKeyRW,
                            false, // read-write
                            [ repoUrl: params.REPO_URL ]
                        )
                        
                        env.TEST_DEPLOY_KEY_RW_ID = deployKeyRWResult.id.toString()
                        echo "âœ… æ›¸ãè¾¼ã¿å¯èƒ½Deploy Keyä½œæˆæˆåŠŸ:"
                        echo "   ID: ${env.TEST_DEPLOY_KEY_RW_ID}"
                        echo "   Read Only: ${deployKeyRWResult.read_only}"
                        
                    } catch (Exception e) {
                        echo "âŒ Deploy Keyä½œæˆãƒ»å–å¾—ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}"
                        throw e
                    }
                }
            }
        }
        
        stage('Search Test') {
            when {
                allOf {
                    anyOf {
                        expression { params.TEST_TYPE == 'ALL' }
                        expression { params.TEST_TYPE == 'SEARCH' }
                    }
                    expression { !params.DRY_RUN }
                }
            }
            steps {
                script {
                    echo "=== Deploy Keyæ¤œç´¢ãƒ†ã‚¹ãƒˆé–‹å§‹ ==="
                    
                    try {
                        // ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢ãƒ†ã‚¹ãƒˆ
                        echo "1. ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ãƒ†ã‚¹ãƒˆ"
                        def searchResults = gitUtils.findDeployKeysByTitle(
                            'Jenkins',
                            [ repoUrl: params.REPO_URL ]
                        )
                        echo "âœ… 'Jenkins'ã‚’å«ã‚€Deploy Key: ${searchResults.size()}ä»¶"
                        searchResults.each { key ->
                            echo "   - ${key.title} (ID: ${key.id})"
                        }
                        
                        // å®Œå…¨ä¸€è‡´æ¤œç´¢ãƒ†ã‚¹ãƒˆ
                        echo "2. ã‚¿ã‚¤ãƒˆãƒ«å®Œå…¨ä¸€è‡´æ¤œç´¢ãƒ†ã‚¹ãƒˆ"
                        def exactResults = gitUtils.findDeployKeysByTitle(
                            params.DEPLOY_KEY_TITLE,
                            [ repoUrl: params.REPO_URL ]
                        )
                        echo "âœ… '${params.DEPLOY_KEY_TITLE}'ã¨å®Œå…¨ä¸€è‡´: ${exactResults.size()}ä»¶"
                        
                    } catch (Exception e) {
                        echo "âŒ Deploy Keyæ¤œç´¢ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}"
                        throw e
                    }
                }
            }
        }
        
        stage('Batch Create Test') {
            when {
                allOf {
                    anyOf {
                        expression { params.TEST_TYPE == 'ALL' }
                        expression { params.TEST_TYPE == 'BATCH_CREATE' }
                    }
                    expression { !params.DRY_RUN }
                }
            }
            steps {
                script {
                    echo "=== Deploy Keyä¸€æ‹¬ä½œæˆãƒ†ã‚¹ãƒˆé–‹å§‹ ==="
                    
                    try {
                        // ä¸€æ‹¬ä½œæˆç”¨ã®éµç”Ÿæˆ
                        echo "1. ä¸€æ‹¬ä½œæˆç”¨SSHéµç”Ÿæˆ"
                        sh '''
                            for i in 1 2 3; do
                                ssh-keygen -t ed25519 -f ./test_batch_key${i} -N "" -C "jenkins-batch-test${i}@example.com"
                                chmod 600 ./test_batch_key${i}*
                            done
                        '''
                        
                        def publicKey1 = readFile('./test_batch_key1.pub').trim()
                        def publicKey2 = readFile('./test_batch_key2.pub').trim()
                        def publicKey3 = readFile('./test_batch_key3.pub').trim()
                        
                        def batchKeyConfigs = [
                            [
                                title: 'Jenkins Batch Test Key 1',
                                key: publicKey1,
                                readOnly: true
                            ],
                            [
                                title: 'Jenkins Batch Test Key 2',
                                key: publicKey2,
                                readOnly: false
                            ],
                            [
                                title: 'Jenkins Batch Test Key 3',
                                key: publicKey3,
                                readOnly: true
                            ]
                        ]
                        
                        echo "2. Deploy Keyä¸€æ‹¬ä½œæˆå®Ÿè¡Œ"
                        def batchKeyResults = gitUtils.batchCreateDeployKeys(
                            batchKeyConfigs,
                            [ repoUrl: params.REPO_URL ]
                        )
                        
                        def keySuccessCount = batchKeyResults.count { it.success }
                        echo "âœ… Deploy Keyä¸€æ‹¬ä½œæˆå®Œäº†: ${keySuccessCount}/${batchKeyResults.size()} æˆåŠŸ"
                        
                        // çµæœã®è©³ç´°è¡¨ç¤º
                        batchKeyResults.eachWithIndex { result, index ->
                            if (result.success) {
                                echo "  [${index + 1}] âœ… æˆåŠŸ: ID=${result.result.id}, Title=${result.result.title}, ReadOnly=${result.result.read_only}"
                            } else {
                                echo "  [${index + 1}] âŒ å¤±æ•—: ${result.error}"
                            }
                        }
                        
                        // ä½œæˆã•ã‚ŒãŸDeploy Keyã®IDã‚’è¨˜éŒ²ï¼ˆå‰Šé™¤ç”¨ï¼‰
                        def batchKeyIds = batchKeyResults.findAll { it.success }.collect { it.result.id }
                        env.BATCH_DEPLOY_KEY_IDS = batchKeyIds.join(',')
                        
                    } catch (Exception e) {
                        echo "âŒ Deploy Keyä¸€æ‹¬ä½œæˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}"
                        throw e
                    }
                }
            }
        }
        
        stage('Verification') {
            when {
                expression { !params.DRY_RUN && params.TEST_TYPE != 'LIST_ONLY' }
            }
            steps {
                script {
                    echo "=== ä½œæˆã•ã‚ŒãŸDeploy Keyã®ç¢ºèª ==="
                    
                    try {
                        // æœ€æ–°ã®Deploy Keyä¸€è¦§ã‚’å–å¾—
                        def finalDeployKeys = gitUtils.listDeployKeys([ repoUrl: params.REPO_URL ])
                        echo "ç¾åœ¨ã®Deploy Keyç·æ•°: ${finalDeployKeys?.size() ?: 0}"
                        
                        // ãƒ†ã‚¹ãƒˆã§ä½œæˆã—ãŸDeploy Keyã®ç¢ºèª
                        if (env.TEST_DEPLOY_KEY_ID) {
                            def testDeployKey = gitUtils.getDeployKey(
                                env.TEST_DEPLOY_KEY_ID,
                                [ repoUrl: params.REPO_URL ]
                            )
                            echo "âœ… ãƒ†ã‚¹ãƒˆDeploy Keyç¢ºèª:"
                            echo "   Title: ${testDeployKey.title}"
                            echo "   Read Only: ${testDeployKey.read_only}"
                            echo "   Verified: ${testDeployKey.verified}"
                        }
                        
                        // ãƒãƒƒãƒä½œæˆã—ãŸDeploy Keyã®æ•°ã‚’ç¢ºèª
                        if (env.BATCH_DEPLOY_KEY_IDS) {
                            def batchIds = env.BATCH_DEPLOY_KEY_IDS.split(',')
                            echo "âœ… ãƒãƒƒãƒä½œæˆDeploy Keyæ•°: ${batchIds.size()}"
                        }
                        
                    } catch (Exception e) {
                        echo "âš ï¸ ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "=== ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ ==="
                echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
                echo "Test Type: ${params.TEST_TYPE}"
                echo "Dry Run: ${params.DRY_RUN}"
                echo "Deploy Key Title: ${params.DEPLOY_KEY_TITLE}"
                
                // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                sh 'rm -f ./test_key* ./test_batch_key* || true'
            }
        }
        
        cleanup {
            script {
                if (params.CLEANUP_AFTER_TEST && !params.DRY_RUN && params.TEST_TYPE != 'LIST_ONLY') {
                    echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹ ==="
                    
                    // ãƒ†ã‚¹ãƒˆç”¨Deploy Keyã®å‰Šé™¤
                    if (env.TEST_DEPLOY_KEY_ID) {
                        try {
                            gitUtils.deleteDeployKey(
                                env.TEST_DEPLOY_KEY_ID,
                                [ repoUrl: params.REPO_URL ]
                            )
                            echo "âœ… ãƒ†ã‚¹ãƒˆDeploy Keyå‰Šé™¤å®Œäº†: ID=${env.TEST_DEPLOY_KEY_ID}"
                        } catch (Exception e) {
                            echo "âš ï¸ ãƒ†ã‚¹ãƒˆDeploy Keyå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}"
                        }
                    }
                    
                    // æ›¸ãè¾¼ã¿å¯èƒ½Deploy Keyã®å‰Šé™¤
                    if (env.TEST_DEPLOY_KEY_RW_ID) {
                        try {
                            gitUtils.deleteDeployKey(
                                env.TEST_DEPLOY_KEY_RW_ID,
                                [ repoUrl: params.REPO_URL ]
                            )
                            echo "âœ… æ›¸ãè¾¼ã¿å¯èƒ½Deploy Keyå‰Šé™¤å®Œäº†: ID=${env.TEST_DEPLOY_KEY_RW_ID}"
                        } catch (Exception e) {
                            echo "âš ï¸ æ›¸ãè¾¼ã¿å¯èƒ½Deploy Keyå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}"
                        }
                    }
                    
                    // ä¸€æ‹¬ä½œæˆã—ãŸDeploy Keyã®å‰Šé™¤
                    if (env.BATCH_DEPLOY_KEY_IDS) {
                        def deletedCount = 0
                        env.BATCH_DEPLOY_KEY_IDS.split(',').each { keyId ->
                            try {
                                gitUtils.deleteDeployKey(
                                    keyId.trim(),
                                    [ repoUrl: params.REPO_URL ]
                                )
                                deletedCount++
                                echo "âœ… ãƒãƒƒãƒDeploy Keyå‰Šé™¤å®Œäº†: ID=${keyId}"
                            } catch (Exception e) {
                                echo "âš ï¸ ãƒãƒƒãƒDeploy Keyå‰Šé™¤ã‚¨ãƒ©ãƒ¼ (ID=${keyId}): ${e.message}"
                            }
                        }
                        echo "ãƒãƒƒãƒDeploy Keyå‰Šé™¤çµæœ: ${deletedCount}/${env.BATCH_DEPLOY_KEY_IDS.split(',').size()}"
                    }
                    
                    echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº† ==="
                } else if (!params.CLEANUP_AFTER_TEST && !params.DRY_RUN && params.TEST_TYPE != 'LIST_ONLY') {
                    echo "=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ ==="
                    if (env.TEST_DEPLOY_KEY_ID) {
                        echo "âš ï¸ æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªDeploy Key ID: ${env.TEST_DEPLOY_KEY_ID}"
                    }
                    if (env.TEST_DEPLOY_KEY_RW_ID) {
                        echo "âš ï¸ æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªDeploy Key ID (RW): ${env.TEST_DEPLOY_KEY_RW_ID}"
                    }
                    if (env.BATCH_DEPLOY_KEY_IDS) {
                        echo "âš ï¸ æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªãƒãƒƒãƒDeploy Key IDs: ${env.BATCH_DEPLOY_KEY_IDS}"
                    }
                }
            }
        }
        
        success {
            echo "ğŸ‰ Deploy Keyãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        }
        
        failure {
            echo "âŒ Deploy Keyãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        }
    }
}