// ========================
// 関数定義
// ========================

/**
 * パラメータの検証
 */
def validateParameters() {
    if (!params.CONFIRM_SHUTDOWN && !params.DRY_RUN) {
        error("環境停止の確認が必要です。CONFIRM_SHUTDOWNパラメータをチェックしてください。")
    }
    
    echo "=== 環境停止ジョブ開始 ==="
    echo "対象環境: ${params.ENVIRONMENT}"
    echo "リージョン: ${params.AWS_REGION}"
    echo "停止モード: ${params.SHUTDOWN_MODE}"
    echo "待機タイムアウト: ${params.WAIT_TIMEOUT_MINUTES}分"
    echo "ドライラン: ${params.DRY_RUN}"
}

/**
 * SSMパラメータからリソースIDを取得
 */
def getResourceIdFromSSM(paramName, resourceType) {
    try {
        def resourceId = sh(
            script: """
                aws ssm get-parameter \
                    --name "${paramName}" \
                    --region ${AWS_REGION} \
                    --query 'Parameter.Value' \
                    --output text 2>/dev/null || echo ""
            """.stripIndent(),
            returnStdout: true
        ).trim()
        
        if (resourceId) {
            echo "${resourceType} ID取得成功: ${resourceId}"
        }
        return resourceId
    } catch (Exception e) {
        echo "${resourceType} IDの取得をスキップ: ${e.message}"
        return ""
    }
}

/**
 * 全リソースIDを取得
 */
def getAllResourceIds() {
    env.CONTROLLER_INSTANCE_ID = getResourceIdFromSSM(CONTROLLER_INSTANCE_ID_PARAM, "Controller Instance")
    env.NAT_INSTANCE_ID = getResourceIdFromSSM(NAT_INSTANCE_ID_PARAM, "NAT Instance")
    env.SPOTFLEET_REQUEST_ID = getResourceIdFromSSM(SPOTFLEET_REQUEST_ID_PARAM, "SpotFleet Request")
    
    echo """
        |停止対象リソース:
        |- Controller Instance: ${env.CONTROLLER_INSTANCE_ID ?: 'Not found'}
        |- NAT Instance: ${env.NAT_INSTANCE_ID ?: 'Not found'}
        |- SpotFleet Request: ${env.SPOTFLEET_REQUEST_ID ?: 'Not found'}
    """.stripMargin()
}

/**
 * SpotFleetの現在のキャパシティを取得
 */
def getSpotFleetCapacity(spotFleetRequestId) {
    return sh(
        script: """
            aws ec2 describe-spot-fleet-requests \
                --spot-fleet-request-ids ${spotFleetRequestId} \
                --region ${AWS_REGION} \
                --query 'SpotFleetRequestConfigs[0].SpotFleetRequestConfig.TargetCapacity' \
                --output text 2>/dev/null || echo "0"
        """.stripIndent(),
        returnStdout: true
    ).trim()
}

/**
 * SpotFleetのキャパシティを0に設定
 */
def scaleDownSpotFleet(spotFleetRequestId) {
    sh """
        aws ec2 modify-spot-fleet-request \
            --spot-fleet-request-id ${spotFleetRequestId} \
            --target-capacity 0 \
            --region ${AWS_REGION}
    """.stripIndent()
    echo "SpotFleetのキャパシティを0に設定しました"
}

/**
 * SpotFleetのインスタンスが全て終了するまで待機
 */
def waitForSpotFleetTermination(spotFleetRequestId, timeoutMinutes) {
    echo "SpotFleetインスタンスの終了を待機中..."

    timeout(time: timeoutMinutes, unit: 'MINUTES') {
        waitUntil {
            def runningInstances = sh(
                script: """
                    aws ec2 describe-spot-fleet-instances \
                        --spot-fleet-request-id ${spotFleetRequestId} \
                        --region ${AWS_REGION} \
                        --query 'ActiveInstances[*].InstanceId' \
                        --output json 2>/dev/null || echo "[]"
                """.stripIndent(),
                returnStdout: true
            ).trim()

            def instances = readJSON(text: runningInstances)
            echo "残りのエージェントインスタンス数: ${instances.size()}"

            // 15秒待機してリトライ
            if (instances.size() > 0) {
                sleep(time: 15, unit: 'SECONDS')
            }
            return instances.size() == 0
        }
    }
    echo "全エージェントが終了しました"
}

/**
 * Jenkins QuietDownモードを設定
 *
 * QuietDownモードを有効にすると、新規ジョブのキューが停止され、
 * 既存のジョブのみが完了するまで実行される。
 *
 * @param enable true: QuietDownを有効化、false: QuietDownをキャンセル
 */
def setJenkinsQuietMode(boolean enable) {
    if (params.DRY_RUN) {
        echo "DRY_RUN: Jenkins QuietDownモードを${enable ? '有効化' : 'キャンセル'}します（スキップ）"
        return
    }

    try {
        if (enable) {
            // QuietDownモードを有効化
            Jenkins.instance.doQuietDown()
            echo "✓ Jenkins QuietDownモードを有効化しました"
            echo "  新規ジョブのキューは停止されました"
        } else {
            // QuietDownモードをキャンセル
            Jenkins.instance.doCancelQuietDown()
            echo "✓ Jenkins QuietDownモードをキャンセルしました"
        }
    } catch (Exception e) {
        // エラーハンドリング
        def errorMsg = "Jenkins QuietDownモードの${enable ? '有効化' : 'キャンセル'}に失敗: ${e.message}"
        echo "警告: ${errorMsg}"

        // Script Security承認が必要な場合のヘルプメッセージ
        if (e.message?.contains("RejectedAccessException")) {
            echo """
            |
            |Script Security承認が必要な可能性があります:
            |1. Jenkins管理 > In-process Script Approval を確認
            |2. 以下のメソッドを承認:
            |   - method jenkins.model.Jenkins doQuietDown
            |   - method jenkins.model.Jenkins doCancelQuietDown
            |""".stripMargin()
        }

        // gracefulモードでは処理を継続（エラーにしない）
        echo "処理を続行します"
    }
}

/**
 * エージェント上で実行中のExecutor数を取得
 *
 * built-in（Jenkins Controller）を除く全エージェントのExecutorを監視し、
 * 実行中（busy）のExecutor数をカウントする。
 *
 * @return 実行中のExecutor数（整数）
 */
def getRunningAgentExecutors() {
    try {
        def busyExecutors = 0

        // 全コンピュータ（ノード）を取得
        def computers = Jenkins.instance.computers

        computers.each { computer ->
            def nodeName = computer.name

            // built-inエージェント（Controller）を除外
            if (nodeName == "" || nodeName == "built-in") {
                return  // continueと同義
            }

            // オフラインノードをスキップ
            if (computer.isOffline()) {
                return
            }

            // Executorの状態をチェック
            def executors = computer.getExecutors()
            executors.each { executor ->
                if (executor.isBusy()) {
                    busyExecutors++

                    // 実行中のジョブ情報をログ出力
                    def currentExecutable = executor.getCurrentExecutable()
                    if (currentExecutable) {
                        def jobName = currentExecutable.toString()
                        echo "  実行中ジョブ: ${jobName} (ノード: ${nodeName})"
                    }
                }
            }
        }

        return busyExecutors
    } catch (Exception e) {
        echo "エージェントExecutor監視でエラー: ${e.message}"

        // Script Security承認が必要な場合のヘルプメッセージ
        if (e.message?.contains("RejectedAccessException")) {
            echo """
            |
            |Script Security承認が必要な可能性があります:
            |1. Jenkins管理 > In-process Script Approval を確認
            |2. 以下のメソッドを承認:
            |   - staticMethod jenkins.model.Jenkins getInstance
            |   - method jenkins.model.Jenkins getComputers
            |   - method hudson.model.Computer getName
            |   - method hudson.model.Computer isOffline
            |   - method hudson.model.Computer getExecutors
            |   - method hudson.model.Executor isBusy
            |   - method hudson.model.Executor getCurrentExecutable
            |""".stripMargin()
        }

        // エラー時は0を返す（安全側に倒す）
        return 0
    }
}

/**
 * エージェントジョブの完了を待機
 *
 * 15秒間隔でエージェント実行中ジョブ数をポーリングし、
 * 全ジョブが完了（ゼロ）になるまで待機する。
 * タイムアウトに達した場合は警告ログを出力して処理を続行（エラーにしない）。
 *
 * @param timeoutMinutes タイムアウト時間（分）
 */
def waitForAgentJobsCompletion(timeoutMinutes) {
    echo "=== エージェントジョブの完了を待機 ==="
    echo "タイムアウト: ${timeoutMinutes}分"

    def startTime = System.currentTimeMillis()

    try {
        timeout(time: timeoutMinutes, unit: 'MINUTES') {
            waitUntil {
                def runningCount = getRunningAgentExecutors()
                echo "残りのエージェント実行中ジョブ: ${runningCount}"

                if (runningCount == 0) {
                    echo "✓ 全エージェントジョブが完了しました"
                    return true
                }

                // 経過時間を表示
                def elapsedMinutes = (System.currentTimeMillis() - startTime) / 60000
                echo "経過時間: ${elapsedMinutes.round(1)}分"

                // 15秒待機してリトライ
                sleep(time: 15, unit: 'SECONDS')
                return false
            }
        }
    } catch (org.jenkinsci.plugins.workflow.steps.FlowInterruptedException e) {
        // タイムアウト例外のハンドリング
        if (e.message?.contains("Timeout")) {
            echo """
            |
            |警告: エージェントジョブのタイムアウト（${timeoutMinutes}分）に達しました
            |
            |SpotFleetのスケールダウンを続行します。
            |実行中のジョブは強制終了される可能性があります。
            |""".stripMargin()

            // 現在の実行中ジョブ数を最終確認
            def finalCount = getRunningAgentExecutors()
            echo "タイムアウト時の実行中ジョブ数: ${finalCount}"
        } else {
            // その他の中断（ユーザーによる手動中断など）
            echo "警告: ジョブ待機が中断されました: ${e.message}"
        }

        // タイムアウト時でもジョブは成功扱い（エラーにしない）
        echo "処理を続行します"
    } catch (Exception e) {
        echo "エージェントジョブ待機でエラー: ${e.message}"
        echo "処理を続行します"
    }
}

/**
 * EC2 Fleetをスケールダウン
 */
def scaleDownEC2Fleet() {
    if (!env.SPOTFLEET_REQUEST_ID || params.DRY_RUN) {
        return
    }

    echo "=== EC2 Fleet (SpotFleet) のスケールダウン ==="

    try {
        def currentCapacity = getSpotFleetCapacity(env.SPOTFLEET_REQUEST_ID)
        echo "現在のキャパシティ: ${currentCapacity}"

        if (currentCapacity != "0") {
            // gracefulモードの場合
            if (params.SHUTDOWN_MODE == 'graceful') {
                echo "--- Gracefulモードでスケールダウン ---"

                // ステップ1: QuietDown設定
                echo "ステップ1: Jenkins QuietDownモードを有効化"
                setJenkinsQuietMode(true)

                // ステップ2: エージェントジョブ完了待機
                echo "ステップ2: エージェントジョブの完了を待機"
                waitForAgentJobsCompletion(params.WAIT_TIMEOUT_MINUTES.toInteger())

                // ステップ3: SpotFleetスケールダウン
                echo "ステップ3: SpotFleetのキャパシティを0に設定"
                scaleDownSpotFleet(env.SPOTFLEET_REQUEST_ID)

                // ステップ4: インスタンス終了待機
                echo "ステップ4: インスタンスの終了を待機"
                waitForSpotFleetTermination(env.SPOTFLEET_REQUEST_ID, params.WAIT_TIMEOUT_MINUTES.toInteger())

                // ステップ5: QuietDownキャンセル（念のため）
                echo "ステップ5: Jenkins QuietDownモードをキャンセル"
                setJenkinsQuietMode(false)

            } else {
                // immediateモードの場合（既存の動作）
                echo "--- Immediateモードでスケールダウン ---"
                scaleDownSpotFleet(env.SPOTFLEET_REQUEST_ID)

                // インスタンス終了待機はスキップ
                echo "Immediateモードのため、インスタンス終了待機をスキップします"
            }
        } else {
            echo "SpotFleetのキャパシティは既に0です"
        }
    } catch (Exception e) {
        echo "SpotFleetのスケールダウンでエラー: ${e.message}"

        // gracefulモードでのエラーの場合、QuietDownをキャンセル（念のため）
        if (params.SHUTDOWN_MODE == 'graceful') {
            echo "エラー発生のため、QuietDownモードをキャンセルします"
            setJenkinsQuietMode(false)
        }

        // immediateモードではエラーを再スロー（既存の動作）
        if (params.SHUTDOWN_MODE == 'immediate') {
            error("SpotFleetのスケールダウンに失敗しました")
        } else {
            // gracefulモードでは警告ログを出力して続行
            echo "警告: SpotFleetのスケールダウンでエラーが発生しましたが、処理を続行します"
        }
    }
}

/**
 * インスタンスの状態を取得
 */
def getInstanceState(instanceId) {
    return sh(
        script: """
            aws ec2 describe-instances \
                --instance-ids ${instanceId} \
                --region ${AWS_REGION} \
                --query 'Reservations[0].Instances[0].State.Name' \
                --output text 2>/dev/null || echo "unknown"
        """.stripIndent(),
        returnStdout: true
    ).trim()
}

/**
 * 実行中のインスタンスIDリストを作成
 */
def getRunningInstances() {
    def instancesToStop = []
    
    if (env.NAT_INSTANCE_ID) {
        def natState = getInstanceState(env.NAT_INSTANCE_ID)
        echo "NAT インスタンスの現在の状態: ${natState}"
        if (natState == 'running') {
            instancesToStop.add(env.NAT_INSTANCE_ID)
        }
    }
    
    if (env.CONTROLLER_INSTANCE_ID) {
        def controllerState = getInstanceState(env.CONTROLLER_INSTANCE_ID)
        echo "Controller インスタンスの現在の状態: ${controllerState}"
        if (controllerState == 'running') {
            instancesToStop.add(env.CONTROLLER_INSTANCE_ID)
        }
    }
    
    return instancesToStop
}

/**
 * NATとControllerインスタンスを停止
 */
def stopNATAndControllerInstances() {
    if (!env.NAT_INSTANCE_ID && !env.CONTROLLER_INSTANCE_ID || params.DRY_RUN) {
        return
    }
    
    echo "=== NAT と Controller インスタンスの同時停止 ==="
    
    try {
        def instancesToStop = getRunningInstances()
        
        if (instancesToStop.size() > 0) {
            def instanceIds = instancesToStop.join(' ')
            echo "停止対象インスタンス: ${instanceIds}"
            
            sh """
                aws ec2 stop-instances \
                    --instance-ids ${instanceIds} \
                    --region ${AWS_REGION}
            """.stripIndent()
            echo "インスタンス停止コマンドを送信しました"
            
            echo """
                |===================================
                |インスタンスの停止コマンドを送信しました：
                |- NAT Instance: ${env.NAT_INSTANCE_ID ?: 'N/A'}
                |- Controller Instance: ${env.CONTROLLER_INSTANCE_ID ?: 'N/A'}
                |
                |注意: まもなくJenkinsへのアクセスが失われます。
                |===================================
            """.stripMargin()
        } else {
            echo "停止対象のインスタンスが見つかりません"
        }
    } catch (Exception e) {
        echo "インスタンスの停止スケジュールでエラー: ${e.message}"
        // 自身の停止なので、エラーでもジョブは成功とする
    }
}

/**
 * 実行サマリーを表示
 */
def showExecutionSummary() {
    echo """
        |===================================
        |環境停止ジョブが完了しました
        |===================================
        |
        |実行された操作:
        |1. EC2 Fleet (SpotFleet): ${env.SPOTFLEET_REQUEST_ID ? 'キャパシティを0に設定' : 'スキップ（ID未検出）'}
        |2. NAT & Controller インスタンス: ${(env.NAT_INSTANCE_ID || env.CONTROLLER_INSTANCE_ID) ? '停止コマンド送信' : 'スキップ（ID未検出）'}
        |
        |注意: Controllerの停止により、このJenkinsへのアクセスは間もなく失われます。
        |環境を再開するには、AWSコンソールからインスタンスを起動してください。
    """.stripMargin()
}

/**
 * ドライラン結果を表示
 */
def showDryRunSummary() {
    echo """
        |===================================
        |ドライラン実行結果
        |===================================
        |
        |以下のリソースが停止対象として検出されました:
        |
        |1. EC2 Fleet (SpotFleet)
        |   - Request ID: ${env.SPOTFLEET_REQUEST_ID ?: 'Not found'}
        |   
        |2. NAT インスタンス
        |   - Instance ID: ${env.NAT_INSTANCE_ID ?: 'Not found'}
        |   
        |3. Controller インスタンス
        |   - Instance ID: ${env.CONTROLLER_INSTANCE_ID ?: 'Not found'}
        |
        |実際の停止を行うには、DRY_RUNをfalseに設定して再実行してください。
    """.stripMargin()
}

// ========================
// パイプライン定義
// ========================

pipeline {
    agent {
        label 'built-in'
    }

    environment {
        // AWS認証情報
        AWS_REGION = "${params.AWS_REGION}"
        
        // 環境名（dev/staging/prod）
        ENVIRONMENT = "${params.ENVIRONMENT}"
        
        // SSMパラメータ名
        CONTROLLER_INSTANCE_ID_PARAM = "/jenkins-infra/${ENVIRONMENT}/controller/instance-id"
        NAT_INSTANCE_ID_PARAM = "/jenkins-infra/${ENVIRONMENT}/nat/instance-id"
        SPOTFLEET_REQUEST_ID_PARAM = "/jenkins-infra/${ENVIRONMENT}/agent/spotFleetRequestId"
        
        // タグフィルター
        PROJECT_NAME = 'jenkins-infra'
    }

    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    validateParameters()
                }
            }
        }

        stage('Get Resource IDs') {
            steps {
                script {
                    echo "=== リソースIDの取得 ==="
                    getAllResourceIds()
                }
            }
        }

        stage('Scale Down EC2 Fleet') {
            when {
                expression { 
                    return env.SPOTFLEET_REQUEST_ID && !params.DRY_RUN 
                }
            }
            steps {
                script {
                    scaleDownEC2Fleet()
                }
            }
        }

        stage('Stop NAT and Controller Instances') {
            when {
                expression { 
                    return (env.NAT_INSTANCE_ID || env.CONTROLLER_INSTANCE_ID) && !params.DRY_RUN 
                }
            }
            steps {
                script {
                    stopNATAndControllerInstances()
                }
            }
        }

        stage('Summary') {
            when {
                expression { return !params.DRY_RUN }
            }
            steps {
                script {
                    showExecutionSummary()
                }
            }
        }

        stage('Dry Run Summary') {
            when {
                expression { return params.DRY_RUN }
            }
            steps {
                script {
                    showDryRunSummary()
                }
            }
        }
    }

    post {
        success {
            echo "環境停止ジョブが正常に完了しました"
        }
        failure {
            echo "環境停止ジョブが失敗しました"
        }
        always {
            // クリーンアップ（Controllerが停止する前に実行）
            cleanWs()
        }
    }
}