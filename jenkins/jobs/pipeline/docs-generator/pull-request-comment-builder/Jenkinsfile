@Library('jenkins-shared-lib') _

/**
 * GitHub PRã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
 * OpenAI APIã‚’ä½¿ç”¨ã—ã¦PRã®å†…å®¹ã‚’åˆ†æã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆãƒ»æŠ•ç¨¿ã—ã¾ã™
 */
pipeline {
    agent {
        docker {
            label 'ec2-fleet'
            image 'python:3.11-slim'
            args '-v ${WORKSPACE}:/workspace -w /workspace -u root'
        }
    }
    
    environment {
        // OpenAI APIè¨­å®š
        OPENAI_API_KEY = credentials('openai-api-key')
        OPENAI_MODEL = "gpt-4.1"
        
        // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆWORKSPACEã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ï¼‰
        WORKSPACE_DIR = "pr-workspace"
        DIFF_DIR = "diff-files"
        ANALYSIS_DIR = "analysis-results"
        PROJECT_HOME_DIR = "project-repo"
        
        // ãƒ„ãƒ¼ãƒ«ã®ãƒ‘ã‚¹
        PROJECT_BASE_DIR = "${PROJECT_HOME_DIR}/jenkins/jobs/pipeline/docs-generator/pull-request-comment-builder"
        PYTHON_PROJECT_DIR = "${PROJECT_BASE_DIR}/src"
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        TIME_STAMP = sh(script: 'TZ="Asia/Tokyo" date "+%Y/%m/%d %H:%M:%S"', returnStdout: true).trim()
    }
    
    stages {
        stage('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼') {
            steps {
                script {
                    // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã®è¨­å®š
                    def (repoOwner, repoName) =  gitUtils.extractRepoInfo(params.REPO_URL)
                    env.REPO_OWNER = repoOwner
                    env.REPO_NAME  = repoName 
                    
                    if (!env.REPO_OWNER?.trim() || !env.REPO_NAME?.trim()) {
                        error "ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"
                    }
                    
                    // PRç•ªå·ã®æ¤œè¨¼ã¨è¨­å®š
                    def prNumber = env.CHANGE_ID?.trim() ?: params.PR_NUMBER?.trim()
                    
                    if (!prNumber) {
                        error "PRç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
                    }
                    
                    try {
                        // Latestã®å ´åˆã¯æœ€æ–°ã®PRã‚’å–å¾—
                        if (prNumber.equalsIgnoreCase('Latest')) {
                            try {
                                def latestPR = gitUtils.getLatestPullRequest([
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME,
                                    state: 'open'
                                ])
                                
                                if (!latestPR) {
                                    error "ã‚ªãƒ¼ãƒ—ãƒ³ãªPRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
                                }
                                
                                prNumber = latestPR.number.toString()
                                echo "æœ€æ–°ã®PR #${prNumber} (${latestPR.title}) ã‚’å‡¦ç†å¯¾è±¡ã¨ã—ã¾ã™ã€‚"
                                
                            } catch (Exception e) {
                                error "æœ€æ–°ã®PRæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                            }
                        }
                        
                        env.PR_NUMBER = prNumber
                        Integer.parseInt(prNumber)
                    } catch (NumberFormatException e) {
                        error "PRç•ªå·ã¯æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: ${prNumber}"
                    }
                }
            }
        }

        stage('ç’°å¢ƒæº–å‚™') {
            steps {
                script {
                    // å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                    sh """
                        apt-get update -qq && apt-get install -qq -y git curl jq
                    """
                    
                    // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
                    sh """
                        mkdir -p ${WORKSPACE_DIR}
                        mkdir -p ${DIFF_DIR}
                        mkdir -p ${ANALYSIS_DIR}
                    """
                    
                    // ãƒ„ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                    dir(PROJECT_HOME_DIR) {
                        gitUtils.checkoutRepository(
                            env.GIT_INFRASTRUCTURE_REPO_URL,
                            env.GIT_INFRASTRUCTURE_REPO_BRANCH,
                            env.GITHUB_APP_CREDENTIALS_ID
                        )
                    }
                    
                    // Pythonã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                    sh """
                        python -m pip install --upgrade pip
                        cd ${PYTHON_PROJECT_DIR}
                        pip install -r requirements.txt --no-cache-dir
                    """
                }
            }
        }
        
        stage('æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®ç¢ºèª') {
            steps {
                script {
                    // ã“ã®ãƒ•ãƒ©ã‚°ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚¹ã‚­ãƒƒãƒ—ã‚’åˆ¶å¾¡
                    env.SKIP_ANALYSIS = 'false'
                    
                    try {
                                                    // PRä¸Šã®å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
                            def existingComments = gitUtils.getPullRequestComments(
                                env.PR_NUMBER as Integer,
                                [
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME
                                ]
                            )                        
                            
                            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
                            echo "æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®æ•°: ${existingComments?.size() ?: 0}"
                            
                            // è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™ï¼ˆæœ€æ–°ã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
                            def autoGenComment = existingComments?.findAll { existingComment ->
                                existingComment.body?.contains('<!-- auto-generated-comment')
                            }?.sort { it.created_at }?.reverse()?.find()

                            if (autoGenComment && !params.FORCE_ANALYSIS) {
                                echo "æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆã‚³ãƒ¡ãƒ³ãƒˆID: ${autoGenComment.id}ï¼‰"
                                echo "FORCE_ANALYSISãŒfalseã®ãŸã‚ã€ä»¥é™ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
                                
                                // ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                                env.SKIP_ANALYSIS = 'true'
                                
                                // ã‚³ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’ä¿å­˜ï¼ˆå¾Œç¶šã‚¹ãƒ†ãƒ¼ã‚¸ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
                                env.EXISTING_COMMENT_ID = autoGenComment.id.toString()
                            } else if (autoGenComment && params.FORCE_ANALYSIS) {
                                echo "æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€FORCE_ANALYSISãŒtrueã®ãŸã‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™"
                                env.EXISTING_COMMENT_ID = autoGenComment.id.toString()
                            } else {
                                echo "æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™"
                            }
                            
                            echo "ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã®çŠ¶æ…‹: SKIP_ANALYSIS=${env.SKIP_ANALYSIS}"
                    } catch (Exception e) {
                        echo "æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}"
                        echo "å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™"
                    }
                }
            }
        }
        
        stage('PRæƒ…å ±ã¨å·®åˆ†ã®å–å¾—') {
            when {
                expression { 
                    echo "ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã®çŠ¶æ…‹ï¼ˆPRæƒ…å ±å–å¾—ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰: SKIP_ANALYSIS=${env.SKIP_ANALYSIS}"
                    return env.SKIP_ANALYSIS == 'false'
                }
            }
            steps {
                script {
                    try {
                        sh "mkdir -p ${DIFF_DIR} ${ANALYSIS_DIR}"
                            
                            def prInfo = gitUtils.getPullRequestInfo(
                                env.PR_NUMBER as Integer,
                                [
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME
                                ]
                            )
                            
                            def prDiff = gitUtils.getPullRequestDiff(
                                env.PR_NUMBER as Integer,
                                [
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME
                                ]
                            )
                            
                            // å˜ç´”ã«ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã§æ›¸ãè¾¼ã¿
                            writeJSON(file: "pr_diff.json", json: prDiff, pretty: 4)
                            writeJSON(file: "pr_info.json", json: prInfo, pretty: 4)
                            
                            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£ã—ã„å ´æ‰€ã«ç§»å‹•
                            sh """
                                mv pr_diff.json ${DIFF_DIR}/
                                mv pr_info.json ${DIFF_DIR}/
                            """
                    } catch (Exception e) {
                        error "PRæƒ…å ±ãƒ»å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                    }
                }
            }
        }
        
        stage('OpenAIã«ã‚ˆã‚‹åˆ†æ') {
            when {
                expression { 
                    // æ–‡å­—åˆ—æ¯”è¼ƒã¯ '==' ã‚’ä½¿ç”¨
                    echo "ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã®çŠ¶æ…‹ï¼ˆåˆ†æã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰: SKIP_ANALYSIS=${env.SKIP_ANALYSIS}"
                    return env.SKIP_ANALYSIS == 'false'
                }
            }
            steps {
                script {
                    try {
                        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
                        sh "mkdir -p ${WORKSPACE}/prompts"
                        
                        withCredentials([
                            usernamePassword(credentialsId: env.GITHUB_APP_CREDENTIALS_ID , 
                                            usernameVariable: 'GITHUB_APP_ID',
                                            passwordVariable: 'GITHUB_ACCESS_TOKEN'),
                            string(credentialsId: 'openai-api-key', 
                                variable: 'OPENAI_API_KEY')
                        ]) {
                            // ä¿å­˜ãƒ•ãƒ©ã‚°ã‚’æ˜ç¤ºçš„ã«ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
                            withEnv(['SAVE_PROMPTS=true', 'GITHUB_AUTH_METHOD=app']) {
                                sh """
                                    cd ${PYTHON_PROJECT_DIR}
                                    python pr_comment_generator.py \
                                        --pr-diff ${WORKSPACE}/${DIFF_DIR}/pr_diff.json \
                                        --pr-info ${WORKSPACE}/${DIFF_DIR}/pr_info.json \
                                        --output ${WORKSPACE}/${ANALYSIS_DIR}/analysis_result.json \
                                        --save-prompts \
                                        --prompt-output-dir ${WORKSPACE}/prompts
                                """
                            }
                        }
                        
                        echo "OpenAIã«ã‚ˆã‚‹åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨çµæœã¯ 'prompts' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚"
                    } catch (Exception e) {
                        error "OpenAIã«ã‚ˆã‚‹åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                    }
                }
            }
        }
        
        stage('PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°') {
            when {
                expression {
                    echo "ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã®çŠ¶æ…‹ï¼ˆæ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰: SKIP_ANALYSIS=${env.SKIP_ANALYSIS}" 
                    return env.SKIP_ANALYSIS == 'false'
                }
            }
            steps {
                script {
                    try {
                        // åˆ†æçµæœã®èª­ã¿è¾¼ã¿
                        def analysisResult = readJSON file: "${ANALYSIS_DIR}/analysis_result.json"
                        def comment = analysisResult.comment
                        def suggestedTitle = analysisResult.suggested_title

                        // è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ã®ä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å«ã‚€ï¼‰
                        def autoGenTag = """
                            <!-- auto-generated-comment
                            timestamp: ${env.TIME_STAMP}
                            jenkins-job: ${env.JOB_NAME}
                            build-number: ${env.BUILD_NUMBER}
                            -->
                            
                        """.stripIndent()
                            
                            // ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°ã¨ã‚³ãƒ¡ãƒ³ãƒˆã®æº–å‚™
                            if (params.UPDATE_TITLE) {
                                // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã™ã‚‹å ´åˆ
                                if (suggestedTitle?.trim()) {
                                    gitUtils.updatePullRequestTitle(
                                        env.PR_NUMBER as Integer,
                                        suggestedTitle,
                                        [
                                            repoOwner: env.REPO_OWNER,
                                            repoName: env.REPO_NAME
                                        ]
                                    )
                                }
                            } else {
                                // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ã—ãªã„å ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆå†…ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç½®æ›
                                if (suggestedTitle?.trim()) {
                                    comment = comment.replaceFirst(
                                        "# å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼(\\r?\\n|\\r)",
                                        "# å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼: ${suggestedTitle}\$1"
                                    )
                                }
                            }

                            // è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã®å…ˆé ­ã«è¿½åŠ 
                            comment = autoGenTag + comment

                            // æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
                            if (env.EXISTING_COMMENT_ID) {
                                try {
                                    echo "è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã‚’é–‹å§‹: ã‚³ãƒ¡ãƒ³ãƒˆID ${env.EXISTING_COMMENT_ID}"
                                    gitUtils.updatePullRequestComment(
                                        env.EXISTING_COMMENT_ID,
                                        comment,
                                        [
                                            repoOwner: env.REPO_OWNER,
                                            repoName: env.REPO_NAME
                                        ]
                                    )
                                    echo "æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ: ã‚³ãƒ¡ãƒ³ãƒˆID ${env.EXISTING_COMMENT_ID}"
                                } catch (Exception e) {
                                    error "ã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                                }
                            } else {
                                echo "æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã®ä½œæˆã‚’é–‹å§‹"
                                gitUtils.createPullRequestComment(
                                    env.PR_NUMBER as Integer,
                                    comment,
                                    [
                                        repoOwner: env.REPO_OWNER,
                                        repoName: env.REPO_NAME
                                    ]
                                )
                                echo "æ–°è¦PRã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ"
                        }
                    } catch (Exception e) {
                        error "PRã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                    }
                }
            }
        }
        
        stage('Jenkinså†å®Ÿè¡Œãƒªãƒ³ã‚¯ã®æŠ•ç¨¿') {
            steps {
                script {
                    try {
                        def rebuildUrl = "${env.BUILD_URL}rebuild/parameterized"
                        def buildUrl = env.BUILD_URL
                        
                        def rerunTag = """
                            <!-- jenkins-pr-comment-builder-rerun-link
                            timestamp: ${env.TIME_STAMP}
                            jenkins-job: ${env.JOB_NAME}
                            -->
                        """.stripIndent()
                        
                        def rerunComment = rerunTag + """
                            ## ğŸ”„ Jenkins ã‚¸ãƒ§ãƒ–å†å®Ÿè¡Œ
                            
                            ã“ã®PRã®åˆ†æã‚’å†å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
                            
                            ğŸš€ **[åˆ†æã‚’å†å®Ÿè¡Œã™ã‚‹](${rebuildUrl})**
                            
                            å¿…è¦ã«å¿œã˜ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã§ãã¾ã™ï¼š
                            - `FORCE_ANALYSIS`: æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã£ã¦ã‚‚å†åˆ†æã‚’å¼·åˆ¶å®Ÿè¡Œ
                            - `UPDATE_TITLE`: PRã‚¿ã‚¤ãƒˆãƒ«ã®è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹åŒ–
                            
                            ğŸ“Š [ãƒ“ãƒ«ãƒ‰ã®è©³ç´°ã‚’ç¢ºèª](${buildUrl})
                            
                            > **æ³¨æ„**: ãƒ“ãƒ«ãƒ‰å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã‚‹ã¨ã€å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚
                        """.stripIndent()
                        
                        def existingComments = gitUtils.getPullRequestComments(
                            env.PR_NUMBER as Integer,
                            [
                                repoOwner: env.REPO_OWNER,
                                repoName: env.REPO_NAME
                            ]
                        )
                        
                        def rerunLinkComment = existingComments?.find { comment ->
                            comment.body?.contains('<!-- jenkins-pr-comment-builder-rerun-link')
                        }
                        
                        if (rerunLinkComment) {
                            echo "æ—¢å­˜ã®å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã™: ã‚³ãƒ¡ãƒ³ãƒˆID ${rerunLinkComment.id}"
                            gitUtils.updatePullRequestComment(
                                rerunLinkComment.id.toString(),
                                rerunComment,
                                [
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME
                                ]
                            )
                            echo "å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ"
                        } else {
                            echo "æ–°è¦å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™"
                            gitUtils.createPullRequestComment(
                                env.PR_NUMBER as Integer,
                                rerunComment,
                                [
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME
                                ]
                            )
                            echo "å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ"
                        }
                    } catch (Exception e) {
                        echo "å†å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                        echo "ã“ã®å‡¦ç†ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªãŸã‚ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç¶™ç¶šã—ã¾ã™"
                    }
                }
            }
        }
    }
    
    post {
        always {
            // åˆ†æçµæœã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æˆæœç‰©ã¨ã—ã¦ä¿å­˜
            archiveArtifacts artifacts: """
                ${DIFF_DIR}/*.json,
                ${ANALYSIS_DIR}/*.json,
                prompts/**/*
            """, allowEmptyArchive: true
            
            // å®Ÿè¡Œçµæœã®ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            script {
                if (env.SKIP_ANALYSIS == 'true') {
                    echo """
                        =============================================
                        PRåˆ†æçµæœã‚µãƒãƒªãƒ¼
                        =============================================
                        PRç•ªå·: ${env.PR_NUMBER}
                        å‡¦ç†çµæœ: æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ
                        â€»å†åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ FORCE_ANALYSIS ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„
                        =============================================
                    """.stripIndent()
                } else {
                    try {
                        def analysisResult = readJSON file: "${ANALYSIS_DIR}/analysis_result.json"
                        if (analysisResult.usage) {
                            echo """
                                =============================================
                                PRåˆ†æçµæœã‚µãƒãƒªãƒ¼
                                =============================================
                                PRç•ªå·: ${env.PR_NUMBER}
                                ã‚¿ã‚¤ãƒˆãƒ«: ${analysisResult.suggested_title ?: 'N/A'}
                                å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${analysisResult.processed_file_count ?: 'N/A'} / ${analysisResult.file_count ?: 'N/A'}
                                ã‚¹ã‚­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${analysisResult.skipped_file_count ?: '0'}
                                ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡: ${analysisResult.usage.total_tokens ?: 'N/A'}
                                å®Ÿè¡Œæ™‚é–“: ${analysisResult.execution_time_seconds ?: 'N/A'} ç§’
                                =============================================
                            """.stripIndent()
                        }
                    } catch (Exception e) {
                        echo "åˆ†æçµæœã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                    }
                }
            }
        }
        
        success {
            script {
                if (env.SKIP_ANALYSIS == 'true') {
                    echo "æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ­£å¸¸çµ‚äº†ã—ã¾ã—ãŸã€‚"
                } else {
                    echo "PRã‚³ãƒ¡ãƒ³ãƒˆç”ŸæˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
                }
            }
        }
        
        failure {
            echo "PRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        }
    }
}
