# データフロー図セクション更新 - 最終生成段階

これまでの計画と自己対話に基づいて、最終的な更新済みデータフロー図セクションを作成してください。

## データフロー図セクション更新の最重要要件

### 黄金律：「5秒ルール」
読者が5秒でシステムの本質を理解できるダイアグラムを作成する。

### 3つの基本原則

1. **簡潔性の確保**
   - 1つのダイアグラムの要素数：5-7個（最大9個）
   - メッセージ/遷移数：主要なもののみ（10-15個程度）
   - 説明文：各図1-2文のみ

2. **固有性の維持**
   - リポジトリ特有の処理を中心に構成
   - ドメイン固有の用語を適切に使用
   - 一般的な処理は最小限の表現

3. **階層的な情報提供**
   - メイン図：全体像（必須）
   - 詳細図：特に重要な部分のみ（オプション、最大2個）
   - 複雑な詳細は注釈で補足

## 使用可能なダイアグラムと制約

### 1. シーケンスダイアグラム
**用途**：主要な処理フローとコンポーネント間の相互作用

**厳守すべき制約**：
- 参加者数：5-7個（絶対最大9個）
- 1つの処理フローに焦点を絞る
- 類似サービスはグループ化（例：「External APIs」として統合）
- エラー処理は主要なもののみ

**簡略化テクニック**：
```mermaid
sequenceDiagram
    participant U as User
    participant S as System
    participant DB as Database
    participant E as External Services
    
    Note over U,E: 認証はOAuth2.0を使用
    
    U->>S: リクエスト
    S->>DB: データ取得
    S->>E: 外部API呼び出し（複数）
    E-->>S: 統合レスポンス
    S-->>U: 処理結果
```

### 2. 状態ダイアグラム
**用途**：重要なデータやプロセスの状態遷移

**厳守すべき制約**：
- 状態数：5-7個（主要な状態のみ）
- 遷移は本質的なもののみ表示
- 詳細な条件は省略または注釈化

**簡略化テクニック**：
```mermaid
stateDiagram-v2
    [*] --> 初期化
    初期化 --> 処理中: 開始
    処理中 --> 完了: 成功
    処理中 --> エラー: 失敗
    完了 --> [*]
    エラー --> [*]
    
    note right of 処理中: 複数の内部処理を含む
```

## 情報の優先順位付けガイドライン

### 必ず含めるべき情報（優先度：高）
1. リポジトリの核となる独自機能
2. 特徴的なデータフロー
3. 重要な外部連携
4. ビジネスクリティカルな処理

### 簡略化または省略すべき情報（優先度：低）
1. 標準的なCRUD操作の詳細
2. 一般的なエラーハンドリング
3. 内部的な補助処理
4. 設定やログ関連の処理

### グループ化の指針
- 同じ種類の外部サービス → 「External APIs」
- 類似のマイクロサービス → 「Internal Services」
- 複数のDBテーブル → 「Database」
- 各種ユーティリティ → 「Utilities」

## Mermaidダイアグラムの最適化チェックリスト

### 作成前の確認
- [ ] このダイアグラムは5秒で理解できるか？
- [ ] リポジトリの特徴が明確に表現されているか？
- [ ] 要素数は適切か（5-7個）？
- [ ] 不要な詳細は省略されているか？

### 作成後の確認
- [ ] ダイアグラムは視覚的にシンプルか？
- [ ] ドメイン固有の価値が伝わるか？
- [ ] 他の一般的なシステムと区別できるか？
- [ ] 技術者でない人でも大まかに理解できるか？

## 出力の構成

```markdown
# データフロー図

## 概要
[1-2文でシステムのデータフローの特徴を説明]

## メインフロー
[最も重要な処理フローを1つのシーケンスダイアグラムで表現]

```mermaid
sequenceDiagram
    [簡潔で理解しやすいメインフロー]
```

## [特徴的な機能名]（オプション）
[リポジトリ固有の重要な処理がある場合のみ追加]

```mermaid
[シーケンスまたは状態ダイアグラム]
```

### 補足情報
- [省略した詳細情報の簡潔な説明]
- [重要な技術的制約や前提条件]
```

## 最終確認事項

1. **全体の分量**：図表70%以上、説明文30%以下
2. **ダイアグラムの数**：最大3個（メイン1個＋詳細2個）
3. **各ダイアグラムの複雑さ**：スマートフォンでも判読可能
4. **リポジトリの独自性**：このリポジトリならではの価値が明確
