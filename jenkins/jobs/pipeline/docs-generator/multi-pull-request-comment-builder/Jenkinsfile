@Library("jenkins-shared-lib@${LIBRARY_BRANCH}") _

/**
 * ãƒãƒƒãƒPRå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
 * æŒ‡å®šã•ã‚ŒãŸPRç•ªå·ã®ç¯„å›²ã«å¯¾ã—ã¦ã€pull_request_comment_builderã‚’é€£ç¶šå®Ÿè¡Œã—ã¾ã™
 */
pipeline {
    agent {
        label 'ec2-fleet'
    }
    
    environment {
        // å‡¦ç†çŠ¶æ³è¿½è·¡ç”¨
        RESULTS_DIR = 'results'
        SUMMARY_FILE = "${RESULTS_DIR}/summary.json"
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        TIME_STAMP = sh(script: 'TZ="Asia/Tokyo" date "+%Y/%m/%d %H:%M:%S"', returnStdout: true).trim()
        START_TIME = System.currentTimeMillis()
    }
    
    stages {
        stage('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼') {
            steps {
                script {
                    // å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
                    if (!params.START_PR_NUMBER?.trim() || !params.END_PR_NUMBER?.trim()) {
                        error "é–‹å§‹PRã¨çµ‚äº†PRã®ä¸¡æ–¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
                    }
                    
                    // æ•°å€¤å¤‰æ›ã¨ç¯„å›²ãƒã‚§ãƒƒã‚¯
                    try {
                        env.START_PR = Integer.parseInt(params.START_PR_NUMBER)
                        env.END_PR = Integer.parseInt(params.END_PR_NUMBER)
                        
                        if (env.START_PR.toInteger() > env.END_PR.toInteger()) {
                            error "é–‹å§‹PRç•ªå·ï¼ˆ${env.START_PR}ï¼‰ã¯çµ‚äº†PRç•ªå·ï¼ˆ${env.END_PR}ï¼‰ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
                        }
                    } catch (NumberFormatException e) {
                        error "PRç•ªå·ã¯æ•°å€¤ã§æŒ‡å®šã—ã¦ãã ã•ã„: ${e.message}"
                    }
                    
                    // ãƒªãƒã‚¸ãƒˆãƒªURLã®ãƒã‚§ãƒƒã‚¯
                    if (!params.REPO_URL?.trim()) {
                        error "ãƒªãƒã‚¸ãƒˆãƒªURLã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
                    }
                    
                    // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã®æŠ½å‡º
                    try {
                        env.REPO_OWNER = sh(script: "echo '${params.REPO_URL}' | sed -n 's#.*/\\([^/]\\+\\)/[^/]\\+\$#\\1#p'", returnStdout: true).trim()
                        env.REPO_NAME = sh(script: "echo '${params.REPO_URL}' | sed -n 's#.*/[^/]\\+/\\([^/]\\+\\)\$#\\1#p'", returnStdout: true).trim()
                        
                        if (!env.REPO_OWNER || !env.REPO_NAME) {
                            error "ãƒªãƒã‚¸ãƒˆãƒªURLã‹ã‚‰æ‰€æœ‰è€…ã¨ãƒªãƒã‚¸ãƒˆãƒªåã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ: ${params.REPO_URL}"
                        }
                        
                        echo "ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±: ${env.REPO_OWNER}/${env.REPO_NAME}"
                    } catch (Exception e) {
                        error "ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}"
                    }
                    
                    // ãƒ“ãƒ«ãƒ‰åã®è¨­å®š
                    currentBuild.displayName = "#${BUILD_NUMBER} - PR ${env.START_PR}â†’${env.END_PR} (${params.TARGET_BRANCH}/${params.PR_STATUS})"
                }
            }
        }
        
        stage('æº–å‚™') {
            steps {
                script {
                    // ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
                    sh """
                        mkdir -p ${RESULTS_DIR}
                    """
                    
                    // çµæœè¿½è·¡ç”¨ã®åˆæœŸJSONã‚’ä½œæˆ
                    def summary = [
                        start_time: env.TIME_STAMP,
                        start_pr: env.START_PR.toInteger(),
                        end_pr: env.END_PR.toInteger(),
                        repo_url: params.REPO_URL,
                        target_branch: params.TARGET_BRANCH,  // JSONã«è¿½åŠ 
                        pr_status: params.PR_STATUS,          // JSONã«è¿½åŠ 
                        jobs: [:],
                        status: [
                            total: (env.END_PR.toInteger() - env.START_PR.toInteger() + 1),
                            success: 0,
                            failed: 0,
                            skipped: 0,
                            pending: (env.END_PR.toInteger() - env.START_PR.toInteger() + 1)
                        ]
                    ]
                    
                    writeJSON file: env.SUMMARY_FILE, json: summary, pretty: 4
                }
            }
        }
        
        stage('PRå‡¦ç†') {
            steps {
                script {
                    def summary = readJSON file: env.SUMMARY_FILE
                    def jobResults = [:]
                    
                    for (int prNum = env.START_PR.toInteger(); prNum <= env.END_PR.toInteger(); prNum++) {
                        // å„PRã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å‡¦ç†çµæœã‚’è¿½è·¡
                        def currentPrStatus = [
                            status: 'PENDING',
                            start_time: new Date().format("yyyy/MM/dd HH:mm:ss", TimeZone.getTimeZone("Asia/Tokyo")),
                            job_url: null,
                            end_time: null,
                            duration: null
                        ]
                        
                        summary.jobs[prNum.toString()] = currentPrStatus
                        writeJSON file: env.SUMMARY_FILE, json: summary, pretty: 4
                        
                        try {
                            echo "PR #${prNum} ã®å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™..."
                            
                            // PRã®è©³ç´°æƒ…å ±ã‚’å–å¾—
                            def prInfo = gitUtils.getPullRequestInfo(
                                prNum,
                                [
                                    repoOwner: env.REPO_OWNER,
                                    repoName: env.REPO_NAME
                                ]
                            )
                            
                            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                            def targetBranch = prInfo.base?.ref
                            if (targetBranch != params.TARGET_BRANCH) {
                                echo "PR #${prNum} ã¯${params.TARGET_BRANCH}ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆå¯¾è±¡: ${targetBranch}ï¼‰ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                                currentPrStatus.status = 'SKIPPED'
                                currentPrStatus.reason = "${params.TARGET_BRANCH}ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆå¯¾è±¡: ${targetBranch}ï¼‰"
                                currentPrStatus.end_time = new Date().format("yyyy/MM/dd HH:mm:ss", TimeZone.getTimeZone("Asia/Tokyo"))
                                
                                summary.status.skipped++
                                summary.status.pending--
                                continue
                            }
                            
                            // PRã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                            def prState = prInfo.state
                            def isMerged = prInfo.merged
                            
                            if (params.PR_STATUS != 'all') {
                                def shouldSkip = false
                                def skipReason = ""
                                
                                switch (params.PR_STATUS) {
                                    case 'open':
                                        if (prState != 'open') {
                                            shouldSkip = true
                                            skipReason = "ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã®PRã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨ã®çŠ¶æ…‹: ${prState}ï¼‰"
                                        }
                                        break
                                    case 'merged':
                                        if (!isMerged) {
                                            shouldSkip = true
                                            skipReason = "ãƒãƒ¼ã‚¸æ¸ˆã¿ã®PRã§ã¯ã‚ã‚Šã¾ã›ã‚“"
                                        }
                                        break
                                    case 'closed_without_merge':
                                        if (prState != 'closed' || isMerged) {
                                            shouldSkip = true
                                            skipReason = "ãƒãƒ¼ã‚¸ã›ãšã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸPRã§ã¯ã‚ã‚Šã¾ã›ã‚“" + 
                                                        (prState != 'closed' ? "ï¼ˆç¾åœ¨ã®çŠ¶æ…‹: ${prState}ï¼‰" : "ï¼ˆãƒãƒ¼ã‚¸æ¸ˆã¿ï¼‰")
                                        }
                                        break
                                }
                                
                                if (shouldSkip) {
                                    echo "PR #${prNum} ã¯${skipReason}ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                                    currentPrStatus.status = 'SKIPPED'
                                    currentPrStatus.reason = skipReason
                                    currentPrStatus.end_time = new Date().format("yyyy/MM/dd HH:mm:ss", TimeZone.getTimeZone("Asia/Tokyo"))
                                    
                                    summary.status.skipped++
                                    summary.status.pending--
                                    continue
                                }
                            }
                            
                            echo "PR #${prNum} ã¯${params.TARGET_BRANCH}ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã§ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
                            
                            // ä¸‹æµã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œ
                            def job = build job: 'pull_request_comment_builder', 
                                parameters: [
                                    string(name: 'PR_NUMBER', value: prNum.toString()),
                                    string(name: 'REPO_URL', value: params.REPO_URL),
                                    booleanParam(name: 'UPDATE_TITLE', value: params.UPDATE_TITLE),
                                    booleanParam(name: 'FORCE_ANALYSIS', value: params.FORCE_ANALYSIS)
                                ], 
                                wait: true,
                                propagate: false
                            
                            // ã‚¸ãƒ§ãƒ–ãŒå³æ™‚ã«å–å¾—ã§ãã‚‹å ´åˆã®URLè¨­å®š
                            currentPrStatus.job_url = job.absoluteUrl
                            
                            // å®Ÿè¡Œå¾Œã®çŠ¶æ…‹ç®¡ç†
                            currentPrStatus.status = job.result
                            currentPrStatus.end_time = new Date().format("yyyy/MM/dd HH:mm:ss", TimeZone.getTimeZone("Asia/Tokyo"))
                            currentPrStatus.duration = job.duration
                            
                            if (job.result == 'SUCCESS') {
                                summary.status.success++
                                summary.status.pending--
                                echo "PR #${prNum} ã®å‡¦ç†ãŒæˆåŠŸã—ã¾ã—ãŸã€‚"
                            } else {
                                summary.status.failed++
                                summary.status.pending--
                                echo "PR #${prNum} ã®å‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ: ${job.result}"
                                error "PR #${prNum} ã®å‡¦ç†ãŒå¤±æ•—ã—ãŸãŸã‚ã€æ®‹ã‚Šã®PRå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                            }
                        } catch (Exception e) {
                            currentPrStatus.status = 'ERROR'
                            currentPrStatus.end_time = new Date().format("yyyy/MM/dd HH:mm:ss", TimeZone.getTimeZone("Asia/Tokyo"))
                            currentPrStatus.error_message = e.message
                            
                            summary.status.failed++
                            summary.status.pending--
                            
                            echo "PR #${prNum} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}"
                            error "PR #${prNum} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€æ®‹ã‚Šã®PRå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                        } finally {
                            // é€²æ—çŠ¶æ³ã‚’æ›´æ–°
                            summary.jobs[prNum.toString()] = currentPrStatus
                            writeJSON file: env.SUMMARY_FILE, json: summary, pretty: 4
                        }
                    }
                }
            }
        }
        
        stage('ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ') {
            steps {
                script {
                    def summary = readJSON file: env.SUMMARY_FILE
                    def endTime = new Date().format("yyyy/MM/dd HH:mm:ss", TimeZone.getTimeZone("Asia/Tokyo"))
                    def totalDuration = (System.currentTimeMillis() - env.START_TIME.toLong()) / 1000
                    
                    // æœ€çµ‚çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
                    summary.end_time = endTime
                    summary.duration_seconds = totalDuration
                    
                    try {
                        summary.duration_formatted = durationToString(totalDuration)
                    } catch (Exception e) {
                        summary.duration_formatted = "${totalDuration}ç§’"
                        echo "æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${e.message}"
                    }
                    
                    writeJSON file: env.SUMMARY_FILE, json: summary, pretty: 4
                    
                    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚‚ç”Ÿæˆ
                    def markdownReport = createMarkdownReport(summary)
                    writeFile file: "${RESULTS_DIR}/summary.md", text: markdownReport
                    
                    echo "å‡¦ç†ã‚µãƒãƒªãƒ¼:"
                    echo "- å‡¦ç†å¯¾è±¡PR: ${summary.start_pr} â†’ ${summary.end_pr}"
                    echo "- å‡¦ç†çµæœ: æˆåŠŸ=${summary.status.success}, å¤±æ•—=${summary.status.failed}, ã‚¹ã‚­ãƒƒãƒ—=${summary.status.skipped}, ä¿ç•™=${summary.status.pending}"
                }
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: "${RESULTS_DIR}/**", allowEmptyArchive: true
        }
    }
}

/**
 * ç§’å˜ä½ã®æ™‚é–“ã‚’äººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›
 */
def durationToString(seconds) {
    try {
        // ç¢ºå®Ÿã«æ•´æ•°å€¤ã¨ã—ã¦æ‰±ã†
        def secondsInt = seconds instanceof BigDecimal ? seconds.intValue() : seconds as int
        def hours = secondsInt / 3600
        def minutes = (secondsInt - (hours * 3600)) / 60
        def secs = secondsInt - (hours * 3600) - (minutes * 60)
        
        return String.format("%02d:%02d:%02d", hours as int, minutes as int, secs as int)
    } catch (Exception e) {
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚·ãƒ³ãƒ—ãƒ«ã«æ™‚é–“ã‚’è¿”ã™
        return "${seconds}ç§’"
    }
}

/**
 * ã‚µãƒãƒªãƒ¼æƒ…å ±ã‹ã‚‰ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
 * è¨ˆç®—ã‚’ç°¡ç•¥åŒ–ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢
 */
def createMarkdownReport(summary) {
    def reportBuilder = new StringBuilder()
    
    // åŸºæœ¬æƒ…å ±ã®è¿½åŠ ï¼ˆã‚°ãƒ©ãƒ•ã‚„ãƒ‡ãƒ¼ã‚¿ã«ä¾å­˜ã—ãªã„éƒ¨åˆ†ï¼‰
    reportBuilder.append("# ãƒãƒƒãƒPRå‡¦ç†ã‚µãƒãƒªãƒ¼\n\n")
    reportBuilder.append("## å‡¦ç†æ¦‚è¦\n\n")
    
    // å®‰å…¨ã«æ–‡å­—åˆ—ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    def safeGetValue = { obj, key, defaultValue = 'æœªæŒ‡å®š' ->
        try {
            def value = obj[key]
            return (value != null) ? value.toString() : defaultValue
        } catch (Exception e) {
            return defaultValue
        }
    }
    
    // åŸºæœ¬æƒ…å ±
    reportBuilder.append("- **å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª**: ${safeGetValue(summary, 'repo_url')}\n")
    reportBuilder.append("- **å¯¾è±¡PRç¯„å›²**: ${safeGetValue(summary, 'start_pr')} â†’ ${safeGetValue(summary, 'end_pr')}\n")
    reportBuilder.append("- **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: ${safeGetValue(summary, 'target_branch')}\n")
    reportBuilder.append("- **PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${safeGetValue(summary, 'pr_status')}\n")
    reportBuilder.append("- **é–‹å§‹æ™‚åˆ»**: ${safeGetValue(summary, 'start_time')}\n")
    reportBuilder.append("- **çµ‚äº†æ™‚åˆ»**: ${safeGetValue(summary, 'end_time')}\n")
    
    // å‡¦ç†çµæœ - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚‚å®‰å…¨ã«å–å¾—
    reportBuilder.append("## å‡¦ç†çµæœ\n\n")
    
    def success = 0
    def failed = 0
    def skipped = 0
    def pending = 0
    
    try {
        if (summary.status) {
            success = summary.status.success ?: 0
            failed = summary.status.failed ?: 0
            skipped = summary.status.skipped ?: 0
            pending = summary.status.pending ?: 0
        }
    } catch (Exception e) {
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
    }
    
    reportBuilder.append("- **æˆåŠŸ**: ${success}\n")
    reportBuilder.append("- **å¤±æ•—**: ${failed}\n")
    reportBuilder.append("- **ã‚¹ã‚­ãƒƒãƒ—**: ${skipped}\n")
    reportBuilder.append("- **ä¿ç•™**: ${pending}\n\n")
    
    // PRæƒ…å ±ã®ãƒ†ãƒ¼ãƒ–ãƒ«
    reportBuilder.append("## PRã”ã¨ã®å‡¦ç†çŠ¶æ³\n\n")
    reportBuilder.append("| PR # | çŠ¶æ…‹ | å‡¦ç†æ™‚é–“ | ãƒªãƒ³ã‚¯ |\n")
    reportBuilder.append("|------|------|----------|--------|\n")
    
    // jobsãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (summary.jobs) {
        try {
            summary.jobs.each { prNum, prData ->
                def row = ""
                try {
                    // PRç•ªå·
                    row += "| ${prNum} "
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±
                    def status = "UNKNOWN"
                    def statusEmoji = "â³"
                    def reason = ""
                    
                    try {
                        if (prData) {
                            status = prData.status ?: "UNKNOWN"
                            
                            // çµµæ–‡å­—ã®æ±ºå®š
                            if (status == "SUCCESS") statusEmoji = "âœ…"
                            else if (status == "FAILURE" || status == "UNSTABLE" || status == "ERROR") statusEmoji = "âŒ"
                            else if (status == "TRIGGERED") statusEmoji = "ğŸ”„"
                            else if (status == "SKIPPED") statusEmoji = "â­ï¸"
                            
                            // ç†ç”±ã®å–å¾—
                            if (prData.reason) {
                                reason = " (${prData.reason})"
                            }
                        }
                    } catch (Exception e) {
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
                    }
                    
                    row += "| ${statusEmoji} ${status}${reason} "
                    
                    // å‡¦ç†æ™‚é–“ï¼ˆè¨ˆç®—ã‚’é¿ã‘ã¦å˜ç´”åŒ–ï¼‰
                    def duration = "-"
                    try {
                        if (prData && prData.duration != null && prData.duration != "null" && prData.duration.toString() != "null") {
                            duration = "${prData.duration}ms"
                        }
                    } catch (Exception e) {
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                    }
                    row += "| ${duration} "
                    
                    // ãƒªãƒ³ã‚¯
                    def link = "-"
                    try {
                        if (prData && prData.job_url && prData.job_url != "null" && prData.job_url.toString() != "null") {
                            link = "[ãƒ“ãƒ«ãƒ‰](${prData.job_url})"
                        }
                    } catch (Exception e) {
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                    }
                    row += "| ${link} |\n"
                    
                    reportBuilder.append(row)
                } catch (Exception e) {
                    // è¡Œã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€æœ€ä½é™ã®æƒ…å ±ã ã‘ã‚’è¡¨ç¤º
                    reportBuilder.append("| ${prNum} | ã‚¨ãƒ©ãƒ¼ | - | - |\n")
                }
            }
        } catch (Exception e) {
            reportBuilder.append("| - | ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼ | - | - |\n")
        }
    } else {
        reportBuilder.append("| - | PRãƒ‡ãƒ¼ã‚¿ãªã— | - | - |\n")
    }
    
    return reportBuilder.toString()
}