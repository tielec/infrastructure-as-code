<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulumi Deployment Report - {{ stack_name }}</title>
    <link rel="stylesheet" href="pulumi_styles.css">
</head>
<body>
    <div class="container">
        <h1>Pulumi {% if action_type == 'destroy' %}Destruction{% else %}Deployment{% endif %} Report</h1>
        
        {% if action_type == 'destroy' %}
        <div class="destruction-notice">
            <h2>âš ï¸ ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <p>ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã€ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ã®å®Ÿè¡Œçµæœã‚’è¨˜éŒ²ã—ãŸã‚‚ã®ã§ã™ã€‚</p>
            <p>å®Ÿè¡Œæ™‚åˆ»: {{ timestamp }}</p>
        </div>
        {% endif %}
        
        {% if change_summary %}
        <div class="change-summary">
            <h2>å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼</h2>
            <div class="change-summary-content">
                <div class="resource-change-flow">
                    ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: <strong>{{ action_type|upper }}</strong><br>
                    å®Ÿè¡Œå‰: <span class="count">{{ change_summary.before_total }}</span>å€‹
                    <span class="arrow">â†’</span>
                    å®Ÿè¡Œå¾Œ: <span class="count">{{ change_summary.after_total }}</span>å€‹ ã®ãƒªã‚½ãƒ¼ã‚¹
                </div>
                <div class="change-details">
                    <div class="change-item">
                        <div class="change-content">
                            <div class="count">{{ change_summary.added }}</div>
                            <div class="label">è¿½åŠ </div>
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-content">
                            <div class="count">{{ change_summary.updated }}</div>
                            <div class="label">æ›´æ–°</div>
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-content">
                            <div class="count">{{ change_summary.deleted }}</div>
                            <div class="label">å‰Šé™¤</div>
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-content">
                            <div class="count">{{ change_summary.unchanged }}</div>
                            <div class="label">å¤‰æ›´ãªã—</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        
        <!-- æ¦‚è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆæ‹¡å¼µç‰ˆï¼‰ -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Resources</div>
                {% if metrics_comparison %}
                <div class="metric-comparison">
                    <div class="metric-before-after">
                        <span>{{ metrics_comparison.before_total }}</span>
                        <span class="arrow">â†’</span>
                        <span>{{ metrics_comparison.after_total }}</span>
                    </div>
                    <div class="metric-change {% if metrics_comparison.total_diff > 0 %}positive{% elif metrics_comparison.total_diff < 0 %}negative{% else %}neutral{% endif %}">
                        {% if metrics_comparison.total_diff > 0 %}+{% endif %}{{ metrics_comparison.total_diff }}
                    </div>
                </div>
                {% else %}
                <div class="metric-value">{{ total_resources }}</div>
                {% endif %}
            </div>
            <div class="metric-card">
                <div class="metric-label">Resource Types</div>
                {% if metrics_comparison %}
                <div class="metric-comparison">
                    <div class="metric-before-after">
                        <span>{{ metrics_comparison.before_types }}</span>
                        <span class="arrow">â†’</span>
                        <span>{{ metrics_comparison.after_types }}</span>
                    </div>
                    <div class="metric-change {% if metrics_comparison.types_diff > 0 %}positive{% elif metrics_comparison.types_diff < 0 %}negative{% else %}neutral{% endif %}">
                        {% if metrics_comparison.types_diff > 0 %}+{% endif %}{{ metrics_comparison.types_diff }}
                    </div>
                </div>
                {% else %}
                <div class="metric-value">{{ resource_types_count }}</div>
                {% endif %}
            </div>
            <div class="metric-card">
                <div class="metric-label">Providers</div>
                {% if metrics_comparison %}
                <div class="metric-comparison">
                    <div class="metric-before-after">
                        <span>{{ metrics_comparison.before_providers }}</span>
                        <span class="arrow">â†’</span>
                        <span>{{ metrics_comparison.after_providers }}</span>
                    </div>
                    <div class="metric-change {% if metrics_comparison.providers_diff > 0 %}positive{% elif metrics_comparison.providers_diff < 0 %}negative{% else %}neutral{% endif %}">
                        {% if metrics_comparison.providers_diff > 0 %}+{% elif metrics_comparison.providers_diff == 0 %}Â±{% endif %}{{ metrics_comparison.providers_diff }}
                    </div>
                </div>
                {% else %}
                <div class="metric-value">{{ resource_providers_count }}</div>
                {% endif %}
            </div>
            <div class="metric-card">
                <div class="metric-label">Status</div>
                <div class="metric-value">
                    {% if action_type == 'destroy' %}
                        <span class="status-badge status-deleted">Destroyed</span>
                    {% else %}
                        <span class="status-badge status-success">Active</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒãƒªãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
        {% if summary_chart %}
        <div class="card">
            <h2>ğŸ“Š ã‚¹ã‚¿ãƒƒã‚¯ã‚µãƒãƒªãƒ¼</h2>
            <div class="chart-container">
                <img src="{{ summary_chart }}" alt="Stack Summary" class="chart-image">
            </div>
        </div>
        {% endif %}
        
        <!-- ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ± -->
        <div class="card">
            <h2>ğŸ“‹ ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">ã‚¹ã‚¿ãƒƒã‚¯å</div>
                    <div class="info-value">{{ stack_name }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
                    <div class="info-value">{{ project_path }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ãƒ–ãƒ©ãƒ³ãƒ</div>
                    <div class="info-value">{{ branch }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ãƒ“ãƒ«ãƒ‰ç•ªå·</div>
                    <div class="info-value">#{{ build_number }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å®Ÿè¡Œæ™‚åˆ»</div>
                    <div class="info-value">{{ timestamp }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Pulumiãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                    <div class="info-value">{{ pulumi_version }}</div>
                </div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµ±è¨ˆ -->
        {% if deployment_stats %}
        <div class="card">
            <h2>ğŸ“ˆ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆçµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ deployment_stats.total_deployments }}</div>
                    <div class="stat-label">ç·ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value success">{{ deployment_stats.success_count }}</div>
                    <div class="stat-label">æˆåŠŸ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value error">{{ deployment_stats.failure_count }}</div>
                    <div class="stat-label">å¤±æ•—</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ deployment_stats.success_rate }}%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ deployment_stats.avg_changes }}</div>
                    <div class="stat-label">å¹³å‡å¤‰æ›´æ•°</div>
                </div>
            </div>
            <div class="deployment-stats-note">
                â€» ä»Šå›ã®å®Ÿè¡Œçµæœã‚’å«ã‚€çµ±è¨ˆã§ã™
            </div>
        </div>
        {% endif %}
        
        <!-- ãƒªã‚½ãƒ¼ã‚¹åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ -->
        {% if resource_chart %}
        <div class="card">
            <h2>ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹åˆ†å¸ƒï¼ˆå®Ÿè¡Œå¾Œï¼‰</h2>
            <div class="chart-container">
                <img src="{{ resource_chart }}" alt="Resource Distribution" class="chart-image">
            </div>
            <div class="provider-legend">
                <h3>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ãƒªã‚½ãƒ¼ã‚¹æ•°</h3>
                <div class="provider-grid">
                    {% for provider, count in resource_providers.items() %}
                    <div class="provider-item">
                        <span class="provider-name">{{ provider }}</span>
                        <span class="provider-count">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ• -->
        {% if dependency_graph %}
        <div class="card">
            <h2>ğŸ”— ãƒªã‚½ãƒ¼ã‚¹ä¾å­˜é–¢ä¿‚ï¼ˆå®Ÿè¡Œå¾Œï¼‰</h2>
            <div class="dependency-graph-info">
                <p>ã“ã®ã‚°ãƒ©ãƒ•ã¯ãƒªã‚½ãƒ¼ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸­å¿ƒã«ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ãƒªã‚½ãƒ¼ã‚¹ã®éšå±¤æ§‹é€ ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
                <p><strong>ãƒ’ãƒ³ãƒˆ:</strong> ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ‹¡å¤§è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
                <div class="graph-legend">
                    <span class="legend-item">
                        <span class="legend-box aws"></span>AWSãƒªã‚½ãƒ¼ã‚¹
                    </span>
                    <span class="legend-item">
                        <span class="legend-box pulumi"></span>Pulumiãƒªã‚½ãƒ¼ã‚¹
                    </span>
                    <span class="legend-item">
                        <span class="legend-box default"></span>ãã®ä»–
                    </span>
                </div>
            </div>
            <div class="chart-container dependency-graph-container">
                <input type="checkbox" id="graph-toggle" class="graph-toggle">
                <label for="graph-toggle" class="graph-wrapper">
                    <span class="graph-toggle-label">æ‹¡å¤§</span>
                    <img src="{{ dependency_graph }}" alt="Resource Dependency Graph" class="dependency-graph-image">
                </label>
            </div>
            <div class="graph-note">
                <p>â€» ç”»åƒã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</p>
                <p>â€» æ‹¡å¤§ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å…¨ç”»é¢è¡¨ç¤ºã«ãªã‚Šã¾ã™</p>
            </div>
        </div>
        {% else %}
        <div class="card">
            <h2>ğŸ”— ãƒªã‚½ãƒ¼ã‚¹ä¾å­˜é–¢ä¿‚</h2>
            <div class="dependency-graph-info">
                <p>ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã¯ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„ã‹ã€ã‚°ãƒ©ãƒ•ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
            </div>
        </div>
        {% endif %}
        
        <!-- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒˆãƒ¬ãƒ³ãƒ‰ -->
        {% if trends_chart %}
        <div class="card">
            <h2>ğŸ“ˆ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒˆãƒ¬ãƒ³ãƒ‰</h2>
            <div class="chart-container">
                <img src="{{ trends_chart }}" alt="Deployment Trends" class="chart-image">
            </div>
        </div>
        {% endif %}
        
        <!-- ã‚¹ã‚¿ãƒƒã‚¯è¨­å®š -->
        {% if stack_config %}
        <div class="card">
            <h2>âš™ï¸ ã‚¹ã‚¿ãƒƒã‚¯è¨­å®šï¼ˆå®Ÿè¡Œå¾Œï¼‰</h2>
            <div class="config-grid">
                {% for key, config in stack_config.items() %}
                <div class="config-item">
                    <div class="config-key">{{ key }}</div>
                    <div class="config-value">
                        {% if config.secret %}
                            <span class="secret-value">[Secret]</span>
                        {% else %}
                            {{ config.value }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ› -->
        {% if stack_outputs %}
        <div class="card">
            <h2>ğŸ“¤ ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›ï¼ˆå®Ÿè¡Œå¾Œï¼‰</h2>
            <div class="outputs-grid">
                {% for key, value in stack_outputs.items() %}
                <div class="output-item">
                    <div class="output-label">{{ key }}</div>
                    <div class="output-value-container">
                        <code class="output-value">{{ value }}</code>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§ï¼ˆæ‹¡å¼µç‰ˆï¼‰ -->
        <div class="card">
            <h2>ğŸ—‚ï¸ ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§</h2>
            <div class="resource-summary">
                <p>åˆè¨ˆ <strong>{{ total_resources_all if total_resources_all is defined else total_resources }}</strong> å€‹ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆ<strong>{{ resource_types_count }}</strong> ç¨®é¡ï¼‰</p>
                {% if action_type == 'destroy' %}
                <p style="color: var(--error-color);">â€» å‰Šé™¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚‚å«ã‚ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™</p>
                {% endif %}
            </div>
            
            <div class="table-wrapper">
                <table class="resource-table">
                    <thead>
                        <tr>
                            <th>ãƒªã‚½ãƒ¼ã‚¹å</th>
                            <th>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</th>
                            <th>ã‚¿ã‚¤ãƒ—</th>
                            <th>å¤‰æ›´çŠ¶æ…‹</th>
                            <th>ä½œæˆæ—¥æ™‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for resource in resources_with_change_status %}
                        <tr>
                            <td class="resource-name">{{ resource.urn.split('::')[-1] }}</td>
                            <td>
                                <span class="provider-badge">{{ resource.type.split(':')[0] }}</span>
                            </td>
                            <td>
                                <span class="resource-type">{{ resource.type.split(':')[-1] }}</span>
                            </td>
                            <td>
                                <span class="change-status {{ resource.change_status }}">
                                    {% if resource.change_status == 'added' %}
                                        <span>ğŸŸ¢</span> è¿½åŠ 
                                    {% elif resource.change_status == 'updated' %}
                                        <span>ğŸŸ¡</span> æ›´æ–°
                                    {% elif resource.change_status == 'deleted' %}
                                        <span>ğŸ”´</span> å‰Šé™¤
                                    {% else %}
                                        <span>âšª</span> å¤‰æ›´ãªã—
                                    {% endif %}
                                </span>
                            </td>
                            <td class="timestamp">
                                {% if resource.created %}
                                    {{ resource.created[:19].replace('T', ' ') }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå±¥æ­´ -->
        <div class="card">
            <h2>ğŸ• ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå±¥æ­´</h2>
            <div class="history-timeline">
                {% for history in deployment_history %}
                <div class="history-item">
                    <div class="history-header">
                        <span class="history-date">
                            {% if history.startTime %}
                                {{ history.startTime[:19].replace('T', ' ') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                        <span class="history-result status-badge status-{{ 'success' if history.result == 'succeeded' else 'error' }}">
                            {{ history.result or 'unknown' }}
                        </span>
                    </div>
                    <div class="history-details">
                        <div class="history-info">
                            <span class="info-label">æ“ä½œ:</span>
                            <span class="info-value">{{ history.kind or 'update' }}</span>
                        </div>
                        {% if history.message %}
                        <div class="history-info">
                            <span class="info-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</span>
                            <span class="info-value">{{ history.message }}</span>
                        </div>
                        {% endif %}
                        <div class="history-changes">
                            {% set changes = history.resourceChanges or {} %}
                            {% if changes.get('create', 0) > 0 %}
                                <span class="change-badge change-create">ä½œæˆ: {{ changes.create }}</span>
                            {% endif %}
                            {% if changes.get('update', 0) > 0 %}
                                <span class="change-badge change-update">æ›´æ–°: {{ changes.get('update') }}</span>
                            {% endif %}
                            {% if changes.get('replace', 0) > 0 %}
                                <span class="change-badge change-replace">ç½®æ›: {{ changes.replace }}</span>
                            {% endif %}
                            {% if changes.get('delete', 0) > 0 %}
                                <span class="change-badge change-delete">å‰Šé™¤: {{ changes.delete }}</span>
                            {% endif %}
                            {% if changes.get('same', 0) > 0 %}
                                <span class="change-badge change-same">å¤‰æ›´ãªã—: {{ changes.same }}</span>
                            {% endif %}
                            {% if changes.get('read', 0) > 0 %}
                                <span class="change-badge change-read">èª­å–: {{ changes.read }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="footer">
            <p>Generated by Pulumi Deployment Pipeline - Build #{{ build_number }}</p>
            <p>{{ timestamp }}</p>
        </div>
    </div>
</body>
</html>
