# dot_processor.py 振る舞い記録ドキュメント

## 概要

このドキュメントは、`dot_processor.py`の既存の振る舞いを記録したものです。リファクタリング時にこの振る舞いが維持されていることを確認するために使用します。

## DotFileGenerator クラス

### `escape_dot_string(s: str) -> str`

**目的**: DOT形式用の特殊文字エスケープ

**期待動作**:
- ダブルクォート (`"`) → `\"`
- バックスラッシュ (`\`) → `\\`
- 改行 (`\n`) → `\n` (エスケープ)
- タブ (`\t`) → `\t` (エスケープ)
- キャリッジリターン (`\r`) → 削除
- 空文字列 → 空文字列（エラーなし）
- None値 → None（エラーなし）
- Unicode文字 → そのまま出力（エラーなし）

**エッジケース**:
- None値: そのまま返される
- 極端に長い文字列（10000文字以上）: エスケープ処理が正常に動作

### `create_dot_file(stack_name, resources, resource_providers) -> List[str]`

**目的**: DOTファイル生成

**期待動作**:
- ヘッダー: `digraph G {`で開始
- スタックノード: 中央に配置、楕円形
- プロバイダーノード: フォルダー形状、色設定適用
- リソース: 最大20個まで処理
- 依存関係: エッジとして表現（通常依存、親依存、プロパティ依存）
- フッター: `}`で終了

**エッジケース**:
- 空リソース: スタックノードのみ生成
- 21個以上のリソース: 最初の20個のみ処理
- 未定義プロバイダー: デフォルト色を適用（`#E3F2FD`, `#1565C0`）

### プロバイダー色設定

**定義済みプロバイダー**:
- AWS: `#FFF3E0` (fill), `#EF6C00` (border)
- Azure: `#E3F2FD` (fill), `#0078D4` (border)
- GCP: `#E8F5E9` (fill), `#4285F4` (border)
- Kubernetes: `#E8EAF6` (fill), `#326DE6` (border)
- Pulumi: `#F3E5F5` (fill), `#6A1B9A` (border)

**デフォルト色**: `#E3F2FD` (fill), `#1565C0` (border)

## DotFileProcessor クラス

### `parse_urn(urn: str) -> Dict[str, str]`

**目的**: Pulumi URN形式の解析

**URN形式**: `urn:pulumi:STACK::PROJECT::PROVIDER:MODULE/TYPE:TYPE::NAME`

**期待動作**:
- 正常なURN: 辞書形式で構成要素を返す
  - キー: `stack`, `project`, `provider`, `module`, `type`, `name`, `full_urn`
- 不正なURN: デフォルト値を含む辞書を返す（エラーなし）
  - `provider`: `'unknown'`
  - `type`: `'unknown'`
- 空文字列: デフォルト値を含む辞書を返す（エラーなし）

**エッジケース**:
- 部分的なURN: デフォルト値で補完
- 極端に長いURN: 正常に解析（パフォーマンスは低下する可能性）
- プロバイダー情報なし: `provider='unknown'`

### `apply_graph_styling(dot_content: str) -> str`

**目的**: グラフスタイル適用

**期待動作**:
- Pulumi生成グラフ（`strict digraph`で始まる）: グラフ拡張処理を適用
  - グラフ属性、ノード属性、エッジ属性を追加
  - URNラベルを読みやすい形式に変換
  - スタックノードに特別なスタイル適用
- 自前生成グラフ（`digraph G {`で始まる）: スタイル設定を置換
  - `STYLE_SETTINGS`に置換
  - ノードラベルを処理

**エッジケース**:
- 空グラフ: そのまま返される（または最小限の変更）
- 不正なDOT形式: エラーが発生する可能性

### `is_empty_graph(dot_content: str) -> bool`

**目的**: 空グラフ判定

**期待動作**:
- `digraph G {}`: `True`
- 30文字未満の文字列: `True`
- それ以外: `False`

**エッジケース**:
- ちょうど30文字: `False`（30文字以上なので空でない）

### `create_readable_label(urn_info: Dict) -> str`

**目的**: 読みやすいラベル生成

**期待動作**:
- 改行区切りで`module`, `type`, `name`を表示
- モジュール名が空の場合: `type`, `name`のみ表示
- 長いタイプ名: 省略処理（30文字以内）

**エッジケース**:
- モジュール名が空: `type\nname`の形式
- 長いタイプ名: キャメルケースを分割して主要部分のみ表示

### `is_stack_resource(urn: str) -> bool`

**目的**: スタックリソース判定

**期待動作**:
- スタックURN（`pulumi:pulumi:Stack`を含む）: `True`
- 通常リソースURN: `False`

**エッジケース**:
- 不正なURN: `False`
- 空文字列: `False`

## 依存関係の種類

### 通常依存（dependencies）
- **スタイル**: `solid`
- **色**: `#9C27B0`（紫）
- **説明**: リソース間の直接的な依存関係

### 親依存（parent）
- **スタイル**: `dashed`
- **色**: `#2196F3`（青）
- **ラベル**: `"parent"`
- **説明**: 親子関係による依存

### プロパティ依存（propertyDependencies）
- **スタイル**: `dotted`
- **色**: `#FF5722`（オレンジ）
- **ラベル**: プロパティ名（短縮形）
- **説明**: プロパティ値による依存

## テスト実行時の注意事項

1. **既存の振る舞いを記録する**: 現在のコードがどのように動作するかを記録し、将来のリファクタリング時に比較できるようにする
2. **正解を決めつけない**: 既存コードの出力が「正解」である。もし期待と異なる動作があっても、まずは記録する
3. **Golden Masterパターン**: 初回実行時の出力を「Golden Master」として保存し、以降のテストで比較

## 更新履歴

| 日付 | バージョン | 変更者 | 変更内容 |
|------|-----------|--------|----------|
| 2025-01-19 | 1.0 | Claude Code | 初版作成（テスト実装前の設計版） |

---

**注意**: このドキュメントは、テスト実装後に実際の振る舞いを記録して完成させます。Phase 5（テストコード実装）およびPhase 6（テスト実行）で更新されます。
