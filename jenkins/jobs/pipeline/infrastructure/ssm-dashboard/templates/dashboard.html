<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSM Parameter Store Dashboard - {{ environment }}</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê SSM Parameter Store Dashboard</h1>
            <div class="timestamp">Áí∞Â¢É: {{ environment }} | ÁîüÊàêÊó•ÊôÇ: {{ timestamp }}</div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">{{ total_params }}</div>
                <div class="stat-label">Á∑è„Éë„É©„É°„Éº„ÇøÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ string_count }}</div>
                <div class="stat-label">String</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ secure_count }}</div>
                <div class="stat-label">SecureString</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ list_count }}</div>
                <div class="stat-label">StringList</div>
            </div>
        </div>
        
        <div class="content">
            <div class="filters">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="„Éë„É©„É°„Éº„ÇøÂêç„ÅßÊ§úÁ¥¢..." onkeyup="filterTable()">
                </div>
                <div class="filter-controls">
                    <select id="typeFilter" onchange="filterTable()">
                        <option value="">„Åô„Åπ„Å¶„ÅÆ„Çø„Ç§„Éó</option>
                        <option value="String">String</option>
                        <option value="SecureString">SecureString</option>
                        <option value="StringList">StringList</option>
                    </select>
                    <select id="pathFilter" onchange="filterTable()">
                        <option value="">„Åô„Åπ„Å¶„ÅÆ„Éë„Çπ</option>
                        {% for path in unique_paths %}
                        <option value="{{ path }}">{{ path }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            {% if hierarchical_view %}
            <div class="tree-view">
                <h2>ÈöéÂ±§„Éì„É•„Éº</h2>
                <div id="parameterTree">
                    {{ hierarchy_html | safe }}
                </div>
            </div>
            {% endif %}
            
            <div class="table-view">
                <h2>„Éë„É©„É°„Éº„Çø‰∏ÄË¶ß</h2>
                <table id="paramTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">„Éë„É©„É°„Éº„ÇøÂêç ‚Üï</th>
                            <th>ÂÄ§</th>
                            <th onclick="sortTable(2)">„Çø„Ç§„Éó ‚Üï</th>
                            <th>Ë™¨Êòé</th>
                            <th onclick="sortTable(4)">ÊúÄÁµÇÊõ¥Êñ∞Êó• ‚Üï</th>
                            <th>„Éê„Éº„Ç∏„Éß„É≥</th>
                            <th>„ÉÜ„Ç£„Ç¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for param in parameters %}
                        <tr data-type="{{ param.Type }}" data-path="{{ param.Hierarchy.Path }}">
                            <td>
                                <span class="param-name" title="{{ param.Name }}">{{ param.Name }}</span>
                                {% if param.Hierarchy.Path != '/' %}
                                <br><span class="hierarchy-path">{{ param.Hierarchy.Path }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="param-value" title="{{ param.Value }}">
                                    {% if param.Type == 'SecureString' and not show_secure_values %}
                                        {% if param.Value == '[SECURE]' %}
                                            <span class="secure-hidden">[‰øùË≠∑„Åï„Çå„Å¶„ÅÑ„Åæ„Åô]</span>
                                        {% else %}
                                            <span class="secure-partial">***{{ param.Value[-4:] if param.Value|length > 4 else '****' }}</span>
                                        {% endif %}
                                    {% else %}
                                        {{ param.Value | truncate(100) }}
                                    {% endif %}
                                </span>
                                {% if param.Value|length > 100 %}
                                <button class="expand-btn" onclick="expandValue(this)">Â±ïÈñã</button>
                                {% endif %}
                            </td>
                            <td><span class="param-type type-{{ param.Type }}">{{ param.Type }}</span></td>
                            <td><span class="description">{{ param.Description }}</span></td>
                            <td><span class="last-modified" data-timestamp="{{ param.LastModified }}">{{ param.LastModifiedFormatted }}</span></td>
                            <td><span class="version">{{ param.Version }}</span></td>
                            <td><span class="tier tier-{{ param.Tier }}">{{ param.Tier }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="export-section">
                <h3>„Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>
                <button onclick="exportToJSON()">üì• JSONÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                <button onclick="exportToCSV()">üìä CSVÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                <button onclick="copyToClipboard()">üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
            </div>
        </div>
        
        <div class="footer">
            <p>Generated by Jenkins SSM Dashboard Job | Build #{{ build_number }}</p>
        </div>
    </div>
    
    <script>
        // ÂÖÉ„Éá„Éº„Çø„Çí‰øùÊåÅ
        const parametersData = {{ parameters_json | safe }};
        
        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const pathFilter = document.getElementById('pathFilter').value;
            const table = document.getElementById('paramTable');
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) {
                const row = tr[i];
                const paramName = row.getElementsByClassName('param-name')[0].textContent.toLowerCase();
                const paramType = row.getAttribute('data-type');
                const paramPath = row.getAttribute('data-path');
                
                let showRow = true;
                
                // Ê§úÁ¥¢„Éï„Ç£„É´„Çø
                if (searchInput && !paramName.includes(searchInput)) {
                    showRow = false;
                }
                
                // „Çø„Ç§„Éó„Éï„Ç£„É´„Çø
                if (typeFilter && paramType !== typeFilter) {
                    showRow = false;
                }
                
                // „Éë„Çπ„Éï„Ç£„É´„Çø
                if (pathFilter && paramPath !== pathFilter) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            }
        }
        
        function sortTable(columnIndex) {
            const table = document.getElementById('paramTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            rows.sort((a, b) => {
                const aValue = a.getElementsByTagName('td')[columnIndex].textContent;
                const bValue = b.getElementsByTagName('td')[columnIndex].textContent;
                
                // Êó•‰ªò„Ç´„É©„É†„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Âá¶ÁêÜ
                if (columnIndex === 4) {
                    const aTimestamp = a.getElementsByClassName('last-modified')[0].getAttribute('data-timestamp');
                    const bTimestamp = b.getElementsByClassName('last-modified')[0].getAttribute('data-timestamp');
                    return aTimestamp > bTimestamp ? 1 : -1;
                }
                
                return aValue.localeCompare(bValue);
            });
            
            // „ÇΩ„Éº„ÉàÁµêÊûú„ÇíÂèçÊò†
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function expandValue(button) {
            const valueSpan = button.previousElementSibling;
            const fullValue = valueSpan.getAttribute('title');
            
            if (button.textContent === 'Â±ïÈñã') {
                valueSpan.textContent = fullValue;
                button.textContent = 'Êäò„Çä„Åü„Åü„ÇÄ';
            } else {
                valueSpan.textContent = fullValue.substring(0, 100) + '...';
                button.textContent = 'Â±ïÈñã';
            }
        }
        
        function exportToJSON() {
            const dataStr = JSON.stringify(parametersData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `ssm_parameters_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function exportToCSV() {
            let csv = 'Name,Value,Type,Description,LastModified,Version,Tier\n';
            
            parametersData.forEach(param => {
                const row = [
                    param.Name,
                    param.Value,
                    param.Type,
                    param.Description || '',
                    param.LastModified || '',
                    param.Version || '',
                    param.Tier || ''
                ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
                
                csv += row + '\n';
            });
            
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            const exportFileDefaultName = `ssm_parameters_${new Date().toISOString().split('T')[0]}.csv`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function copyToClipboard() {
            const text = parametersData.map(p => `${p.Name}: ${p.Value}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        }
    </script>
</body>
</html>