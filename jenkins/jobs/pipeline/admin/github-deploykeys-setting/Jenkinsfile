@Library('jenkins-shared-lib') _

pipeline {
    agent { 
        label 'ec2-fleet' 
    }
    
    environment {
        // GitHubã®Deploy Keyåã¯å›ºå®š
        GITHUB_DEPLOY_KEY_TITLE = 'tielec-dev-jenkins'
        
        // ä¸€æ™‚çš„ãªSSHéµãƒ•ã‚¡ã‚¤ãƒ«å
        TEMP_KEY_FILE = "temp_deploy_key_${BUILD_NUMBER}"
        TEMP_KEY_FILE_PUB = "${TEMP_KEY_FILE}.pub"
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    echo "=== GitHub Deploy Key & Jenkins Credential Setup ==="
                    echo "Action: ${params.ACTION}"
                    echo "Repository URL: ${params.REPO_URL}"
                    
                    // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’æŠ½å‡º
                    def repoInfo = gitUtils.extractRepoInfo(params.REPO_URL)
                    env.REPO_OWNER = repoInfo[0]
                    env.REPO_NAME = repoInfo[1]
                    
                    // Jenkins Credential IDã‚’ç”Ÿæˆ
                    env.JENKINS_CREDENTIAL_ID = "github-deploy-key-${env.REPO_NAME}"
                    
                    echo "Repository: ${env.REPO_OWNER}/${env.REPO_NAME}"
                    echo "Deploy Key Title: ${env.GITHUB_DEPLOY_KEY_TITLE}"
                    echo "Jenkins Credential ID: ${env.JENKINS_CREDENTIAL_ID}"
                    echo "Read Only: ${params.READ_ONLY}"
                    
                    // Jenkins CLIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                    jenkinsCliUtils.setupCli(env.JENKINS_URL)
                    
                    // GitHubæ¥ç¶šãƒ†ã‚¹ãƒˆ
                    def connectionTest = gitUtils.testGitHubAppConnection()
                    if (connectionTest.success) {
                        echo "âœ… GitHubæ¥ç¶š: æˆåŠŸ"
                        echo "   Rate Limit: ${connectionTest.rate_limit.remaining}/${connectionTest.rate_limit.limit}"
                    } else {
                        error "âŒ GitHubæ¥ç¶š: å¤±æ•—"
                    }
                }
            }
        }
        
        stage('List Deploy Keys') {
            when {
                expression { params.ACTION == 'LIST' }
            }
            steps {
                script {
                    echo "\n=== ç¾åœ¨ã®Deploy Keyä¸€è¦§ ==="
                    
                    // GitHubã®Deploy Keys
                    echo "\n--- GitHub Deploy Keys ---"
                    try {
                        def deployKeys = gitUtils.listDeployKeys([repoUrl: params.REPO_URL])
                        if (deployKeys && deployKeys.size() > 0) {
                            deployKeys.each { key ->
                                echo "ID: ${key.id}"
                                echo "  Title: ${key.title}"
                                echo "  Key: ${key.key?.take(50)}..."
                                echo "  Read Only: ${key.read_only}"
                                echo "  Created: ${key.created_at}"
                                echo "  Verified: ${key.verified}"
                                if (key.title == env.GITHUB_DEPLOY_KEY_TITLE) {
                                    echo "  â­ This is the managed deploy key"
                                }
                                echo "---"
                            }
                            echo "åˆè¨ˆ: ${deployKeys.size()}å€‹ã®Deploy Key"
                        } else {
                            echo "Deploy KeyãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
                        }
                    } catch (Exception e) {
                        echo "âŒ GitHub Deploy Keyä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                    
                    // Jenkins Credentials
                    echo "\n--- Jenkins Credentials ---"
                    try {
                        def credentialsList = jenkinsCliUtils.listCredentials(params.CREDENTIAL_FOLDER)
                        if (credentialsList.contains(env.JENKINS_CREDENTIAL_ID)) {
                            echo "âœ… Credential '${env.JENKINS_CREDENTIAL_ID}' ãŒå­˜åœ¨ã—ã¾ã™"
                            
                            // è©³ç´°æƒ…å ±ã‚’å–å¾—
                            def credXml = jenkinsCliUtils.getCredentialAsXml(
                                params.CREDENTIAL_FOLDER,
                                params.CREDENTIAL_DOMAIN,
                                env.JENKINS_CREDENTIAL_ID
                            )
                            echo "Credentialè©³ç´°:\n${credXml}"
                        } else {
                            echo "Credential '${env.JENKINS_CREDENTIAL_ID}' ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
                        }
                    } catch (Exception e) {
                        echo "âŒ Jenkins Credentialç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                }
            }
        }
        
        stage('Create SSH Key Pair') {
            when {
                expression { params.ACTION in ['CREATE', 'UPDATE'] }
            }
            steps {
                script {
                    echo "\n=== SSHéµãƒšã‚¢ç”Ÿæˆ ==="
                    
                    try {
                        // ED25519éµã‚’ç”Ÿæˆï¼ˆã‚ˆã‚Šå®‰å…¨ã§çŸ­ã„ï¼‰
                        sh """
                            ssh-keygen -t ed25519 -f '${env.WORKSPACE}/${env.TEMP_KEY_FILE}' -N '' -C 'jenkins-deploy-key@${env.REPO_NAME}'
                            chmod 600 '${env.WORKSPACE}/${env.TEMP_KEY_FILE}'*
                        """
                        
                        // ç”Ÿæˆã•ã‚ŒãŸéµã‚’èª­ã¿è¾¼ã‚€
                        env.PRIVATE_KEY_CONTENT = readFile("${env.WORKSPACE}/${env.TEMP_KEY_FILE}").trim()
                        env.PUBLIC_KEY_CONTENT = readFile("${env.WORKSPACE}/${env.TEMP_KEY_FILE_PUB}").trim()
                        
                        echo "âœ… SSHéµãƒšã‚¢ç”Ÿæˆå®Œäº†"
                        echo "å…¬é–‹éµ: ${env.PUBLIC_KEY_CONTENT.take(50)}..."
                        
                    } catch (Exception e) {
                        error "SSHéµç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                }
            }
        }
        
        stage('Check Existing Resources') {
            when {
                expression { params.ACTION in ['CREATE', 'UPDATE'] }
            }
            steps {
                script {
                    echo "\n=== æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª ==="
                    
                    // GitHub Deploy Keyç¢ºèª
                    try {
                        def existingKeys = gitUtils.findDeployKeysByTitle(
                            env.GITHUB_DEPLOY_KEY_TITLE,
                            [repoUrl: params.REPO_URL]
                        )
                        
                        if (existingKeys && existingKeys.size() > 0) {
                            env.EXISTING_DEPLOY_KEY_ID = existingKeys[0].id.toString()
                            echo "âš ï¸  æ—¢å­˜ã®Deploy Key '${env.GITHUB_DEPLOY_KEY_TITLE}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ (ID: ${env.EXISTING_DEPLOY_KEY_ID})"
                            
                            if (params.ACTION == 'CREATE') {
                                error "Deploy KeyãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚UPDATEã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
                            }
                        } else {
                            echo "âœ… Deploy Key '${env.GITHUB_DEPLOY_KEY_TITLE}' ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
                            
                            if (params.ACTION == 'UPDATE') {
                                error "æ›´æ–°ã™ã‚‹Deploy KeyãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚CREATEã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"
                            }
                        }
                    } catch (Exception e) {
                        if (e.message.contains("æ—¢ã«å­˜åœ¨") || e.message.contains("å­˜åœ¨ã—ã¾ã›ã‚“")) {
                            throw e
                        }
                        echo "Deploy Keyç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                    
                    // Jenkins Credentialç¢ºèª
                    try {
                        def credentialsList = jenkinsCliUtils.listCredentials(params.CREDENTIAL_FOLDER)
                        env.CREDENTIAL_EXISTS = credentialsList.contains(env.JENKINS_CREDENTIAL_ID) ? 'true' : 'false'
                        
                        if (env.CREDENTIAL_EXISTS == 'true') {
                            echo "âš ï¸  æ—¢å­˜ã®Credential '${env.JENKINS_CREDENTIAL_ID}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
                        } else {
                            echo "âœ… Credential '${env.JENKINS_CREDENTIAL_ID}' ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
                        }
                    } catch (Exception e) {
                        echo "Credentialç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}"
                        env.CREDENTIAL_EXISTS = 'false'
                    }
                }
            }
        }
        
        stage('Create/Update GitHub Deploy Key') {
            when {
                expression { params.ACTION in ['CREATE', 'UPDATE'] }
            }
            steps {
                script {
                    echo "\n=== GitHub Deploy Key ${params.ACTION} ==="
                    
                    try {
                        if (params.ACTION == 'UPDATE' && env.EXISTING_DEPLOY_KEY_ID) {
                            // æ—¢å­˜ã®Deploy Keyã‚’å‰Šé™¤
                            echo "æ—¢å­˜ã®Deploy Keyã‚’å‰Šé™¤ä¸­..."
                            gitUtils.deleteDeployKey(
                                env.EXISTING_DEPLOY_KEY_ID,
                                [repoUrl: params.REPO_URL]
                            )
                            echo "âœ… æ—¢å­˜ã®Deploy Keyå‰Šé™¤å®Œäº†"
                        }
                        
                        // æ–°ã—ã„Deploy Keyã‚’ä½œæˆ
                        echo "æ–°ã—ã„Deploy Keyã‚’ä½œæˆä¸­..."
                        def deployKeyResult = gitUtils.createDeployKey(
                            env.GITHUB_DEPLOY_KEY_TITLE,
                            env.PUBLIC_KEY_CONTENT,
                            params.READ_ONLY,
                            [repoUrl: params.REPO_URL]
                        )
                        
                        env.NEW_DEPLOY_KEY_ID = deployKeyResult.id.toString()
                        echo "âœ… Deploy Key ${params.ACTION}æˆåŠŸ:"
                        echo "   ID: ${env.NEW_DEPLOY_KEY_ID}"
                        echo "   Title: ${deployKeyResult.title}"
                        echo "   Read Only: ${deployKeyResult.read_only}"
                        echo "   Verified: ${deployKeyResult.verified}"
                        
                    } catch (Exception e) {
                        error "GitHub Deploy Key ${params.ACTION}ã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                }
            }
        }
        
        stage('Create/Update Jenkins Credential') {
            when {
                expression { params.ACTION in ['CREATE', 'UPDATE'] }
            }
            steps {
                script {
                    echo "\n=== Jenkins Credential ${params.ACTION} ==="
                    
                    try {
                        if (env.CREDENTIAL_EXISTS == 'true') {
                            // æ—¢å­˜ã®Credentialã‚’æ›´æ–°
                            echo "æ—¢å­˜ã®Credentialã‚’æ›´æ–°ä¸­..."
                            
                            def credentialXml = """<com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey>
  <scope>GLOBAL</scope>
  <id>${env.JENKINS_CREDENTIAL_ID}</id>
  <description>GitHub Deploy Key for ${env.REPO_OWNER}/${env.REPO_NAME} - Updated ${new Date()}</description>
  <username>git</username>
  <privateKeySource class="com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey\$DirectEntryPrivateKeySource">
    <privateKey>${env.PRIVATE_KEY_CONTENT}</privateKey>
  </privateKeySource>
</com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey>"""
                            
                            writeFile file: 'credential.xml', text: credentialXml
                            
                            jenkinsCliUtils.updateCredentialByXml(
                                params.CREDENTIAL_FOLDER,
                                params.CREDENTIAL_DOMAIN,
                                env.JENKINS_CREDENTIAL_ID,
                                'credential.xml'
                            )
                            echo "âœ… Credentialæ›´æ–°å®Œäº†"
                            
                        } else {
                            // æ–°è¦ä½œæˆ
                            echo "æ–°ã—ã„Credentialã‚’ä½œæˆä¸­..."
                            jenkinsCliUtils.createCredential(
                                params.CREDENTIAL_FOLDER,
                                params.CREDENTIAL_DOMAIN,
                                [
                                    type: 'sshKey',
                                    id: env.JENKINS_CREDENTIAL_ID,
                                    description: "GitHub Deploy Key for ${env.REPO_OWNER}/${env.REPO_NAME}",
                                    username: 'git',
                                    privateKey: env.PRIVATE_KEY_CONTENT
                                ]
                            )
                            echo "âœ… Credentialä½œæˆå®Œäº†"
                        }
                        
                    } catch (Exception e) {
                        error "Jenkins Credential ${params.ACTION}ã‚¨ãƒ©ãƒ¼: ${e.message}"
                    }
                }
            }
        }
        
        stage('Delete Resources') {
            when {
                expression { params.ACTION == 'DELETE' }
            }
            steps {
                script {
                    echo "\n=== ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ ==="
                    
                    def deletionResults = [:]
                    
                    // GitHub Deploy Keyå‰Šé™¤
                    echo "\n--- GitHub Deploy Keyå‰Šé™¤ ---"
                    try {
                        def deployKeys = gitUtils.findDeployKeysByTitle(
                            env.GITHUB_DEPLOY_KEY_TITLE,
                            [repoUrl: params.REPO_URL]
                        )
                        
                        if (deployKeys && deployKeys.size() > 0) {
                            deployKeys.each { key ->
                                try {
                                    gitUtils.deleteDeployKey(
                                        key.id.toString(),
                                        [repoUrl: params.REPO_URL]
                                    )
                                    echo "âœ… Deploy Keyå‰Šé™¤å®Œäº† (ID: ${key.id})"
                                    deletionResults['github_deploy_key'] = 'success'
                                } catch (Exception e) {
                                    echo "âŒ Deploy Keyå‰Šé™¤ã‚¨ãƒ©ãƒ¼ (ID: ${key.id}): ${e.message}"
                                    deletionResults['github_deploy_key'] = 'failed'
                                }
                            }
                        } else {
                            echo "å‰Šé™¤ã™ã‚‹Deploy KeyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                            deletionResults['github_deploy_key'] = 'not_found'
                        }
                    } catch (Exception e) {
                        echo "âŒ Deploy Keyæ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${e.message}"
                        deletionResults['github_deploy_key'] = 'error'
                    }
                    
                    // Jenkins Credentialå‰Šé™¤
                    echo "\n--- Jenkins Credentialå‰Šé™¤ ---"
                    try {
                        jenkinsCliUtils.deleteCredential(
                            params.CREDENTIAL_FOLDER,
                            params.CREDENTIAL_DOMAIN,
                            env.JENKINS_CREDENTIAL_ID
                        )
                        echo "âœ… Credentialå‰Šé™¤å®Œäº†"
                        deletionResults['jenkins_credential'] = 'success'
                    } catch (Exception e) {
                        if (e.message.contains('404')) {
                            echo "å‰Šé™¤ã™ã‚‹CredentialãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                            deletionResults['jenkins_credential'] = 'not_found'
                        } else {
                            echo "âŒ Credentialå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}"
                            deletionResults['jenkins_credential'] = 'failed'
                        }
                    }
                    
                    // å‰Šé™¤çµæœã‚µãƒãƒªãƒ¼
                    echo "\n=== å‰Šé™¤çµæœã‚µãƒãƒªãƒ¼ ==="
                    deletionResults.each { resource, status ->
                        def statusIcon = status == 'success' ? 'âœ…' : status == 'not_found' ? 'âš ï¸' : 'âŒ'
                        echo "${statusIcon} ${resource}: ${status}"
                    }
                }
            }
        }
        
        stage('Verify Setup') {
            when {
                expression { params.ACTION in ['CREATE', 'UPDATE'] }
            }
            steps {
                script {
                    echo "\n=== ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¤œè¨¼ ==="
                    
                    def verificationPassed = true
                    
                    // GitHub Deploy Keyæ¤œè¨¼
                    echo "\n--- GitHub Deploy Keyæ¤œè¨¼ ---"
                    try {
                        def deployKey = gitUtils.getDeployKey(
                            env.NEW_DEPLOY_KEY_ID,
                            [repoUrl: params.REPO_URL]
                        )
                        echo "âœ… Deploy Keyç¢ºèª:"
                        echo "   Title: ${deployKey.title}"
                        echo "   Read Only: ${deployKey.read_only}"
                        echo "   Verified: ${deployKey.verified}"
                        
                        if (deployKey.title != env.GITHUB_DEPLOY_KEY_TITLE) {
                            echo "âš ï¸  Deploy Keyã®ã‚¿ã‚¤ãƒˆãƒ«ãŒä¸€è‡´ã—ã¾ã›ã‚“"
                            verificationPassed = false
                        }
                        if (deployKey.read_only != params.READ_ONLY) {
                            echo "âš ï¸  Deploy Keyã®æ¨©é™è¨­å®šãŒä¸€è‡´ã—ã¾ã›ã‚“"
                            verificationPassed = false
                        }
                    } catch (Exception e) {
                        echo "âŒ Deploy Keyæ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${e.message}"
                        verificationPassed = false
                    }
                    
                    // Jenkins Credentialæ¤œè¨¼
                    echo "\n--- Jenkins Credentialæ¤œè¨¼ ---"
                    try {
                        def credXml = jenkinsCliUtils.getCredentialAsXml(
                            params.CREDENTIAL_FOLDER,
                            params.CREDENTIAL_DOMAIN,
                            env.JENKINS_CREDENTIAL_ID
                        )
                        if (credXml.contains(env.JENKINS_CREDENTIAL_ID)) {
                            echo "âœ… Credentialç¢ºèª: ${env.JENKINS_CREDENTIAL_ID}"
                        } else {
                            echo "âŒ CredentialãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                            verificationPassed = false
                        }
                    } catch (Exception e) {
                        echo "âŒ Credentialæ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${e.message}"
                        verificationPassed = false
                    }
                    
                    if (verificationPassed) {
                        echo "\nâœ… ã™ã¹ã¦ã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
                        echo "\n=== ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº† ==="
                        echo "GitHubãƒªãƒã‚¸ãƒˆãƒª: ${env.REPO_OWNER}/${env.REPO_NAME}"
                        echo "Deploy Key: ${env.GITHUB_DEPLOY_KEY_TITLE} (${params.READ_ONLY ? 'èª­ã¿å–ã‚Šå°‚ç”¨' : 'èª­ã¿æ›¸ãå¯èƒ½'})"
                        echo "Jenkins Credential: ${env.JENKINS_CREDENTIAL_ID}"
                        echo "\nJenkinsã‚¸ãƒ§ãƒ–ã§ã“ã®Credentialã‚’ä½¿ç”¨ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚"
                    } else {
                        error "æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                echo "\n=== ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ==="
                sh """
                    rm -f '${env.WORKSPACE}/${env.TEMP_KEY_FILE}' || true
                    rm -f '${env.WORKSPACE}/${env.TEMP_KEY_FILE_PUB}' || true
                    rm -f '${env.WORKSPACE}/credential.xml' || true
                """
                echo "ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
                
                // å®Ÿè¡Œã‚µãƒãƒªãƒ¼
                echo "\n=== å®Ÿè¡Œã‚µãƒãƒªãƒ¼ ==="
                echo "å®Ÿè¡Œæ—¥æ™‚: ${new Date()}"
                echo "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${params.ACTION}"
                echo "ãƒªãƒã‚¸ãƒˆãƒª: ${env.REPO_OWNER}/${env.REPO_NAME}"
                echo "Deploy Key: ${env.GITHUB_DEPLOY_KEY_TITLE}"
                echo "Credential ID: ${env.JENKINS_CREDENTIAL_ID}"
            }
        }
        
        success {
            echo "\nğŸ‰ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        }
        
        failure {
            echo "\nâŒ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        }
    }
}