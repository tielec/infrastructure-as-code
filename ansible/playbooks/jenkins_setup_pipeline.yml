---
# jenkins-setup-pipeline.yml
# Jenkins環境構築の全体フローを管理するプレイブック

- name: Jenkins Infrastructure Setup Pipeline
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    # 環境名はコマンドラインから指定可能
    env_name: "{{ env | default('dev') }}"
    # ベースとなるプロジェクト名 - all.ymlから取得せず直接定義
    project_name: "jenkins-infra"
    # リージョン設定
    aws_region_name: "ap-northeast-1"
    # Pulumiプロジェクトパス
    pulumi_path: "{{ playbook_dir }}/../../pulumi"
    
  tasks:
    - name: Display pipeline information
      ansible.builtin.debug:
        msg: |
          Jenkins Infrastructure Setup Pipeline
          ==================================
          Project: {{ project_name }}
          Environment: {{ env_name }}
          AWS Region: {{ aws_region_name }}
          
          Pulumi Projects:
          - Network: jenkins-network
          - Security: jenkins-security
    
    - name: Check Ansible version
      ansible.builtin.debug:
        msg: "Ansible version: {{ ansible_version.full }}"
    
    - name: Check if group_vars/all.yml exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../inventory/group_vars/all.yml"
      register: all_yml_check
    
    - name: Report group_vars/all.yml status
      ansible.builtin.debug:
        msg: "group_vars/all.yml file {{ 'exists' if all_yml_check.stat.exists else 'does not exist' }}"
    
    - name: Include group_vars/all.yml if exists
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../inventory/group_vars/all.yml"
      when: all_yml_check.stat.exists
      
    - name: Display project information after including all.yml
      ansible.builtin.debug:
        msg: |
          Project information after including all.yml:
          Project name: {{ infra.project_name | default('Not defined in all.yml') }}
          AWS Region: {{ infra.aws.default_region | default('Not defined in all.yml') }}
      when: all_yml_check.stat.exists
    
    - name: Check AWS credentials
      ansible.builtin.shell: aws sts get-caller-identity
      register: aws_identity
      changed_when: false
      ignore_errors: yes
      
    - name: Display AWS identity
      ansible.builtin.debug:
        msg: "AWS Identity: {{ aws_identity.stdout }}"
      when: aws_identity.rc == 0
      
    - name: Warning about AWS credentials
      ansible.builtin.debug:
        msg: "WARNING: AWS credentials not configured or not working properly"
      when: aws_identity.rc != 0
    
    # ネットワークインフラのデプロイ (明示的に変数を渡す)
    - name: Deploy Network Infrastructure
      ansible.builtin.include_tasks: 
        file: deploy_jenkins_network.yml
        apply:
          vars:
            # 変数名をリネームして自己参照を避ける
            network_project_name: "jenkins-network"
            project_name_value: "{{ project_name }}"  # 別名で渡す
            env_name_value: "{{ env_name }}"
            aws_region_name_value: "{{ aws_region_name }}"
      when: run_network | default(true) | bool
      
    # ネットワークデプロイが成功したらセキュリティグループをデプロイ
    - name: Deploy Security Groups
      ansible.builtin.include_tasks: 
        file: deploy_jenkins_security.yml
        apply:
          vars:
            # 変数名をリネームして自己参照を避ける
            security_project_name: "jenkins-security"
            network_project_name: "jenkins-network"
            project_name_value: "{{ project_name }}"  # 別名で渡す
            env_name_value: "{{ env_name }}"
            aws_region_name_value: "{{ aws_region_name }}"
      when: 
        - network_deployed is defined and network_deployed
        - run_security | default(true) | bool

    # デプロイメント結果サマリー
    - name: Deployment Summary
      ansible.builtin.debug:
        msg: |
          Jenkins Infrastructure Deployment Summary
          =======================================
          Network: {{ network_deployed | default(false) }}
          Security: {{ security_deployed | default(false) }}
          
          # 今後追加予定:
          # Storage: (Not deployed yet)
          # Load Balancer: (Not deployed yet)
          # Jenkins Controller: (Not deployed yet)
          # Jenkins Agent: (Not deployed yet)
          # Jenkins Application: (Not deployed yet)
