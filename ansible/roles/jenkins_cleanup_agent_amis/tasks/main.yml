---
# Main tasks file for cleanup_image_builder_amis

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - env_name is defined
      - aws_region is defined
      - retention_count is defined
      - retention_count | int >= safety_checks.minimum_retention | int
    fail_msg: "Required variables are not defined or retention_count is too low"

- name: Display cleanup configuration
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Image Builder AMI Cleanup Configuration"
      - "=========================================="
      - "Environment: {{ env_name }}"
      - "Region: {{ aws_region }}"
      - "Retention Count: {{ retention_count }}"
      - "Dry Run: {{ dry_run }}"
      - "Cleanup Targets:"
      - "  - AMIs: {{ cleanup_targets.amis }}"
      - "  - Snapshots: {{ cleanup_targets.snapshots }}"
      - "  - Image Builder Versions: {{ cleanup_targets.image_builder_versions }}"
      - "  - Image Builder Pipelines: {{ cleanup_targets.image_builder_pipelines }}"
      - "=========================================="

# AMIのクリーンアップ
- name: Cleanup AMIs and Snapshots
  ansible.builtin.include_tasks: cleanup_amis.yml
  when: cleanup_targets.amis or cleanup_targets.snapshots

# Image Builderイメージバージョンのクリーンアップ
- name: Cleanup Image Builder Versions
  ansible.builtin.include_tasks: cleanup_image_versions.yml
  when: cleanup_targets.image_builder_versions

# Image Builderパイプライン出力のクリーンアップ
- name: Cleanup Image Builder Pipeline Outputs
  ansible.builtin.include_tasks: cleanup_pipeline_outputs.yml
  when: cleanup_targets.image_builder_pipelines

# レポート生成
- name: Generate cleanup report
  ansible.builtin.include_tasks: generate_report.yml
  when: generate_report