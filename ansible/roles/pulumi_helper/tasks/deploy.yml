# Pulumiのデプロイ実行ヘルパータスク

# 認証処理を実行（既に認証済みの場合はスキップ）
- name: Ensure Pulumi authentication
  ansible.builtin.include_tasks: login.yml
  when: pulumi_authenticated is not defined

- name: Deploy with Pulumi
  block:
    # スタックが選択されているか確認
    - name: Ensure stack is selected
      ansible.builtin.shell: |
        cd {{ pulumi_project_path }}
        {{ pulumi_env_prefix }} && {{ pulumi_sudo_cmd }} stack --show-name || exit 1
      register: current_stack
      changed_when: false
      failed_when: current_stack.rc != 0
      when: not ansible_check_mode
    
    - name: Start deployment
      ansible.builtin.debug:
        msg: "Deploying stack '{{ current_stack.stdout }}' in {{ pulumi_project_path | basename }}"
      when: not ansible_check_mode
    
    # デプロイを実行
    - name: Run deployment
      ansible.builtin.shell: |
        cd {{ pulumi_project_path }}
        {{ pulumi_commands.up }}
      register: pulumi_up_result
      changed_when: "'No changes' not in pulumi_up_result.stdout"
      when: not ansible_check_mode
    
    # 変更があった場合のみ結果サマリーを表示
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: >-
          Deployment {{ 'completed with changes' if pulumi_up_result.changed else 'completed (no changes)' }}
      when: not ansible_check_mode
    
    # 詳細な結果はverbosity > 0の場合のみ
    - name: Display deployment details
      ansible.builtin.debug:
        msg: "{{ pulumi_up_result.stdout_lines[-20:] }}"  # 最後の20行のみ表示
      when: 
        - not ansible_check_mode 
        - ansible_verbosity > 0
        - pulumi_up_result.changed
    
    - name: Set success status
      ansible.builtin.set_fact:
        pulumi_deployment_succeeded: true
        
  rescue:
    - name: Report deployment failure
      ansible.builtin.debug:
        msg: |
          Deployment failed!
          {% if 'TypeScript' in pulumi_up_result.stdout | default('') %}
          Reason: TypeScript compilation errors
          {% elif 'unhandled exception' in pulumi_up_result.stdout | default('') %}
          Reason: Unhandled exception during deployment
          {% else %}
          Error code: {{ pulumi_up_result.rc | default('unknown') }}
          {% endif %}
    
    # エラー詳細はverbosity > 0の場合のみ
    - name: Display error details
      ansible.builtin.debug:
        msg: |
          Error output:
          {{ pulumi_up_result.stdout_lines[-50:] | join('\n') }}
      when: 
        - ansible_verbosity > 0
        - pulumi_up_result is defined
        - pulumi_up_result.stdout is defined
    
    - name: Set failure status
      ansible.builtin.set_fact:
        pulumi_deployment_failed: true
    
    - name: Fail the playbook
      ansible.builtin.fail:
        msg: "Pulumi deployment failed. Run with -v for more details."

# チェックモード
- name: Mock deploy (check mode)
  ansible.builtin.debug:
    msg: "Would deploy with Pulumi (check mode)"
  when: ansible_check_mode
