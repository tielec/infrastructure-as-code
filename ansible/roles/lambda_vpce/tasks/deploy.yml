---
# Lambda API VPCエンドポイントのデプロイタスク

- name: Display VPC endpoints deployment information
  ansible.builtin.debug:
    msg: |
      Deploying Lambda API VPC Endpoints:
      - Project: {{ project_name }}
      - VPC Endpoints Pulumi Project: {{ vpce_project_name }}
      - Environment: {{ env_name }}
      - Endpoints to create: {{ vpc_endpoints | join(', ') }}

# Pulumiデプロイ
- name: Deploy VPC Endpoints with Pulumi
  block:
    # Pulumiヘルパータスクを呼び出す
    - name: Initialize VPC endpoints stack
      ansible.builtin.include_role:
        name: pulumi_helper
        tasks_from: init_stack
      vars:
        pulumi_project_path: "{{ pulumi_path }}/lambda-vpce"
        stack_name: "{{ env_name }}"
    
    - name: Configure VPC endpoints stack - AWS region
      ansible.builtin.include_role:
        name: pulumi_helper
        tasks_from: set_config
      vars:
        pulumi_project_path: "{{ pulumi_path }}/lambda-vpce"
        config_key: "aws:region"
        config_value: "{{ aws_region_name }}"
    
    # Pulumiプレビュー
    - name: Preview VPC endpoints deployment
      ansible.builtin.include_role:
        name: pulumi_helper
        tasks_from: preview
      vars:
        pulumi_project_path: "{{ pulumi_path }}/lambda-vpce"
      when: preview_only | default(false) | bool
    
    # Pulumiデプロイ
    - name: Deploy VPC endpoints stack
      ansible.builtin.include_role:
        name: pulumi_helper
        tasks_from: deploy
      vars:
        pulumi_project_path: "{{ pulumi_path }}/lambda-vpce"
      when: not preview_only | default(false) | bool
    
    # デプロイ成功を示す変数設定
    - name: Set VPC endpoints deployment status
      ansible.builtin.set_fact:
        vpce_deployed: true
      when: not preview_only | default(false) | bool
    
    # SSMから作成されたVPCエンドポイント情報を取得（オプション）
    - name: Get S3 VPC Endpoint ID from SSM
      ansible.builtin.include_role:
        name: ssm_parameter_store
        tasks_from: get_parameter
      vars:
        parameter_name: "/{{ project_name }}/{{ env_name }}/vpce/endpoints/s3-id"
        store_as: "s3_vpce_id"
        default_value: ""
        ssm_parameter_store_fail_on_missing: false
      when: 
        - not preview_only | default(false) | bool
        - "'s3' in vpc_endpoints"
    
    # VPCエンドポイント情報の表示
    - name: Display VPC endpoints deployment summary
      ansible.builtin.debug:
        msg: |
          VPC Endpoints deployment successful:
          - Endpoints configured: {{ vpc_endpoints | join(', ') }}
          {% if s3_vpce_id is defined and s3_vpce_id | length > 0 %}
          - S3 Endpoint ID: {{ s3_vpce_id }}
          {% endif %}
      when: 
        - vpce_deployed is defined and vpce_deployed
  
  rescue:
    - name: Display error on VPC endpoints deployment
      ansible.builtin.debug:
        msg: "Failed to deploy Lambda API VPC endpoints. See error details above."
      
    - name: Set VPC endpoints deployment failure
      ansible.builtin.set_fact:
        vpce_deployed: false
      
    - name: Fail the playbook
      ansible.builtin.fail:
        msg: "Lambda API VPC endpoints deployment failed."
