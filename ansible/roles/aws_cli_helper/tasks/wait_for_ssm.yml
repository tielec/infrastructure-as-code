---
# SSMエージェントが準備完了になるまで待機
#
# 必須変数:
#   - instance_id: 対象のEC2インスタンスID
#
# オプション変数:
#   - max_wait_time: 最大待機時間（秒） (default: 300)
#   - check_interval: チェック間隔（秒） (default: 10)
#   - target_status: 期待するステータス (default: "Online")
#   - aws_region: AWSリージョン (default: aws_cli_helper_region)

- name: Set SSM wait parameters
  ansible.builtin.set_fact:
    _ssm_max_wait: "{{ max_wait_time | default(300) }}"
    _ssm_interval: "{{ check_interval | default(10) }}"
    _ssm_target_status: "{{ target_status | default('Online') }}"
    _ssm_region: "{{ aws_region | default(aws_cli_helper_region) }}"
    _ssm_max_attempts: "{{ ((max_wait_time | default(300) | int) / (check_interval | default(10) | int)) | int }}"
    _ssm_current_attempt: 0

- name: Wait for SSM agent to be ready
  block:
    - name: Check SSM agent status loop
      ansible.builtin.include_tasks: _ssm_check_loop.yml

    - name: Verify SSM agent is ready
      ansible.builtin.assert:
        that:
          - ssm_agent_ready | default(false)
        fail_msg: "SSM agent did not become ready within {{ _ssm_max_wait }} seconds"
        success_msg: "SSM agent is ready on instance {{ instance_id }}"

  rescue:
    - name: Get current SSM status for debugging
      ansible.builtin.include_tasks: execute.yml
      vars:
        aws_command: "aws ssm describe-instance-information --instance-information-filter-list key=InstanceIds,valueSet={{ instance_id }} --output json"
        operation_name: "Get SSM debug info for {{ instance_id }}"
        parse_output: true
      ignore_errors: true

    - name: Display SSM agent status
      ansible.builtin.debug:
        msg: |
          SSM agent is not ready on instance {{ instance_id }}
          Current status: {{ ssm_agent_status | default('Unknown') }}
          Debug info: {{ aws_cli_data | default('No debug info available') }}
          
    - name: Fail with detailed error
      ansible.builtin.fail:
        msg: "SSM agent did not become ready within {{ _ssm_max_wait }} seconds for instance {{ instance_id }}"