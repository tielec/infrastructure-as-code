---
# 内部用: リトライループの実装

- name: Increment retry counter
  ansible.builtin.set_fact:
    aws_cli_helper_retry_attempt: "{{ (aws_cli_helper_retry_attempt | int) + 1 }}"

- name: Retry loop iteration
  when: not aws_cli_helper_retry_success and (aws_cli_helper_retry_attempt | int) <= (max_attempts | int)
  block:
    - name: Execute AWS command
      ansible.builtin.include_tasks: execute.yml

    - name: Check if retry is needed
      ansible.builtin.set_fact:
        aws_cli_helper_retry_should_retry: >-
          {{
            not aws_cli_success and
            aws_cli_error_type | default('') in aws_cli_helper_retriable_errors and
            (aws_cli_helper_retry_attempt | int) < (max_attempts | int)
          }}

    - name: Mark success if no retry needed
      ansible.builtin.set_fact:
        aws_cli_helper_retry_success: "{{ aws_cli_success }}"
      when: not aws_cli_helper_retry_should_retry

    - name: Calculate retry delay
      when: aws_cli_helper_retry_should_retry
      ansible.builtin.set_fact:
        aws_cli_helper_retry_wait: >-
          {%- if use_backoff | default(aws_cli_helper_retry_backoff) -%}
            {{ [(retry_delay | default(aws_cli_helper_retry_delay) | int) * (2 ** ((aws_cli_helper_retry_attempt | int) - 1)),
                aws_cli_helper_retry_max_delay | int] | min }}
          {%- else -%}
            {{ retry_delay | default(aws_cli_helper_retry_delay) | int }}
          {%- endif -%}

    - name: Wait before retry
      when: aws_cli_helper_retry_should_retry
      ansible.builtin.pause:
        seconds: "{{ aws_cli_helper_retry_wait | int }}"
        prompt: "Retrying after {{ aws_cli_helper_retry_wait }} seconds (attempt {{ aws_cli_helper_retry_attempt }}/{{ max_attempts }})"

    - name: Continue retry loop
      when: aws_cli_helper_retry_should_retry
      ansible.builtin.include_tasks: _retry_loop.yml

# 最終的なリトライ情報を整数として設定
- name: Set final retry status
  ansible.builtin.set_fact:
    aws_cli_retry_attempts: "{{ aws_cli_helper_retry_attempt | int }}"
    aws_cli_retry_exhausted: "{{ not aws_cli_helper_retry_success and (aws_cli_helper_retry_attempt | int) >= (max_attempts | int) }}"
