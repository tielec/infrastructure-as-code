name: JenkinsAgentSetup-arm64
description: Install and configure Jenkins Agent dependencies for ARM64
schemaVersion: 1.0

phases:
  - name: build
    steps:
      - name: ExpandEBSVolume
        action: ExecuteBash
        inputs:
          commands:
            - echo "Expanding EBS volume to use full capacity..."
            - |
              # ルートデバイスの情報を取得
              ROOT_DEVICE=$(df / | tail -1 | awk '{print $1}')
              echo "Root device: $ROOT_DEVICE"
              
              # デバイス名からパーティション番号を取得
              if [[ "$ROOT_DEVICE" =~ nvme ]]; then
                  DEVICE_NAME=$(echo "$ROOT_DEVICE" | sed 's/p[0-9]*$//')
                  PARTITION_NUM=$(echo "$ROOT_DEVICE" | grep -o '[0-9]*$')
              else
                  DEVICE_NAME=$(echo "$ROOT_DEVICE" | sed 's/[0-9]*$//')
                  PARTITION_NUM=$(echo "$ROOT_DEVICE" | grep -o '[0-9]*$')
              fi
              
              # cloud-utils-growpartのインストール
              dnf install -y cloud-utils-growpart || yum install -y cloud-utils-growpart
              
              # パーティションの拡張
              growpart "$DEVICE_NAME" "$PARTITION_NUM" || echo "Partition might already be expanded"
              
              # ファイルシステムの拡張
              FS_TYPE=$(blkid -o value -s TYPE "$ROOT_DEVICE")
              if [[ "$FS_TYPE" =~ ext[234] ]]; then
                  resize2fs "$ROOT_DEVICE"
              elif [[ "$FS_TYPE" == "xfs" ]]; then
                  xfs_growfs -d /
              fi
              
              echo "Disk usage after expansion:"
              df -h /

      - name: UpdateSystem
        action: ExecuteBash
        inputs:
          commands:
            - echo "Starting Jenkins Agent setup for ARM64"
            - dnf update -y

      - name: InstallBasicPackages
        action: ExecuteBash
        inputs:
          commands:
            - dnf install -y git jq wget tar gzip unzip which
            - dnf install -y amazon-ssm-agent

      - name: InstallDocker
        action: ExecuteBash
        inputs:
          commands:
            - dnf install -y docker
            - systemctl enable docker
            - groupadd -f docker
            - chmod 666 /var/run/docker.sock || true

      - name: InstallJava
        action: ExecuteBash
        inputs:
          commands:
            - dnf install -y java-21-amazon-corretto
            - java -version

      - name: InstallBuildTools
        action: ExecuteBash
        inputs:
          commands:
            - dnf install -y gcc gcc-c++ make
            - dnf install -y python3 python3-pip
            - pip3 install --upgrade pip

      - name: InstallNodeJS
        action: ExecuteBash
        inputs:
          commands:
            - curl -sL https://rpm.nodesource.com/setup_20.x | bash -
            - dnf install -y nodejs
            - node --version
            - npm --version
            - npm install -g npm@latest
            - npm install -g typescript
            - npm install -g ts-node

      - name: InstallAWSCLIv2
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing AWS CLI v2 for ARM64..."
            - cd /tmp
            - curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"
            - unzip -q awscliv2.zip
            - ./aws/install
            - rm -rf aws awscliv2.zip
            - aws --version

      - name: InstallGitHubCLI
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing GitHub CLI..."
            - |
              # GitHub CLIのリポジトリ追加
              cat <<EOF > /etc/yum.repos.d/gh-cli.repo
              [gh-cli]
              name=packages by the GitHub CLI team
              baseurl=https://cli.github.com/packages/rpm
              enabled=1
              gpgkey=https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x23F3D4EA75716059
              gpgcheck=1
              EOF
            - dnf install -y gh
            - gh --version

      - name: ConfigureGit
        action: ExecuteBash
        inputs:
          commands:
            - echo "Configuring Git..."
            - git config --global --add safe.directory '*'
            - git config --global user.name "Jenkins"
            - git config --global user.email "jenkins@tielec.local"
            - git config --global --list

      - name: InstallCodexCLI
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing Codex CLI..."
            - npm install -g @openai/codex
            - codex --version || echo "Codex CLI installed"

      - name: SetupAIWorkflowAgent
        action: ExecuteBash
        inputs:
          commands:
            - echo "Setting up AI Workflow Agent project..."
            - mkdir -p /opt
            - cd /opt
            - |
              # プロジェクトクローン
              REPO_URL="https://github.com/tielec/ai-workflow-agent.git"
              BRANCH="main"
              PROJECT_DIR="/opt/ai-workflow-agent"

              echo "Cloning repository from ${REPO_URL}..."
              git clone --branch ${BRANCH} --depth 1 ${REPO_URL}

              cd ${PROJECT_DIR}

              # 依存関係インストール（Claudeを含む）
              echo "Installing project dependencies (including Claude SDK)..."
              npm install --production=false

              # TypeScriptビルド
              echo "Building TypeScript sources..."
              npm run build

              # ディレクトリ権限設定（Jenkins実行ユーザーからアクセス可能に）
              chmod -R 755 ${PROJECT_DIR}

              # ビルド成果物確認
              if [ -d "${PROJECT_DIR}/dist" ]; then
                  echo "Project built successfully"
                  ls -lh ${PROJECT_DIR}/dist/index.js
              else
                  echo "ERROR: Build failed - dist directory not found"
                  exit 1
              fi

              # node_modules サイズ確認
              NODE_MODULES_SIZE=$(du -sh ${PROJECT_DIR}/node_modules 2>/dev/null | cut -f1 || echo "unknown")
              echo "node_modules size: ${NODE_MODULES_SIZE}"

              # Claude SDK インストール確認
              if [ -d "${PROJECT_DIR}/node_modules/@anthropic-ai/claude-agent-sdk" ]; then
                  CLAUDE_SDK_VERSION=$(cat ${PROJECT_DIR}/node_modules/@anthropic-ai/claude-agent-sdk/package.json | grep '"version"' | cut -d'"' -f4)
                  echo "✅ Claude Agent SDK v${CLAUDE_SDK_VERSION} installed"
              else
                  echo "⚠️  Claude Agent SDK not found in node_modules"
              fi

      - name: InstallPulumi
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing Pulumi..."
            - curl -fsSL https://get.pulumi.com | sh
            - echo "Finding pulumi binary..."
            - find / -name pulumi -type f 2>/dev/null | head -1 || true
            - |
              # Pulumiバイナリと言語プラグインをシステム全体で利用可能にする
              if [ -d "/.pulumi/bin" ]; then
                cp -r /.pulumi/bin/* /usr/local/bin/ || echo "Failed to copy from /.pulumi/bin"
              elif [ -d "/root/.pulumi/bin" ]; then
                cp -r /root/.pulumi/bin/* /usr/local/bin/ || echo "Failed to copy from /root/.pulumi/bin"
              elif [ -d "/home/ec2-user/.pulumi/bin" ]; then
                cp -r /home/ec2-user/.pulumi/bin/* /usr/local/bin/ || echo "Failed to copy from /home/ec2-user/.pulumi/bin"
              fi
            - chmod 755 /usr/local/bin/pulumi* || true
            - /usr/local/bin/pulumi version
            - |
              # Node.js言語プラグインを明示的にインストール
              /usr/local/bin/pulumi plugin install language nodejs || true
              # プラグインの確認
              /usr/local/bin/pulumi plugin ls

      - name: InstallAnsible
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing Ansible..."
            - pip3 install ansible ansible-core
            - ansible --version

      - name: InstallMitogen
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing Mitogen for Ansible..."
            - pip3 install mitogen
            - python3 -c "import ansible_mitogen" && echo "Mitogen installed successfully"

      - name: InstallCloudWatchAgent
        action: ExecuteBash
        inputs:
          commands:
            - echo "Installing CloudWatch Agent..."
            - dnf install -y amazon-cloudwatch-agent
            - rpm -q amazon-cloudwatch-agent

      - name: ConfigureCloudWatchAgent
        action: ExecuteBash
        inputs:
          commands:
            - echo "Configuring CloudWatch Agent..."
            - mkdir -p /opt/aws/amazon-cloudwatch-agent/etc
            - |
              cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << 'EOF'
              __CWAGENT_CONFIG__
              EOF
            - cat /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

      - name: ValidateCloudWatchAgentConfig
        action: ExecuteBash
        inputs:
          commands:
            - echo "Validating CloudWatch Agent configuration with Translator..."
            - |
              set -e
              CONFIG_PATH="/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json"
              TRANSLATOR="/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-config-translator"
              OUTPUT_PATH="/tmp/cwagent.translated.json"
              if [ ! -x "$TRANSLATOR" ]; then
                echo "ERROR: Translator not found at $TRANSLATOR"
                exit 1
              fi
              "$TRANSLATOR" -input /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -format json -output /tmp/cwagent.translated.json
            - cat /tmp/cwagent.translated.json

      - name: EnableCloudWatchAgent
        action: ExecuteBash
        inputs:
          commands:
            - echo "Enabling CloudWatch Agent service..."
            - systemctl enable amazon-cloudwatch-agent
            - echo "CloudWatch Agent will start automatically on instance boot"

      - name: PullDockerImages
        action: ExecuteBash
        inputs:
          commands:
            - echo "===== Docker Image Pre-pulling for faster job startup ====="
            - echo "Starting Docker daemon..."
            - systemctl start docker
            - sleep 5
            - 'systemctl is-active docker || (echo "ERROR: Docker daemon is not running" && exit 1)'
            - echo "Docker daemon is running. Starting image pull..."
            - echo "Pulling Python images..."
            - 'docker pull python:3.11-slim || echo "WARNING: Failed to pull python:3.11-slim"'
            - echo "Pulling Node.js images..."
            - 'docker pull node:18-slim || echo "WARNING: Failed to pull node:18-slim"'
            - 'docker pull node:20-slim || echo "WARNING: Failed to pull node:20-slim"'
            - echo "Pulling Rust images..."
            - 'docker pull rust:1.76-slim || echo "WARNING: Failed to pull rust:1.76-slim"'
            - 'docker pull rust:slim || echo "WARNING: Failed to pull rust:slim"'
            - echo "Pulling AWS CLI image..."
            - 'docker pull amazon/aws-cli:latest || echo "WARNING: Failed to pull amazon/aws-cli:latest"'
            - echo "Pulling Pulumi image..."
            - 'docker pull pulumi/pulumi:latest || echo "WARNING: Failed to pull pulumi/pulumi:latest"'
            - echo "Pulling Ubuntu image..."
            - 'docker pull ubuntu:22.04 || echo "WARNING: Failed to pull ubuntu:22.04"'
            - echo "Pulling Python + Node.js combined image..."
            - 'docker pull nikolaik/python-nodejs:python3.11-nodejs20 || echo "WARNING: Failed to pull nikolaik/python-nodejs:python3.11-nodejs20"'
            - echo "===== Verifying pulled images ====="
            - docker images
            - echo "===== Docker image pre-pulling completed successfully ====="

      - name: CreateJenkinsUser
        action: ExecuteBash
        inputs:
          commands:
            - useradd -m -d /home/jenkins -s /bin/bash jenkins || true
            - usermod -aG docker jenkins
            - newgrp docker || true
            - mkdir -p /home/jenkins/agent
            - mkdir -p /home/jenkins/.docker
            - mkdir -p /home/jenkins/.pulumi/plugins
            - |
              # Pulumiプラグインをjenkinsユーザーにもコピー
              if [ -d "/usr/local/bin" ]; then
                cp /usr/local/bin/pulumi* /home/jenkins/.pulumi/plugins/ 2>/dev/null || true
              fi
              # Pulumiバイナリへのシンボリックリンク作成
              ln -sf /usr/local/bin/pulumi /home/jenkins/.pulumi/bin/pulumi 2>/dev/null || true
              mkdir -p /home/jenkins/.pulumi/bin
            - chown -R jenkins:jenkins /home/jenkins
            - echo '{"group":"docker"}' > /etc/docker/daemon.json || true
            - chmod 666 /var/run/docker.sock || true
            - |
              # jenkinsユーザーの環境変数設定
              echo 'export PATH="/usr/local/bin:$PATH"' >> /home/jenkins/.bashrc
              echo 'export PULUMI_SKIP_UPDATE_CHECK=true' >> /home/jenkins/.bashrc

      - name: SetupSwap
        action: ExecuteBash
        inputs:
          commands:
            - dd if=/dev/zero of=/swapfile bs=1M count=2048
            - chmod 600 /swapfile
            - mkswap /swapfile
            - echo '/swapfile none swap sw 0 0' >> /etc/fstab

      - name: CleanupCache
        action: ExecuteBash
        inputs:
          commands:
            - dnf clean all
            - rm -rf /var/cache/dnf
            - rm -rf /tmp/*

  - name: validate
    steps:
      - name: ValidateInstallation
        action: ExecuteBash
        inputs:
          commands:
            - java -version
            - docker --version
            - git --version
            - node --version
            - npm --version
            - python3 --version
            - echo "Checking AWS CLI v2..."
            - aws --version
            - echo "Checking GitHub CLI..."
            - gh --version
            - echo "Checking Git configuration..."
            - git config --global --list
            - echo "Checking Codex CLI..."
            - codex --version || echo "Codex CLI installed"
            - echo "Checking AI Workflow Agent project..."
            - test -d /opt/ai-workflow-agent
            - test -f /opt/ai-workflow-agent/dist/index.js
            - echo "AI Workflow Agent project is ready"
            - pulumi version
            - ansible --version
            - echo "Checking Mitogen installation..."
            - python3 -m ansible_mitogen || echo "Mitogen module check completed"
            - echo "Checking CloudWatch Agent installation..."
            - amazon-cloudwatch-agent-ctl --version
            - test -f /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
            - echo "CloudWatch Agent configuration:"
            - cat /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
            - systemctl is-enabled amazon-cloudwatch-agent
