# テストシナリオ - Issue #305: AI Workflow Jenkins統合完成とPhase終了後の自動commit & push機能

## 1. テスト戦略サマリー

### 1.1 選択されたテスト戦略

**UNIT_INTEGRATION** (Phase 2で決定)

### 1.2 テスト対象の範囲

| コンポーネント | テスト種別 | 優先度 |
|--------------|-----------|--------|
| GitManagerクラス | Unit | 高 |
| BasePhase拡張（Git操作統合） | Unit | 高 |
| Git Workflow統合 | Integration | 高 |
| Jenkins Phase 1-7実行 | Integration | 高 |
| End-to-End Workflow | Integration | 中 |

### 1.3 テストの目的

1. **Git自動commit & push機能の検証**
   - GitManagerクラスの各メソッドが正しく動作すること
   - Phase完了後に成果物が自動的にcommit & pushされること
   - エラーハンドリング（リトライ、失敗時の継続）が正しく機能すること

2. **Jenkins統合の検証**
   - Phase 1-7がJenkins環境で正常に実行されること
   - Docker環境内でPython実行が正常に動作すること
   - 環境変数が正しく設定・伝達されること

3. **品質保証**
   - 既存Phase実装との互換性を確保すること
   - Git操作失敗時もPhaseが継続すること
   - セキュリティ要件（認証情報の保護）を満たすこと

## 2. Unitテストシナリオ

### 2.1 GitManagerクラス - create_commit_message()

#### UT-GM-001: コミットメッセージ生成（正常系）

**目的**: 規定フォーマットでコミットメッセージが生成されることを検証

**前提条件**:
- GitManagerインスタンスが初期化済み
- metadata.jsonに以下のデータが存在:
  - issue_number: 305
  - phase_number: "01"
  - phase_name: "requirements"

**入力**:
```python
phase_name = "requirements"
status = "completed"
review_result = "PASS"
```

**期待結果**:
```
[ai-workflow] Phase 1 (requirements) - completed

Issue: #305
Phase: 1 (requirements)
Status: completed
Review: PASS

Auto-generated by AI Workflow
```

**テストデータ**: 上記入力パラメータ

**検証ポイント**:
- [ ] 1行目のフォーマットが正しい
- [ ] Issue番号が正しく含まれる
- [ ] Phase番号がゼロパディング除去される（"01" → "1"）
- [ ] Statusが正しく含まれる
- [ ] Review結果が正しく含まれる

---

#### UT-GM-002: コミットメッセージ生成（レビュー未実施）

**目的**: レビュー未実施時に"N/A"が設定されることを検証

**前提条件**: UT-GM-001と同じ

**入力**:
```python
phase_name = "requirements"
status = "completed"
review_result = None
```

**期待結果**:
```
Review: N/A
```
の行が含まれること

**テストデータ**: 上記入力パラメータ

**検証ポイント**:
- [ ] review_result=Noneの場合、"N/A"が設定される
- [ ] その他のフォーマットは変わらない

---

#### UT-GM-003: コミットメッセージ生成（失敗ステータス）

**目的**: Phase失敗時のメッセージが正しく生成されることを検証

**前提条件**: UT-GM-001と同じ

**入力**:
```python
phase_name = "implementation"
status = "failed"
review_result = "FAIL"
```

**期待結果**:
```
[ai-workflow] Phase 4 (implementation) - failed

Issue: #305
Phase: 4 (implementation)
Status: failed
Review: FAIL

Auto-generated by AI Workflow
```

**テストデータ**: 上記入力パラメータ

**検証ポイント**:
- [ ] ステータスが"failed"と表示される
- [ ] Review結果が"FAIL"と表示される

---

### 2.2 GitManagerクラス - commit_phase_output()

#### UT-GM-004: Phase成果物のcommit（正常系）

**目的**: .ai-workflow/issue-305/ 配下のファイルが正しくcommitされることを検証

**前提条件**:
- Git リポジトリが初期化済み
- 以下のファイルが変更状態:
  - `.ai-workflow/issue-305/01_requirements/output/requirements.md`
  - `.ai-workflow/issue-305/01_requirements/execute/agent_log.md`
  - `README.md` (対象外)

**入力**:
```python
phase_name = "requirements"
status = "completed"
review_result = "PASS"
```

**期待結果**:
```python
{
    'success': True,
    'commit_hash': '1a2b3c4d...',  # 実際のコミットハッシュ
    'files_committed': [
        '.ai-workflow/issue-305/01_requirements/output/requirements.md',
        '.ai-workflow/issue-305/01_requirements/execute/agent_log.md'
    ],
    'error': None
}
```

**テストデータ**: テスト用Gitリポジトリ（一時ディレクトリ）

**検証ポイント**:
- [ ] `.ai-workflow/issue-305/` 配下のファイルのみcommitされる
- [ ] `README.md`はcommit対象外
- [ ] commit_hashが返される
- [ ] files_committedに正しいファイルリストが含まれる
- [ ] success=True

---

#### UT-GM-005: Phase成果物のcommit（ファイル0件）

**目的**: コミット対象ファイルが0件の場合、スキップされることを検証

**前提条件**:
- Git リポジトリが初期化済み
- 変更ファイルが存在しない（クリーン状態）

**入力**:
```python
phase_name = "requirements"
status = "completed"
review_result = "PASS"
```

**期待結果**:
```python
{
    'success': True,
    'commit_hash': None,
    'files_committed': [],
    'error': None
}
```

**テストデータ**: クリーンなテスト用Gitリポジトリ

**検証ポイント**:
- [ ] success=True（エラーではない）
- [ ] commit_hash=None（コミット未実行）
- [ ] files_committed=[]（空リスト）
- [ ] エラーメッセージなし

---

#### UT-GM-006: Phase成果物のcommit（Git未初期化エラー）

**目的**: Gitリポジトリが存在しない場合、エラーが返されることを検証

**前提条件**:
- Gitリポジトリが初期化されていない
- `.git/` ディレクトリが存在しない

**入力**:
```python
phase_name = "requirements"
status = "completed"
review_result = "PASS"
```

**期待結果**:
```python
{
    'success': False,
    'commit_hash': None,
    'files_committed': [],
    'error': 'Git repository not found: ...'
}
```

**テストデータ**: Git未初期化ディレクトリ

**検証ポイント**:
- [ ] success=False
- [ ] エラーメッセージが適切
- [ ] commit_hash=None
- [ ] files_committed=[]

---

### 2.3 GitManagerクラス - push_to_remote()

#### UT-GM-007: リモートリポジトリへのpush（正常系）

**目的**: リモートリポジトリへのpushが成功することを検証

**前提条件**:
- Gitリポジトリが初期化済み
- リモートリポジトリが設定済み（origin）
- 未pushのコミットが存在する
- リモートリポジトリへの認証情報が設定済み

**入力**:
```python
max_retries = 3
retry_delay = 2.0
```

**期待結果**:
```python
{
    'success': True,
    'retries': 0,  # リトライなし
    'error': None
}
```

**テストデータ**: テスト用リモートリポジトリ（モック）

**検証ポイント**:
- [ ] success=True
- [ ] retries=0（1回で成功）
- [ ] エラーなし
- [ ] リモートリポジトリにcommitが反映される

---

#### UT-GM-008: リモートリポジトリへのpush（リトライ成功）

**目的**: ネットワークエラー時にリトライして成功することを検証

**前提条件**:
- UT-GM-007と同じ
- 1回目のpushは失敗（ネットワークタイムアウト）
- 2回目のpushは成功

**入力**:
```python
max_retries = 3
retry_delay = 0.1  # テスト高速化のため短縮
```

**期待結果**:
```python
{
    'success': True,
    'retries': 1,  # 1回リトライして成功
    'error': None
}
```

**テストデータ**: ネットワークエラーをシミュレートするモック

**検証ポイント**:
- [ ] success=True（最終的に成功）
- [ ] retries=1（1回リトライ）
- [ ] リトライ間隔が正しい（retry_delay秒）
- [ ] エラーなし

---

#### UT-GM-009: リモートリポジトリへのpush（権限エラー）

**目的**: 権限エラー時にリトライせず即座にエラーを返すことを検証

**前提条件**:
- UT-GM-007と同じ
- リモートリポジトリへのpush権限がない

**入力**:
```python
max_retries = 3
retry_delay = 0.1
```

**期待結果**:
```python
{
    'success': False,
    'retries': 0,  # リトライしない
    'error': 'Permission denied: ...'
}
```

**テストデータ**: 権限エラーをシミュレートするモック

**検証ポイント**:
- [ ] success=False
- [ ] retries=0（リトライしない）
- [ ] エラーメッセージが適切
- [ ] 即座にエラーを返す（リトライしない）

---

#### UT-GM-010: リモートリポジトリへのpush（最大リトライ超過）

**目的**: 最大リトライ回数を超えた場合、エラーを返すことを検証

**前提条件**:
- UT-GM-007と同じ
- すべてのpush試行が失敗（ネットワークエラー）

**入力**:
```python
max_retries = 3
retry_delay = 0.1
```

**期待結果**:
```python
{
    'success': False,
    'retries': 3,  # 3回リトライ
    'error': 'Max retries exceeded: ...'
}
```

**テストデータ**: 常にネットワークエラーを返すモック

**検証ポイント**:
- [ ] success=False
- [ ] retries=3（最大リトライ回数）
- [ ] エラーメッセージが適切
- [ ] 3回リトライ後にエラーを返す

---

### 2.4 GitManagerクラス - get_status()

#### UT-GM-011: Git状態確認（クリーン状態）

**目的**: クリーンな状態のGit情報が取得できることを検証

**前提条件**:
- Gitリポジトリが初期化済み
- 未コミットの変更がない
- ブランチ: feature/issue-305

**入力**: なし

**期待結果**:
```python
{
    'branch': 'feature/issue-305',
    'is_dirty': False,
    'untracked_files': [],
    'modified_files': []
}
```

**テストデータ**: クリーンなテスト用Gitリポジトリ

**検証ポイント**:
- [ ] ブランチ名が正しい
- [ ] is_dirty=False
- [ ] untracked_files=[]
- [ ] modified_files=[]

---

#### UT-GM-012: Git状態確認（変更あり）

**目的**: 未コミットの変更がある場合の情報が取得できることを検証

**前提条件**:
- Gitリポジトリが初期化済み
- 未追跡ファイル: `new_file.md`
- 変更ファイル: `existing_file.md`

**入力**: なし

**期待結果**:
```python
{
    'branch': 'feature/issue-305',
    'is_dirty': True,
    'untracked_files': ['new_file.md'],
    'modified_files': ['existing_file.md']
}
```

**テストデータ**: 変更ありのテスト用Gitリポジトリ

**検証ポイント**:
- [ ] is_dirty=True
- [ ] untracked_filesに未追跡ファイルが含まれる
- [ ] modified_filesに変更ファイルが含まれる

---

### 2.5 BasePhaseクラス - _auto_commit_and_push()

#### UT-BP-001: Git自動commit & push（成功）

**目的**: Phase完了後にGit操作が正常に実行されることを検証

**前提条件**:
- BasePhaseインスタンスが初期化済み
- GitManagerインスタンスが正常動作
- Phase成果物が存在

**入力**:
```python
git_manager = MockGitManager(commit_success=True, push_success=True)
status = "completed"
review_result = "PASS"
```

**期待結果**:
- `commit_phase_output()` が1回呼ばれる
- `push_to_remote()` が1回呼ばれる
- ログに成功メッセージが出力される
- 例外が発生しない

**テストデータ**: モックGitManager

**検証ポイント**:
- [ ] commit_phase_output()が呼ばれる
- [ ] push_to_remote()が呼ばれる
- [ ] ログメッセージが適切
- [ ] 例外が発生しない

---

#### UT-BP-002: Git自動commit & push（commit失敗）

**目的**: commit失敗時にログ記録してPhaseは継続することを検証

**前提条件**: UT-BP-001と同じ

**入力**:
```python
git_manager = MockGitManager(commit_success=False, commit_error="Git commit failed")
status = "completed"
review_result = "PASS"
```

**期待結果**:
- `commit_phase_output()` が1回呼ばれる
- `push_to_remote()` が呼ばれない（commitが失敗したため）
- ログに警告メッセージが出力される
- 例外が発生しない（Phase継続）

**テストデータ**: モックGitManager

**検証ポイント**:
- [ ] commit_phase_output()が呼ばれる
- [ ] push_to_remote()が呼ばれない
- [ ] 警告ログが出力される
- [ ] 例外が発生しない

---

#### UT-BP-003: Git自動commit & push（push失敗）

**目的**: push失敗時にログ記録してPhaseは継続することを検証

**前提条件**: UT-BP-001と同じ

**入力**:
```python
git_manager = MockGitManager(commit_success=True, push_success=False, push_error="Network error")
status = "completed"
review_result = "PASS"
```

**期待結果**:
- `commit_phase_output()` が1回呼ばれる
- `push_to_remote()` が1回呼ばれる
- ログに警告メッセージが出力される
- 例外が発生しない（Phase継続）

**テストデータ**: モックGitManager

**検証ポイント**:
- [ ] commit_phase_output()が呼ばれる
- [ ] push_to_remote()が呼ばれる
- [ ] 警告ログが出力される
- [ ] 例外が発生しない

---

#### UT-BP-004: Git自動commit & push（Phase失敗時）

**目的**: Phase失敗時もGit操作が実行されることを検証

**前提条件**: UT-BP-001と同じ

**入力**:
```python
git_manager = MockGitManager(commit_success=True, push_success=True)
status = "failed"
review_result = "FAIL"
```

**期待結果**:
- `commit_phase_output()` が1回呼ばれる
- status="failed"が渡される
- review_result="FAIL"が渡される
- コミットメッセージに"failed"と"FAIL"が含まれる

**テストデータ**: モックGitManager

**検証ポイント**:
- [ ] Phase失敗時もGit操作が実行される
- [ ] statusが正しく渡される
- [ ] review_resultが正しく渡される

---

### 2.6 GitManagerクラス - _filter_phase_files()

#### UT-GM-013: ファイルフィルタリング（正常系）

**目的**: .ai-workflow/issue-305/ 配下のファイルのみフィルタリングされることを検証

**前提条件**: GitManagerインスタンスが初期化済み

**入力**:
```python
files = [
    '.ai-workflow/issue-305/01_requirements/output/requirements.md',
    '.ai-workflow/issue-305/02_design/output/design.md',
    'README.md',
    'scripts/ai-workflow/main.py',
    '.ai-workflow/issue-304/01_requirements/output/requirements.md'
]
issue_number = 305
```

**期待結果**:
```python
[
    '.ai-workflow/issue-305/01_requirements/output/requirements.md',
    '.ai-workflow/issue-305/02_design/output/design.md'
]
```

**テストデータ**: 上記ファイルリスト

**検証ポイント**:
- [ ] `.ai-workflow/issue-305/` 配下のファイルのみ含まれる
- [ ] `README.md`は除外される
- [ ] `scripts/ai-workflow/main.py`は除外される
- [ ] `.ai-workflow/issue-304/` 配下のファイルは除外される

---

#### UT-GM-014: ファイルフィルタリング（0件）

**目的**: 対象ファイルが0件の場合、空リストが返されることを検証

**前提条件**: UT-GM-013と同じ

**入力**:
```python
files = [
    'README.md',
    'scripts/ai-workflow/main.py'
]
issue_number = 305
```

**期待結果**:
```python
[]
```

**テストデータ**: 上記ファイルリスト

**検証ポイント**:
- [ ] 空リストが返される
- [ ] エラーが発生しない

---

### 2.7 GitManagerクラス - _is_retriable_error()

#### UT-GM-015: リトライ可能エラーの判定（ネットワークエラー）

**目的**: ネットワークエラーがリトライ可能と判定されることを検証

**前提条件**: GitManagerインスタンスが初期化済み

**入力**:
```python
error = TimeoutError("Network timeout")
```

**期待結果**: `True`

**テストデータ**: TimeoutError例外

**検証ポイント**:
- [ ] Trueが返される
- [ ] ネットワークタイムアウトがリトライ可能と判定される

---

#### UT-GM-016: リトライ可能エラーの判定（権限エラー）

**目的**: 権限エラーがリトライ不可能と判定されることを検証

**前提条件**: UT-GM-015と同じ

**入力**:
```python
error = PermissionError("Permission denied")
```

**期待結果**: `False`

**テストデータ**: PermissionError例外

**検証ポイント**:
- [ ] Falseが返される
- [ ] 権限エラーがリトライ不可能と判定される

---

#### UT-GM-017: リトライ可能エラーの判定（認証エラー）

**目的**: 認証エラーがリトライ不可能と判定されることを検証

**前提条件**: UT-GM-015と同じ

**入力**:
```python
error = GitCommandError("Authentication failed")
```

**期待結果**: `False`

**テストデータ**: GitCommandError例外（Authentication）

**検証ポイント**:
- [ ] Falseが返される
- [ ] 認証エラーがリトライ不可能と判定される

---

## 3. Integrationテストシナリオ

### 3.1 Git Workflow統合

#### IT-GW-001: Phase実行からGit commit & pushまでの完全フロー

**シナリオ名**: Phase実行 → Git自動commit & push

**目的**: Phase実行完了後、成果物が自動的にcommit & pushされることを検証

**前提条件**:
- 実際のGitリポジトリが存在（テスト用ブランチ）
- 認証情報が設定済み
- Phase実行環境が整っている

**テスト手順**:
1. テスト用のIssueディレクトリを作成（例: issue-999）
2. Phase 1（requirements）を実行
   ```bash
   python main.py execute --phase requirements --issue 999
   ```
3. レビューを実行
   ```bash
   python main.py review --phase requirements --issue 999
   ```
4. Git状態を確認
   ```bash
   git status
   git log -1
   ```
5. リモートリポジトリを確認

**期待結果**:
- [ ] Phase実行が成功する
- [ ] `.ai-workflow/issue-999/01_requirements/` 配下にファイルが生成される
- [ ] Gitコミットが作成される
- [ ] コミットメッセージが規定フォーマットに従う
- [ ] リモートリポジトリにpushされる
- [ ] その他のファイル（README.md等）は含まれない

**確認項目**:
- [ ] `git log -1 --pretty=format:"%s"`がコミットメッセージ1行目を表示
- [ ] `git log -1 --pretty=format:"%b"`がコミットメッセージ本文を表示
- [ ] `git diff HEAD~1 --name-only`が`.ai-workflow/issue-999/` 配下のみ表示
- [ ] リモートリポジトリに反映されている

---

#### IT-GW-002: Phase失敗時のGit commit

**シナリオ名**: Phase失敗 → Git自動commit

**目的**: Phase失敗時も成果物がcommitされることを検証

**前提条件**: IT-GW-001と同じ

**テスト手順**:
1. テスト用のIssueディレクトリを作成
2. 意図的にPhase失敗を引き起こす（例: 無効なIssue番号）
3. Git状態を確認

**期待結果**:
- [ ] Phase実行が失敗する
- [ ] 途中まで生成されたファイルがcommitされる
- [ ] コミットメッセージに"failed"が含まれる
- [ ] リモートリポジトリにpushされる
- [ ] Phase実行エラーとGit操作は独立している

**確認項目**:
- [ ] コミットメッセージに`Status: failed`が含まれる
- [ ] `.ai-workflow/issue-XXX/` 配下の生成済みファイルがcommitされる

---

#### IT-GW-003: Git push失敗時のリトライ

**シナリオ名**: Git push失敗 → リトライ → 成功

**目的**: ネットワークエラー時にリトライして成功することを検証

**前提条件**:
- IT-GW-001と同じ
- ネットワークエラーをシミュレート可能（モック or 手動）

**テスト手順**:
1. Phase実行準備
2. ネットワークエラーをシミュレート（1回目のpush失敗）
3. Phase実行
4. ログを確認

**期待結果**:
- [ ] 1回目のpushが失敗する
- [ ] リトライが実行される
- [ ] 2回目以降のpushが成功する
- [ ] ログに"Retrying push..."メッセージが出力される
- [ ] 最終的にリモートリポジトリに反映される

**確認項目**:
- [ ] ログに"Retrying push (attempt X/3)"が表示される
- [ ] 最終的にpushが成功する
- [ ] リモートリポジトリに反映されている

---

#### IT-GW-004: 複数Phase実行時のGit commit

**シナリオ名**: Phase 1 → Phase 2 → Phase 3（複数Phase連続実行）

**目的**: 複数Phaseを連続実行した場合、各Phaseごとにcommitされることを検証

**前提条件**: IT-GW-001と同じ

**テスト手順**:
1. Phase 1実行 → Git commit確認
2. Phase 2実行 → Git commit確認
3. Phase 3実行 → Git commit確認
4. Git履歴を確認
   ```bash
   git log --oneline -3
   ```

**期待結果**:
- [ ] 各Phase実行後にcommitが作成される
- [ ] 3つのcommitが作成される
- [ ] 各commitメッセージが適切（Phase 1, Phase 2, Phase 3）
- [ ] すべてのcommitがリモートリポジトリにpushされる

**確認項目**:
- [ ] `git log --oneline -3`が3つのcommitを表示
- [ ] 各commitメッセージが規定フォーマットに従う
- [ ] Phase番号が正しい（1, 2, 3）

---

### 3.2 Jenkins統合

#### IT-JK-001: Jenkins Phase 1実行（Docker環境）

**シナリオ名**: Jenkins Phase 1実行

**目的**: Jenkins環境でPhase 1が正常に実行されることを検証

**前提条件**:
- Jenkinsジョブ（ai-workflow-orchestrator）がデプロイ済み
- Docker環境が利用可能
- Jenkins Credentialsに以下が登録済み:
  - CLAUDE_CODE_OAUTH_TOKEN
  - GITHUB_TOKEN

**テスト手順**:
1. Jenkinsジョブを手動実行
   - パラメータ: ISSUE_NUMBER=999, PHASE_START=1, PHASE_END=1, SKIP_REVIEW=false
2. ジョブログを確認
3. 成果物を確認（`.ai-workflow/issue-999/01_requirements/`）
4. Git履歴を確認

**期待結果**:
- [ ] ジョブが成功する（Build #XX: SUCCESS）
- [ ] Docker環境内でPython実行される
- [ ] Phase 1の成果物が生成される
- [ ] レビューが実行される
- [ ] Git commit & pushが実行される
- [ ] Jenkins Workspaceにファイルがマウントされる

**確認項目**:
- [ ] ジョブログに`Stage: Phase 1 - Requirements Definition`が表示される
- [ ] ジョブログに`main.py execute --phase requirements --issue 999`が表示される
- [ ] ジョブログに`main.py review --phase requirements --issue 999`が表示される
- [ ] ジョブログに`Git commit successful`が表示される
- [ ] ジョブログに`Git push successful`が表示される

---

#### IT-JK-002: Jenkins Phase 1-7完全実行

**シナリオ名**: Jenkins Phase 1-7完全実行

**目的**: Jenkins環境でPhase 1-7がすべて正常に実行されることを検証

**前提条件**: IT-JK-001と同じ

**テスト手順**:
1. Jenkinsジョブを手動実行
   - パラメータ: ISSUE_NUMBER=999, PHASE_START=1, PHASE_END=7, SKIP_REVIEW=false
2. 各Stageの実行状態を確認
3. 最終成果物を確認
4. Git履歴を確認（7つのcommit）

**期待結果**:
- [ ] すべてのStageが成功する
- [ ] Phase 1-7の成果物が生成される
- [ ] 各Phase後にレビューが実行される
- [ ] 7つのGit commitが作成される
- [ ] リモートリポジトリに反映される
- [ ] 最終レポート（Phase 7）が生成される

**確認項目**:
- [ ] ジョブログに7つのStageログが表示される
- [ ] 各Stageが緑（成功）
- [ ] `.ai-workflow/issue-999/` 配下に7つのPhaseディレクトリが存在
- [ ] `git log --oneline -7`が7つのcommitを表示
- [ ] 各commitメッセージが規定フォーマットに従う

---

#### IT-JK-003: Jenkins環境変数の検証

**シナリオ名**: Jenkins環境変数が正しく設定されることを検証

**目的**: Docker環境内で環境変数が正しく渡されることを検証

**前提条件**: IT-JK-001と同じ

**テスト手順**:
1. Jenkinsジョブを実行
2. ジョブログで環境変数を確認
3. Docker環境内で環境変数を確認

**期待結果**:
- [ ] `CLAUDE_CODE_OAUTH_TOKEN`が設定される（マスク表示）
- [ ] `GITHUB_TOKEN`が設定される（マスク表示）
- [ ] `GITHUB_REPOSITORY`が設定される
- [ ] `ISSUE_NUMBER`が設定される
- [ ] Docker環境内で環境変数が利用可能

**確認項目**:
- [ ] ジョブログに環境変数が表示される（トークンはマスク）
- [ ] ジョブログに`ISSUE_NUMBER=999`が表示される
- [ ] ジョブログに`GITHUB_REPOSITORY=tielec/infrastructure-as-code`が表示される
- [ ] Docker環境内で`echo $ISSUE_NUMBER`が動作する

---

#### IT-JK-004: Jenkins Phase実行失敗時の動作

**シナリオ名**: Phase失敗時のJenkins動作検証

**目的**: Phase失敗時にパイプライン全体が失敗することを検証

**前提条件**: IT-JK-001と同じ

**テスト手順**:
1. 意図的にPhase失敗を引き起こす（無効なIssue番号等）
2. ジョブの失敗を確認
3. Git commit状態を確認

**期待結果**:
- [ ] Phase Stageが失敗する
- [ ] パイプライン全体が失敗する（Build #XX: FAILURE）
- [ ] 後続のStageは実行されない
- [ ] Git commitは実行される（失敗時も記録）
- [ ] エラーメッセージがログに表示される

**確認項目**:
- [ ] ジョブステータスが`FAILURE`
- [ ] 失敗したStageが赤で表示される
- [ ] Git commitが作成される（Status: failed）
- [ ] ジョブログにエラーメッセージが表示される

---

#### IT-JK-005: Jenkins SKIP_REVIEWパラメータの検証

**シナリオ名**: SKIP_REVIEW=trueの場合、レビューがスキップされることを検証

**目的**: レビュースキップオプションが正しく動作することを検証

**前提条件**: IT-JK-001と同じ

**テスト手順**:
1. Jenkinsジョブを実行
   - パラメータ: SKIP_REVIEW=true
2. ジョブログを確認
3. 成果物を確認

**期待結果**:
- [ ] Phase実行は成功する
- [ ] レビューステップがスキップされる
- [ ] `main.py review`が呼ばれない
- [ ] Git commit & pushは実行される
- [ ] コミットメッセージのReviewが"N/A"

**確認項目**:
- [ ] ジョブログに`Skipping review`が表示される
- [ ] ジョブログに`main.py review`が表示されない
- [ ] `.ai-workflow/issue-XXX/XX_phase/review/`が存在しない（レビュー未実行）
- [ ] Git commitメッセージに`Review: N/A`が含まれる

---

### 3.3 End-to-End Workflow

#### IT-E2E-001: GitHub Issue → Jenkins実行 → Git commit & push

**シナリオ名**: 完全なワークフロー実行

**目的**: GitHub IssueからJenkins実行、Git commit & pushまでの完全フローを検証

**前提条件**:
- GitHub Issueが存在（Issue #999）
- Jenkinsジョブがデプロイ済み
- Git認証情報が設定済み

**テスト手順**:
1. GitHub Issueを作成（Issue #999）
2. Jenkinsジョブを実行（ISSUE_NUMBER=999）
3. 各Phaseの実行を確認
4. GitHubリポジトリで成果物を確認
5. GitHub Issueでレポートを確認（Phase 7）

**期待結果**:
- [ ] すべてのPhaseが成功する
- [ ] 各Phase完了後にGit commitされる
- [ ] GitHubリポジトリに成果物が反映される
- [ ] Phase 7完了後、GitHub Issueにレポートが投稿される
- [ ] コミット履歴が適切に管理される

**確認項目**:
- [ ] GitHub Issueが存在する
- [ ] Jenkinsジョブが成功する
- [ ] GitHubリポジトリの`.ai-workflow/issue-999/` 配下にファイルが存在
- [ ] GitHub Issueにレポートコメントが投稿される
- [ ] `git log --grep="ai-workflow" --oneline -7`が7つのcommitを表示

---

## 4. テストデータ

### 4.1 Git テストデータ

#### テスト用Gitリポジトリ構造

```
test_repo/
├── .git/
├── .ai-workflow/
│   ├── issue-305/
│   │   ├── 01_requirements/
│   │   │   ├── output/
│   │   │   │   └── requirements.md
│   │   │   ├── execute/
│   │   │   │   └── agent_log.md
│   │   │   └── review/
│   │   │       └── result.md
│   │   ├── 02_design/
│   │   │   └── output/
│   │   │       └── design.md
│   │   └── metadata.json
│   └── issue-304/
│       └── (他のIssueデータ)
├── README.md
└── scripts/
    └── ai-workflow/
        └── main.py
```

#### metadata.json サンプル

```json
{
  "issue_number": 305,
  "issue_title": "AI Workflow: Jenkins統合完成とPhase終了後の自動commit & push機能",
  "created_at": "2025-01-15T10:00:00Z",
  "phases": {
    "01_requirements": {
      "phase_number": "01",
      "phase_name": "requirements",
      "status": "completed",
      "review_result": "PASS"
    }
  }
}
```

### 4.2 Jenkinsテストデータ

#### ジョブパラメータ（正常系）

```
ISSUE_NUMBER: 999
PHASE_START: 1
PHASE_END: 7
SKIP_REVIEW: false
COST_LIMIT_USD: 100.0
```

#### ジョブパラメータ（レビュースキップ）

```
ISSUE_NUMBER: 999
PHASE_START: 1
PHASE_END: 1
SKIP_REVIEW: true
COST_LIMIT_USD: 100.0
```

### 4.3 コミットメッセージサンプル

#### Phase成功時

```
[ai-workflow] Phase 1 (requirements) - completed

Issue: #305
Phase: 1 (requirements)
Status: completed
Review: PASS

Auto-generated by AI Workflow
```

#### Phase失敗時

```
[ai-workflow] Phase 4 (implementation) - failed

Issue: #305
Phase: 4 (implementation)
Status: failed
Review: FAIL

Auto-generated by AI Workflow
```

#### レビュー未実施時

```
[ai-workflow] Phase 1 (requirements) - completed

Issue: #305
Phase: 1 (requirements)
Status: completed
Review: N/A

Auto-generated by AI Workflow
```

### 4.4 モック/スタブデータ

#### MockGitManager

```python
class MockGitManager:
    def __init__(self, commit_success=True, push_success=True, commit_error=None, push_error=None):
        self.commit_success = commit_success
        self.push_success = push_success
        self.commit_error = commit_error
        self.push_error = push_error
        self.commit_called = False
        self.push_called = False

    def commit_phase_output(self, phase_name, status, review_result=None):
        self.commit_called = True
        if self.commit_success:
            return {
                'success': True,
                'commit_hash': 'abc123',
                'files_committed': ['.ai-workflow/issue-305/01_requirements/output/requirements.md'],
                'error': None
            }
        else:
            return {
                'success': False,
                'commit_hash': None,
                'files_committed': [],
                'error': self.commit_error
            }

    def push_to_remote(self):
        self.push_called = True
        if self.push_success:
            return {
                'success': True,
                'retries': 0,
                'error': None
            }
        else:
            return {
                'success': False,
                'retries': 3,
                'error': self.push_error
            }
```

## 5. テスト環境要件

### 5.1 Unitテスト環境

| 項目 | 要件 |
|-----|------|
| **実行環境** | ローカル開発環境、CI/CD（GitHub Actions） |
| **Python** | 3.8以上 |
| **テストフレームワーク** | pytest 7.0以上 |
| **カバレッジツール** | pytest-cov |
| **モックライブラリ** | unittest.mock, pytest-mock |
| **Git** | 2.30以上 |

### 5.2 Integrationテスト環境

| 項目 | 要件 |
|-----|------|
| **実行環境** | Jenkins環境、ローカルDocker環境 |
| **Docker** | 20.10以上 |
| **Jenkins** | 2.400以上 |
| **Gitリポジトリ** | テスト用リモートリポジトリ（GitHub） |
| **認証情報** | SSH鍵またはPersonal Access Token |
| **外部サービス** | GitHub API、Claude Code API |

### 5.3 モック/スタブの必要性

#### Unitテストでモックが必要なもの

- **GitPythonのRepoオブジェクト**: テスト用Gitリポジトリで代替可能だが、エラーケースのテストでモック使用
- **ネットワーク接続**: push時のネットワークエラーをシミュレート
- **ファイルシステム**: 一時ディレクトリ（tempfile）を使用

#### Integrationテストでモックが必要なもの

- **Claude Code API**: 実際のAPI呼び出しはコスト・時間がかかるため、特定のケースでモック
- **GitHub API**: レート制限回避のため、一部モック使用

#### モック不要なもの（実際のリソース使用）

- **Gitリポジトリ**: テスト用ブランチで実際のGit操作を検証
- **Jenkinsジョブ**: 実際のJenkins環境で実行
- **Docker環境**: 実際のDockerコンテナで実行

### 5.4 テスト実行コマンド

#### Unitテスト

```bash
# 全Unitテスト実行
pytest tests/unit/ -v

# GitManagerのみ
pytest tests/unit/core/test_git_manager.py -v

# カバレッジ測定
pytest tests/unit/core/test_git_manager.py --cov=scripts.ai-workflow.core.git_manager --cov-report=html
```

#### Integrationテスト

```bash
# 全Integrationテスト実行
pytest tests/integration/ -v

# Git Workflow統合テストのみ
pytest tests/integration/test_git_workflow.py -v
```

#### Jenkinsテスト

```
# Jenkins Web UIから手動実行
ジョブ: ai-workflow-orchestrator
パラメータ: ISSUE_NUMBER=999, PHASE_START=1, PHASE_END=7
```

## 6. テストカバレッジ目標

### 6.1 Unitテストカバレッジ

| コンポーネント | 目標カバレッジ | 優先度 |
|--------------|----------------|--------|
| GitManager | 80%以上 | 高 |
| BasePhase（Git操作部分） | 80%以上 | 高 |

### 6.2 Integrationテストカバレッジ

| 統合ポイント | 必須テストシナリオ数 | 優先度 |
|------------|---------------------|--------|
| Git Workflow | 4シナリオ | 高 |
| Jenkins統合 | 5シナリオ | 高 |
| End-to-End | 1シナリオ | 中 |

## 7. 品質ゲート確認

### ✅ Phase 2の戦略に沿ったテストシナリオである

- [ ] **確認**: UNIT_INTEGRATION戦略に基づき、Unitテスト（17件）とIntegrationテスト（10件）を作成
- [ ] **Unitテスト**: GitManagerクラス（13件）、BasePhaseクラス（4件）
- [ ] **Integrationテスト**: Git Workflow（4件）、Jenkins統合（5件）、E2E（1件）
- [ ] BDDシナリオは作成していない（戦略に含まれないため）

### ✅ 主要な正常系がカバーされている

**正常系テストケース**:

- [x] UT-GM-001: コミットメッセージ生成（正常系）
- [x] UT-GM-004: Phase成果物のcommit（正常系）
- [x] UT-GM-007: リモートリポジトリへのpush（正常系）
- [x] UT-GM-011: Git状態確認（クリーン状態）
- [x] UT-BP-001: Git自動commit & push（成功）
- [x] IT-GW-001: Phase実行からGit commit & pushまでの完全フロー
- [x] IT-JK-001: Jenkins Phase 1実行
- [x] IT-JK-002: Jenkins Phase 1-7完全実行
- [x] IT-E2E-001: GitHub Issue → Jenkins実行 → Git commit & push

### ✅ 主要な異常系がカバーされている

**異常系テストケース**:

- [x] UT-GM-006: Git未初期化エラー
- [x] UT-GM-009: リモートリポジトリへのpush（権限エラー）
- [x] UT-GM-010: リモートリポジトリへのpush（最大リトライ超過）
- [x] UT-BP-002: Git自動commit & push（commit失敗）
- [x] UT-BP-003: Git自動commit & push（push失敗）
- [x] IT-GW-002: Phase失敗時のGit commit
- [x] IT-GW-003: Git push失敗時のリトライ
- [x] IT-JK-004: Jenkins Phase実行失敗時の動作

### ✅ 期待結果が明確である

**すべてのテストケースで以下を明記**:

- [x] 具体的な入力値
- [x] 期待される出力値
- [x] 検証ポイント（チェックリスト形式）
- [x] テストデータ

**例（UT-GM-001）**:

```
入力: phase_name = "requirements", status = "completed", review_result = "PASS"
期待結果:
  [ai-workflow] Phase 1 (requirements) - completed

  Issue: #305
  Phase: 1 (requirements)
  Status: completed
  Review: PASS

  Auto-generated by AI Workflow

検証ポイント:
  - [ ] 1行目のフォーマットが正しい
  - [ ] Issue番号が正しく含まれる
  - [ ] Phase番号がゼロパディング除去される
  - [ ] Statusが正しく含まれる
  - [ ] Review結果が正しく含まれる
```

## 8. 要件との対応表

### 8.1 機能要件とテストシナリオの対応

| 機能要件 | 対応するテストシナリオ | 備考 |
|---------|---------------------|------|
| **FR-01: GitManagerコンポーネント実装** | UT-GM-001～UT-GM-017 | Unitテストで全メソッドをカバー |
| **FR-02: BasePhaseへのGit操作統合** | UT-BP-001～UT-BP-004 | Unitテストで統合部分を検証 |
| **FR-03: コミットメッセージフォーマット** | UT-GM-001, UT-GM-002, UT-GM-003 | 各パターンを網羅 |
| **FR-04: GitPython依存関係** | （インストール検証） | pytest実行時に自動検証 |
| **FR-05: Phase 1-7実行ステージ実装** | IT-JK-001, IT-JK-002 | Jenkins統合テストで検証 |
| **FR-06: 環境変数の追加** | IT-JK-003 | Jenkins環境変数検証 |
| **FR-07: Docker環境での実行** | IT-JK-001, IT-JK-002 | Docker実行検証 |
| **FR-08: GitManager Unitテスト** | UT-GM-001～UT-GM-017 | 本テストシナリオ自体 |
| **FR-09: Jenkins Job手動実行テスト** | IT-JK-001～IT-JK-005 | Jenkins統合テスト |

### 8.2 非機能要件とテストシナリオの対応

| 非機能要件 | 対応するテストシナリオ | 備考 |
|----------|---------------------|------|
| **NFR-01: Git操作パフォーマンス** | IT-GW-001 | 実行時間を測定（30秒以内） |
| **NFR-02: Jenkins実行時間** | IT-JK-002 | 全Phase実行時間を測定（2時間以内） |
| **NFR-03: 認証情報の管理** | IT-JK-003 | 環境変数マスキング確認 |
| **NFR-05: エラーハンドリング** | UT-GM-008, UT-GM-010, IT-GW-003 | リトライ機能検証 |
| **NFR-06: 冪等性** | IT-GW-004 | 複数回実行検証 |

### 8.3 受け入れ基準とテストシナリオの対応

| 受け入れ基準 | 対応するテストシナリオ | 備考 |
|----------|---------------------|------|
| **AC-01: Git自動commit & push機能** | IT-GW-001, IT-GW-002 | 完全フロー検証 |
| **AC-02: Jenkins Phase実行** | IT-JK-002 | Phase 1-7実行検証 |
| **AC-03: エラーハンドリング** | UT-GM-008, UT-GM-010, IT-GW-003 | リトライ検証 |
| **AC-04: テストカバレッジ** | （全Unitテスト） | 80%以上を目標 |
| **AC-06: エンドツーエンドテスト** | IT-E2E-001 | 完全ワークフロー検証 |

## 9. テスト実行計画

### 9.1 実装フェーズ別のテスト実行順序

#### Phase 1: GitManager実装

**実行するテスト**:
- [ ] UT-GM-001～UT-GM-017（GitManager Unitテスト）
- [ ] カバレッジ測定（目標: 80%以上）

#### Phase 2: BasePhase拡張

**実行するテスト**:
- [ ] UT-BP-001～UT-BP-004（BasePhase Unitテスト）
- [ ] IT-GW-001～IT-GW-004（Git Workflow統合テスト）

#### Phase 3: Jenkins統合

**実行するテスト**:
- [ ] IT-JK-001～IT-JK-005（Jenkins統合テスト）
- [ ] IT-E2E-001（End-to-Endテスト）

### 9.2 優先度別のテスト実行

#### 優先度: 高（必須）

**Phase 4（実装フェーズ）移行前に必ず実行**:

- [x] UT-GM-001: コミットメッセージ生成（正常系）
- [x] UT-GM-004: Phase成果物のcommit（正常系）
- [x] UT-GM-007: リモートリポジトリへのpush（正常系）
- [x] UT-BP-001: Git自動commit & push（成功）
- [x] IT-GW-001: Phase実行からGit commit & pushまでの完全フロー
- [x] IT-JK-001: Jenkins Phase 1実行

#### 優先度: 中（推奨）

**Phase 5（テストフェーズ）で実行**:

- [x] UT-GM-005～UT-GM-017（残りのUnitテスト）
- [x] UT-BP-002～UT-BP-004（エラーケース）
- [x] IT-GW-002～IT-GW-004（Git Workflow）
- [x] IT-JK-002～IT-JK-005（Jenkins）

#### 優先度: 低（オプション）

**Phase 5（テストフェーズ）で時間があれば実行**:

- [x] IT-E2E-001（End-to-Endテスト）
- [x] パフォーマンステスト
- [x] セキュリティテスト

## 10. テスト成功基準

### 10.1 Unitテスト成功基準

- [ ] すべてのUnitテストが成功（0 failed）
- [ ] GitManagerクラスのカバレッジが80%以上
- [ ] BasePhaseクラス（Git操作部分）のカバレッジが80%以上
- [ ] 実行時間が5分以内

### 10.2 Integrationテスト成功基準

- [ ] すべてのIntegrationテストが成功（0 failed）
- [ ] Git commit & pushが実際のリポジトリで動作
- [ ] Jenkins Phase 1-7が正常実行
- [ ] 実行時間が30分以内（Jenkins Phase 1-7は2時間以内）

### 10.3 全体的な成功基準

- [ ] すべてのテストが成功
- [ ] 品質ゲート4項目をすべて満たす
- [ ] 要件定義書の受け入れ基準（AC-01～AC-06）をすべて満たす
- [ ] セキュリティ要件（NFR-03, NFR-04）を満たす
- [ ] パフォーマンス要件（NFR-01, NFR-02）を満たす

---

## 付録

### A. テスト実行ログサンプル

#### Unitテスト実行ログ

```
$ pytest tests/unit/core/test_git_manager.py -v

============================= test session starts ==============================
platform linux -- Python 3.8.10, pytest-7.0.0, pluggy-1.0.0
collected 17 items

tests/unit/core/test_git_manager.py::test_create_commit_message_success PASSED     [  5%]
tests/unit/core/test_git_manager.py::test_create_commit_message_no_review PASSED   [ 11%]
tests/unit/core/test_git_manager.py::test_create_commit_message_failed PASSED      [ 17%]
tests/unit/core/test_git_manager.py::test_commit_phase_output_success PASSED       [ 23%]
tests/unit/core/test_git_manager.py::test_commit_phase_output_no_files PASSED      [ 29%]
tests/unit/core/test_git_manager.py::test_commit_phase_output_git_not_found PASSED [ 35%]
tests/unit/core/test_git_manager.py::test_push_to_remote_success PASSED            [ 41%]
tests/unit/core/test_git_manager.py::test_push_to_remote_retry PASSED              [ 47%]
tests/unit/core/test_git_manager.py::test_push_to_remote_permission_error PASSED   [ 52%]
tests/unit/core/test_git_manager.py::test_push_to_remote_max_retries PASSED        [ 58%]
tests/unit/core/test_git_manager.py::test_get_status_clean PASSED                  [ 64%]
tests/unit/core/test_git_manager.py::test_get_status_dirty PASSED                  [ 70%]
tests/unit/core/test_git_manager.py::test_filter_phase_files PASSED                [ 76%]
tests/unit/core/test_git_manager.py::test_filter_phase_files_empty PASSED          [ 82%]
tests/unit/core/test_git_manager.py::test_is_retriable_error_network PASSED        [ 88%]
tests/unit/core/test_git_manager.py::test_is_retriable_error_permission PASSED     [ 94%]
tests/unit/core/test_git_manager.py::test_is_retriable_error_auth PASSED           [100%]

========================= 17 passed in 2.34s ===============================

---------- coverage: platform linux, python 3.8.10-final-0 ----------
Name                                      Stmts   Miss  Cover
-------------------------------------------------------------
scripts/ai-workflow/core/git_manager.py      85      8    91%
-------------------------------------------------------------
TOTAL                                        85      8    91%
```

#### Integrationテスト実行ログ

```
$ pytest tests/integration/test_git_workflow.py -v

============================= test session starts ==============================
collected 4 items

tests/integration/test_git_workflow.py::test_phase_execution_with_git_commit PASSED      [ 25%]
tests/integration/test_git_workflow.py::test_phase_failure_with_git_commit PASSED        [ 50%]
tests/integration/test_git_workflow.py::test_git_push_retry_on_network_error PASSED      [ 75%]
tests/integration/test_git_workflow.py::test_multiple_phases_execution PASSED            [100%]

========================= 4 passed in 45.12s ===============================
```

### B. Jenkinsジョブ実行ログサンプル

```
Started by user admin
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins in /var/jenkins_home/workspace/ai-workflow-orchestrator
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Phase 1: Requirements)
[Pipeline] echo
=========================================
Stage: Phase 1 - Requirements Definition
=========================================
[Pipeline] dir
Running in /var/jenkins_home/workspace/ai-workflow-orchestrator/scripts/ai-workflow
[Pipeline] {
[Pipeline] sh
+ /usr/bin/python3 main.py execute --phase requirements --issue 999
[INFO] Executing Phase: requirements
[INFO] Git commit successful: abc123
[INFO] Files committed: ['.ai-workflow/issue-999/01_requirements/output/requirements.md']
[INFO] Git push successful (retries: 0)
[Pipeline] }
[Pipeline] // dir
[Pipeline] }
[Pipeline] // stage
[Pipeline] End of Pipeline
Finished: SUCCESS
```

### C. 参考資料

- **GitPython ドキュメント**: https://gitpython.readthedocs.io/
- **pytest ドキュメント**: https://docs.pytest.org/
- **Jenkins Pipeline ドキュメント**: https://www.jenkins.io/doc/book/pipeline/
- **要件定義書**: `.ai-workflow/issue-305/01_requirements/output/requirements.md`
- **設計書**: `.ai-workflow/issue-305/02_design/output/design.md`

---

**作成日**: 2025-01-XX
**バージョン**: 1.0.0
**作成者**: AI Workflow Test Scenario Phase
