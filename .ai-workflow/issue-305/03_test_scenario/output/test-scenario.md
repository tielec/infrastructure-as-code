# テストシナリオ - Issue #305

**タイトル**: AI Workflow: Jenkins統合完成とPhase終了後の自動commit & push機能
**Issue番号**: #305
**作成日**: 2025-10-09
**ステータス**: Phase 3 - Test Scenario
**バージョン**: 1.1
**最終更新**: 2025-10-09

---

## 1. テスト戦略サマリー

### 1.1 選択されたテスト戦略

**UNIT_INTEGRATION**

Phase 2の設計書で決定されたテスト戦略に基づき、以下の2種類のテストを実施します：

1. **Unitテスト**: GitManagerクラスおよびBasePhaseクラスの個別メソッドをテスト（✅ Issue #304で完全実装済み）
2. **Integrationテスト**: Jenkins環境での実行確認およびGit操作の統合検証（📝 新規作成、既存実装の検証）

### 1.2 テスト対象の範囲

#### 対象コンポーネント

| コンポーネント | テスト種別 | 状態 |
|--------------|----------|------|
| **GitManager** | Unit | ✅ 完全実装済み（Issue #304、17テストケース） |
| **BasePhase** | Unit | ✅ 完全実装済み（Issue #304） |
| **Jenkins Workflow** | Integration | 📝 新規作成（既存実装の検証） |
| **Git Auto Commit & Push** | Integration | 📝 新規作成（既存実装の検証） |

#### 対象機能要件

- **FR-001**: Jenkins統合の動作確認（既存実装の検証）
- **FR-002**: Git自動commit & push機能の検証（既存実装の検証）
- **FR-003**: エンドツーエンドテストの実施（全フロー検証）

### 1.3 テストの目的

1. **既存実装の検証**: Issue #304で実装されたGitManagerとBasePhaseが要件を満たすことを確認
2. **Jenkins統合の確認**: Jenkins環境でPhase実行が正常に動作することを確認
3. **Git自動化の確認**: Phase完了後、成果物が自動的にcommit & pushされることを確認
4. **エラーハンドリング**: 失敗時やネットワークエラー時の動作を確認

**重要**: 本Issueは**既存実装の検証**が主目的です。GitManagerとBasePhaseは既にIssue #304で完成しており、新規コード作成は不要です。Integrationテストで既存実装が要件を満たすことを確認します。

---

## 2. Unitテストシナリオ

### 2.1 GitManagerクラス

**状態**: ✅ 完全実装済み（Issue #304）

**ファイル**: `tests/unit/core/test_git_manager.py`

**実装状況**: 17テストケース、すべてPASS済み

#### UT-GM-001: create_commit_message_成功（正常系）

- **目的**: コミットメッセージが正しいフォーマットで生成されることを検証
- **前提条件**:
  - GitManagerインスタンスが初期化されている
  - metadata.dataに有効なissue_numberが設定されている
- **入力**:
  ```python
  phase_name = "requirements"
  status = "completed"
  review_result = "PASS"
  issue_number = 305
  ```
- **期待結果**:
  ```
  [ai-workflow] Phase 1 (requirements) - completed

  Issue: #305
  Phase: 1 (requirements)
  Status: completed
  Review: PASS

  Auto-generated by AI Workflow
  ```
- **テストデータ**: 上記入力パラメータ
- **状態**: ✅ PASS

#### UT-GM-002: create_commit_message_レビュー未実施（正常系）

- **目的**: レビュー未実施時にReviewフィールドが"N/A"となることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  phase_name = "requirements"
  status = "completed"
  review_result = None
  ```
- **期待結果**: Reviewフィールドが"N/A"となる
- **テストデータ**: review_result = None
- **状態**: ✅ PASS

#### UT-GM-003: create_commit_message_Phase失敗（正常系）

- **目的**: Phase失敗時のコミットメッセージが正しく生成されることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  phase_name = "requirements"
  status = "failed"
  review_result = "FAIL"
  ```
- **期待結果**: Statusフィールドが"failed"、Reviewフィールドが"FAIL"となる
- **テストデータ**: status = "failed", review_result = "FAIL"
- **状態**: ✅ PASS

#### UT-GM-004: commit_phase_output_成功（正常系）

- **目的**: Phase成果物が正常にcommitされることを検証
- **前提条件**:
  - Gitリポジトリが初期化されている
  - `.ai-workflow/issue-305/01_requirements/output/requirements.md`が存在
  - ファイルが未追跡または変更されている
- **入力**:
  ```python
  phase_name = "requirements"
  status = "completed"
  review_result = "PASS"
  ```
- **期待結果**:
  ```python
  {
    'success': True,
    'commit_hash': '<valid_hash>',
    'files_committed': ['.ai-workflow/issue-305/01_requirements/output/requirements.md'],
    'error': None
  }
  ```
- **テストデータ**: テスト用requirements.mdファイル
- **状態**: ✅ PASS

#### UT-GM-005: commit_phase_output_ファイル0件（正常系）

- **目的**: コミット対象ファイルが0件の場合、スキップされることを検証
- **前提条件**:
  - Gitリポジトリが初期化されている
  - すべてのファイルがcommit済み（変更なし）
- **入力**:
  ```python
  phase_name = "requirements"
  status = "completed"
  review_result = "PASS"
  ```
- **期待結果**:
  ```python
  {
    'success': True,
    'commit_hash': None,
    'files_committed': [],
    'error': None
  }
  ```
- **テストデータ**: 変更ファイルなし
- **状態**: ✅ PASS

#### UT-GM-006: commit_phase_output_Gitリポジトリ未初期化（異常系）

- **目的**: Gitリポジトリが存在しない場合、エラーが返されることを検証
- **前提条件**: Gitリポジトリが初期化されていない（.gitディレクトリなし）
- **入力**:
  ```python
  phase_name = "requirements"
  status = "completed"
  review_result = "PASS"
  ```
- **期待結果**:
  ```python
  {
    'success': False,
    'commit_hash': None,
    'files_committed': [],
    'error': 'Git repository not found'
  }
  ```
- **テストデータ**: Gitリポジトリなし
- **状態**: ✅ PASS

#### UT-GM-007: push_to_remote_成功（正常系）

- **目的**: リモートリポジトリへのpushが正常に完了することを検証
- **前提条件**:
  - Gitリポジトリが初期化されている
  - コミットが存在する
  - リモートリポジトリが設定されている（origin）
  - GITHUB_TOKEN環境変数が設定されている
- **入力**:
  ```python
  max_retries = 3
  retry_delay = 2.0
  ```
- **期待結果**:
  ```python
  {
    'success': True,
    'retries': 0,
    'error': None
  }
  ```
- **テストデータ**: モックGitリモート
- **状態**: ✅ PASS

#### UT-GM-008: push_to_remote_リトライ成功（正常系）

- **目的**: ネットワークエラー時にリトライして成功することを検証
- **前提条件**:
  - 1回目のpushでネットワークタイムアウトエラー
  - 2回目のpushで成功
- **入力**:
  ```python
  max_retries = 3
  retry_delay = 2.0
  ```
- **期待結果**:
  ```python
  {
    'success': True,
    'retries': 1,
    'error': None
  }
  ```
- **テストデータ**: モック - 1回目timeout、2回目成功
- **状態**: ✅ PASS

#### UT-GM-009: push_to_remote_権限エラー（異常系）

- **目的**: 権限エラー時にリトライせず即座に失敗することを検証
- **前提条件**: push実行時に権限エラー（Permission denied）が発生
- **入力**:
  ```python
  max_retries = 3
  retry_delay = 2.0
  ```
- **期待結果**:
  ```python
  {
    'success': False,
    'retries': 0,
    'error': 'Permission denied'
  }
  ```
- **テストデータ**: モック - 権限エラー
- **状態**: ✅ PASS

#### UT-GM-010: push_to_remote_最大リトライ超過（異常系）

- **目的**: 最大リトライ回数を超えた場合に失敗することを検証
- **前提条件**: すべてのpush試行でネットワークタイムアウトエラー
- **入力**:
  ```python
  max_retries = 3
  retry_delay = 2.0
  ```
- **期待結果**:
  ```python
  {
    'success': False,
    'retries': 3,
    'error': 'Network timeout'
  }
  ```
- **テストデータ**: モック - すべてtimeout
- **状態**: ✅ PASS

#### UT-GM-011: get_status_クリーン（正常系）

- **目的**: Git作業ディレクトリがクリーンな状態を正しく検出することを検証
- **前提条件**:
  - Gitリポジトリが初期化されている
  - すべての変更がcommit済み
- **入力**: なし
- **期待結果**:
  ```python
  {
    'is_dirty': False,
    'untracked_files': [],
    'modified_files': [],
    'staged_files': []
  }
  ```
- **テストデータ**: クリーンなGitリポジトリ
- **状態**: ✅ PASS

#### UT-GM-012: get_status_変更あり（正常系）

- **目的**: Git作業ディレクトリに変更がある状態を正しく検出することを検証
- **前提条件**:
  - Gitリポジトリが初期化されている
  - 未追跡ファイルが存在
  - 変更されたファイルが存在
- **入力**: なし
- **期待結果**:
  ```python
  {
    'is_dirty': True,
    'untracked_files': ['.ai-workflow/issue-305/metadata.json'],
    'modified_files': ['.ai-workflow/issue-305/01_requirements/output/requirements.md'],
    'staged_files': []
  }
  ```
- **テストデータ**: 変更のあるGitリポジトリ
- **状態**: ✅ PASS

#### UT-GM-013: filter_phase_files_正常系

- **目的**: Phaseファイルが正しくフィルタリングされることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  files = [
    '.ai-workflow/issue-305/01_requirements/output/requirements.md',
    '.ai-workflow/issue-305/metadata.json',
    '.ai-workflow/issue-999/01_requirements/output/requirements.md',  # 他Issue
    'workspace@tmp/temp.txt',  # Jenkins一時ファイル
    'scripts/ai-workflow/main.py'  # プロジェクト本体
  ]
  issue_number = 305
  ```
- **期待結果**:
  ```python
  [
    '.ai-workflow/issue-305/01_requirements/output/requirements.md',
    '.ai-workflow/issue-305/metadata.json',
    'scripts/ai-workflow/main.py'
  ]
  ```
- **テストデータ**: 上記filesリスト
- **状態**: ✅ PASS

#### UT-GM-014: filter_phase_files_空リスト（境界値）

- **目的**: 空のファイルリストを渡した場合、空リストが返されることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  files = []
  issue_number = 305
  ```
- **期待結果**: `[]`
- **テストデータ**: 空リスト
- **状態**: ✅ PASS

#### UT-GM-015: is_retriable_error_ネットワークエラー（正常系）

- **目的**: ネットワークエラーがリトライ可能と判定されることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  error = GitCommandError('git push', 128, stderr='fatal: unable to access ... timeout')
  ```
- **期待結果**: `True`
- **テストデータ**: ネットワークタイムアウトエラー
- **状態**: ✅ PASS

#### UT-GM-016: is_retriable_error_権限エラー（正常系）

- **目的**: 権限エラーがリトライ不可と判定されることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  error = GitCommandError('git push', 128, stderr='fatal: Permission denied')
  ```
- **期待結果**: `False`
- **テストデータ**: 権限エラー
- **状態**: ✅ PASS

#### UT-GM-017: is_retriable_error_認証エラー（正常系）

- **目的**: 認証エラーがリトライ不可と判定されることを検証
- **前提条件**: GitManagerインスタンスが初期化されている
- **入力**:
  ```python
  error = GitCommandError('git push', 128, stderr='fatal: Authentication failed')
  ```
- **期待結果**: `False`
- **テストデータ**: 認証エラー
- **状態**: ✅ PASS

### 2.2 Unitテストサマリー

| テストID | テスト名 | 種別 | 状態 |
|---------|---------|------|------|
| UT-GM-001 | create_commit_message_成功 | 正常系 | ✅ PASS |
| UT-GM-002 | create_commit_message_レビュー未実施 | 正常系 | ✅ PASS |
| UT-GM-003 | create_commit_message_Phase失敗 | 正常系 | ✅ PASS |
| UT-GM-004 | commit_phase_output_成功 | 正常系 | ✅ PASS |
| UT-GM-005 | commit_phase_output_ファイル0件 | 正常系 | ✅ PASS |
| UT-GM-006 | commit_phase_output_Gitリポジトリ未初期化 | 異常系 | ✅ PASS |
| UT-GM-007 | push_to_remote_成功 | 正常系 | ✅ PASS |
| UT-GM-008 | push_to_remote_リトライ成功 | 正常系 | ✅ PASS |
| UT-GM-009 | push_to_remote_権限エラー | 異常系 | ✅ PASS |
| UT-GM-010 | push_to_remote_最大リトライ超過 | 異常系 | ✅ PASS |
| UT-GM-011 | get_status_クリーン | 正常系 | ✅ PASS |
| UT-GM-012 | get_status_変更あり | 正常系 | ✅ PASS |
| UT-GM-013 | filter_phase_files_正常系 | 正常系 | ✅ PASS |
| UT-GM-014 | filter_phase_files_空リスト | 境界値 | ✅ PASS |
| UT-GM-015 | is_retriable_error_ネットワークエラー | 正常系 | ✅ PASS |
| UT-GM-016 | is_retriable_error_権限エラー | 正常系 | ✅ PASS |
| UT-GM-017 | is_retriable_error_認証エラー | 正常系 | ✅ PASS |

**合計**: 17テストケース（すべてPASS）

---

## 3. Integrationテストシナリオ

### 3.1 Jenkins Git統合テスト

**ファイル**: `tests/integration/test_jenkins_git_integration.py`（新規作成）

**目的**: Issue #304で実装済みのGitManager・BasePhaseが、Jenkins環境で正常に動作することを検証

#### IT-JG-001: Phase 1完了後の自動commit（既存実装の検証）

**対応受け入れ基準**: AC-004

- **目的**: Phase 1（Requirements）完了後、成果物が自動的にcommitされることを検証
- **検証対象**: BasePhase.run() → GitManager.commit_phase_output()の統合動作
- **前提条件**:
  - Jenkins環境が正常に動作している
  - Docker環境が構築されている
  - GITHUB_TOKEN環境変数が設定されている
  - Gitリポジトリが初期化されている
  - **既存実装**: BasePhase.run()のfinally句でGitManagerが既に統合済み（Issue #304）
- **テスト手順**:
  1. ワークフロー初期化
     ```bash
     python main.py init --issue-url https://github.com/tielec/infrastructure-as-code/issues/305
     ```
  2. Phase 1実行
     ```bash
     python main.py execute --phase requirements --issue 305
     ```
  3. Git履歴確認
     ```bash
     git log -1 --pretty=format:"%s"
     ```
  4. コミットされたファイル確認
     ```bash
     git show --name-only --pretty=format:
     ```
- **期待結果**:
  - コミットメッセージ: `[ai-workflow] Phase 1 (requirements) - completed`
  - コミットされたファイルに`.ai-workflow/issue-305/`配下のファイルが含まれる
  - metadata.jsonが含まれる
  - requirements.mdが含まれる
- **確認項目**:
  - [x] コミットメッセージフォーマットが正しい
  - [x] `.ai-workflow/issue-305/`配下のファイルがcommitされている
  - [x] 他のIssueのファイル（`issue-999/`等）は含まれていない
  - [x] Jenkins一時ファイル（`@tmp/`）は含まれていない

#### IT-JG-002: Phase 1完了後の自動push（既存実装の検証）

**対応受け入れ基準**: AC-006

- **目的**: Phase 1完了後、コミットがリモートリポジトリに自動的にpushされることを検証
- **検証対象**: GitManager.push_to_remote()の実環境での動作
- **前提条件**:
  - Phase 1が正常に完了している
  - Git commitが作成されている
  - リモートリポジトリが設定されている
  - GITHUB_TOKEN環境変数が設定されている
  - **既存実装**: GitManager.push_to_remote()が実装済み（Issue #304）
- **テスト手順**:
  1. Phase 1実行（IT-JG-001から継続）
  2. ローカルコミットハッシュ取得
     ```bash
     git rev-parse HEAD
     ```
  3. リモートリポジトリのコミットハッシュ取得
     ```bash
     git ls-remote origin feature/ai-workflow-mvp | awk '{print $1}'
     ```
  4. コミットハッシュを比較
- **期待結果**:
  - ローカルとリモートのコミットハッシュが一致
  - Jenkins Console Outputに"Git push successful"ログが出力される
  - リトライ回数が0（正常系のため）
- **確認項目**:
  - [x] リモートリポジトリに同じコミットが存在する
  - [x] push成功ログが出力されている
  - [x] リトライが発生していない

#### IT-JG-003: Phase失敗時もcommit実行（既存実装の検証）

**対応受け入れ基準**: AC-005

- **目的**: Phase実行が失敗した場合でも、ログファイルが自動的にcommitされることを検証
- **検証対象**: BasePhase.run()のfinally句が失敗時も確実に実行されること
- **前提条件**:
  - Jenkins環境が正常に動作している
  - Phase実行が失敗する状況を再現（例: Claude APIタイムアウト、レビューFAIL）
  - **既存実装**: BasePhase.run()のfinally句でGit処理が必ず実行される（Issue #304）
- **テスト手順**:
  1. Phase実行を失敗させる（モック使用またはタイムアウト設定）
     ```bash
     # レビューが必ずFAILするようにモック設定
     python main.py execute --phase requirements --issue 305
     ```
  2. Git履歴確認
     ```bash
     git log -1 --pretty=format:"%s%n%b"
     ```
  3. コミットされたファイル確認
     ```bash
     git show --name-only
     ```
- **期待結果**:
  - コミットメッセージ: `[ai-workflow] Phase 1 (requirements) - failed`
  - Statusフィールド: `failed`
  - Reviewフィールド: `FAIL`（またはN/A）
  - `.ai-workflow/issue-305/01_requirements/execute/`配下にログファイルが保存されている
  - ログファイルがcommitされている
- **確認項目**:
  - [x] 失敗時もcommitが作成される
  - [x] コミットメッセージに"failed"が含まれる
  - [x] ログファイルがcommitされている
  - [x] pushも実行される（失敗時も）

#### IT-JG-004: コミットメッセージフォーマット検証（既存実装の検証）

**対応受け入れ基準**: AC-008

- **目的**: コミットメッセージが指定されたフォーマットに従うことを検証
- **検証対象**: GitManager.create_commit_message()の実装
- **前提条件**:
  - Phase 1が正常に完了している
  - レビュー結果が"PASS"
  - **既存実装**: GitManager.create_commit_message()が実装済み（Issue #304）
- **テスト手順**:
  1. Phase 1実行
     ```bash
     python main.py execute --phase requirements --issue 305
     ```
  2. コミットメッセージ全文取得
     ```bash
     git log -1 --pretty=format:"%s%n%b"
     ```
  3. フォーマット検証
- **期待結果**:
  ```
  [ai-workflow] Phase 1 (requirements) - completed

  Issue: #305
  Phase: 1 (requirements)
  Status: completed
  Review: PASS

  Auto-generated by AI Workflow
  ```
- **確認項目**:
  - [x] サブジェクト行: `[ai-workflow] Phase 1 (requirements) - completed`
  - [x] 本文にIssue番号が含まれる: `Issue: #305`
  - [x] 本文にPhase情報が含まれる: `Phase: 1 (requirements)`
  - [x] 本文にステータスが含まれる: `Status: completed`
  - [x] 本文にレビュー結果が含まれる: `Review: PASS`
  - [x] 最終行に署名がある: `Auto-generated by AI Workflow`

#### IT-JG-005: Git pushリトライロジック（既存実装の検証）

**対応受け入れ基準**: AC-007

- **目的**: Git push時にネットワークエラーが発生した場合、リトライロジックが正常に動作することを検証
- **検証対象**: GitManager.push_to_remote()のリトライロジック
- **前提条件**:
  - Phase 1が正常に完了している
  - Git commitが作成されている
  - ネットワークエラーを再現可能（モック使用）
  - **既存実装**: GitManager.push_to_remote()にリトライロジック実装済み（Issue #304）
- **テスト手順**:
  1. GitManager.push_to_remote()をモックし、1回目はネットワークタイムアウト、2回目は成功するように設定
  2. Phase 1実行
     ```bash
     python main.py execute --phase requirements --issue 305
     ```
  3. ログ確認
     ```bash
     # Jenkins Console Output または agent_log.mdを確認
     grep "Git push" .ai-workflow/issue-305/01_requirements/execute/agent_log.md
     ```
- **期待結果**:
  - 1回目のpush失敗ログ: `[WARNING] Git push failed (attempt 1/3): timeout`
  - 2秒間スリープ
  - 2回目のpush成功ログ: `[INFO] Git push successful (retries: 1)`
  - 最終的にpushが成功
- **確認項目**:
  - [x] 1回目のpush失敗が検出される
  - [x] 2秒間のリトライ遅延が発生する
  - [x] 2回目のpushが実行される
  - [x] 2回目のpushが成功する
  - [x] リトライ回数が正しくログに記録される

#### IT-JG-006: Jenkins Phase実行ステージの動作確認（既存実装の検証）

**対応受け入れ基準**: AC-001

- **目的**: Jenkins上でPhase 1実行ステージが正常に動作することを検証
- **検証対象**: Jenkinsfile（Phase 1-7実行ステージ、Issue #304で実装済み）
- **前提条件**:
  - Jenkins Controllerが起動している
  - `ai_workflow_orchestrator`ジョブが存在する
  - Docker環境が利用可能
  - **既存実装**: Jenkinsfile行156-365にPhase実行ステージ実装済み（Issue #304）
- **テスト手順**:
  1. Jenkins UIから`ai_workflow_orchestrator`ジョブを手動実行
  2. パラメータ設定:
     - ISSUE_URL: `https://github.com/tielec/infrastructure-as-code/issues/305`
     - START_PHASE: `requirements`
     - DRY_RUN: `false`
  3. Jenkins Console Outputを確認
  4. Phase 1実行完了まで待機
- **期待結果**:
  - Jenkins Console Outputに"Stage: Phase 1 - Requirements Definition"が表示される
  - `python main.py execute --phase requirements --issue 305`が実行される
  - Phase実行が正常に完了する
  - 成果物が`.ai-workflow/issue-305/01_requirements/output/requirements.md`に生成される
  - Git commit & pushが実行される
- **確認項目**:
  - [x] Jenkinsステージが開始される
  - [x] Phase実行コマンドが正しく実行される
  - [x] Claude Agent SDKが呼び出される
  - [x] 成果物が生成される
  - [x] エラーが発生しない

#### IT-JG-007: 複数Phase順次実行（既存実装の検証）

**対応受け入れ基準**: AC-002

- **目的**: Jenkins上でPhase 1-7が順次実行されることを検証
- **検証対象**: Jenkinsfile（全Phase実行ループ、Issue #304で実装済み）
- **前提条件**:
  - Jenkins Controllerが起動している
  - `ai_workflow_orchestrator`ジョブが存在する
  - START_PHASEが"requirements"に設定されている
  - **既存実装**: Jenkinsfileに全7Phase実行ステージ実装済み（Issue #304）
- **テスト手順**:
  1. Jenkins UIからジョブを実行
  2. Phase 1-7の実行を監視
  3. 各Phaseの成果物とGit履歴を確認
- **期待結果**:
  - Phase 1（Requirements）が完了
  - Phase 2（Design）が自動的に開始
  - Phase 3（Test Scenario）が自動的に開始
  - Phase 4（Implementation）が自動的に開始
  - Phase 5（Testing）が自動的に開始
  - Phase 6（Documentation）が自動的に開始
  - Phase 7（Report）が自動的に開始
  - 全Phaseが正常に完了
  - 各Phase完了後にGit commitが作成される（合計7コミット）
- **確認項目**:
  - [x] 各Phaseが順次実行される
  - [x] Phase間で依存関係が正しく処理される
  - [x] 各Phase完了後にGit commit & pushが実行される
  - [x] すべてのPhaseが成功する

#### IT-JG-008: エラーハンドリング（既存実装の検証）

**対応受け入れ基準**: AC-003

- **目的**: Phase実行中にエラーが発生した場合、適切にハンドリングされることを検証
- **検証対象**: BasePhase.run()のエラーハンドリングとGitHub連携
- **前提条件**:
  - Jenkins Controllerが起動している
  - Phase実行中にエラーを発生させる（例: Claude APIタイムアウト）
  - **既存実装**: BasePhase.run()にエラーハンドリング実装済み（Issue #304）
- **テスト手順**:
  1. Claude APIタイムアウトを再現（モック使用または実際のタイムアウト）
  2. Phase 1実行
  3. エラーログ確認
  4. GitHub Issue確認
- **期待結果**:
  - エラーメッセージがJenkins Console Outputに出力される
  - Phaseステータスが"failed"に更新される
  - GitHub IssueにエラーコメントDが投稿される
  - ジョブが失敗ステータスで終了する
  - Git commitは実行される（失敗時も）
- **確認項目**:
  - [x] エラーが適切に検出される
  - [x] エラーメッセージがログに出力される
  - [x] Phaseステータスが"failed"になる
  - [x] GitHub Issueにコメント投稿される
  - [x] Jenkinsジョブが失敗する
  - [x] Git commitは実行される

### 3.2 エンドツーエンドテスト（手動実行）

#### E2E-001: 全フロー統合テスト

**対応受け入れ基準**: AC-009

- **目的**: Issue取得からPhase実行、レビュー、Git commit & pushまでの全フローを検証
- **検証対象**: 既存実装（GitManager + BasePhase + Jenkinsfile）の統合動作
- **前提条件**:
  - Jenkins環境が正常に動作している
  - テスト用GitHub Issue #305が作成されている
  - **既存実装**: すべてのコンポーネントがIssue #304で実装済み

- **テスト手順**:

  **1. テスト用Issue確認**
  ```bash
  # Issue #305が存在することを確認
  gh issue view 305
  ```

  **2. Jenkins Job実行**
  - Jenkins UI: `AI_Workflow/ai_workflow_orchestrator`
  - パラメータ:
    - ISSUE_URL: `https://github.com/tielec/infrastructure-as-code/issues/305`
    - START_PHASE: `requirements`
    - DRY_RUN: `false`
  - "Build with Parameters" → "Build"をクリック

  **3. Phase 1実行確認**
  - Jenkins Console Outputで進捗確認
  - Phase 1完了まで待機（約10分）

  **4. 成果物確認**
  ```bash
  # 成果物確認
  ls -la .ai-workflow/issue-305/01_requirements/output/
  # → requirements.md が存在すること

  # 内容確認
  cat .ai-workflow/issue-305/01_requirements/output/requirements.md
  ```

  **5. Git履歴確認**
  ```bash
  # 最新コミット確認
  git log -1 --pretty=format:"%s%n%b"

  # 期待される出力:
  # [ai-workflow] Phase 1 (requirements) - completed
  #
  # Issue: #305
  # Phase: 1 (requirements)
  # Status: completed
  # Review: PASS
  #
  # Auto-generated by AI Workflow
  ```

  **6. リモートpush確認**
  ```bash
  # リモートの最新コミット確認
  git log origin/feature/ai-workflow-mvp -1 --pretty=format:"%s"
  # リモートに同じコミットが存在すること
  ```

  **7. GitHub Issue確認**
  ```bash
  # Issue #305のコメント確認
  gh issue view 305 --comments
  # レビュー結果コメントが投稿されていること
  # フォーマット: "## 📄 要件定義フェーズ - 成果物"
  ```

  **8. Phase 2-7実行（オプション）**
  - Jenkins上で同じジョブを継続実行
  - 各Phase完了後にGit履歴を確認

- **期待結果**:
  - ✅ Phase 1が正常に完了
  - ✅ `.ai-workflow/issue-305/01_requirements/output/requirements.md`が生成
  - ✅ Git commitが作成（コミットメッセージフォーマット正しい）
  - ✅ リモートリポジトリにpush成功
  - ✅ GitHub Issueにレビュー結果投稿
  - ✅ Jenkins Console Outputにエラーなし
  - ✅ metadata.jsonが更新される

- **確認項目**:
  - [x] Issue取得が成功する
  - [x] Phase 1実行が成功する
  - [x] レビューが実行される
  - [x] レビュー結果がPASSまたはPASS_WITH_SUGGESTIONS
  - [x] Git commitが作成される
  - [x] Git pushが成功する
  - [x] GitHub Issueにコメントが投稿される
  - [x] 成果物が正しい場所に保存される
  - [x] metadata.jsonが更新される

### 3.3 Integrationテストサマリー

| テストID | テスト名 | 対応AC | 検証対象 | 状態 |
|---------|---------|--------|---------|------|
| IT-JG-001 | Phase 1完了後の自動commit | AC-004 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-002 | Phase 1完了後の自動push | AC-006 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-003 | Phase失敗時もcommit実行 | AC-005 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-004 | コミットメッセージフォーマット検証 | AC-008 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-005 | Git pushリトライロジック | AC-007 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-006 | Jenkins Phase実行ステージの動作確認 | AC-001 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-007 | 複数Phase順次実行 | AC-002 | 既存実装の検証 | 📝 新規作成 |
| IT-JG-008 | エラーハンドリング | AC-003 | 既存実装の検証 | 📝 新規作成 |
| E2E-001 | 全フロー統合テスト | AC-009 | 既存実装の検証 | 📝 手動実行 |

**合計**: 8 Integrationテストケース + 1 E2Eテスト

**重要**: すべてのIntegrationテストは**既存実装の検証**を目的としています。GitManagerとBasePhaseはIssue #304で完全実装済みであり、これらのテストで要件を満たすことを確認します。

---

## 4. テストデータ

### 4.1 テスト用Issue

**Issue番号**: #305
**タイトル**: [TASK] AI Workflow: Jenkins統合完成とPhase終了後の自動commit & push機能
**本文**: （実際のIssue #305の内容を使用）

### 4.2 テスト用ファイル

#### 4.2.1 正常データ

**requirements.md**（Phase 1成果物）
```markdown
# 要件定義書 - Issue #305

## 1. 概要
...
```

**metadata.json**（ワークフロー管理情報）
```json
{
  "issue_number": 305,
  "issue_title": "[TASK] AI Workflow: Jenkins統合完成とPhase終了後の自動commit & push機能",
  "created_at": "2025-10-09T00:00:00Z",
  "phases": {
    "requirements": {
      "status": "completed",
      "review_result": "PASS"
    }
  }
}
```

#### 4.2.2 異常データ

**無効なIssue URL**
```
https://github.com/invalid/repo/issues/999999
```

**Gitリポジトリ未初期化**
```bash
# .gitディレクトリが存在しない状態
rm -rf .git
```

**権限エラー（GITHUB_TOKEN未設定）**
```bash
unset GITHUB_TOKEN
```

#### 4.2.3 境界値データ

**空のファイルリスト**
```python
files = []
```

**大量のファイル（100ファイル）**
```python
files = [f'.ai-workflow/issue-305/file_{i}.txt' for i in range(100)]
```

**長いコミットメッセージ（1000文字）**
```python
review_result = "PASS_WITH_SUGGESTIONS: " + "x" * 1000
```

### 4.3 モックデータ

#### 4.3.1 Git操作モック

**正常系push**
```python
def mock_push_success(origin, refspec):
    return None  # 成功
```

**ネットワークエラー（1回目）、成功（2回目）**
```python
push_attempt = 0

def mock_push_retry(origin, refspec):
    global push_attempt
    push_attempt += 1
    if push_attempt == 1:
        raise GitCommandError('git push', 128, stderr='fatal: timeout')
    return None  # 成功
```

**権限エラー**
```python
def mock_push_permission_error(origin, refspec):
    raise GitCommandError('git push', 128, stderr='fatal: Permission denied')
```

#### 4.3.2 GitHub API モック

**Issue取得成功**
```python
mock_issue = {
    'number': 305,
    'title': '[TASK] AI Workflow: Jenkins統合完成とPhase終了後の自動commit & push機能',
    'body': '...',
    'state': 'open'
}
```

**コメント投稿成功**
```python
def mock_create_comment(issue_number, body):
    return {'id': 12345, 'body': body}
```

---

## 5. テスト環境要件

### 5.1 ローカル環境（Unitテスト）

| 要件 | 詳細 |
|-----|------|
| **Python** | 3.8以上 |
| **依存パッケージ** | pytest, pytest-mock, GitPython |
| **Git** | 2.x以上 |
| **テストフレームワーク** | pytest |
| **モックライブラリ** | pytest-mock, unittest.mock |

**セットアップ手順**:
```bash
# 仮想環境作成
python -m venv venv
source venv/bin/activate

# 依存パッケージインストール
pip install -r scripts/ai-workflow/requirements.txt
pip install pytest pytest-mock

# Unitテスト実行
pytest tests/unit/core/test_git_manager.py -v
```

### 5.2 Jenkins環境（Integrationテスト）

| 要件 | 詳細 |
|-----|------|
| **Jenkins Controller** | 2.x以上 |
| **Jenkins Agent** | Docker対応 |
| **Docker** | 20.x以上 |
| **Python (Docker内)** | 3.8以上 |
| **Claude CLI** | headless mode対応 |
| **Git** | 2.x以上 |
| **環境変数** | GITHUB_TOKEN, CLAUDE_CODE_OAUTH_TOKEN |

**セットアップ手順**:
```bash
# Jenkinsクレデンシャル設定確認
# Jenkins UI → Manage Jenkins → Manage Credentials
# - GITHUB_TOKEN (Secret text)
# - CLAUDE_CODE_OAUTH_TOKEN (Secret text)

# Job確認
# Jenkins UI → AI_Workflow/ai_workflow_orchestrator
```

### 5.3 必要な外部サービス

| サービス | 用途 | 状態確認 |
|---------|------|---------|
| **GitHub API** | Issue取得、コメント投稿 | `gh api user` |
| **Claude API** | Phase実行、レビュー | Claude CLI動作確認 |
| **Git Remote** | push/pull | `git remote -v` |

### 5.4 モック/スタブの必要性

| テスト種別 | モック対象 | 理由 |
|----------|----------|------|
| **Unitテスト** | Git操作（commit, push） | 実際のGit操作を避け、高速化 |
| **Unitテスト** | GitHub API | 外部API呼び出しを避け、テスト安定化 |
| **Unitテスト** | Claude API | API料金削減、テスト高速化 |
| **Integrationテスト** | なし（実環境使用） | 実際の統合動作を検証 |

---

## 6. テスト実行計画

### 6.1 Unitテスト実行

**実行頻度**: コミット前、CI/CD自動実行

**実行コマンド**:
```bash
# すべてのUnitテスト実行
pytest tests/unit/ -v

# GitManagerのみ
pytest tests/unit/core/test_git_manager.py -v

# カバレッジ付き
pytest tests/unit/ --cov=scripts/ai-workflow/core --cov-report=html
```

**期待カバレッジ**: 80%以上

### 6.2 Integrationテスト実行

**実行頻度**: PR作成時、手動実行

**実行コマンド**:
```bash
# Integrationテスト実行
pytest tests/integration/test_jenkins_git_integration.py -v

# 特定のテストのみ
pytest tests/integration/test_jenkins_git_integration.py::test_phase1_auto_commit -v
```

**実行環境**: Jenkins環境またはDocker環境

### 6.3 E2Eテスト実行

**実行頻度**: リリース前、手動実行

**実行方法**: 手動（セクション3.2参照）

**所要時間**: 約10分（Phase 1のみ）、約70分（全Phase）

### 6.4 テスト実行順序

```
1. Unitテスト（既存） → すべてPASS確認 ✅ 完了
   ↓
2. Integrationテスト（新規作成） → 作成後に実行
   ↓
3. E2Eテスト（手動実行） → Jenkins環境で実行
   ↓
4. すべてPASS → Phase 4（Implementation）へ進む
```

---

## 7. 品質ゲート検証

### ✅ 品質ゲート1: Phase 2の戦略に沿ったテストシナリオである

**状態**: ✅ 合格

**根拠**:
- Phase 2で決定されたテスト戦略: **UNIT_INTEGRATION**
- Unitテストシナリオ: 17ケース（✅ Issue #304で実装済み、すべてPASS）
- Integrationテストシナリオ: 8ケース（📝 新規作成、既存実装の検証）
- BDDテストシナリオ: なし（戦略に含まれていない）
- **結論**: 戦略に完全準拠

### ✅ 品質ゲート2: 主要な正常系がカバーされている

**状態**: ✅ 合格

**カバーされている正常系**:

| 機能 | テストケース |
|-----|------------|
| **コミットメッセージ生成** | UT-GM-001 |
| **Phase成果物commit** | UT-GM-004, IT-JG-001 |
| **リモートpush** | UT-GM-007, IT-JG-002 |
| **Phase実行** | IT-JG-006, E2E-001 |
| **レビュー実行** | E2E-001 |
| **複数Phase順次実行** | IT-JG-007 |
| **Git自動化** | IT-JG-001, IT-JG-002 |

**結論**: 主要な正常系（7機能）をすべてカバー

### ✅ 品質ゲート3: 主要な異常系がカバーされている

**状態**: ✅ 合格

**カバーされている異常系**:

| 異常ケース | テストケース |
|----------|------------|
| **Gitリポジトリ未初期化** | UT-GM-006 |
| **権限エラー** | UT-GM-009 |
| **ネットワークエラー** | UT-GM-008, IT-JG-005 |
| **最大リトライ超過** | UT-GM-010 |
| **Phase実行失敗** | IT-JG-003, IT-JG-008 |
| **Claude APIエラー** | IT-JG-008 |

**結論**: 主要な異常系（6ケース）をすべてカバー

### ✅ 品質ゲート4: 期待結果が明確である

**状態**: ✅ 合格

**検証項目**:
- [x] すべてのテストケースに「期待結果」セクションがある
- [x] 期待結果が具体的な値・状態で記述されている（曖昧な表現なし）
- [x] 確認項目チェックリストが明記されている
- [x] 検証可能な形式（コマンド実行結果、ログ出力等）で記述されている

**例**:
- UT-GM-004: 期待結果に具体的なDict構造を記載
- IT-JG-004: 期待されるコミットメッセージを完全に記載
- E2E-001: 各ステップの期待される出力を明記

**結論**: すべてのテストケースで期待結果が明確

---

## 8. テストシナリオサマリー

### 8.1 テストケース数

| テスト種別 | ケース数 | 状態 |
|----------|---------|------|
| **Unitテスト** | 17 | ✅ 実装済み（すべてPASS） |
| **Integrationテスト** | 8 | 📝 新規作成（既存実装の検証） |
| **E2Eテスト** | 1 | 📝 手動実行 |
| **合計** | 26 | - |

### 8.2 受け入れ基準カバレッジ

| 受け入れ基準 | 対応テストケース | カバー状況 |
|------------|----------------|----------|
| **AC-001** | IT-JG-006 | ✅ カバー済み |
| **AC-002** | IT-JG-007 | ✅ カバー済み |
| **AC-003** | IT-JG-008 | ✅ カバー済み |
| **AC-004** | IT-JG-001, UT-GM-004 | ✅ カバー済み |
| **AC-005** | IT-JG-003 | ✅ カバー済み |
| **AC-006** | IT-JG-002, UT-GM-007 | ✅ カバー済み |
| **AC-007** | IT-JG-005, UT-GM-008 | ✅ カバー済み |
| **AC-008** | IT-JG-004, UT-GM-001 | ✅ カバー済み |
| **AC-009** | E2E-001 | ✅ カバー済み |

**カバレッジ**: 9/9（100%）

### 8.3 機能要件カバレッジ

| 機能要件 | 対応テストケース | カバー状況 |
|---------|----------------|----------|
| **FR-001: Jenkins統合の動作確認** | IT-JG-006, IT-JG-007, IT-JG-008 | ✅ カバー済み |
| **FR-002: Git自動commit & push機能の検証** | IT-JG-001, IT-JG-002, IT-JG-003, IT-JG-004, IT-JG-005 | ✅ カバー済み |
| **FR-003: エンドツーエンドテストの実施** | E2E-001 | ✅ カバー済み |

**カバレッジ**: 3/3（100%）

### 8.4 非機能要件カバレッジ

| 非機能要件 | テストでの検証方法 |
|----------|------------------|
| **NFR-001: Phase実行時間** | E2E-001で所要時間を測定（10分以内/Phase） |
| **NFR-002: Git操作タイムアウト** | IT-JG-005でリトライロジック検証 |
| **NFR-007: エラーハンドリング** | IT-JG-003, IT-JG-008で失敗時の動作確認 |
| **NFR-008: レジリエンス** | UT-GM-008, IT-JG-005でリトライ動作確認 |

---

## 9. リスクと対策

### 9.1 テスト実行リスク

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| **Jenkins環境不安定** | 高 | 低 | Integrationテスト前にJenkins状態確認 |
| **Claude API タイムアウト** | 中 | 中 | モック使用、タイムアウト設定調整 |
| **ネットワークエラー** | 中 | 低 | リトライロジック実装済み（既存） |
| **テストデータ不足** | 低 | 低 | 本ドキュメントに詳細なテストデータを記載 |

### 9.2 テスト品質リスク

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| **エッジケースの見落とし** | 中 | 中 | レビューで確認、80点主義（完璧を目指さない） |
| **テストの脆弱性** | 中 | 低 | モック使用、環境依存を最小化 |
| **カバレッジ不足** | 低 | 低 | 受け入れ基準100%カバー達成済み |
| **既存実装の不具合** | 中 | 低 | Unitテストで既に検証済み（17ケースPASS） |

---

## 10. まとめ

### 10.1 テストシナリオの要点

1. **戦略準拠**: Phase 2のUNIT_INTEGRATION戦略に完全準拠
2. **既存活用**: Unitテスト17ケースは既に実装済み（すべてPASS）
3. **検証中心**: Integrationテスト8ケースで既存実装（Issue #304）を検証
4. **全フローカバー**: E2Eテストで全体フローを検証
5. **品質ゲート合格**: 4つの必須品質ゲートをすべて満たす

### 10.2 既存実装との関係

**Issue #304で完成済み**:
- ✅ GitManagerクラス（commit_phase_output, push_to_remote, create_commit_message等）
- ✅ BasePhaseクラス（run()メソッド内でGit統合完了）
- ✅ Jenkinsfile（Phase 1-7実行ステージ完成）
- ✅ Unitテスト（17ケース、すべてPASS）

**本Issue #305で実施**:
- 📝 Integrationテスト作成（既存実装の検証）
- 📝 E2Eテスト実施（全フロー検証）
- 📝 ドキュメント整備

### 10.3 次フェーズ（Phase 4: Implementation）への引き継ぎ事項

1. **Integrationテスト実装**:
   - `tests/integration/test_jenkins_git_integration.py`を作成
   - IT-JG-001〜IT-JG-008を実装
   - **重要**: テストコードは新規作成するが、テスト対象（GitManager・BasePhase）は既存実装を使用

2. **E2Eテスト実行**:
   - Jenkins環境でE2E-001を手動実行
   - 結果をドキュメント化

3. **テストカバレッジ確認**:
   - pytest --cov実行
   - 80%以上を確認

4. **ドキュメント整備**:
   - README.md、ARCHITECTURE.md、jenkins/README.mdを更新

### 10.4 成功基準

- ✅ 既存Unitテスト（17ケース）がすべてPASS（既に達成済み）
- ⏳ Integrationテスト（8ケース）がすべてPASS（Phase 5で確認）
- ⏳ E2Eテストが成功（Phase 5で確認）
- ✅ 受け入れ基準カバレッジ100%（達成済み）
- ✅ 品質ゲート4つすべて合格（達成済み）

---

**承認者**: （レビュー後に記入）
**承認日**: （レビュー後に記入）
**バージョン**: 1.1
**最終更新**: 2025-10-09

**変更履歴**:
- v1.0 (2025-10-09): 初版作成
- v1.1 (2025-10-09): 既存実装の検証という観点を明確化、Integrationテストの位置づけを調整
