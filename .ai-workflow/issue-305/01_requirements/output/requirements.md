# 要件定義書 - Issue #305: AI Workflow Jenkins統合完成とPhase終了後の自動commit & push機能

## 1. 概要

### 1.1 背景

Issue #304において、AI駆動開発自動化ワークフローのPhase 1-7（要件定義、設計、テストシナリオ、実装、テスト、ドキュメント、レポート）の実装が完了しました。しかし、Jenkins統合とGit自動commit機能が未実装のまま残されています。

現状:
- Jenkins統合は途中まで実装済み（`ai-workflow-orchestrator`ジョブ）
- Job DSLとJenkinsfileは作成済み
- Phase 1-7の実行部分はコメントアウトされた状態（Jenkinsfile 156-233行）
- Phase完了後の成果物を自動的にGitにcommit & pushする機能が未実装

### 1.2 目的

本タスクの目的は以下の2つです：

1. **Jenkins統合の完成**: Phase 1-7を自動実行できるJenkinsパイプラインを完成させる
2. **自動commit & push機能の実装**: 各Phase終了後に成果物を自動的にGitリポジトリにcommit & pushする機能を実装

### 1.3 ビジネス価値・技術的価値

**ビジネス価値:**
- CI/CD環境での自動実行により、開発プロセスの完全な自動化を実現
- 成果物の自動コミットにより、作業履歴の自動保存と追跡可能性を確保
- レビュープロセスの自動化により、品質保証の一貫性を向上

**技術的価値:**
- Infrastructure as Code（IaC）原則に基づいた、完全自動化されたワークフロー
- Jenkins統合により、既存CI/CD環境との統合を実現
- Git管理の自動化により、開発者の手作業を削減し、ヒューマンエラーを防止

## 2. 機能要件

### 2.1 Git自動commit & push機能（優先度: 高）

#### FR-01: GitManagerコンポーネントの実装
**説明**: Git操作を管理するGitManagerクラスを実装する

**詳細:**
- ファイルパス: `scripts/ai-workflow/core/git_manager.py`
- クラス名: `GitManager`
- 必須メソッド:
  - `commit_phase_output()`: Phase成果物をcommit
  - `push_to_remote()`: リモートリポジトリにpush
  - `get_status()`: Git状態確認
  - `create_commit_message()`: コミットメッセージ生成

**受け入れ基準:**
- Given: GitManagerクラスがインスタンス化されている
- When: `commit_phase_output()`メソッドが呼び出される
- Then:
  - `.ai-workflow/issue-XXX/` 配下のファイルがcommitされる
  - 規定のコミットメッセージフォーマットが使用される
  - その他のファイルは対象外となる

#### FR-02: BasePhaseへのGit操作統合
**説明**: 各Phaseの実行完了後、自動的にGit操作を実行する

**詳細:**
- 修正ファイル: `scripts/ai-workflow/phases/base_phase.py`
- 修正箇所: `run()` メソッド内
- 実行タイミング: Phase完了後（成功・失敗問わず）

**受け入れ基準:**
- Given: あるPhaseが実行される
- When: Phase実行が完了する（成功または失敗）
- Then:
  - GitManagerの`commit_phase_output()`が呼び出される
  - GitManagerの`push_to_remote()`が呼び出される
  - commit & push失敗時はログに記録される（Phase自体は失敗としない）

#### FR-03: コミットメッセージフォーマット
**説明**: 規定のフォーマットでコミットメッセージを生成する

**フォーマット:**
```
[ai-workflow] Phase X (phase_name) - status

Issue: #XXX
Phase: X (phase_name)
Status: completed/failed
Review: PASS/PASS_WITH_SUGGESTIONS/FAIL

Auto-generated by AI Workflow
```

**受け入れ基準:**
- Given: Phase実行が完了している
- When: コミットメッセージが生成される
- Then:
  - Issue番号が正しく含まれる
  - Phase番号とPhase名が正しく含まれる
  - Statusが実行結果に応じて設定される（completed/failed）
  - レビュー結果が含まれる（レビュー実施時）

#### FR-04: GitPython依存関係の追加
**説明**: GitPythonライブラリを依存関係に追加する

**詳細:**
- 修正ファイル: `scripts/ai-workflow/requirements.txt`
- 追加パッケージ: `gitpython>=3.1.0`

**受け入れ基準:**
- Given: requirements.txtが存在する
- When: `pip install -r requirements.txt`が実行される
- Then: GitPythonパッケージがインストールされる

### 2.2 Jenkins統合の完成（優先度: 高）

#### FR-05: Phase 1-7実行ステージの実装
**説明**: コメントアウトされているPhase実行ステージを実装する

**詳細:**
- 修正ファイル: `jenkins/jobs/pipeline/ai-workflow/ai-workflow-orchestrator/Jenkinsfile`
- 修正箇所: 行156-233（コメントアウト部分）
- 実装対象:
  - Phase 1: Requirements
  - Phase 2: Design
  - Phase 3: Test Scenario
  - Phase 4: Implementation
  - Phase 5: Testing
  - Phase 6: Documentation
  - Phase 7: Report

**受け入れ基準:**
- Given: Jenkinsジョブが実行される
- When: 各Phaseステージに到達する
- Then:
  - Docker環境内で`main.py execute --phase {phase_name} --issue {issue_number}`が実行される
  - レビューがスキップされない場合、`main.py review --phase {phase_name} --issue {issue_number}`が実行される
  - ステージ成功時は次のステージに進む
  - ステージ失敗時はパイプライン全体が失敗する

#### FR-06: 環境変数の追加
**説明**: Jenkins実行に必要な環境変数を追加する

**詳細:**
- `CLAUDE_CODE_OAUTH_TOKEN`: Claude Code OAuthトークン（Jenkins Credentials）
- `GITHUB_REPOSITORY`: GitHubリポジトリ名（例: `tielec/infrastructure-as-code`）

**受け入れ基準:**
- Given: Jenkinsジョブが設定されている
- When: ジョブが実行される
- Then:
  - `CLAUDE_CODE_OAUTH_TOKEN`がCredentials Storeから取得される
  - `GITHUB_REPOSITORY`が環境変数として設定される
  - これらの環境変数がDocker環境に渡される

#### FR-07: Docker環境での実行
**説明**: 各PhaseをDocker環境内で実行する

**詳細:**
- Dockerイメージ: `scripts/ai-workflow/Dockerfile`を使用
- マウント:
  - ワークスペース: `/workspace`
  - AWS認証情報: `~/.aws`（読み取り専用）
- 環境変数: `CLAUDE_CODE_OAUTH_TOKEN`, `GITHUB_TOKEN`等

**受け入れ基準:**
- Given: Dockerfileが存在する
- When: Phaseが実行される
- Then:
  - Docker環境が正常に起動する
  - 必要なファイルがマウントされる
  - 環境変数が正しく設定される
  - Phase実行結果がホストに保存される

### 2.3 テスト（優先度: 中）

#### FR-08: GitManager Unitテスト
**説明**: GitManagerクラスのUnitテストを作成する

**詳細:**
- テストファイル: `tests/unit/core/test_git_manager.py`
- テスト対象:
  - `commit_phase_output()`: 正常系、異常系
  - `push_to_remote()`: 正常系、異常系
  - `create_commit_message()`: メッセージフォーマット検証

**受け入れ基準:**
- Given: テストファイルが存在する
- When: `pytest tests/unit/core/test_git_manager.py`が実行される
- Then:
  - すべてのテストが成功する
  - カバレッジが80%以上である

#### FR-09: Jenkins Job手動実行テスト
**説明**: Jenkinsジョブを手動実行し、各Phaseの動作を確認する

**受け入れ基準:**
- Given: Jenkinsジョブがデプロイされている
- When: ジョブが手動実行される
- Then:
  - Phase 1-7がすべて実行される
  - 各Phase完了後、成果物が自動commitされる
  - レビューが実行される（SKIP_REVIEW=falseの場合）
  - 最終レポートが生成される

### 2.4 ドキュメント更新（優先度: 中）

#### FR-10: AI Workflow README更新
**説明**: Git自動commit機能の説明をREADMEに追加する

**詳細:**
- 修正ファイル: `scripts/ai-workflow/README.md`
- 追加セクション:
  - Git自動commit機能の概要
  - コミットメッセージフォーマット
  - トラブルシューティング

**受け入れ基準:**
- Given: READMEが存在する
- When: ドキュメントが更新される
- Then: Git自動commit機能の使用方法が明確に記載される

#### FR-11: Jenkins README更新
**説明**: ai-workflow-orchestratorジョブの説明をJenkins READMEに追加する

**詳細:**
- 修正ファイル: `jenkins/README.md`
- 追加セクション:
  - ai-workflow-orchestratorジョブの概要
  - パラメータ説明
  - 実行方法

**受け入れ基準:**
- Given: Jenkins READMEが存在する
- When: ドキュメントが更新される
- Then: ai-workflow-orchestratorジョブの使用方法が明確に記載される

#### FR-12: ARCHITECTURE.md更新
**説明**: GitManagerコンポーネントをアーキテクチャドキュメントに追加する

**詳細:**
- 修正ファイル: `scripts/ai-workflow/ARCHITECTURE.md`
- 追加セクション:
  - GitManagerコンポーネントの責務
  - 他コンポーネントとの関係

**受け入れ基準:**
- Given: ARCHITECTURE.mdが存在する
- When: ドキュメントが更新される
- Then: GitManagerコンポーネントがアーキテクチャ図に含まれる

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### NFR-01: Git操作のパフォーマンス
- Git commit & push操作は30秒以内に完了すること
- 大量のファイル（100ファイル以上）がある場合でも、60秒以内に完了すること

#### NFR-02: Jenkins実行時間
- Phase 1-7の合計実行時間は2時間以内であること
- 各Phaseのタイムアウトは20分に設定すること

### 3.2 セキュリティ要件

#### NFR-03: 認証情報の管理
- OAuthトークンはJenkins Credentials Storeで管理すること
- トークンはログに出力しないこと
- Docker環境内でトークンを環境変数として安全に渡すこと

#### NFR-04: Git操作の権限
- Git操作は必要最小限の権限で実行すること
- `.ai-workflow/` ディレクトリ以外へのcommitは禁止すること

### 3.3 可用性・信頼性要件

#### NFR-05: エラーハンドリング
- Git操作失敗時はログに記録し、Phase自体は継続すること
- リトライ機能を実装すること（最大3回）
- ネットワークエラー時は適切なエラーメッセージを表示すること

#### NFR-06: 冪等性
- 同じPhaseを複数回実行しても、同じ結果が得られること
- Git操作は既存のcommitと競合しないこと

### 3.4 保守性・拡張性要件

#### NFR-07: コードの保守性
- GitManagerクラスは単一責任原則に従うこと
- メソッドは1つあたり50行以内に収めること
- 型ヒントを使用すること

#### NFR-08: 拡張性
- 将来的なGit操作（branch作成、PR作成等）を追加できる設計とすること
- 設定ファイル（`config.yaml`）で動作をカスタマイズできること

## 4. 制約事項

### 4.1 技術的制約

#### C-01: 既存実装との整合性
- 既存のJenkinsfile構造（Docker実行、環境変数設定）を維持すること
- 既存のPythonコード（BasePhase、GitHubClient等）と整合性を保つこと
- プロジェクトのコーディング規約（`CLAUDE.md`）に従うこと

#### C-02: 使用技術
- Python 3.8以上
- GitPython 3.1.0以上
- Jenkins 2.400以上
- Docker環境での実行

### 4.2 リソース制約

#### C-03: 実装期間
- 実装期間: 5営業日以内
- テスト期間: 3営業日以内

#### C-04: Jenkins環境
- 既存のJenkins環境を使用
- 新規プラグインのインストールは最小限とする

### 4.3 ポリシー制約

#### C-05: コーディング規約
- コメントは日本語で記述すること（`CLAUDE.md`に準拠）
- コミットメッセージは規定フォーマットに従うこと

#### C-06: セキュリティポリシー
- クレデンシャルのハードコーディング禁止
- SSMパラメータはSecureString使用（該当する場合）
- ログに機密情報を出力しない

## 5. 前提条件

### 5.1 システム環境

#### ENV-01: Python環境
- Python 3.8以上がインストールされていること
- pip 20.0以上がインストールされていること
- 仮想環境（venv）が使用可能であること

#### ENV-02: Git環境
- Git 2.30以上がインストールされていること
- GitHubリポジトリへのpush権限があること
- Git認証情報（SSH鍵またはトークン）が設定されていること

#### ENV-03: Jenkins環境
- Jenkins 2.400以上が稼働していること
- Docker Pipeline Pluginがインストールされていること
- Credentials Pluginがインストールされていること

### 5.2 依存コンポーネント

#### DEP-01: AI Workflow Phase 1-7
- Phase 1-7の実装が完了していること（Issue #304）
- `scripts/ai-workflow/main.py`が正常動作すること
- 各Phaseクラスが実装されていること

#### DEP-02: Jenkins Job DSL
- Job DSL Pluginがインストールされていること
- `ai-workflow-orchestrator.groovy`が存在すること
- `job-config.yaml`に登録されていること

### 5.3 外部システム連携

#### EXT-01: GitHub API
- GitHub APIへのアクセスが可能であること
- Personal Access TokenまたはGitHub Appトークンが利用可能であること

#### EXT-02: Claude Code API
- Claude Code OAuth認証が設定されていること
- APIレート制限内で実行可能であること

## 6. 受け入れ基準

### 6.1 機能受け入れ基準

#### AC-01: Git自動commit & push機能
- Given: あるPhaseが実行される
- When: Phase実行が完了する
- Then:
  - `.ai-workflow/issue-XXX/` 配下のファイルがcommitされる
  - リモートリポジトリにpushされる
  - コミットメッセージが規定フォーマットに従う
  - Git操作失敗時もPhaseは継続する

#### AC-02: Jenkins Phase実行
- Given: `ai-workflow-orchestrator`ジョブが実行される
- When: 各Phaseが実行される
- Then:
  - Phase 1-7がすべて実行される
  - Docker環境内で実行される
  - 環境変数が正しく設定される
  - レビューが実行される（SKIP_REVIEW=falseの場合）

#### AC-03: エラーハンドリング
- Given: Git操作が失敗する
- When: リトライが実行される
- Then:
  - 最大3回リトライされる
  - エラーメッセージがログに記録される
  - Phase自体は継続する

### 6.2 品質受け入れ基準

#### AC-04: テストカバレッジ
- Given: Unitテストが実装されている
- When: `pytest --cov`が実行される
- Then:
  - GitManagerクラスのカバレッジが80%以上である
  - すべてのテストが成功する

#### AC-05: ドキュメント品質
- Given: ドキュメントが更新されている
- When: ドキュメントがレビューされる
- Then:
  - 使用方法が明確に記載されている
  - トラブルシューティング情報が含まれている
  - サンプルコードが提供されている

### 6.3 統合受け入れ基準

#### AC-06: エンドツーエンドテスト
- Given: Jenkinsジョブがデプロイされている
- When: Issue番号を指定してジョブを実行する
- Then:
  - Phase 1-7がすべて実行される
  - 各Phase完了後、成果物がcommitされる
  - 最終レポートが生成される
  - GitHubリポジトリに成果物がpushされる

## 7. スコープ外

### 7.1 明確にスコープ外とする事項

#### OUT-01: Pull Request自動作成
- Phase完了後のPull Request自動作成機能は本タスクのスコープ外
- 将来的な拡張候補として検討

#### OUT-02: ブランチ戦略
- 自動的なfeatureブランチ作成・切り替えは本タスクのスコープ外
- mainブランチへの直接commitを前提とする

#### OUT-03: コンフリクト解決
- Git merge conflictの自動解決は本タスクのスコープ外
- コンフリクト発生時は手動対応が必要

#### OUT-04: Jenkins UI拡張
- カスタムUI（Blue Ocean等）の実装は本タスクのスコープ外
- 標準のJenkins UIを使用

### 7.2 将来的な拡張候補

#### FUT-01: Pull Request自動作成
- Phase 7完了後、自動的にPull Requestを作成する機能
- レビュアーの自動割り当て

#### FUT-02: Slack/Teams通知
- Phase完了時のSlack/Teams通知機能
- エラー発生時のアラート

#### FUT-03: メトリクス収集
- Phase実行時間の測定
- 成功率・失敗率の集計
- ダッシュボード表示

#### FUT-04: 並列実行
- 独立したPhaseの並列実行
- 実行時間の短縮

---

## 付録

### A. コミットメッセージフォーマット詳細

```
[ai-workflow] Phase {phase_number} ({phase_name}) - {status}

Issue: #{issue_number}
Phase: {phase_number} ({phase_name})
Status: {completed|failed}
Review: {PASS|PASS_WITH_SUGGESTIONS|FAIL|N/A}

Auto-generated by AI Workflow
```

**変数説明:**
- `{phase_number}`: Phase番号（1-7）
- `{phase_name}`: Phase名（requirements, design, test_scenario, implementation, testing, documentation, report）
- `{status}`: 実行結果（completed/failed）
- `{issue_number}`: GitHub Issue番号
- `{PASS|PASS_WITH_SUGGESTIONS|FAIL|N/A}`: レビュー結果（レビュー未実施時はN/A）

**例:**
```
[ai-workflow] Phase 1 (requirements) - completed

Issue: #305
Phase: 1 (requirements)
Status: completed
Review: PASS

Auto-generated by AI Workflow
```

### B. 参考実装ファイル

- `jenkins/jobs/pipeline/ai-workflow/ai-workflow-orchestrator/Jenkinsfile` - Jenkins Pipeline定義
- `jenkins/jobs/dsl/ai-workflow/ai-workflow-orchestrator.groovy` - Job DSL定義
- `scripts/ai-workflow/phases/base_phase.py` - BasePhaseクラス
- `scripts/ai-workflow/core/github_client.py` - GitHubClient参考実装
- `scripts/ai-workflow/core/claude_agent_client.py` - Claude Agent Client参考実装

### C. 品質ゲート確認チェックリスト

- [x] **機能要件が明確に記載されている** - FR-01 ~ FR-12として明確に定義
- [x] **受け入れ基準が定義されている** - AC-01 ~ AC-06として明確に定義
- [x] **スコープが明確である** - セクション7で明確に定義
- [x] **論理的な矛盾がない** - 全セクション間で整合性を確認済み
