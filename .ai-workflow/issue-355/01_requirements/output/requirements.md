# 要件定義書 - Issue #355

## ドキュメント情報

- **Issue番号**: #355
- **タイトル**: [FEATURE] AI Workflow: Init時にドラフトPRを自動作成
- **作成日**: 2025-10-12
- **バージョン**: 1.0.0

---

## 0. Planning Documentの確認

### 開発計画の全体像

Planning Phase（Phase 0）で策定された以下の戦略を踏まえて要件定義を実施します。

#### 実装戦略
- **戦略**: EXTEND（既存のinitコマンドを拡張）
- **根拠**:
  - 新規ファイル作成不要
  - GitManagerとGitHubClientの既存機能を活用
  - 最小限の変更で実装可能

#### テスト戦略
- **戦略**: UNIT_INTEGRATION（ユニットテストと統合テストの両方）
- **根拠**:
  - ユニットテスト: `GitHubClient.create_pull_request()`のモック化テスト
  - 統合テスト: initコマンド全体のワークフロー（ブランチ作成 → commit → push → PR作成）

#### テストコード戦略
- **戦略**: BOTH_TEST（既存テストの拡張と新規テスト作成）
- **根拠**:
  - 既存テストの拡張: `tests/unit/core/test_github_client.py`
  - 新規テスト作成: `tests/unit/test_main_init_pr.py`, `tests/integration/test_init_pr_workflow.py`

#### 複雑度とリスク
- **複雑度**: 中程度
- **総工数**: 約12時間
- **総合リスク**: 中
- **主要リスク**:
  - GitHub Token権限不足（repo スコープが必要）
  - gh CLI依存による環境構築の複雑化（→ PyGithubで実装して回避）
  - 既存PR重複によるエラー

---

## 1. 概要

### 背景
AI Workflowの初期化（`python main.py init --issue-url <URL>`）実行時、現在は以下の処理が行われます：

1. `.ai-workflow/issue-XXX/metadata.json` の作成
2. ローカルブランチ `ai-workflow/issue-XXX` の作成またはチェックアウト
3. **処理が終了**（ブランチはローカルにのみ存在）

この状態では、以下の問題が発生します：

- **可視性の低さ**: GitHub上でワークフローの進捗を追跡できない
- **手作業の必要性**: ブランチのpushとPR作成を手動で実施する必要がある
- **協業の困難さ**: 他の開発者がワークフローの状態を確認できない
- **CI/CD統合の遅延**: PRが存在しないため、GitHub ActionsやJenkinsとの連携が困難

### 目的
init実行時に以下を自動化し、開発者の作業効率とワークフローの可視性を向上させます：

1. metadata.jsonをGitコミット
2. リモートブランチへのpush
3. ドラフトPull Requestの自動作成

### ビジネス価値
- **開発効率の向上**: 手作業によるpush・PR作成が不要になり、ワークフロー開始が1コマンドで完結
- **可視性の向上**: GitHub上でワークフローの進捗をリアルタイムで追跡可能
- **レビューの早期化**: ドラフトPRにより、作業中でもレビュアーがコードを確認可能

### 技術的価値
- **CI/CD統合の簡素化**: PRが存在することで、GitHub ActionsやJenkinsとの連携が容易
- **チーム協業の改善**: 他の開発者がワークフローの状態を把握しやすい
- **ブランチ保護ルールとの統合**: PRベースのワークフローを実現

---

## 2. 機能要件

### FR-01: metadata.json自動コミット（優先度: 高）

**要件内容**:
init実行後、metadata.jsonを自動的にGitコミットする。

**詳細**:
- 対象ファイル: `.ai-workflow/issue-{issue_number}/metadata.json`
- コミットメッセージフォーマット:
  ```
  [ai-workflow] Phase 0 (planning) - completed

  Issue: #{issue_number}
  Phase: 0 (planning)
  Status: completed
  Review: N/A

  Auto-generated by AI Workflow
  ```
- 既存のGitManager.commit_phase_output()メソッドを活用

**検証可能な基準**:
- init実行後、`git log`でコミットが確認できる
- コミットメッセージが規定フォーマットに従っている
- metadata.jsonのみがコミット対象に含まれる

---

### FR-02: リモートブランチへの自動push（優先度: 高）

**要件内容**:
コミット成功後、ブランチを自動的にリモートリポジトリにpushする。

**詳細**:
- pushコマンド: `git push origin ai-workflow/issue-{issue_number}`
- リモートブランチが存在しない場合: `git push -u origin ai-workflow/issue-{issue_number}`
- リモートブランチが存在する場合: `git push origin ai-workflow/issue-{issue_number}`
- 既存のGitManager.push_to_remote()メソッドを活用（最大3回リトライ機能付き）

**検証可能な基準**:
- init実行後、`git ls-remote`でリモートブランチが確認できる
- push失敗時は最大3回リトライされる
- ネットワークエラー時はリトライされる
- 権限エラー時はリトライせずにエラーを返す

---

### FR-03: ドラフトPR自動作成（優先度: 高）

**要件内容**:
push成功後、ドラフトPull Requestを自動的に作成する。

**詳細**:
- 実装方法: PyGithubのPR作成API（gh CLI依存を排除）
- PRタイトル: `[AI-Workflow] Issue #{issue_number}`
- PRベースブランチ: `main`（またはリポジトリのデフォルトブランチ）
- PRヘッドブランチ: `ai-workflow/issue-{issue_number}`
- PR状態: ドラフト（draft=True）
- PR本文テンプレート: 以下の構造
  ```markdown
  ## AI Workflow自動生成PR

  ### 📋 関連Issue
  Closes #{issue_number}

  ### 🔄 ワークフロー進捗

  - [x] Phase 0: Planning
  - [ ] Phase 1: Requirements
  - [ ] Phase 2: Design
  - [ ] Phase 3: Test Scenario
  - [ ] Phase 4: Implementation
  - [ ] Phase 5: Test Implementation
  - [ ] Phase 6: Testing
  - [ ] Phase 7: Documentation
  - [ ] Phase 8: Report

  ### 📁 成果物

  `.ai-workflow/issue-{issue_number}/` ディレクトリに各フェーズの成果物が格納されています。

  ### ⚙️ 実行環境

  - **モデル**: Claude Code Pro Max (Sonnet 4.5)
  - **ContentParser**: OpenAI GPT-4o mini
  - **ブランチ**: ai-workflow/issue-{issue_number}
  ```

**検証可能な基準**:
- init実行後、GitHub上でドラフトPRが作成される
- PRタイトルが規定フォーマットに従っている
- PR本文が上記テンプレートに従っている
- PRがドラフト状態である
- Issue番号が正しくリンクされている（Closes #XXX）

---

### FR-04: 既存PRチェック機能（優先度: 中）

**要件内容**:
PR作成前に、同じブランチで既にPRが存在するかチェックする。

**詳細**:
- チェック対象: ブランチ `ai-workflow/issue-{issue_number}` に対応するPR
- 既存PR存在時の挙動:
  - 警告メッセージを表示: `[WARNING] PR already exists: {pr_url}`
  - PR作成をスキップ（エラーではない、成功として扱う）
  - 既存PRのURLをログ出力
- チェック方法: `PyGithub`の`repository.get_pulls(head=branch_name)`を使用

**検証可能な基準**:
- 既存PR存在時、新しいPRが作成されない
- 警告メッセージが表示される
- 既存PRのURLがログに出力される
- init全体は成功として完了する

---

### FR-05: GitHubClient.create_pull_request()メソッド追加（優先度: 高）

**要件内容**:
GitHubClientクラスに、PR作成機能を追加する。

**詳細**:
- メソッド名: `create_pull_request()`
- 引数:
  - `title`: str - PRタイトル
  - `body`: str - PR本文
  - `head`: str - ヘッドブランチ名
  - `base`: str - ベースブランチ名（デフォルト: 'main'）
  - `draft`: bool - ドラフトフラグ（デフォルト: True）
- 戻り値: Dict[str, Any]
  - `success`: bool - 成功/失敗
  - `pr_url`: Optional[str] - PRのURL
  - `pr_number`: Optional[int] - PR番号
  - `error`: Optional[str] - エラーメッセージ
- 実装: PyGithubの`repository.create_pull()`を使用

**検証可能な基準**:
- メソッド呼び出しでPRが作成される
- 戻り値が規定フォーマットに従っている
- エラー時は`success=False`とエラーメッセージを返す

---

### FR-06: GitHubClient.check_existing_pr()メソッド追加（優先度: 中）

**要件内容**:
GitHubClientクラスに、既存PR確認機能を追加する。

**詳細**:
- メソッド名: `check_existing_pr()`
- 引数:
  - `head`: str - ヘッドブランチ名
  - `base`: str - ベースブランチ名（デフォルト: 'main'）
- 戻り値: Optional[Dict[str, Any]]
  - PRが存在する場合:
    - `pr_number`: int - PR番号
    - `pr_url`: str - PRのURL
    - `state`: str - PRの状態（open/closed）
  - PRが存在しない場合: None
- 実装: PyGithub の `repository.get_pulls(head=head, base=base, state='open')` を使用

**検証可能な基準**:
- 既存PR存在時、PR情報を返す
- 既存PRが存在しない場合、Noneを返す
- openとclosedの両方のPRをチェックできる

---

### FR-07: エラーハンドリングとログ出力（優先度: 高）

**要件内容**:
各ステップでエラーが発生した場合、適切にハンドリングし、ログ出力する。

**詳細**:
- commit失敗時:
  - 警告メッセージ: `[WARNING] Commit failed. PR will not be created: {error}`
  - pushとPR作成をスキップ
  - init全体は失敗として終了
- push失敗時:
  - 警告メッセージ: `[WARNING] Push failed. PR will not be created: {error}`
  - PR作成をスキップ
  - init全体は失敗として終了
- PR作成失敗時:
  - 警告メッセージ: `[WARNING] PR creation failed: {error}`
  - init全体は成功として完了（commitとpushは成功しているため）
- GitHub Token権限不足時:
  - エラーメッセージ: `[ERROR] GitHub Token lacks 'repo' scope. Please regenerate token with appropriate permissions.`
  - init全体は失敗として終了

**検証可能な基準**:
- 各エラーケースで適切なログメッセージが表示される
- commitまたはpush失敗時はinit全体が失敗する
- PR作成失敗時でもinit全体は成功する（commitとpushは完了しているため）

---

### FR-08: main.py init コマンドの拡張（優先度: 高）

**要件内容**:
main.pyのinitコマンドを拡張し、commit → push → PR作成のフローを追加する。

**詳細**:
- 処理フロー:
  1. 既存の処理（metadata.json作成、ブランチ作成）
  2. **新規追加**: GitManager.commit_phase_output()を呼び出し
  3. **新規追加**: GitManager.push_to_remote()を呼び出し
  4. **新規追加**: GitHubClient.check_existing_pr()で既存PRをチェック
  5. **新規追加**: 既存PRが存在しない場合、GitHubClient.create_pull_request()を呼び出し
  6. **新規追加**: PR URLをログ出力

**検証可能な基準**:
- init実行後、上記のフローが順番に実行される
- 各ステップの成功/失敗が適切にログ出力される
- エラー時は適切にスキップまたは停止する

---

## 3. 非機能要件

### NFR-01: パフォーマンス要件

- **init実行時間への影響**: init実行時間は追加で3-5秒程度（commit 1秒 + push 1-2秒 + PR作成 1-2秒）
- **GitHub API レート制限**: PR作成は1回のAPI呼び出しのため、レート制限への影響は最小限
- **リトライ機構**: push失敗時は最大3回リトライ（exponential backoff: 2秒, 4秒, 8秒）

### NFR-02: セキュリティ要件

- **GitHub Token管理**:
  - 環境変数 `GITHUB_TOKEN` から読み込み
  - トークンは `repo` スコープが必要（PR作成権限）
  - トークンはログに出力しない（機密情報）
- **SSHキー管理**: 既存のGit認証設定を活用（変更なし）
- **権限チェック**: PR作成前にGitHub Tokenの権限を確認（可能であれば）

### NFR-03: 可用性・信頼性要件

- **ネットワークエラー対応**: push失敗時は最大3回リトライ
- **部分的失敗の許容**: PR作成失敗時でもinit全体は成功として扱う（commitとpushは完了しているため）
- **既存PR存在時の安全性**: 既存PRが存在する場合は新規作成をスキップ（重複防止）

### NFR-04: 保守性・拡張性要件

- **モジュラー設計**: GitHubClient.create_pull_request()を独立したメソッドとして実装
- **テスト容易性**: モック化可能な設計（PyGithubのインターフェースを活用）
- **将来の拡張性**:
  - PR本文の動的更新機能（各フェーズ完了時にチェックリストを更新）
  - `--no-pr` オプションの追加（PR作成をスキップ）

---

## 4. 制約事項

### 技術的制約

1. **PyGithubライブラリの使用**:
   - gh CLI依存を排除し、PyGithubのPR作成APIを使用
   - PyGithubはプロジェクトに既に導入済み

2. **既存コードとの整合性**:
   - GitManager.commit_phase_output()とpush_to_remote()は既存実装をそのまま活用
   - GitHubClientクラスに新規メソッドを追加（破壊的変更なし）

3. **Git設定**:
   - user.nameとuser.emailが未設定の場合、環境変数またはデフォルト値を使用（既存実装）

### リソース制約

1. **時間**: 総工数 約12時間（Planning Documentで策定）
2. **人員**: 1名（AI Workflowによる自動化）
3. **GitHub API レート制限**:
   - 認証済みユーザー: 5000リクエスト/時間
   - init1回あたり: 2-3リクエスト（issue取得、PR作成、既存PRチェック）
   - 制限への影響は無視できるレベル

### ポリシー制約

1. **コーディング規約**:
   - CLAUDE.mdのガイドラインに準拠
   - コメントとドキュメントは日本語で記述
   - コミットメッセージは既存フォーマットに従う

2. **セキュリティポリシー**:
   - GitHub Tokenはハードコーディング禁止
   - トークンはログに出力しない

3. **ブランチ保護ルール**:
   - `ai-workflow/*` ブランチは保護しない（PRワークフローを可能にする）
   - `main` ブランチへの直接pushは禁止（既存ルール）

---

## 5. 前提条件

### システム環境

1. **Python環境**: Python 3.11以上
2. **必要なライブラリ**:
   - PyGithub 2.0以上（既にインストール済み）
   - GitPython 3.1以上（既にインストール済み）
3. **Git環境**: Git 2.0以上
4. **Docker環境**: Docker 20.0以上（オプション、CI/CDで使用）

### 依存コンポーネント

1. **GitManager**:
   - `commit_phase_output()`: metadata.jsonをコミット
   - `push_to_remote()`: リモートブランチにpush（リトライ機能付き）
   - `_ensure_git_config()`: Git設定の自動設定

2. **GitHubClient**:
   - `get_issue()`: Issue情報を取得（既存）
   - `create_pull_request()`: PR作成（新規実装）
   - `check_existing_pr()`: 既存PRチェック（新規実装）

3. **MetadataManager**:
   - Issue番号の取得: `metadata.data['issue_number']`

### 外部システム連携

1. **GitHub API**:
   - エンドポイント: `https://api.github.com/`
   - 認証: Personal Access Token（`GITHUB_TOKEN`）
   - 必要なスコープ: `repo`（PR作成権限）

2. **Gitリモートリポジトリ**:
   - プロトコル: HTTPS
   - 認証: GitHub Token（環境変数から自動設定、GitManager._setup_github_credentials()）

---

## 6. 受け入れ基準

### AC-01: init実行後、metadata.jsonが自動コミットされる

**Given**: Issue URLを指定してinit実行
**When**: metadata.jsonが作成される
**Then**:
- `git log`でコミットが確認できる
- コミットメッセージが `[ai-workflow] Phase 0 (planning) - completed` で始まる
- コミット対象ファイルが `.ai-workflow/issue-{issue_number}/metadata.json` のみ

---

### AC-02: コミット成功後、ブランチがリモートにpushされる

**Given**: metadata.jsonのコミットが成功
**When**: push処理が実行される
**Then**:
- `git ls-remote`でリモートブランチ `origin/ai-workflow/issue-{issue_number}` が確認できる
- push成功メッセージが表示される: `[INFO] Git push successful`

---

### AC-03: push成功後、ドラフトPRが自動作成される

**Given**: ブランチのpushが成功
**When**: PR作成処理が実行される
**Then**:
- GitHub上でドラフトPRが作成される
- PRタイトルが `[AI-Workflow] Issue #{issue_number}` である
- PRがドラフト状態である
- PR本文に以下が含まれる:
  - `Closes #{issue_number}`
  - ワークフロー進捗チェックリスト
  - 成果物ディレクトリの説明
  - 実行環境情報
- PR URLがログに出力される: `[INFO] Draft PR created: {pr_url}`

---

### AC-04: 既存PRが存在する場合、新規PR作成をスキップする

**Given**: 同じブランチで既にPRが存在する
**When**: init実行時にPR作成処理が実行される
**Then**:
- 新しいPRは作成されない
- 警告メッセージが表示される: `[WARNING] PR already exists: {pr_url}`
- init全体は成功として完了する

---

### AC-05: commit失敗時、pushとPR作成がスキップされる

**Given**: metadata.jsonのコミットが失敗
**When**: init実行が進行する
**Then**:
- 警告メッセージが表示される: `[WARNING] Commit failed. PR will not be created: {error}`
- pushとPR作成はスキップされる
- init全体は失敗として終了する

---

### AC-06: push失敗時、PR作成がスキップされる

**Given**: ブランチのpushが失敗
**When**: init実行が進行する
**Then**:
- 警告メッセージが表示される: `[WARNING] Push failed. PR will not be created: {error}`
- PR作成はスキップされる
- init全体は失敗として終了する
- push失敗時は最大3回リトライされる（ネットワークエラーの場合）

---

### AC-07: PR作成失敗時、init全体は成功として完了する

**Given**: commit・pushが成功し、PR作成が失敗
**When**: init実行が進行する
**Then**:
- 警告メッセージが表示される: `[WARNING] PR creation failed: {error}`
- init全体は成功として完了する（commitとpushは完了しているため）

---

### AC-08: GitHub Token権限不足時、適切なエラーメッセージが表示される

**Given**: GitHub Tokenに `repo` スコープが設定されていない
**When**: PR作成処理が実行される
**Then**:
- エラーメッセージが表示される: `[ERROR] GitHub Token lacks 'repo' scope. Please regenerate token with appropriate permissions.`
- init全体は失敗として終了する

---

## 7. スコープ外

### 明確にスコープ外とする事項

1. **PR本文の動的更新機能**:
   - 各フェーズ完了時にPR本文のチェックリストを自動更新する機能
   - 理由: 初期実装では静的なテンプレートで十分
   - 将来的な拡張候補: Issue #XXX（別Issue化）

2. **`--no-pr` オプション**:
   - PR作成をスキップするCLIオプション
   - 理由: Issue本文に記載があるが、初期実装では必須ではない
   - 将来的な拡張候補: Issue本文に記載あり

3. **PR作成のリトライ機構**:
   - PR作成失敗時のリトライ処理
   - 理由: push失敗時のリトライは実装済み、PR作成は冪等性が低いためリトライは不要
   - 代替案: PR作成失敗時はログ出力のみ、手動でPR作成を実施

4. **PR自動マージ機能**:
   - 全フェーズ完了時にPRを自動的にマージする機能
   - 理由: レビュープロセスを省略するリスクがある
   - 将来的な拡張候補: 別Issueで検討

5. **gh CLI統合**:
   - gh CLIを使用したPR作成
   - 理由: PyGithubで実装することで依存を簡素化
   - 代替案: PyGithub の PR作成API を使用

6. **PR作成通知機能**:
   - PR作成時にSlackやメールで通知する機能
   - 理由: GitHubの標準通知機能で十分
   - 将来的な拡張候補: Jenkins統合時に検討

---

## 8. 補足情報

### 関連ファイル

1. **main.py:339-405** - initコマンドの既存実装
2. **core/git_manager.py:50-169** - commit_phase_output()メソッド
3. **core/git_manager.py:171-284** - push_to_remote()メソッド
4. **core/github_client.py** - GitHub API統合（PR作成機能は未実装）

### 既存機能の活用

1. **GitManager.commit_phase_output()**: metadata.jsonをcommitする機能は既に実装済み
2. **GitManager.push_to_remote()**: リトライ機能付きのpush実装は既に存在
3. **GitManager.create_branch()**: ブランチ作成とリモート同期は実装済み
4. **GitHubClient**: Issue情報取得とコメント投稿は実装済み（PR作成は未実装）

### 技術スタック

- **言語**: Python 3.11+
- **Git操作**: GitPython 3.1+
- **GitHub API**: PyGithub 2.0+
- **テスト**: pytest 7.0+
- **Docker**: Docker 20.0+
- **CI/CD**: Jenkins（ai-workflow-orchestratorジョブ）

---

## 9. 成功基準

以下の条件をすべて満たす場合、本要件定義は成功とみなされます：

1. ✅ **機能要件が明確に記載されている**: 全8個の機能要件（FR-01〜FR-08）が具体的かつ検証可能な形で定義されている
2. ✅ **受け入れ基準が定義されている**: 全8個の受け入れ基準（AC-01〜AC-08）がGiven-When-Then形式で明確に記述されている
3. ✅ **スコープが明確である**: スコープ外の事項が6個明示されており、将来的な拡張候補も記載されている
4. ✅ **論理的な矛盾がない**: 各セクション間で矛盾がなく、Planning Documentの戦略と整合している

---

## 10. 次のステップ

要件定義完了後、以下のフェーズに進みます：

- **Phase 2（設計）**: アーキテクチャ設計、クラス設計、データ構造設計
- **Phase 3（テストシナリオ）**: ユニットテスト、統合テスト、E2Eテストのシナリオ作成
- **Phase 4（実装）**: GitHubClient拡張、main.py init拡張、Docker環境整備

---

**要件定義書バージョン**: 1.0.0
**作成日**: 2025-10-12
**レビュー**: クリティカルシンキングレビュー待ち
