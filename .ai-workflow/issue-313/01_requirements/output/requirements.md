# 要件定義書: Phase 0 (Planning) - プロジェクトマネージャ役割の追加

## 1. 概要

### 1.1 背景
現在のAI駆動開発自動化ワークフローは、以下の構成となっている：

- **Execute (Phase 1-7)**: 開発者の役割
  - Phase 1: Requirements（要件定義）
  - Phase 2: Design（設計）
  - Phase 3: Test Scenario（テストシナリオ）
  - Phase 4: Implementation（実装）
  - Phase 5: Testing（テスト）
  - Phase 6: Documentation（ドキュメント）
  - Phase 7: Report（レポート）

- **Review**: QAエンジニアの役割
  - 各フェーズの品質チェック
  - 品質ゲートの判定（PASS/PASS_WITH_SUGGESTIONS/FAIL）

現在のPhase 2（Design）では実装戦略（CREATE/EXTEND/REFACTOR）やテスト戦略の決定を行っているが、これらの重要な判断は設計フェーズではなく、プロジェクト開始前の計画フェーズで行うべきである。

### 1.2 目的
**Phase 0 (Planning): プロジェクトマネージャ**の役割を追加し、以下を実現する：

1. **計画の前倒し**: 実装戦略・テスト戦略の決定をPhase 2からPhase 0に移行
2. **プロジェクト俯瞰**: Issue内容を分析し、全体的な作業計画を策定
3. **リスク管理**: 潜在的な問題を早期発見し、軽減策を準備
4. **タスク管理**: 適切な粒度でタスクを分割し、依存関係を明確化
5. **進捗管理**: 各フェーズの見積もりとマイルストーン設定

### 1.3 ビジネス価値
- **計画性の向上**: 事前に全体像を把握することで手戻りを削減
- **見積もり精度向上**: タスク分割と依存関係の明確化により、より正確な工数見積もりが可能
- **リスク軽減**: 早期のリスク評価により、問題発生前に対策を講じられる
- **コミュニケーション改善**: ステークホルダーに明確な計画を提示できる

### 1.4 技術的価値
- **Phase 2の負荷軽減**: 実装戦略決定をPhase 0に移行することで、Phase 2は純粋な設計に専念できる
- **メタデータの充実**: planning.mdとmetadata.jsonに計画情報を保存し、後続フェーズで参照可能
- **モジュール性の向上**: 既存のBasePhase構造を活用した拡張

## 2. 機能要件

### 2.1 Issue分析と作業計画の策定（優先度: 高）

#### FR-1.1: Issue複雑度分析
- **説明**: Issueの内容を分析し、複雑度を評価する
- **複雑度レベル**:
  - **簡単**: 単一ファイルの修正、シンプルな機能追加（見積もり: 〜4時間）
  - **中程度**: 複数ファイルの修正、既存機能の拡張（見積もり: 4〜16時間）
  - **複雑**: アーキテクチャ変更、新規サブシステム追加（見積もり: 16時間〜）
- **入力**: Issue情報（タイトル、本文、ラベル）
- **出力**: 複雑度判定（簡単/中程度/複雑）、判定理由

#### FR-1.2: 実装タスクの洗い出しと分割
- **説明**: Issue要件を実装可能な粒度のタスクに分割する
- **タスク粒度基準**:
  - 1タスク = 1〜4時間程度で完了可能な作業単位
  - 明確な完了条件（Done criteria）を持つ
  - 他のタスクから独立して実装・テスト可能
- **入力**: Issue本文のTODOリスト
- **出力**: Phase別のサブタスクリスト

#### FR-1.3: タスク間依存関係の特定
- **説明**: タスク間の依存関係を明確化し、実行順序を決定する
- **依存関係タイプ**:
  - **必須依存**: タスクAの完了なしにタスクBは開始不可
  - **推奨依存**: 並行実行可能だが、順序実行が望ましい
  - **独立**: 完全に独立して実行可能
- **入力**: タスクリスト
- **出力**: 依存関係グラフ（Mermaid形式推奨）

#### FR-1.4: 各フェーズの見積もり
- **説明**: Phase 1〜7の各フェーズについて工数を見積もる
- **見積もり要素**:
  - 実装工数（人時）
  - レビュー・修正工数（リトライを考慮）
  - バッファ（不確実性への対応）
- **入力**: タスクリスト、複雑度
- **出力**: Phase別見積もり（時間単位）

#### FR-1.5: リスク評価とリスク軽減策
- **説明**: プロジェクト実行時の潜在的リスクを特定し、軽減策を提案する
- **リスクカテゴリ**:
  - **技術的リスク**: 新技術の学習コスト、既存システムとの統合問題
  - **スコープリスク**: 要件の曖昧さ、スコープクリープ
  - **リソースリスク**: 工数不足、スキル不足
  - **依存リスク**: 外部システム依存、ブロッキング問題
- **入力**: Issue内容、タスクリスト、依存関係
- **出力**: リスクリスト（各リスクに対する軽減策付き）

### 2.2 実装戦略の事前決定（優先度: 高）

#### FR-2.1: 実装戦略の決定
- **説明**: Phase 2で行っていた実装戦略決定をPhase 0に移行する
- **実装戦略タイプ**:
  - **CREATE**: 新規ファイル・クラス・モジュールの作成
  - **EXTEND**: 既存コードの拡張（機能追加）
  - **REFACTOR**: 既存コードのリファクタリング（構造改善）
- **判断基準**:
  - Issue内容（新規機能 vs 既存機能改善）
  - 既存コードベースの調査結果
  - アーキテクチャ設計思想との整合性
- **入力**: Issue情報、既存コードベースの調査結果
- **出力**: 実装戦略（CREATE/EXTEND/REFACTOR）、選定理由

#### FR-2.2: テスト戦略の決定
- **説明**: 必要なテストレベルを決定する
- **テスト戦略タイプ**:
  - **UNIT_ONLY**: ユニットテストのみ
  - **INTEGRATION_ONLY**: インテグレーションテストのみ
  - **BDD_ONLY**: BDDテスト（Behaveフレームワーク）のみ
  - **UNIT_INTEGRATION**: ユニット + インテグレーション
  - **UNIT_BDD**: ユニット + BDD
  - **INTEGRATION_BDD**: インテグレーション + BDD
  - **ALL**: すべてのテストレベル
- **判断基準**:
  - 変更の影響範囲（コンポーネント内 vs システム全体）
  - リスクレベル（低リスク vs 高リスク）
  - 既存テストカバレッジ
- **入力**: 実装戦略、影響範囲分析
- **出力**: テスト戦略（上記タイプから選択）、選定理由

#### FR-2.3: テストコード戦略の決定
- **説明**: 既存テストの拡張か新規作成かを決定する
- **テストコード戦略タイプ**:
  - **EXTEND_TEST**: 既存テストファイルに追加
  - **CREATE_TEST**: 新規テストファイル作成
  - **BOTH_TEST**: 両方（既存テスト拡張 + 新規テスト作成）
- **判断基準**:
  - 実装戦略（CREATE → CREATE_TEST、EXTEND → EXTEND_TEST）
  - 既存テストファイルの構造
- **入力**: 実装戦略
- **出力**: テストコード戦略（上記タイプから選択）

#### FR-2.4: 影響範囲の分析
- **説明**: 変更が影響するコンポーネント・モジュールを特定する
- **影響範囲レベル**:
  - **限定的**: 単一ファイル・単一クラス内
  - **モジュール内**: 同一モジュール内の複数ファイル
  - **システム全体**: 複数モジュール、外部システム連携
- **入力**: Issue内容、既存コードベース調査
- **出力**: 影響を受けるファイル・モジュールのリスト

### 2.3 成果物の生成（優先度: 高）

#### FR-3.1: planning.md の生成
- **説明**: プロジェクト計画書をMarkdown形式で生成する
- **必須セクション**:
  1. **Issue分析**: 複雑度、見積もり工数、リスク評価
  2. **実装戦略**: 戦略タイプ、テスト戦略、影響範囲
  3. **タスク分割**: Phase別サブタスクリスト（見積もり付き）
  4. **依存関係**: タスク間の依存関係図
  5. **リスクと軽減策**: リスクリストと各対応策
  6. **品質ゲート**: Phase別の合格基準
- **出力先**: `.ai-workflow/issue-{number}/00_planning/output/planning.md`
- **フォーマット**: GitHub Flavored Markdown

#### FR-3.2: metadata.jsonへの戦略保存
- **説明**: 決定した戦略をmetadata.jsonに保存する
- **保存項目**:
  ```json
  {
    "design_decisions": {
      "implementation_strategy": "CREATE|EXTEND|REFACTOR",
      "test_strategy": "UNIT_ONLY|INTEGRATION_ONLY|...|ALL",
      "test_code_strategy": "EXTEND_TEST|CREATE_TEST|BOTH_TEST"
    }
  }
  ```
- **タイミング**: Planning Phase完了時
- **アクセス**: 後続フェーズから参照可能

### 2.4 品質保証とレビュー（優先度: 高）

#### FR-4.1: 計画書のレビュー
- **説明**: 作成されたplanning.mdをレビューし、実現可能性を確認する
- **レビュー観点**:
  - **実現可能性**: 見積もりが現実的か、リソースは十分か
  - **タスク分割の適切性**: 粒度が適切か、依存関係は正確か
  - **リスク分析の網羅性**: 重要なリスクが見逃されていないか
  - **戦略判断の妥当性**: 実装戦略・テスト戦略が適切か
- **判定基準**:
  - **PASS**: 計画が適切で実行可能
  - **PASS_WITH_SUGGESTIONS**: 改善余地はあるが実行可能
  - **FAIL**: 重大な問題があり再計画が必要
- **入力**: planning.md
- **出力**: レビュー結果（判定、フィードバック、改善提案）

#### FR-4.2: リトライ機能
- **説明**: レビューで不合格の場合、最大3回まで計画を修正する
- **リトライプロセス**:
  1. レビューフィードバックを取得
  2. revise()メソッドで計画を修正
  3. 再度レビュー実行
  4. 最大3回まで繰り返し
- **入力**: レビューフィードバック
- **出力**: 修正されたplanning.md

### 2.5 後続フェーズとの連携（優先度: 中）

#### FR-5.1: Phase 2への情報引き継ぎ
- **説明**: Phase 2（Design）は実装戦略決定を行わず、Phase 0の結果を参照する
- **変更点**:
  - Phase 2のプロンプトから実装戦略決定ロジックを削除
  - metadata.jsonから戦略情報を読み取り、設計に反映
- **互換性**: 既存のPhase 2実装との後方互換性を維持

#### FR-5.2: 進捗トラッキング（将来拡張）
- **説明**: 各フェーズの進捗を計画と比較してトラッキング
- **スコープ**: 本Phase（Phase 0追加）では実装しない（Phase 8で実装予定）
- **将来実装**: Phase 8 (Evaluation)で全体評価時に実装

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **NFR-1.1**: Planning Phase実行時間は15分以内であること
  - Claude Agent SDK実行: 最大50ターン
  - タイムアウト: 15分
- **NFR-1.2**: planning.mdのファイルサイズは500KB以内であること
  - 長大な計画書は可読性を損なうため制限

### 3.2 可用性・信頼性要件
- **NFR-2.1**: レビュー失敗時のリトライ機能により、最大3回の修正機会を提供すること
- **NFR-2.2**: metadata.jsonの読み書きでエラーが発生した場合、適切なエラーメッセージを表示すること
- **NFR-2.3**: Git自動commit & pushが失敗してもPhase自体は失敗させないこと（既存仕様を踏襲）

### 3.3 保守性・拡張性要件
- **NFR-3.1**: BasePhaseクラスを継承した実装により、既存フェーズと同様の構造を維持すること
- **NFR-3.2**: PHASE_NUMBERSマッピングにplanning: '00'を追加し、既存フェーズの番号（01〜07）との整合性を保つこと
- **NFR-3.3**: プロンプトファイルは`scripts/ai-workflow/prompts/planning/`ディレクトリに配置し、既存構造を踏襲すること

### 3.4 セキュリティ要件
- **NFR-4.1**: GitHub APIトークンは環境変数`GITHUB_TOKEN`から取得し、ハードコーディングしないこと
- **NFR-4.2**: metadata.jsonに機密情報（APIキー、パスワード等）を保存しないこと

### 3.5 ユーザビリティ要件
- **NFR-5.1**: planning.mdは日本語で記述し、GitHub Flavored Markdownで読みやすくフォーマットすること
- **NFR-5.2**: GitHub Issueへの進捗報告は、フェーズ開始時・完了時・レビュー時に自動投稿すること
- **NFR-5.3**: CLIコマンドは既存フェーズと同様の形式を踏襲すること:
  ```bash
  python scripts/ai-workflow/main.py execute --phase planning --issue 313
  ```

## 4. 制約事項

### 4.1 技術的制約
- **使用技術**:
  - Python 3.8以上
  - Claude Agent SDK（既存実装）
  - GitHub API（PyGithub）
  - GitPython
- **既存システムとの整合性**:
  - BasePhaseクラスのインターフェース（execute/review/revise）を実装必須
  - metadata.jsonのスキーマを破壊しないこと
  - 既存フェーズ（Phase 1〜7）の動作に影響を与えないこと

### 4.2 リソース制約
- **時間**: 本Issue（#313）の実装は1〜2日以内に完了すること
- **人員**: 1名（AIエージェント）での実装を想定
- **Claude API使用量**: Planning Phase実行時の推定コスト: $0.50〜$1.00

### 4.3 ポリシー制約
- **コーディング規約**: CLAUDE.mdに記載された規約を遵守
  - 思考: 技術的内容は英語、プロジェクト固有内容は日本語
  - 対話: 日本語
  - ドキュメント: 日本語
  - コメント: 日本語
- **Git運用**:
  - ブランチ名: `ai-workflow/issue-313`
  - コミットメッセージ: `[ai-workflow] add: Phase 0 (Planning)の実装`

## 5. 前提条件

### 5.1 システム環境
- Python 3.8以上がインストールされていること
- Claude Agent SDK（anthropic-beta）がインストールされていること
- Git、GitHub CLIが利用可能であること

### 5.2 依存コンポーネント
- **既存コンポーネント**:
  - `core/workflow_state.py`: ワークフロー状態管理
  - `core/metadata_manager.py`: metadata.json管理
  - `core/claude_agent_client.py`: Claude Agent SDK統合
  - `core/github_client.py`: GitHub API統合
  - `core/git_manager.py`: Git操作
  - `phases/base_phase.py`: フェーズ基底クラス

### 5.3 外部システム連携
- **GitHub API**: Issue情報の取得、進捗報告、レビュー結果投稿
- **Claude API**: 計画書生成、レビュー、修正

## 6. 受け入れ基準

### 6.1 Phase 0実装の受け入れ基準
```gherkin
Given Issue #313が存在する
When `python main.py execute --phase planning --issue 313`を実行
Then planning.mdが生成される
And metadata.jsonに実装戦略・テスト戦略が保存される
And GitHub Issueに進捗報告が投稿される
```

### 6.2 planning.md生成の受け入れ基準
```gherkin
Given Planning Phaseが実行される
When Claude Agent SDKがプロンプトを処理
Then planning.mdに以下のセクションが含まれる:
  - Issue分析（複雑度、見積もり、リスク）
  - 実装戦略（戦略タイプ、テスト戦略、影響範囲）
  - タスク分割（Phase別サブタスク）
  - 依存関係（タスク間の依存関係図）
  - リスクと軽減策
  - 品質ゲート
```

### 6.3 レビュー機能の受け入れ基準
```gherkin
Given planning.mdが生成されている
When review()メソッドが実行される
Then レビュー結果（PASS/PASS_WITH_SUGGESTIONS/FAIL）が返される
And レビュー結果がGitHub Issueに投稿される
And レビュー結果が.ai-workflow/issue-{number}/00_planning/review/result.mdに保存される
```

### 6.4 リトライ機能の受け入れ基準
```gherkin
Given レビュー結果がFAILである
When retry_count < 3
Then revise()メソッドが実行される
And 修正されたplanning.mdが生成される
And 再度review()が実行される
```

### 6.5 metadata.json更新の受け入れ基準
```gherkin
Given Planning Phaseが完了する
When metadata.jsonを確認
Then design_decisionsセクションに以下が保存されている:
  - implementation_strategy（CREATE/EXTEND/REFACTOR）
  - test_strategy（UNIT_ONLY/INTEGRATION_ONLY/.../ALL）
  - test_code_strategy（EXTEND_TEST/CREATE_TEST/BOTH_TEST）
```

### 6.6 Phase 2との連携の受け入れ基準
```gherkin
Given Planning Phaseが完了し、metadata.jsonに戦略が保存されている
When Phase 2（Design）を実行
Then Phase 2は実装戦略決定を行わない
And metadata.jsonから戦略情報を読み取る
And 戦略情報を設計書（design.md）に反映する
```

### 6.7 Git自動commit & pushの受け入れ基準
```gherkin
Given Planning Phaseが完了または失敗する
When BasePhase.run()のfinallyブロックが実行される
Then 変更ファイルが自動的にcommitされる
And リモートブランチにpushされる
And commit失敗時もPhase自体は失敗しない（warningログのみ）
```

## 7. スコープ外

### 7.1 Phase 8 (Evaluation)の実装
- 本IssueではPhase 0（Planning）のみを実装
- Phase 8（プロジェクト評価）はIssue本文で提案されているが、別Issueとして扱う
- Phase 8の機能:
  - Phase 1-6完了後の全体評価
  - 判定（PASS/PASS_WITH_ISSUES/FAIL_PHASE_X/ABORT）
  - 残課題の新Issue自動作成
  - フェーズ再実行機能

### 7.2 進捗トラッキング機能
- 各フェーズの進捗を計画と比較する機能
- ブロッカーの自動検出とエスカレーション
- これらはPhase 8（Evaluation）で実装予定

### 7.3 マイルストーン管理
- GitHubマイルストーンとの連携
- 進捗率の自動計算
- 将来的な拡張として検討

### 7.4 コスト最適化
- Claude API使用量の最適化（プロンプトキャッシュ活用等）
- Phase 0では基本実装に専念し、最適化は後回し

### 7.5 UI改善
- CLIインターフェースの拡張（インタラクティブモード等）
- 進捗表示の改善（プログレスバー等）
- 既存のシンプルなCLIを維持

## 8. 実装順序

### Phase 1: 基本実装（Issue #313のスコープ）
1. `phases/planning.py`の作成（BasePhase継承）
2. `prompts/planning/`ディレクトリとプロンプト作成
   - `execute.txt`: 計画書生成プロンプト
   - `review.txt`: 計画書レビュープロンプト
   - `revise.txt`: 計画書修正プロンプト
3. `main.py`にplanningフェーズを追加
4. `BasePhase.PHASE_NUMBERS`を更新（planning: '00'）

### Phase 2: プロンプト最適化（Issue #313のスコープ）
1. execute.txtのプロンプト改善
2. review.txtのプロンプト改善
3. revise.txtのプロンプト改善

### Phase 3: 既存フェーズとの連携（Issue #313のスコープ）
1. Phase 2（design.py）のプロンプト修正
   - 実装戦略決定ロジックを削除
   - metadata.jsonから戦略情報を読み取るロジックに変更
2. metadataへのplanning情報保存
3. 各フェーズでplanning情報を参照（オプション）

### Phase 4: テストとドキュメント（Issue #313のスコープ）
1. E2Eテストの作成（`tests/e2e/test_phase0.py`）
2. ユニットテストの作成（`tests/unit/phases/test_planning.py`）
3. READMEの更新（Phase 0の説明追加）
4. CONTRIBUTION.mdの更新（Phase 0の開発ガイドライン追加）

### Phase 5: Phase 8実装（別Issue、スコープ外）
- Phase 8 (Evaluation)の実装
- 新Issue自動作成機能
- フェーズ再実行機能

## 9. リスクと軽減策

### リスク1: 既存フェーズへの影響
- **説明**: Phase 0追加により既存Phase 1〜7の動作が影響を受ける
- **影響度**: 高
- **確率**: 中
- **軽減策**:
  - BasePhaseの既存インターフェースを厳密に遵守
  - 既存E2Eテストを実行し、回帰テストを確保
  - Phase 2のプロンプト修正は慎重に行い、後方互換性を維持

### リスク2: metadata.jsonスキーマ変更の影響
- **説明**: design_decisionsの構造変更により、既存データとの互換性が失われる
- **影響度**: 中
- **確率**: 低
- **軽減策**:
  - 既存のdesign_decisionsスキーマを維持
  - 新規フィールドは追加のみ（削除・変更なし）
  - マイグレーションスクリプト不要

### リスク3: Claude API使用量の増加
- **説明**: Phase 0追加により、Claude API呼び出しが増加しコストが上昇
- **影響度**: 低
- **確率**: 高（確実に増加）
- **軽減策**:
  - Phase 0実行は任意（必要に応じてスキップ可能）
  - 最大ターン数を50に制限
  - 将来的にプロンプトキャッシュを活用

### リスク4: プロンプト設計の不備
- **説明**: プロンプトが不適切で、期待通りの計画書が生成されない
- **影響度**: 高
- **確率**: 中
- **軽減策**:
  - Phase 1（Requirements）のプロンプトを参考に設計
  - レビュー＆リトライ機能により、最大3回の修正機会を提供
  - 実際のIssueでテスト実行し、プロンプトを改善

### リスク5: 工数見積もりの精度
- **説明**: AIによる工数見積もりが現実と乖離する
- **影響度**: 中
- **確率**: 高
- **軽減策**:
  - 見積もりはあくまで参考値として扱う
  - Phase 0の目的は完璧な見積もりではなく、計画の可視化
  - 実績データを蓄積し、将来的に見積もり精度を向上

## 10. 品質ゲート（Phase 1）

本要件定義書は、以下の品質ゲートを満たす必要がある：

### ✅ 機能要件が明確に記載されている
- FR-1.1〜FR-5.2: 13の機能要件を明確に定義
- 各機能要件には説明、入力、出力、判断基準を記載

### ✅ 受け入れ基準が定義されている
- セクション6: 7つの受け入れ基準をGiven-When-Then形式で定義
- 各機能要件に対応する受け入れテストを記載

### ✅ スコープが明確である
- セクション7: スコープ外項目を明確に列挙
- Phase 0実装とPhase 8実装を明確に分離

### ✅ 論理的な矛盾がない
- 実装順序（セクション8）が機能要件と整合
- 非機能要件がアーキテクチャ制約と矛盾しない
- 受け入れ基準が機能要件を網羅

---

**作成日**: 2025-10-10
**対象Issue**: #313
**ワークフローバージョン**: 1.0.0
