# 要件定義書: dot_processor.py - Phase 1: 基盤整備

## Issue情報

- **Issue番号**: #460
- **タイトル**: [Refactor] dot_processor.py - Phase 1: 基盤整備
- **親Issue**: #448
- **状態**: open
- **URL**: https://github.com/tielec/infrastructure-as-code/issues/460
- **作成日**: 2025-01-19

---

## 0. Planning Documentの確認

Planning Phase（Phase 0）で策定された開発計画を確認しました：

### 開発戦略の概要

- **実装戦略**: REFACTOR
  - Phase 1では既存コードの変更は一切行わない
  - 特性テスト（Characterization Test）によって既存の振る舞いを記録
  - Phase 2以降のリファクタリングに備えた安全網を構築

- **テスト戦略**: UNIT_ONLY
  - 単一モジュール（`dot_processor.py`）を対象
  - ユニットテストと特性テストで振る舞いを保証
  - カバレッジ目標: 80%以上

- **テストコード戦略**: CREATE_TEST
  - 新規テストフレームワーク（pytest）を構築
  - テストディレクトリ構造を新規作成
  - テストフィクスチャとサンプルデータを準備

### 対象コードの特徴（Planning Documentより）

- **ファイル**: `jenkins/jobs/pipeline/infrastructure/pulumi-stack-action/src/dot_processor.py`
- **行数**: 617行
- **クラス構成**: 2クラス
  - `DotFileGenerator`: DOTファイル生成の責務
  - `DotFileProcessor`: DOTファイル処理の責務
- **主要な機能**:
  1. DOT形式生成（Graphviz形式の依存関係グラフ）
  2. URN解析（Pulumi URN形式の文字列解析）
  3. グラフスタイル適用（プロバイダー別の色設定、ノード/エッジのスタイリング）
  4. エスケープ処理（DOT形式用の特殊文字エスケープ）

### リスク評価（Planning Documentより）

- **リスクレベル**: 中
- **主要リスク**:
  1. テストインフラ未整備（ゼロから構築が必要）
  2. 外部依存の複雑性（DOT形式、JSON解析、文字列エスケープ）
  3. 網羅性の担保（全振る舞いを記録できない可能性）
  4. テストデータ準備（実際のPulumiデータ構造が必要）

### スケジュール（Planning Documentより）

- **見積もり工数**: 12~16時間
- **フェーズ構成**:
  - Phase 1: 要件定義（2~3h）
  - Phase 2: 設計（2~3h）
  - Phase 3: テストシナリオ（2~3h）
  - Phase 5: テストコード実装（3~4h）
  - Phase 6: テスト実行（1~2h）
  - Phase 7: ドキュメント（1~1.5h）
  - Phase 8: レポート（0.5~1h）

**注意**: Phase 4（実装）は存在しません。Phase 1では既存コードの変更を一切行わないため。

---

## 1. 概要

### 1.1 背景

Issue #448（親Issue）の一環として、`dot_processor.py`のリファクタリングを段階的に実施する計画が策定されました。本Phase 1は、リファクタリングの基盤整備として、既存の振る舞いを保証するテストを作成するフェーズです。

現在、`dot_processor.py`（617行、2クラス構成）には以下の課題があります：

1. **テストインフラの不在**: テストフレームワークが存在せず、振る舞いが保証されていない
2. **複雑なロジック**: DOT形式処理、URN解析、グラフ生成といった複雑なロジックが含まれる
3. **リファクタリングのリスク**: テストがないため、リファクタリング時に既存の振る舞いを破壊するリスクが高い

### 1.2 目的

本Phase 1の目的は以下の3点です：

1. **既存の振る舞いの記録**: 特性テスト（Characterization Test）によって、現在の`dot_processor.py`の振る舞いを正確に記録する
2. **リファクタリングの安全網構築**: Phase 2以降のリファクタリング時に、既存の振る舞いが維持されていることを検証できる仕組みを提供する
3. **テストインフラの整備**: pytest環境を構築し、将来的なテスト追加を容易にする基盤を作る

### 1.3 ビジネス価値・技術的価値

#### ビジネス価値

- **品質向上**: リファクタリング時のリグレッション（機能退行）を防ぎ、Jenkins CI/CDパイプラインの信頼性を維持
- **保守性向上**: テストコードがドキュメントの役割を果たし、コードの理解と保守が容易になる
- **リスク低減**: リファクタリング作業のリスクを低減し、安全に技術的負債を解消できる

#### 技術的価値

- **テストカバレッジの確立**: カバレッジ80%以上を達成し、主要な振る舞いを保証
- **継続的改善の基盤**: テストがあることで、将来的なコード改善が安全に実施可能
- **技術標準の確立**: pytest環境を整備することで、他のPythonスクリプトのテスト作成の模範となる

---

## 2. 機能要件

本Phase 1では、既存コードの変更は一切行わず、テスト作成のみを実施します。

### 2.1 テストフレームワークの構築

**要件ID**: FR-001
**優先度**: 高（必須）
**説明**: pytest環境を構築し、テスト実行基盤を整備する

**詳細**:
- pytestをテストフレームワークとして採用
- テストディレクトリ構造を作成（`tests/`）
- 共通フィクスチャを定義（`conftest.py`）
- カバレッジ測定設定を作成（`.coveragerc`、`pytest.ini`）

**受け入れ基準**:
- **Given**: リポジトリルートに移動した状態
- **When**: `pytest --version`を実行する
- **Then**: pytestのバージョン情報が表示される

- **Given**: テストディレクトリが作成された状態
- **When**: `pytest tests/`を実行する
- **Then**: テストが検出され、実行される（失敗してもよいが、検出されること）

---

### 2.2 `DotFileGenerator`クラスの特性テスト作成

**要件ID**: FR-002
**優先度**: 高（必須）
**説明**: `DotFileGenerator`クラスの既存の振る舞いを記録する特性テストを作成する

**対象メソッド**:
1. `escape_dot_string(s: str) -> str`
   - 特殊文字エスケープの検証
   - ダブルクォート、バックスラッシュ、改行、タブのエスケープ
   - 空文字列、None値の処理

2. `create_dot_file(stack_name, resources, resource_providers) -> List[str]`
   - DOTファイル生成の完全検証
   - ヘッダー、スタックノード、プロバイダーノード、リソース、依存関係の生成
   - 最大20リソースの制限動作
   - 空リソースの処理

3. プロバイダー色設定
   - `PROVIDER_COLORS`辞書の検証
   - デフォルト色の適用

4. プライベートヘルパーメソッド（公開メソッド経由でテスト）
   - `_add_stack_node`
   - `_add_provider_nodes`
   - `_add_stack_to_provider_connections`
   - `_add_resources`
   - `_add_resource_dependencies`

**受け入れ基準**:
- **Given**: 特殊文字を含む文字列（例: `"test\nvalue"`）
- **When**: `escape_dot_string()`を呼び出す
- **Then**: 正しくエスケープされた文字列（例: `"test\\nvalue"`）が返される

- **Given**: サンプルのスタック名、リソース、プロバイダー情報
- **When**: `create_dot_file()`を呼び出す
- **Then**: 有効なDOT形式の文字列リストが返される（`digraph G {`で始まり`}`で終わる）

- **Given**: 既知のプロバイダー名（例: `"aws"`）
- **When**: プロバイダーノードを生成する
- **Then**: 正しい色設定（`#FFF3E0`, `#EF6C00`）が適用される

---

### 2.3 `DotFileProcessor`クラスの特性テスト作成

**要件ID**: FR-003
**優先度**: 高（必須）
**説明**: `DotFileProcessor`クラスの既存の振る舞いを記録する特性テストを作成する

**対象メソッド**:
1. `parse_urn(urn: str) -> Dict[str, str]`
   - URN解析の網羅的検証
   - 正常なURN形式の解析
   - 不正なURN形式の処理
   - 空文字列、部分的なURNの処理

2. `apply_graph_styling(dot_content: str) -> str`
   - グラフスタイル適用の検証
   - Pulumi生成グラフ（`strict digraph`）の処理
   - 自前生成グラフ（`digraph G {`）の処理

3. `is_empty_graph(dot_content: str) -> bool`
   - 空グラフ判定の検証
   - 空グラフの識別（`digraph G {}`）
   - 最小グラフの識別（30文字未満）

4. `create_readable_label(urn_info: Dict) -> str`
   - ラベル生成の検証
   - 長いリソース名の省略処理
   - モジュール名の表示

5. `is_stack_resource(urn: str) -> bool`
   - スタックリソース判定
   - 正常なスタックURN、通常リソースURNの識別

**受け入れ基準**:
- **Given**: 正しいURN形式の文字列（例: `"urn:pulumi:dev::myproject::aws:s3/bucket:Bucket::my-bucket"`）
- **When**: `parse_urn()`を呼び出す
- **Then**: 辞書形式で構成要素が返される（`stack`, `project`, `provider`, `type`, `name`を含む）

- **Given**: Pulumi生成のDOT文字列（`strict digraph`で始まる）
- **When**: `apply_graph_styling()`を呼び出す
- **Then**: スタイル拡張されたDOT文字列が返される（グラフ属性、ノード属性が追加される）

- **Given**: 空グラフの文字列（`"digraph G {}"`）
- **When**: `is_empty_graph()`を呼び出す
- **Then**: `True`が返される

- **Given**: URN情報辞書（`type`, `name`, `module`を含む）
- **When**: `create_readable_label()`を呼び出す
- **Then**: 改行区切りの読みやすいラベル文字列が返される

---

### 2.4 エッジケースのテストシナリオ作成

**要件ID**: FR-004
**優先度**: 中（重要）
**説明**: エッジケースや異常系の振る舞いを記録するテストを作成する

**対象エッジケース**:
1. **空入力**:
   - 空文字列、空リスト、空辞書
   - None値の処理

2. **不正なURN形式**:
   - `::` 区切りが不足
   - プロバイダー情報が欠落
   - 完全に不正な文字列

3. **特殊文字**:
   - Unicode文字、絵文字
   - 制御文字（改行、タブ、キャリッジリターン）
   - DOT予約語

4. **境界値**:
   - 最大20リソース、21リソース以上
   - 極端に長いリソース名（1000文字以上）
   - 極端に長いURN

5. **プロバイダー**:
   - 未定義のプロバイダー名（デフォルト色適用の検証）
   - 大文字小文字の混在

**受け入れ基準**:
- **Given**: 空文字列
- **When**: `escape_dot_string("")`を呼び出す
- **Then**: 空文字列が返される（エラーが発生しない）

- **Given**: 不正なURN（例: `"invalid-urn"`）
- **When**: `parse_urn()`を呼び出す
- **Then**: デフォルト値を含む辞書が返される（エラーが発生しない）

- **Given**: Unicode文字を含む文字列（例: `"テスト🚀"`）
- **When**: `escape_dot_string()`を呼び出す
- **Then**: エスケープされた文字列が返される（エラーが発生しない）

- **Given**: 21個のリソースを含むリスト
- **When**: `create_dot_file()`を呼び出す
- **Then**: 最初の20リソースのみが処理される

---

### 2.5 テストデータの準備

**要件ID**: FR-005
**優先度**: 高（必須）
**説明**: 実際のPulumiデータ構造を模したテストデータを準備する

**テストデータの種類**:
1. **サンプルURN**:
   - AWS、Azure、GCP、Kubernetesなど主要プロバイダーのURN
   - スタックリソースのURN
   - 不正なURN

2. **サンプルリソース**:
   - 正常なリソースオブジェクト（`type`, `urn`, `dependencies`, `parent`, `propertyDependencies`を含む）
   - 最小限のリソースオブジェクト
   - 依存関係を持つリソース

3. **サンプルDOT文字列**:
   - Pulumi生成グラフ（`strict digraph`）
   - 自前生成グラフ（`digraph G {`）
   - 空グラフ

4. **プロバイダー情報**:
   - プロバイダー名とリソース数の辞書

**受け入れ基準**:
- **Given**: テストフィクスチャが定義されている
- **When**: テストケースでフィクスチャを参照する
- **Then**: 有効なサンプルデータが提供される

- **Given**: テストデータディレクトリ（`tests/fixtures/test_data/`）
- **When**: テストケースでJSONファイルを読み込む
- **Then**: 正しい構造のデータが取得できる

---

### 2.6 カバレッジ測定

**要件ID**: FR-006
**優先度**: 高（必須）
**説明**: テストカバレッジを測定し、80%以上を達成する

**カバレッジ目標**:
- **全体カバレッジ**: 80%以上
- **公開メソッド**: 100%
- **プライベートメソッド**: 70%以上
- **エッジケース処理**: 100%

**カバレッジレポート形式**:
- HTML形式レポート（詳細な行カバレッジ）
- ターミナル出力（サマリー）
- JSON形式（CI/CD連携用、オプション）

**受け入れ基準**:
- **Given**: 全テストが作成された状態
- **When**: `pytest --cov=src --cov-report=html tests/`を実行する
- **Then**: カバレッジレポートが生成され、80%以上の値が表示される

- **Given**: カバレッジレポート（HTML）
- **When**: `htmlcov/index.html`をブラウザで開く
- **Then**: 各ファイル、各行のカバレッジ状況が確認できる

---

### 2.7 テスト実行の安定性

**要件ID**: FR-007
**優先度**: 高（必須）
**説明**: テストが安定して実行され、冪等性を保証する

**安定性の要件**:
- 複数回実行しても同じ結果が得られる
- テスト実行順序に依存しない
- 外部ファイルへの副作用がない（テストデータの変更なし）
- 並列実行可能（`pytest -n auto`）

**受け入れ基準**:
- **Given**: テストスイートが作成された状態
- **When**: テストを3回連続で実行する
- **Then**: 全回で同じ結果（Pass/Fail）が得られる

- **Given**: テストスイートが作成された状態
- **When**: `pytest --random-order tests/`を実行する
- **Then**: ランダム順序でも全テストがパスする

- **Given**: テストスイートが作成された状態
- **When**: `pytest -n auto tests/`を実行する（並列実行）
- **Then**: 全テストがパスする

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

**NFR-001: テスト実行時間**
- 全テスト実行時間: 30秒以内（目標値）
- 単一テストケース: 1秒以内
- カバレッジ測定を含む全実行: 60秒以内

**理由**: CI/CDパイプラインへの組み込みを考慮し、高速なフィードバックを実現

---

### 3.2 保守性要件

**NFR-002: テストコードの可読性**
- テストケース名は「何をテストするか」を明確に記述（例: `test_escape_dot_string_with_special_characters`）
- 各テストにドキュメント文字列（docstring）を記載
- Given-When-Then形式でコメントを記述

**NFR-003: テストの独立性**
- 各テストケースは独立して実行可能
- テストケース間で状態を共有しない
- フィクスチャは適切にクリーンアップ

**NFR-004: PEP 8準拠**
- テストコードもPEP 8スタイルガイドに準拠
- 行長制限（100文字推奨、最大120文字）
- 適切なインデント、スペーシング

---

### 3.3 拡張性要件

**NFR-005: テストフレームワークの拡張性**
- 新規テストケースの追加が容易
- フィクスチャの再利用が可能
- テストユーティリティ関数の共通化

**NFR-006: 将来的な統合**
- CI/CDパイプライン（Jenkins）への統合を考慮
- JUnit XML形式のレポート出力をサポート（`pytest --junitxml=report.xml`）

---

### 3.4 セキュリティ要件

**NFR-007: テストデータのセキュリティ**
- テストデータに実際のクレデンシャル、APIキー、シークレットを含めない
- 実際のAWS URN、プロジェクト名を使用する場合は匿名化
- サンプルデータはダミー値を使用

---

## 4. 制約事項

### 4.1 技術的制約

**C-001: Pythonバージョン**
- Python 3.8以上を使用
- 理由: 型ヒント、f-strings等の現代的な機能を活用

**C-002: テストフレームワーク**
- pytestを使用（unittest、noseは使用しない）
- 理由: Planning Documentで策定された方針

**C-003: 依存ライブラリ**
- pytest 7.4.3
- pytest-cov 4.1.0
- pytest-mock 3.12.0
- これらのバージョンを固定し、再現性を確保

**C-004: 既存コードの不変性**
- **Phase 1では`dot_processor.py`を一切変更しない**
- テストコードのみを作成
- 理由: 特性テストは「現在の振る舞い」を記録するため

---

### 4.2 リソース制約

**C-005: 工数制約**
- 見積もり工数: 12~16時間
- Phase 1全体（要件定義～レポート作成）を含む

**C-006: 実行環境**
- Jenkinsエージェント環境でテスト実行可能であること
- Docker環境での実行をサポート（オプション）

---

### 4.3 ポリシー制約

**C-007: コーディング規約**
- PEP 8準拠
- プロジェクトの既存コーディング規約に従う（CLAUDE.md、CONTRIBUTION.md）

**C-008: ドキュメント**
- 日本語でドキュメントを記述
- コメントも日本語（プロジェクト方針）

---

## 5. 前提条件

### 5.1 システム環境

**ENV-001: Python環境**
- Python 3.8以上がインストールされている
- pip3が利用可能

**ENV-002: 依存ライブラリ**
- 既存の`dot_processor.py`が依存するライブラリがインストール済み
- 特に必須のもの: なし（標準ライブラリのみ使用）

**ENV-003: 開発環境**
- テキストエディタまたはIDE（VSCode推奨）
- Gitクライアント

---

### 5.2 依存コンポーネント

**DEP-001: 既存ファイル**
- `jenkins/jobs/pipeline/infrastructure/pulumi-stack-action/src/dot_processor.py`が存在する
- 617行、2クラス構成で変更されていない

**DEP-002: 関連ファイル（参照のみ）**
- `graph_processor.py`: `dot_processor.py`を使用している
- `main.py`: エントリーポイント

---

### 5.3 外部システム連携

**EXT-001: 外部システム不要**
- Phase 1では外部システム連携は不要
- テストはローカルで完結

---

## 6. 受け入れ基準

各機能要件の受け入れ基準は、セクション2「機能要件」に記載されています。以下は、Phase 1全体の受け入れ基準です。

### 6.1 Phase 1全体の受け入れ基準（Issue #460の完了条件）

**AC-001: テストフレームワークの構築**
- **Given**: リポジトリルートに移動した状態
- **When**: `pytest --version`を実行する
- **Then**: pytest 7.4.3以上が正しくインストールされている

**AC-002: テストの実行**
- **Given**: テストスイートが作成された状態
- **When**: `pytest tests/`を実行する
- **Then**: 全テストがパスする（FAILが0件）

**AC-003: カバレッジ達成**
- **Given**: 全テストが作成された状態
- **When**: `pytest --cov=src --cov-report=term tests/`を実行する
- **Then**: カバレッジ80%以上と表示される

**AC-004: カバレッジレポート生成**
- **Given**: カバレッジ測定を実行した状態
- **When**: `htmlcov/`ディレクトリを確認する
- **Then**: HTMLカバレッジレポートが生成されている

**AC-005: 振る舞い記録ドキュメント**
- **Given**: テスト作成が完了した状態
- **When**: `CHARACTERIZATION_TEST.md`を開く
- **Then**: 各メソッドの期待動作、エッジケースの振る舞いが記録されている

**AC-006: テストREADME**
- **Given**: テスト作成が完了した状態
- **When**: `tests/README.md`を開く
- **Then**: テスト構造、実行方法、カバレッジレポート生成方法が記載されている

**AC-007: Phase 1完了レポート**
- **Given**: 全タスクが完了した状態
- **When**: Phase 1完了レポートを確認する
- **Then**: 達成事項、カバレッジレポート、発見した問題点、Phase 2への引き継ぎ事項が記載されている

---

## 7. スコープ外

以下の項目は本Phase 1のスコープ外とし、将来的な拡張候補とします。

### 7.1 明確にスコープ外とする事項

**OUT-001: 既存コードの変更**
- `dot_processor.py`のリファクタリング（Phase 2で実施）
- コードの構造改善、メソッド抽出
- 型ヒントの追加
- コメントの改善

**OUT-002: 統合テスト**
- `graph_processor.py`との統合テスト
- エンドツーエンドテスト（Jenkinsパイプライン全体）

**OUT-003: CI/CDパイプライン統合**
- Jenkinsジョブへのテスト組み込み
- 自動テスト実行
- カバレッジレポートの可視化

**OUT-004: パフォーマンステスト**
- 大規模リソース（1000リソース以上）の処理時間測定
- メモリ使用量の測定

**OUT-005: 他のPythonスクリプトのテスト**
- `graph_processor.py`のテスト
- `report_generator.py`のテスト
- これらは別Issueで実施

---

### 7.2 将来的な拡張候補

**FUT-001: ミューテーションテスト**
- pytest-mutateを使用したテスト品質の検証
- コード変更を自動的に行い、テストが検出できるか確認

**FUT-002: プロパティベーステスト**
- Hypothesisライブラリを使用した自動テストケース生成
- 想定外の入力に対する堅牢性の検証

**FUT-003: ビジュアルリグレッションテスト**
- 生成されるDOT画像の視覚的な変化を検出
- pytest-regtest等のツールを使用

**FUT-004: ドキュメント生成**
- Sphinxを使用したAPIドキュメント自動生成
- テストケースからサンプルコードを抽出

---

## 8. 補足情報

### 8.1 用語定義

| 用語 | 定義 |
|------|------|
| 特性テスト（Characterization Test） | リファクタリング前の既存コードの振る舞いを記録するテスト。Golden Master Testingとも呼ばれる。 |
| DOT形式 | Graphvizが使用するグラフ記述言語。依存関係をテキストで表現する。 |
| URN（Uniform Resource Name） | Pulumiが使用するリソース識別子。`urn:pulumi:STACK::PROJECT::PROVIDER:TYPE::NAME`の形式。 |
| カバレッジ | テストによって実行されたコードの割合。行カバレッジ、分岐カバレッジなどがある。 |
| pytest | Pythonの代表的なテストフレームワーク。シンプルな構文とプラグインエコシステムが特徴。 |
| フィクスチャ | テストの前提条件を準備する仕組み。pytestでは`@pytest.fixture`デコレータで定義。 |

### 8.2 参考リソース

- **Planning Document**: `.ai-workflow/issue-460/00_planning/output/planning.md`
- **親Issue**: https://github.com/tielec/infrastructure-as-code/issues/448
- **対象コード**: `jenkins/jobs/pipeline/infrastructure/pulumi-stack-action/src/dot_processor.py`
- **プロジェクトガイドライン**:
  - `CLAUDE.md` - Claude Code向けガイダンス
  - `CONTRIBUTION.md` - 開発者向けガイドライン
  - `ARCHITECTURE.md` - アーキテクチャ設計思想

### 8.3 品質ゲート（チェックリスト）

本要件定義書は、以下の品質ゲートを満たす必要があります：

- [x] **機能要件が明確に記載されている**: FR-001～FR-007で7つの機能要件を定義
- [x] **受け入れ基準が定義されている**: 各機能要件にGiven-When-Then形式の受け入れ基準を記載
- [x] **スコープが明確である**: スコープ内（FR-001～FR-007）とスコープ外（OUT-001～OUT-005）を明確に分離
- [x] **論理的な矛盾がない**: Planning Documentの方針（REFACTOR戦略、既存コード変更なし）と整合

---

## 9. 変更履歴

| 日付 | バージョン | 変更者 | 変更内容 |
|------|-----------|--------|----------|
| 2025-01-19 | 1.0 | Claude Code | 初版作成 |

---

**作成日**: 2025-01-19
**最終更新**: 2025-01-19
**作成者**: Claude Code (AI Workflow Phase 1)
**レビュー状態**: 未レビュー
**承認者**: -
**次フェーズ**: Phase 2（設計）
