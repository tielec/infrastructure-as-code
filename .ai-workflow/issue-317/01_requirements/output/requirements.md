# 要件定義書: リトライ時のログファイル連番管理

**Issue番号**: #317
**作成日**: 2025-10-10
**対象システム**: AI Workflow Orchestrator
**実装対象**: BasePhase クラス

---

## 1. 概要

### 背景
現在のAI Workflow Orchestratorでは、各フェーズのリトライ実行時に以下のログファイルが上書きされ、過去の実行履歴が失われる問題が発生している。

- `agent_log.md` - エージェント実行ログ（Markdown形式）
- `agent_log_raw.txt` - エージェント実行ログ（生テキスト形式）
- `prompt.txt` - エージェントへの入力プロンプト

これにより、トラブルシューティング時に過去の実行内容を追跡できず、デバッグ効率が低下している。

### 目的
リトライ実行時のログファイルに実行回数の連番を付与することで、すべての実行履歴を保持し、以下を実現する：

1. **トレーサビリティの向上**: 各リトライの実行内容を時系列で追跡可能にする
2. **デバッグ効率の改善**: 問題発生時に過去の実行ログと比較して原因を特定できる
3. **監査証跡の保持**: すべての実行履歴を記録し、後から検証可能にする

### ビジネス価値
- **開発生産性向上**: デバッグ時間の短縮（推定30-50%削減）
- **品質向上**: 過去の実行ログから問題パターンを分析し、再発防止につなげる
- **運用コスト削減**: トラブルシューティングの迅速化

### 技術的価値
- **保守性向上**: 実行履歴の完全な追跡により、バグ修正が容易になる
- **拡張性**: ログファイルの連番管理機能は他のフェーズにも適用可能
- **運用性向上**: 各リトライの実行内容を後から検証できる

---

## 2. 機能要件

### FR-1: ログファイル名への連番付与（優先度: 高）
**内容**: `execute_with_claude()`メソッドで生成される以下のログファイルに、実行回数に基づく連番を付与する。

- `agent_log.md` → `agent_log_1.md`, `agent_log_2.md`, ...
- `agent_log_raw.txt` → `agent_log_raw_1.txt`, `agent_log_raw_2.txt`, ...
- `prompt.txt` → `prompt_1.txt`, `prompt_2.txt`, ...

**連番ルール**:
- 初回実行: `_1`
- リトライ1回目: `_2`
- リトライN回目: `_{N+1}`

**適用範囲**:
- `execute/` ディレクトリ配下
- `review/` ディレクトリ配下
- `revise/` ディレクトリ配下

### FR-2: 既存ログファイルの検出と連番決定（優先度: 高）
**内容**: 各実行時に、対象ディレクトリ内の既存ログファイルを検出し、次の連番を自動的に決定する。

**検出ロジック**:
1. 対象ディレクトリ内の `agent_log_*.md` パターンのファイルを列挙
2. ファイル名から連番を抽出（正規表現: `agent_log_(\d+)\.md`）
3. 最大連番を取得し、`最大連番 + 1` を次の連番とする
4. ファイルが存在しない場合は `1` を連番とする

### FR-3: 成果物ファイルの上書き動作維持（優先度: 高）
**内容**: `output/` ディレクトリ配下の成果物ファイルは、従来通り上書き動作を維持する。

**対象外ファイル**（上書きでOK）:
- `output/requirements.md`
- `output/design.md`
- `output/result.md`
- その他、各フェーズの成果物ファイル

**理由**: 成果物は常に最新版が必要であり、履歴管理はGitで行うため。

### FR-4: BasePhaseクラスへの実装（優先度: 高）
**内容**: `BasePhase`クラスの`execute_with_claude()`メソッドに実装することで、すべての派生フェーズで自動的に連番管理機能を利用できるようにする。

**実装箇所**:
- ファイル: `ai_workflow_orchestrator/phases/base_phase.py`
- メソッド: `execute_with_claude()`
- 実装方法: ログファイルパス生成部分を修正し、連番を付与するロジックを追加

### FR-5: ディレクトリ構造の維持（優先度: 中）
**内容**: 既存のディレクトリ構造を変更せず、ファイル名のみを変更する。

**既存構造**:
```
.ai-workflow/issue-XXX/
├── 02_execute/
│   ├── agent_log_1.md
│   ├── agent_log_raw_1.txt
│   ├── prompt_1.txt
│   └── output/
│       └── requirements.md  # 上書きOK
├── 03_review/
│   ├── agent_log_1.md
│   ├── agent_log_raw_1.txt
│   ├── prompt_1.txt
│   └── result.md  # 上書きOK
└── 04_revise/
    ├── agent_log_1.md
    ├── agent_log_raw_1.txt
    ├── prompt_1.txt
    └── output/
        └── requirements.md  # 上書きOK
```

---

## 3. 非機能要件

### NFR-1: パフォーマンス要件
- **連番決定処理**: 100ms以内に完了すること
- **ファイル検出処理**: 対象ディレクトリ内に最大1000ファイルが存在する場合でも、1秒以内に処理完了すること
- **既存処理への影響**: ログファイル書き込み処理のオーバーヘッドは5%以内に抑えること

### NFR-2: 信頼性要件
- **ファイル名の一意性**: 同一ディレクトリ内で同じ連番のファイルが重複しないこと
- **エラーハンドリング**: ファイルシステムエラー（権限不足、ディスク容量不足）発生時は適切なエラーメッセージを出力し、処理を中断すること
- **冪等性**: 同じ連番での実行を複数回行っても、最後の実行結果が保存されること（連番は重複しない）

### NFR-3: 保守性要件
- **コードの可読性**: 連番決定ロジックは独立したメソッドとして実装し、単体テストが可能な構造とすること
- **拡張性**: 将来的にログファイルの種類が増加した場合でも、最小限の変更で対応できること
- **既存コードへの影響**: `BasePhase`クラスの既存メソッドへの影響を最小限に抑えること

### NFR-4: 互換性要件
- **後方互換性**: 既存のログファイル（連番なし）が存在する場合でも、正常に動作すること
- **Python バージョン**: Python 3.8以上で動作すること
- **OS互換性**: Linux、macOS、Windowsで動作すること

---

## 4. 制約事項

### 技術的制約
- **実装言語**: Python 3.8以上
- **実装クラス**: `BasePhase`クラスのみ修正（派生クラスは修正不要）
- **ファイルシステム**: POSIXおよびWindows互換のファイル名規則に従うこと
- **既存アーキテクチャ**: 現行のAI Workflow Orchestratorのフェーズベース設計を維持すること

### リソース制約
- **開発時間**: 実装とテストで2日以内
- **ディスク容量**: ログファイルの増加により、長期運用時にディスク容量を圧迫する可能性がある（運用で定期的な古いログの削除が必要）

### ポリシー制約
- **コーディング規約**: CLAUDE.mdおよびCONTRIBUTION.mdに記載された規約に準拠すること
- **コメント**: ソースコード内のコメントは日本語で記述すること
- **ドキュメント**: すべてのドキュメントは日本語で記述すること

---

## 5. 前提条件

### システム環境
- Python 3.8以上がインストールされていること
- `pathlib`モジュールが使用可能であること（Python標準ライブラリ）
- ファイルシステムへの読み書き権限があること

### 依存コンポーネント
- `BasePhase`クラス（`ai_workflow_orchestrator/phases/base_phase.py`）
- `execute_with_claude()`メソッド
- Claude APIクライアント（Anthropic SDK）

### 外部システム連携
- なし（ファイルシステムのみ使用）

---

## 6. 受け入れ基準

### AC-1: ログファイル名への連番付与
**Given**: 初回実行時
**When**: `execute_with_claude()`メソッドを実行
**Then**:
- `agent_log_1.md`が作成される
- `agent_log_raw_1.txt`が作成される
- `prompt_1.txt`が作成される

### AC-2: リトライ時の連番インクリメント
**Given**: `agent_log_1.md`, `agent_log_raw_1.txt`, `prompt_1.txt`が存在する
**When**: リトライ実行で`execute_with_claude()`メソッドを再度実行
**Then**:
- `agent_log_2.md`が作成される
- `agent_log_raw_2.txt`が作成される
- `prompt_2.txt`が作成される
- 既存の`agent_log_1.md`、`agent_log_raw_1.txt`、`prompt_1.txt`は上書きされずに保持される

### AC-3: 複数回リトライ時の連番管理
**Given**: `agent_log_1.md`から`agent_log_5.md`まで存在する
**When**: 6回目の実行で`execute_with_claude()`メソッドを実行
**Then**:
- `agent_log_6.md`、`agent_log_raw_6.txt`、`prompt_6.txt`が作成される
- 既存のファイル（1〜5）はすべて保持される

### AC-4: 成果物ファイルの上書き動作
**Given**: `output/requirements.md`が存在する
**When**: リトライ実行で新しい成果物が生成される
**Then**:
- `output/requirements.md`が上書きされる（連番は付与されない）
- 最新の成果物のみが保存される

### AC-5: 欠番がある場合の連番決定
**Given**: `agent_log_1.md`、`agent_log_3.md`、`agent_log_5.md`が存在する（2と4が欠番）
**When**: `execute_with_claude()`メソッドを実行
**Then**:
- `agent_log_6.md`が作成される（最大連番+1）
- 欠番（2、4）は埋められない

### AC-6: 全フェーズでの動作確認
**Given**: execute、review、reviseの各フェーズが存在する
**When**: 各フェーズでリトライ実行を行う
**Then**:
- すべてのフェーズで連番付きログファイルが作成される
- 各フェーズのディレクトリ内で独立した連番管理が行われる

### AC-7: エラーハンドリング
**Given**: ディレクトリへの書き込み権限がない
**When**: `execute_with_claude()`メソッドを実行
**Then**:
- 適切なエラーメッセージが出力される
- 処理が中断される
- 既存のログファイルは破損しない

### AC-8: 後方互換性
**Given**: 既存の連番なしログファイル（`agent_log.md`）が存在する
**When**: 新しいロジックで`execute_with_claude()`メソッドを実行
**Then**:
- `agent_log_1.md`が作成される（既存ファイルは無視される、または`_1`にリネームされる）
- 処理がエラーなく完了する

---

## 7. スコープ外

### 明確にスコープ外とする事項
1. **古いログファイルの自動削除機能**: ディスク容量管理は運用で対応（将来的な拡張候補）
2. **ログファイルのアーカイブ機能**: 圧縮やリモートストレージへの転送は含まない
3. **ログファイルの検索・閲覧UI**: CLIやWebUIでのログ閲覧機能は含まない
4. **連番のリセット機能**: 連番を1に戻す機能は含まない（手動で古いファイルを削除することで実現可能）
5. **成果物ファイルの履歴管理**: `output/`配下のファイルはGitで管理するため、本機能の対象外
6. **ログファイルのローテーション**: 最大ファイル数や保存期間に基づくローテーションは含まない

### 将来的な拡張候補
1. **ログファイルのクリーンアップコマンド**: 古いログファイルを一括削除するCLIコマンド
2. **ログファイルの自動アーカイブ**: 一定期間経過後に自動的に圧縮・アーカイブ
3. **ログファイルの統計情報**: 各フェーズの実行回数、成功率、平均実行時間などの統計レポート
4. **ログビューア**: ログファイルを時系列で閲覧できるWebUI
5. **連番のカスタマイズ**: タイムスタンプ形式やUUID形式など、連番以外の命名規則のサポート

---

## 品質ゲート確認

- [x] **機能要件が明確に記載されている**: FR-1〜FR-5で具体的に記載
- [x] **受け入れ基準が定義されている**: AC-1〜AC-8でGiven-When-Then形式で記載
- [x] **スコープが明確である**: 対象範囲（ログファイル3種類）と対象外（成果物ファイル）が明確
- [x] **論理的な矛盾がない**: 要件間で矛盾なし、連番ルールも一貫している

---

**レビュー準備完了**: この要件定義書はクリティカルシンキングレビューの準備ができています。
