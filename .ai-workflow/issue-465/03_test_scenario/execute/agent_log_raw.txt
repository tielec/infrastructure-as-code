{"type":"system","subtype":"init","cwd":"/tmp/ai-workflow-repos-1/infrastructure-as-code","session_id":"9372c318-f402-4566-b686-9bcc506e3b73","tools":["Task","Bash","Glob","Grep","ExitPlanMode","Read","Edit","Write","NotebookEdit","WebFetch","TodoWrite","WebSearch","BashOutput","KillShell","Skill","SlashCommand"],"mcp_servers":[],"model":"claude-sonnet-4-5-20250929","permissionMode":"bypassPermissions","slash_commands":["compact","context","cost","init","output-style:new","pr-comments","release-notes","todos","review","security-review"],"apiKeySource":"none","claude_code_version":"2.0.21","output_style":"default","agents":["general-purpose","statusline-setup","output-style-setup","Explore"],"uuid":"032bee09-f537-4f70-8c6b-84d8c8c9e106"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012zY7DPoYF3PUmJnGwvbd8i","type":"message","role":"assistant","content":[{"type":"text","text":"I'll analyze the planning, requirements, and design documents to create comprehensive test scenarios for Issue #465."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":46521,"cache_read_input_tokens":12202,"cache_creation":{"ephemeral_5m_input_tokens":46521,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"a39877dd-f776-4515-b3ef-d6ceb1367281"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012zY7DPoYF3PUmJnGwvbd8i","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VpjvmdpHtdmWoszE5DE1f2","name":"Bash","input":{"command":"mkdir -p /tmp/ai-workflow-repos-1/infrastructure-as-code/.ai-workflow/issue-465/03_test_scenario/output","description":"Create output directory for test scenarios"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":46521,"cache_read_input_tokens":12202,"cache_creation":{"ephemeral_5m_input_tokens":46521,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"76b6ac77-b074-452f-9628-d2729d3944ce"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VpjvmdpHtdmWoszE5DE1f2","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"da5cbc45-96fc-4a62-bfd7-158a9ca0b05a"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_0124VMGUdLvBQuGufi9QA7Jy","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll create the comprehensive test scenario document based on the INTEGRATION_BDD strategy defined in the design document:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":152,"cache_read_input_tokens":58723,"cache_creation":{"ephemeral_5m_input_tokens":152,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"146324b9-3ad7-442c-a31b-b0b5f16e646b"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_0124VMGUdLvBQuGufi9QA7Jy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EDtzkyfp4JvoYb7Vjk566p","name":"Write","input":{"file_path":"/tmp/ai-workflow-repos-1/infrastructure-as-code/.ai-workflow/issue-465/03_test_scenario/output/test-scenario.md","content":"# テストシナリオ: Issue #465\n\n## メタデータ\n\n- **Issue番号**: #465\n- **タイトル**: [Refactor] dot_processor.py - Phase 4: レビューと最適化\n- **親Issue**: #448\n- **依存Issue**: #464 (Phase 3: 統合とネスト解消)\n- **作成日**: 2025年10月17日\n- **ステータス**: テストシナリオ作成完了\n- **URL**: https://github.com/tielec/infrastructure-as-code/issues/465\n\n---\n\n## 1. テスト戦略サマリー\n\n### 1.1 選択されたテスト戦略\n\n**INTEGRATION_BDD** (Phase 2で決定)\n\n### 1.2 テスト対象の範囲\n\nPhase 4は、Phase 1~3のリファクタリング成果を検証・補強するフェーズです。以下の範囲をテスト対象とします：\n\n#### テスト対象コンポーネント\n\n1. **DotFileGenerator** (生成層)\n   - DOTファイル生成のエントリーポイント\n   - Pulumiリソースデータの処理\n\n2. **DotFileProcessor** (処理層)\n   - DOTファイルのスタイル適用\n   - グラフの拡張処理\n\n3. **UrnProcessor** (ユーティリティ層)\n   - URN解析処理\n   - Phase 1で分離\n\n4. **NodeLabelGenerator** (ユーティリティ層)\n   - ノードラベル生成\n   - Phase 2で分離\n\n5. **ResourceDependencyBuilder** (ユーティリティ層)\n   - リソース依存関係構築\n   - Phase 3で分離\n\n#### 統合テストの焦点\n\n- **4つのクラスの協調動作**: Phase 1~3で分離されたクラス間の連携\n- **エンドツーエンドのデータフロー**: Pulumi生成データ → DOT出力までの一連の流れ\n- **エラーハンドリング**: 不正データに対する適切な処理\n- **境界値**: リソース数の境界での動作\n\n### 1.3 テストの目的\n\nPhase 4のテスト目的は以下の通りです：\n\n1. **品質保証**: リファクタリング後のコードが正しく動作することを検証\n2. **統合検証**: 分離されたクラスが協調して動作することを確認\n3. **性能検証**: リファクタリング前後で性能劣化がないこと（±10%以内）を確認\n4. **回帰防止**: 既存機能が維持されていることを確認\n\n### 1.4 テスト種別と件数\n\n| テスト種別 | テストケース数 | 説明 |\n|-----------|---------------|------|\n| **統合テスト - エンドツーエンド** | 5ケース | Pulumiデータ → DOT出力の正常系 |\n| **統合テスト - エラーハンドリング** | 3ケース | 異常データ処理の検証 |\n| **統合テスト - 境界値** | 3ケース | リソース数の境界値検証 |\n| **パフォーマンステスト** | 5ケース | リファクタリング前後の性能比較 |\n| **合計** | **16ケース** | Phase 4で追加する新規テスト |\n\n**既存テスト**: 114ケース（Phase 1~3で作成済み）\n\n**全体**: 130ケース（114 + 16）\n\n---\n\n## 2. 統合テストシナリオ\n\n### 2.1 エンドツーエンド統合テスト（5ケース）\n\nPhase 1~3で分離された4つのクラスの協調動作を検証します。\n\n---\n\n#### TC-E-01: 基本的なPulumiグラフ処理（AWS）\n\n**Feature**: Pulumi生成データからDOTファイル生成\n\n**Scenario**: 基本的なAWSリソースのグラフを正しく生成できる\n\n**目的**:\n- 最も基本的なエンドツーエンドのデータフローを検証\n- DotFileGenerator → UrnProcessor → NodeLabelGenerator → ResourceDependencyBuilderの連携を確認\n\n**Given** (前提条件):\n- Pulumiで生成されたAWSリソースデータが存在する\n- リソース数: 3個（S3バケット、Lambda関数、IAMロール）\n- スタック名: \"dev-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 生成されたDOT文字列にDotFileProcessor.apply_graph_styling()を適用する\n\n**Then** (期待結果):\n- DOTファイルが正しく生成される\n- 以下のノードが含まれている:\n  - スタックノード: \"dev-stack\"\n  - プロバイダーノード: \"aws\"\n  - リソースノード: 3個（S3、Lambda、IAM）\n- AWSプロバイダーの色設定が適用されている（オレンジ系）\n- リソース間の依存関係エッジが生成されている（Lambda → IAMロール）\n- ノードラベルが省略記号なしで表示されている（短いリソース名）\n\n**テストデータ**:\n```python\nstack_name = \"dev-stack\"\nresources = [\n    {\n        \"urn\": \"urn:pulumi:dev::myapp::aws:s3/bucket:Bucket::my-bucket\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::myapp::aws:iam/role:Role::lambda-role\",\n        \"type\": \"aws:iam/role:Role\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::myapp::aws:lambda/function:Function::my-function\",\n        \"type\": \"aws:lambda/function:Function\",\n        \"dependencies\": [\"urn:pulumi:dev::myapp::aws:iam/role:Role::lambda-role\"]\n    }\n]\nresource_providers = {\"aws\": 3}\n```\n\n**検証項目**:\n- [ ] DOT文字列が`digraph`で始まる\n- [ ] スタックノード`dev-stack`が存在する\n- [ ] プロバイダーノード`aws`が存在する\n- [ ] 3つのリソースノードが存在する\n- [ ] Lambda → IAMロールのエッジが存在する\n- [ ] AWSの色設定（fillcolor, color）が適用されている\n- [ ] エスケープ処理が正しく適用されている（特殊文字なし）\n\n---\n\n#### TC-E-02: 複数プロバイダー（AWS + Azure）\n\n**Feature**: マルチクラウドリソースのグラフ生成\n\n**Scenario**: AWS and Azureの両方のリソースを含むグラフを正しく生成できる\n\n**目的**:\n- 複数プロバイダーの処理を検証\n- プロバイダー別の色設定が正しく適用されることを確認\n\n**Given** (前提条件):\n- AWS and Azureのリソースが混在するPulumiデータが存在する\n- リソース数: 5個（AWS: 3個、Azure: 2個）\n- スタック名: \"multi-cloud-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 生成されたDOT文字列にDotFileProcessor.apply_graph_styling()を適用する\n\n**Then** (期待結果):\n- DOTファイルが正しく生成される\n- 以下のノードが含まれている:\n  - スタックノード: \"multi-cloud-stack\"\n  - プロバイダーノード: \"aws\" and \"azure\"\n  - リソースノード: 5個（AWS: 3個、Azure: 2個）\n- AWSリソースにはオレンジ系の色設定\n- Azureリソースには青系の色設定\n- スタック → 各プロバイダーのエッジが存在する\n- プロバイダー → リソースのエッジが存在する\n\n**テストデータ**:\n```python\nstack_name = \"multi-cloud-stack\"\nresources = [\n    # AWS Resources\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket1\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:ec2/instance:Instance::instance1\",\n        \"type\": \"aws:ec2/instance:Instance\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:rds/instance:Instance::db1\",\n        \"type\": \"aws:rds/instance:Instance\",\n        \"dependencies\": []\n    },\n    # Azure Resources\n    {\n        \"urn\": \"urn:pulumi:dev::app::azure:storage/account:Account::storage1\",\n        \"type\": \"azure:storage/account:Account\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::azure:compute/virtualMachine:VirtualMachine::vm1\",\n        \"type\": \"azure:compute/virtualMachine:VirtualMachine\",\n        \"dependencies\": []\n    }\n]\nresource_providers = {\"aws\": 3, \"azure\": 2}\n```\n\n**検証項目**:\n- [ ] 2つのプロバイダーノード（aws, azure）が存在する\n- [ ] AWSリソースにオレンジ系の色設定が適用されている\n- [ ] Azureリソースに青系の色設定が適用されている\n- [ ] スタック → aws、スタック → azureのエッジが存在する\n- [ ] 各プロバイダー → リソースのエッジが存在する\n- [ ] 5つのリソースノードがすべて存在する\n\n---\n\n#### TC-E-03: 複雑な依存関係\n\n**Feature**: 複雑な依存関係を持つリソースのグラフ生成\n\n**Scenario**: 多段階の依存関係（A→B→C）と複数依存（D→A, D→B）を正しく表現できる\n\n**目的**:\n- ResourceDependencyBuilderの依存関係構築ロジックを検証\n- 複雑な依存関係グラフが正しく生成されることを確認\n\n**Given** (前提条件):\n- 複雑な依存関係を持つPulumiリソースデータが存在する\n- リソース数: 5個\n- 依存関係:\n  - Lambda → IAMロール（単純依存）\n  - API Gateway → Lambda（単純依存）\n  - CloudWatch → Lambda（単純依存）\n  - CloudWatch → API Gateway（複数依存）\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 生成されたDOT文字列にDotFileProcessor.apply_graph_styling()を適用する\n\n**Then** (期待結果):\n- DOTファイルが正しく生成される\n- 以下の依存関係エッジが存在する:\n  - Lambda → IAMロール\n  - API Gateway → Lambda\n  - CloudWatch → Lambda\n  - CloudWatch → API Gateway\n- エッジのスタイルが適用されている（directDependencies: 実線、propertyDependencies: 点線等）\n- 循環依存がない（DAG構造）\n- すべてのリソースが到達可能\n\n**テストデータ**:\n```python\nstack_name = \"complex-stack\"\nresources = [\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:iam/role:Role::lambda-role\",\n        \"type\": \"aws:iam/role:Role\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:lambda/function:Function::my-function\",\n        \"type\": \"aws:lambda/function:Function\",\n        \"dependencies\": [\"urn:pulumi:dev::app::aws:iam/role:Role::lambda-role\"]\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:apigateway/restApi:RestApi::my-api\",\n        \"type\": \"aws:apigateway/restApi:RestApi\",\n        \"dependencies\": [\"urn:pulumi:dev::app::aws:lambda/function:Function::my-function\"]\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::log-bucket\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:cloudwatch/logGroup:LogGroup::logs\",\n        \"type\": \"aws:cloudwatch/logGroup:LogGroup\",\n        \"dependencies\": [\n            \"urn:pulumi:dev::app::aws:lambda/function:Function::my-function\",\n            \"urn:pulumi:dev::app::aws:apigateway/restApi:RestApi::my-api\"\n        ]\n    }\n]\nresource_providers = {\"aws\": 5}\n```\n\n**検証項目**:\n- [ ] 5つのリソースノードが存在する\n- [ ] 5本の依存関係エッジが存在する（Lambda→IAM、API→Lambda、CloudWatch→Lambda、CloudWatch→API、独立したS3）\n- [ ] エッジのスタイルが適用されている\n- [ ] 循環依存がない\n- [ ] 依存関係の方向が正しい（被依存リソース → 依存元リソース）\n\n---\n\n#### TC-E-04: 長いリソース名の処理\n\n**Feature**: 長いリソース名の省略表示\n\n**Scenario**: 長いリソース名が省略記号付きで処理される\n\n**目的**:\n- NodeLabelGeneratorの省略処理を検証\n- 長いリソース名でもグラフが読みやすいことを確認\n\n**Given** (前提条件):\n- 非常に長いリソース名を含むPulumiデータが存在する\n- リソース名の長さ: 100文字以上\n- リソース数: 3個\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 生成されたDOT文字列にDotFileProcessor.apply_graph_styling()を適用する\n\n**Then** (期待結果):\n- DOTファイルが正しく生成される\n- 長いリソース名が省略記号（...）付きで表示されている\n- ノードラベルの最大長が制限されている（例: 50文字）\n- 省略されても、リソースを識別できる情報が残っている\n- エスケープ処理が正しく適用されている\n\n**テストデータ**:\n```python\nstack_name = \"long-name-stack\"\nresources = [\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::this-is-a-very-long-bucket-name-that-exceeds-the-normal-length-limit-for-display-purposes-in-graph-visualization-tools-like-graphviz\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:lambda/function:Function::another-extremely-long-lambda-function-name-that-should-be-truncated-to-ensure-readability-in-the-generated-dot-file\",\n        \"type\": \"aws:lambda/function:Function\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:iam/role:Role::iam-role-with-a-moderately-long-name\",\n        \"type\": \"aws:iam/role:Role\",\n        \"dependencies\": []\n    }\n]\nresource_providers = {\"aws\": 3}\n```\n\n**検証項目**:\n- [ ] 3つのリソースノードが存在する\n- [ ] 長いリソース名が省略記号付きで表示されている\n- [ ] ノードラベルが50文字程度に制限されている\n- [ ] 省略されたラベルでもリソースタイプが識別可能\n- [ ] DOT構文が正しい（エスケープ処理）\n\n---\n\n#### TC-E-05: 特殊文字を含むリソース名\n\n**Feature**: 特殊文字のエスケープ処理\n\n**Scenario**: DOT構文の特殊文字（`\"`、`\\`、改行等）を含むリソース名が正しくエスケープされる\n\n**目的**:\n- DotFileGenerator.escape_dot_string()の機能を検証\n- 特殊文字を含むリソース名でもDOTファイルが正しく生成されることを確認\n\n**Given** (前提条件):\n- 特殊文字を含むリソース名のPulumiデータが存在する\n- 特殊文字: `\"`、`\\`、改行（`\\n`）、タブ（`\\t`）\n- リソース数: 4個\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 生成されたDOT文字列にDotFileProcessor.apply_graph_styling()を適用する\n\n**Then** (期待結果):\n- DOTファイルが正しく生成される\n- 特殊文字がエスケープされている:\n  - `\"` → `\\\"`\n  - `\\` → `\\\\`\n  - `\\n` → `\\\\n`\n  - `\\t` → `\\\\t`\n- DOT構文が有効である（Graphvizでパース可能）\n- リソース名が正しく表示される\n\n**テストデータ**:\n```python\nstack_name = \"special-char-stack\"\nresources = [\n    {\n        \"urn\": 'urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-with-\"quotes\"',\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:lambda/function:Function::function\\\\with\\\\backslash\",\n        \"type\": \"aws:lambda/function:Function\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:iam/role:Role::role\\nwith\\nnewline\",\n        \"type\": \"aws:iam/role:Role\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:rds/instance:Instance::db\\twith\\ttab\",\n        \"type\": \"aws:rds/instance:Instance\",\n        \"dependencies\": []\n    }\n]\nresource_providers = {\"aws\": 4}\n```\n\n**検証項目**:\n- [ ] 4つのリソースノードが存在する\n- [ ] `\"`が`\\\"`にエスケープされている\n- [ ] `\\`が`\\\\`にエスケープされている\n- [ ] `\\n`が`\\\\n`にエスケープされている\n- [ ] `\\t`が`\\\\t`にエスケープされている\n- [ ] 生成されたDOT文字列が有効なDOT構文である\n- [ ] 特殊文字を含むリソース名が正しく表示される\n\n---\n\n### 2.2 エラーハンドリング統合テスト（3ケース）\n\n異常データに対する適切なエラーハンドリングを検証します。\n\n---\n\n#### TC-EH-01: 不正なURN形式\n\n**Feature**: 不正なURN形式の処理\n\n**Scenario**: 不正なURN形式のリソースを含むデータを処理しても、エラーを投げずにデフォルト値で処理される\n\n**目的**:\n- UrnProcessor.parse_urn()のエラーハンドリングを検証\n- 不正なURN形式でもシステムが停止しないことを確認\n\n**Given** (前提条件):\n- 不正なURN形式を含むPulumiデータが存在する\n- 不正なURNの例:\n  - \"invalid-urn-format\"（区切り文字`::`がない）\n  - \"\"（空文字列）\n  - \"urn:pulumi\"（不完全なURN）\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 不正なURNを含むリソースデータを渡す\n\n**Then** (期待結果):\n- エラーを投げない（例外が発生しない）\n- DOTファイルが生成される\n- 不正なURNはデフォルト値で処理される:\n  - プロバイダー: \"unknown\"\n  - リソースタイプ: \"unknown\"\n  - リソース名: URN文字列そのまま\n- 正常なURNのリソースは正しく処理される\n- デフォルト色設定（グレー系）が適用される\n\n**テストデータ**:\n```python\nstack_name = \"invalid-urn-stack\"\nresources = [\n    {\n        \"urn\": \"invalid-urn-format\",\n        \"type\": \"unknown:type\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"\",\n        \"type\": \"unknown:type\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi\",\n        \"type\": \"incomplete:type\",\n        \"dependencies\": []\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::valid-bucket\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n]\nresource_providers = {\"unknown\": 3, \"aws\": 1}\n```\n\n**検証項目**:\n- [ ] エラーを投げない（例外が発生しない）\n- [ ] DOTファイルが生成される\n- [ ] 不正なURNのリソースがデフォルト色設定で表示される\n- [ ] 正常なURNのリソースは正しく処理される\n- [ ] スタックノードが存在する\n- [ ] プロバイダーノード（unknown, aws）が存在する\n\n---\n\n#### TC-EH-02: 空データ\n\n**Feature**: 空データの処理\n\n**Scenario**: リソースリストが空の場合、空のDOT出力を生成してエラーを投げない\n\n**目的**:\n- 空リソースリストのハンドリングを検証\n- エッジケースでもシステムが安定していることを確認\n\n**Given** (前提条件):\n- リソースリストが空（`[]`）のPulumiデータが存在する\n- スタック名: \"empty-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 空のリソースリストを渡す\n\n**Then** (期待結果):\n- エラーを投げない（例外が発生しない）\n- DOTファイルが生成される\n- スタックノードのみが存在する\n- プロバイダーノードは存在しない\n- リソースノードは存在しない\n- DOT構文が有効である\n\n**テストデータ**:\n```python\nstack_name = \"empty-stack\"\nresources = []\nresource_providers = {}\n```\n\n**検証項目**:\n- [ ] エラーを投げない（例外が発生しない）\n- [ ] DOTファイルが生成される\n- [ ] スタックノード\"empty-stack\"が存在する\n- [ ] プロバイダーノードが存在しない\n- [ ] リソースノードが存在しない\n- [ ] DOT文字列が`digraph`で始まる\n- [ ] DOT文字列が`}`で終わる\n\n---\n\n#### TC-EH-03: Noneデータ\n\n**Feature**: Noneデータの処理\n\n**Scenario**: Noneデータを含むリソースを処理しても、デフォルト値で処理されエラーを投げない\n\n**目的**:\n- Noneデータのハンドリングを検証\n- 各メソッドのNoneチェックが機能していることを確認\n\n**Given** (前提条件):\n- Noneデータを含むPulumiデータが存在する\n- リソースのURNがNone\n- リソースのtypeがNone\n- リソースのdependenciesがNone\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- Noneデータを含むリソースリストを渡す\n\n**Then** (期待結果):\n- エラーを投げない（例外が発生しない）\n- DOTファイルが生成される\n- Noneデータはデフォルト値で処理される:\n  - URN: \"unknown\" or 空文字列\n  - type: \"unknown\"\n  - dependencies: 空リスト\n- 正常なリソースは正しく処理される\n\n**テストデータ**:\n```python\nstack_name = \"none-data-stack\"\nresources = [\n    {\n        \"urn\": None,\n        \"type\": None,\n        \"dependencies\": None\n    },\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::valid-bucket\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n]\nresource_providers = {\"unknown\": 1, \"aws\": 1}\n```\n\n**検証項目**:\n- [ ] エラーを投げない（例外が発生しない）\n- [ ] DOTファイルが生成される\n- [ ] Noneデータのリソースがデフォルト値で処理される\n- [ ] 正常なリソースは正しく処理される\n- [ ] スタックノードが存在する\n- [ ] 2つのプロバイダーノード（unknown, aws）が存在する\n\n---\n\n### 2.3 境界値統合テスト（3ケース）\n\nリソース数の境界値での動作を検証します。\n\n---\n\n#### TC-BV-01: 0リソース（空リソース）\n\n**Feature**: 0リソースの処理\n\n**Scenario**: リソース数が0の場合、スタックノードのみのDOT出力を生成する\n\n**目的**:\n- 最小境界値（0リソース）のハンドリングを検証\n- TC-EH-02（空データ）と同じだが、境界値テストとして明示的に実施\n\n**Given** (前提条件):\n- リソース数が0のPulumiデータが存在する\n- スタック名: \"zero-resource-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 空のリソースリスト（`[]`）を渡す\n\n**Then** (期待結果):\n- エラーを投げない（例外が発生しない）\n- DOTファイルが生成される\n- スタックノードのみが存在する\n- プロバイダーノードは存在しない\n- リソースノードは存在しない\n\n**テストデータ**:\n```python\nstack_name = \"zero-resource-stack\"\nresources = []\nresource_providers = {}\n```\n\n**検証項目**:\n- [ ] エラーを投げない\n- [ ] DOTファイルが生成される\n- [ ] スタックノード\"zero-resource-stack\"が存在する\n- [ ] プロバイダーノードが0個\n- [ ] リソースノードが0個\n- [ ] DOT構文が有効である\n\n---\n\n#### TC-BV-02: 20リソース（最大値）\n\n**Feature**: 最大リソース数の処理\n\n**Scenario**: リソース数が20（最大値）の場合、全20リソースが正しく処理される\n\n**目的**:\n- 最大境界値（20リソース）のハンドリングを検証\n- パフォーマンスが許容範囲内であることを確認\n\n**Given** (前提条件):\n- リソース数が20のPulumiデータが存在する\n- スタック名: \"max-resource-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 20個のリソースを含むリストを渡す\n\n**Then** (期待結果):\n- エラーを投げない（例外が発生しない）\n- DOTファイルが生成される\n- 全20リソースが処理される\n- スタックノード、プロバイダーノード、20個のリソースノードが存在する\n- 処理時間が許容範囲内（< 2秒）\n\n**テストデータ**:\n```python\nstack_name = \"max-resource-stack\"\nresources = [\n    {\n        \"urn\": f\"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-{i}\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n    for i in range(20)\n]\nresource_providers = {\"aws\": 20}\n```\n\n**検証項目**:\n- [ ] エラーを投げない\n- [ ] DOTファイルが生成される\n- [ ] スタックノードが存在する\n- [ ] プロバイダーノード\"aws\"が存在する\n- [ ] 20個のリソースノードが存在する\n- [ ] 処理時間 < 2秒\n\n---\n\n#### TC-BV-03: 21リソース（最大値超過）\n\n**Feature**: 最大リソース数超過の処理\n\n**Scenario**: リソース数が21（最大値超過）の場合、最初の20リソースのみ処理される\n\n**目的**:\n- 最大値超過時の制限処理を検証\n- `resources[:20]`のスライス処理が機能していることを確認\n\n**Given** (前提条件):\n- リソース数が21のPulumiデータが存在する\n- スタック名: \"overflow-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を呼び出す\n- 21個のリソースを含むリストを渡す\n\n**Then** (期待結果):\n- エラーを投げない（例外が発生しない）\n- DOTファイルが生成される\n- 最初の20リソースのみが処理される\n- 21番目のリソースは処理されない\n- スタックノード、プロバイダーノード、20個のリソースノードが存在する\n- 警告メッセージが出力される（オプション）\n\n**テストデータ**:\n```python\nstack_name = \"overflow-stack\"\nresources = [\n    {\n        \"urn\": f\"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-{i}\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n    for i in range(21)\n]\nresource_providers = {\"aws\": 21}\n```\n\n**検証項目**:\n- [ ] エラーを投げない\n- [ ] DOTファイルが生成される\n- [ ] スタックノードが存在する\n- [ ] プロバイダーノード\"aws\"が存在する\n- [ ] 20個のリソースノードが存在する（21個ではない）\n- [ ] 21番目のリソース（bucket-20）が存在しない\n- [ ] 処理時間 < 2秒\n\n---\n\n## 3. パフォーマンステストシナリオ\n\nリファクタリング前後のパフォーマンス比較を実施します。\n\n### 3.1 パフォーマンステストの測定方法\n\n**測定ツール**: `timeit`モジュール\n\n**測定手順**:\n1. ウォームアップ実行（10回）: キャッシュを効かせる\n2. 本測定（100回実行）: 平均実行時間を測定\n3. 標準偏差を計算: 測定のばらつきを評価\n\n**ベースライン**:\n- Phase 1実施前のコード（可能であれば別ブランチから取得）\n- ベースラインが取得できない場合は、現在のパフォーマンスを記録して将来の基準とする\n\n**許容範囲**: ±10%以内\n\n**結果の記録**:\n- CSV形式で保存: `テストメソッド名, リソース数, 平均実行時間(秒), 標準偏差(秒), ベースライン比較(%)`\n\n---\n\n#### TC-P-01: 1リソース処理時間\n\n**Feature**: DotFileGenerator.create_dot_file()のパフォーマンス\n\n**Scenario**: 1リソース処理時間が許容範囲内である\n\n**目的**:\n- 最小リソース数でのパフォーマンスを測定\n- ベースラインとの比較\n\n**Given** (前提条件):\n- リソース数: 1個\n- スタック名: \"perf-test-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を100回実行\n- 平均実行時間を測定\n\n**Then** (期待結果):\n- 平均実行時間 < 0.1秒\n- ベースラインとの差が±10%以内\n- 標準偏差が小さい（安定した実行時間）\n\n**テストデータ**:\n```python\nstack_name = \"perf-test-stack\"\nresources = [\n    {\n        \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-1\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n]\nresource_providers = {\"aws\": 1}\n```\n\n**検証項目**:\n- [ ] 平均実行時間 < 0.1秒\n- [ ] ベースライン比較: -10% ≤ 差 ≤ +10%\n- [ ] 標準偏差 < 平均の10%\n\n---\n\n#### TC-P-02: 5リソース処理時間\n\n**Feature**: DotFileGenerator.create_dot_file()のパフォーマンス\n\n**Scenario**: 5リソース処理時間が許容範囲内である\n\n**目的**:\n- 中規模リソース数でのパフォーマンスを測定\n\n**Given** (前提条件):\n- リソース数: 5個\n- スタック名: \"perf-test-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を100回実行\n- 平均実行時間を測定\n\n**Then** (期待結果):\n- 平均実行時間 < 0.5秒\n- ベースラインとの差が±10%以内\n\n**テストデータ**:\n```python\nstack_name = \"perf-test-stack\"\nresources = [\n    {\n        \"urn\": f\"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-{i}\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n    for i in range(5)\n]\nresource_providers = {\"aws\": 5}\n```\n\n**検証項目**:\n- [ ] 平均実行時間 < 0.5秒\n- [ ] ベースライン比較: -10% ≤ 差 ≤ +10%\n- [ ] 標準偏差 < 平均の10%\n\n---\n\n#### TC-P-03: 10リソース処理時間\n\n**Feature**: DotFileGenerator.create_dot_file()のパフォーマンス\n\n**Scenario**: 10リソース処理時間が許容範囲内である\n\n**目的**:\n- 大規模リソース数でのパフォーマンスを測定\n\n**Given** (前提条件):\n- リソース数: 10個\n- スタック名: \"perf-test-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を100回実行\n- 平均実行時間を測定\n\n**Then** (期待結果):\n- 平均実行時間 < 1.0秒\n- ベースラインとの差が±10%以内\n\n**テストデータ**:\n```python\nstack_name = \"perf-test-stack\"\nresources = [\n    {\n        \"urn\": f\"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-{i}\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n    for i in range(10)\n]\nresource_providers = {\"aws\": 10}\n```\n\n**検証項目**:\n- [ ] 平均実行時間 < 1.0秒\n- [ ] ベースライン比較: -10% ≤ 差 ≤ +10%\n- [ ] 標準偏差 < 平均の10%\n\n---\n\n#### TC-P-04: 20リソース処理時間（境界値）\n\n**Feature**: DotFileGenerator.create_dot_file()のパフォーマンス\n\n**Scenario**: 20リソース（最大値）処理時間が許容範囲内である\n\n**目的**:\n- 最大リソース数でのパフォーマンスを測定\n- スケーラビリティの限界を確認\n\n**Given** (前提条件):\n- リソース数: 20個\n- スタック名: \"perf-test-stack\"\n\n**When** (操作):\n- DotFileGenerator.create_dot_file()を100回実行\n- 平均実行時間を測定\n\n**Then** (期待結果):\n- 平均実行時間 < 2.0秒\n- ベースラインとの差が±10%以内\n\n**テストデータ**:\n```python\nstack_name = \"perf-test-stack\"\nresources = [\n    {\n        \"urn\": f\"urn:pulumi:dev::app::aws:s3/bucket:Bucket::bucket-{i}\",\n        \"type\": \"aws:s3/bucket:Bucket\",\n        \"dependencies\": []\n    }\n    for i in range(20)\n]\nresource_providers = {\"aws\": 20}\n```\n\n**検証項目**:\n- [ ] 平均実行時間 < 2.0秒\n- [ ] ベースライン比較: -10% ≤ 差 ≤ +10%\n- [ ] 標準偏差 < 平均の10%\n\n---\n\n#### TC-P-05: グラフスタイル適用処理時間\n\n**Feature**: DotFileProcessor.apply_graph_styling()のパフォーマンス\n\n**Scenario**: グラフスタイル適用処理時間が許容範囲内である\n\n**目的**:\n- DotFileProcessorのパフォーマンスを測定\n- ノードラベル生成、色設定適用の処理時間を確認\n\n**Given** (前提条件):\n- 10リソースのDOT文字列が存在する\n- スタイル未適用の状態\n\n**When** (操作):\n- DotFileProcessor.apply_graph_styling()を100回実行\n- 平均実行時間を測定\n\n**Then** (期待結果):\n- 平均実行時間 < 0.1秒\n- ベースラインとの差が±10%以内\n\n**テストデータ**:\n```python\n# DotFileGenerator.create_dot_file()で生成された10リソースのDOT文字列\ndot_content = \"\"\"digraph G {\n    \"stack:dev-stack\" [label=\"dev-stack\"];\n    \"provider:aws\" [label=\"aws\"];\n    \"stack:dev-stack\" -> \"provider:aws\";\n    # ... 10 resources ...\n}\"\"\"\n```\n\n**検証項目**:\n- [ ] 平均実行時間 < 0.1秒\n- [ ] ベースライン比較: -10% ≤ 差 ≤ +10%\n- [ ] 標準偏差 < 平均の10%\n\n---\n\n## 4. BDDシナリオ\n\nユーザーストーリーベースのBDDシナリオを記載します。\n\n### 4.1 Feature: Pulumi Stack Visualization\n\n**ユーザーストーリー**:\nAs a DevOps engineer,\nI want to visualize Pulumi stack resources as a graph,\nSo that I can understand resource dependencies and architecture at a glance.\n\n---\n\n#### Scenario: Visualize a basic AWS stack\n\n**Given** ユーザーがPulumiスタック \"dev-stack\" をデプロイしている\n**And** スタックには以下のリソースが含まれている:\n  - S3バケット \"my-bucket\"\n  - Lambda関数 \"my-function\"\n  - IAMロール \"lambda-role\"\n**And** Lambda関数はIAMロールに依存している\n\n**When** ユーザーがDOTファイル生成を実行する\n\n**Then** DOTファイルが生成される\n**And** DOTファイルには以下が含まれている:\n  - スタックノード \"dev-stack\"\n  - AWSプロバイダーノード\n  - 3つのリソースノード（S3、Lambda、IAM）\n  - Lambda → IAMロールの依存関係エッジ\n**And** AWSリソースにオレンジ系の色が適用されている\n**And** ユーザーがGraphvizでグラフを可視化できる\n\n---\n\n#### Scenario: Visualize a multi-cloud stack\n\n**Given** ユーザーがPulumiスタック \"multi-cloud-stack\" をデプロイしている\n**And** スタックにはAWS and Azureのリソースが混在している\n**And** AWSリソース: 3個（S3、EC2、RDS）\n**And** Azureリソース: 2個（Storage、VM）\n\n**When** ユーザーがDOTファイル生成を実行する\n\n**Then** DOTファイルが生成される\n**And** DOTファイルには以下が含まれている:\n  - スタックノード \"multi-cloud-stack\"\n  - AWSプロバイダーノード（オレンジ系）\n  - Azureプロバイダーノード（青系）\n  - 5つのリソースノード\n**And** AWSリソースにオレンジ系の色が適用されている\n**And** Azureリソースに青系の色が適用されている\n**And** ユーザーが各プロバイダーのリソースを視覚的に区別できる\n\n---\n\n#### Scenario: Handle empty stack gracefully\n\n**Given** ユーザーがPulumiスタック \"empty-stack\" をデプロイしている\n**And** スタックにはリソースが1つも含まれていない\n\n**When** ユーザーがDOTファイル生成を実行する\n\n**Then** エラーが発生しない\n**And** DOTファイルが生成される\n**And** DOTファイルにはスタックノード \"empty-stack\" のみが含まれている\n**And** ユーザーにエラーメッセージが表示されない\n\n---\n\n#### Scenario: Handle invalid URN gracefully\n\n**Given** ユーザーがPulumiスタック \"invalid-urn-stack\" をデプロイしている\n**And** スタックに不正なURN形式のリソースが含まれている\n**And** 一部のリソースは正常なURN形式である\n\n**When** ユーザーがDOTファイル生成を実行する\n\n**Then** エラーが発生しない\n**And** DOTファイルが生成される\n**And** 不正なURNのリソースはデフォルト色（グレー系）で表示される\n**And** 正常なURNのリソースは正しい色で表示される\n**And** ユーザーが不正なURNのリソースを視覚的に識別できる\n\n---\n\n#### Scenario: Visualize complex dependencies\n\n**Given** ユーザーがPulumiスタック \"complex-stack\" をデプロイしている\n**And** スタックには以下の依存関係がある:\n  - Lambda → IAMロール（単純依存）\n  - API Gateway → Lambda（単純依存）\n  - CloudWatch → Lambda（単純依存）\n  - CloudWatch → API Gateway（複数依存）\n\n**When** ユーザーがDOTファイル生成を実行する\n\n**Then** DOTファイルが生成される\n**And** すべての依存関係エッジが正しく表示される\n**And** 依存関係の方向が正しい（被依存 → 依存元）\n**And** ユーザーがリソース間の依存関係を理解できる\n\n---\n\n## 5. テストデータ\n\n### 5.1 テストデータの種類\n\n| データ種別 | 説明 | 使用テストケース |\n|----------|------|-----------------|\n| **正常データ** | 標準的なPulumiリソースデータ | TC-E-01, TC-E-02, TC-E-03 |\n| **長いリソース名** | 100文字以上のリソース名 | TC-E-04 |\n| **特殊文字データ** | DOT特殊文字を含むリソース名 | TC-E-05 |\n| **不正URN** | URN形式が不正なデータ | TC-EH-01 |\n| **空データ** | リソースリストが空 | TC-EH-02, TC-BV-01 |\n| **Noneデータ** | Noneを含むリソースデータ | TC-EH-03 |\n| **境界値データ** | 0, 20, 21リソース | TC-BV-01, TC-BV-02, TC-BV-03 |\n| **パフォーマンステストデータ** | 1, 5, 10, 20リソース | TC-P-01~TC-P-04 |\n\n### 5.2 テストデータの配置\n\nテストデータは以下のディレクトリ構造で管理します：\n\n```\njenkins/jobs/pipeline/infrastructure/pulumi-stack-action/tests/fixtures/test_data/\n├── e2e/\n│   ├── basic_aws.json           # TC-E-01\n│   ├── multi_cloud.json         # TC-E-02\n│   ├── complex_dependencies.json # TC-E-03\n│   ├── long_resource_names.json # TC-E-04\n│   └── special_characters.json  # TC-E-05\n├── error_handling/\n│   ├── invalid_urn.json         # TC-EH-01\n│   ├── empty_data.json          # TC-EH-02\n│   └── none_data.json           # TC-EH-03\n├── boundary/\n│   ├── zero_resources.json      # TC-BV-01\n│   ├── max_resources.json       # TC-BV-02\n│   └── overflow_resources.json  # TC-BV-03\n└── performance/\n    ├── 1_resource.json          # TC-P-01\n    ├── 5_resources.json         # TC-P-02\n    ├── 10_resources.json        # TC-P-03\n    └── 20_resources.json        # TC-P-04\n```\n\n### 5.3 テストデータのフォーマット\n\nすべてのテストデータはJSON形式で保存します：\n\n```json\n{\n  \"stack_name\": \"dev-stack\",\n  \"resources\": [\n    {\n      \"urn\": \"urn:pulumi:dev::app::aws:s3/bucket:Bucket::my-bucket\",\n      \"type\": \"aws:s3/bucket:Bucket\",\n      \"dependencies\": []\n    }\n  ],\n  \"resource_providers\": {\n    \"aws\": 1\n  }\n}\n```\n\n---\n\n## 6. テスト環境要件\n\n### 6.1 テスト実行環境\n\n| 項目 | 要件 | 説明 |\n|------|------|------|\n| **OS** | Amazon Linux 2023 | ブートストラップ環境 |\n| **Python** | 3.8以上 | 言語バージョン |\n| **pytest** | 7.4.3 | テストフレームワーク |\n| **pytest-cov** | 4.1.0 | カバレッジ測定ツール |\n| **pytest-benchmark** | 4.0.0 (オプション) | パフォーマンステスト支援 |\n\n### 6.2 必要な外部サービス\n\n**なし**\n\nPhase 4のテストは既存コードのレビューとテストが中心のため、外部サービス連携は発生しません。\n\n### 6.3 モック/スタブの必要性\n\n**不要**\n\nPhase 4のテストは以下の理由でモック/スタブを使用しません：\n\n1. **静的メソッド設計**: すべてのメソッドが静的メソッドであり、外部依存がない\n2. **ステートレス設計**: 状態を持たない設計のため、モックが不要\n3. **純粋関数**: 入力 → 処理 → 出力の純粋関数として実装されている\n\n### 6.4 テストデータの準備\n\nテストデータは以下の手順で準備します：\n\n1. **フィクスチャの作成**: `conftest.py`に共通フィクスチャを定義\n2. **テストデータファイルの配置**: `tests/fixtures/test_data/`にJSONファイルを配置\n3. **テストコードでの読み込み**: `json.load()`でテストデータを読み込み\n\n---\n\n## 7. テスト実行手順\n\n### 7.1 全テスト実行\n\n```bash\n# カレントディレクトリをテストディレクトリに移動\ncd jenkins/jobs/pipeline/infrastructure/pulumi-stack-action/tests\n\n# 全テスト実行\npytest -v\n\n# カバレッジ付きで実行\npytest -v --cov=../src --cov-report=html --cov-report=term\n```\n\n### 7.2 特定のテスト種別のみ実行\n\n```bash\n# 統合テストのみ実行\npytest -v -m integration\n\n# パフォーマンステストのみ実行\npytest -v -m performance\n\n# エンドツーエンドテストのみ実行\npytest -v -k \"test_e2e\"\n\n# エラーハンドリングテストのみ実行\npytest -v -k \"test_error_handling\"\n\n# 境界値テストのみ実行\npytest -v -k \"test_boundary\"\n```\n\n### 7.3 並列実行（高速化）\n\n```bash\n# pytest-xdistを使用して4並列で実行\npytest -v -n 4\n```\n\n### 7.4 カバレッジ確認\n\n```bash\n# カバレッジ測定\npytest --cov=../src --cov-report=html --cov-report=term\n\n# HTMLレポートを開く\nopen htmlcov/index.html\n```\n\n---\n\n## 8. テスト成功基準\n\n### 8.1 全体的な成功基準\n\n| 項目 | 基準 | 説明 |\n|------|------|------|\n| **テスト合格率** | 100% | 全テストケース（130ケース）がパスする |\n| **カバレッジ** | 80%以上 | pytest-covで測定 |\n| **パフォーマンス** | ±10%以内 | リファクタリング前後の性能差 |\n| **テスト実行時間** | 10秒以内 | 全テスト（130ケース）の実行時間 |\n\n### 8.2 Phase 4の品質ゲート\n\nPhase 4のテストシナリオは以下の品質ゲートを満たしています：\n\n- [x] **Phase 2の戦略に沿ったテストシナリオである**: INTEGRATION_BDD戦略に準拠\n- [x] **主要な正常系がカバーされている**: エンドツーエンド5ケース（基本、マルチクラウド、複雑依存、長い名前、特殊文字）\n- [x] **主要な異常系がカバーされている**: エラーハンドリング3ケース（不正URN、空データ、Noneデータ）\n- [x] **期待結果が明確である**: すべてのテストケースに検証項目のチェックリストを記載\n\n---\n\n## 9. リスクと軽減策\n\n### 9.1 テストシナリオ作成に関するリスク\n\n#### リスク1: テストデータ不足\n\n- **影響度**: 中\n- **確率**: 低\n- **軽減策**:\n  - テストデータファイルをJSON形式で事前準備\n  - フィクスチャを活用して再利用可能なテストデータを作成\n  - 既存のPhase 1~3のテストデータを活用\n\n#### リスク2: パフォーマンステストのベースライン取得困難\n\n- **影響度**: 中\n- **確率**: 中\n- **軽減策**:\n  - Phase 1実施前のコードをGit履歴から取得\n  - ベースライン取得が不可能な場合は、現在のパフォーマンスを記録して将来の基準とする\n  - 相対的な性能比較ではなく、絶対的な性能目標（< 2秒）を設定\n\n#### リスク3: 統合テストの実行時間が長い\n\n- **影響度**: 低\n- **確率**: 低\n- **軽減策**:\n  - pytest-xdistで並列実行（4並列）\n  - テストケース数を16ケースに絞り込み（既存114ケースと合わせて130ケース）\n  - パフォーマンステストは別途実行（マーカーで分離）\n\n---\n\n## 10. トレーサビリティマトリックス\n\nIssue #465の要件とテストシナリオの対応関係を示します。\n\n### 10.1 機能要件とテストシナリオの対応\n\n| 機能要件 | テストシナリオ | 説明 |\n|---------|--------------|------|\n| FR-01: コードレビュー実施 | （テスト対象外） | コードレビューは手動プロセス |\n| FR-02: レビュー指摘事項の修正 | （既存テストで検証） | 修正後、既存114ケースで回帰テスト |\n| FR-03: パフォーマンステスト実施 | TC-P-01~TC-P-05 | 5ケースのパフォーマンステスト |\n| FR-04: 統合テストケース追加 | TC-E-01~TC-E-05, TC-EH-01~TC-EH-03, TC-BV-01~TC-BV-03 | 11ケースの統合テスト |\n| FR-05: アーキテクチャ図作成 | （テスト対象外） | ドキュメント成果物 |\n| FR-06: クラス図作成 | （テスト対象外） | ドキュメント成果物 |\n| FR-07: README更新 | （テスト対象外） | ドキュメント成果物 |\n| FR-08: レビュー報告書作成 | （テスト対象外） | レポート成果物 |\n| FR-09: パフォーマンス比較レポート作成 | TC-P-01~TC-P-05 | パフォーマンステスト結果を基に作成 |\n| FR-10: Phase 4完了レポート作成 | （テスト対象外） | レポート成果物 |\n\n### 10.2 受け入れ基準とテストシナリオの対応\n\n| 受け入れ基準 | テストシナリオ | 説明 |\n|------------|--------------|------|\n| AC-01: コードレビューが承認されていること | （テスト対象外） | 手動レビュープロセス |\n| AC-02: パフォーマンスに大きな劣化がないこと | TC-P-01~TC-P-05 | ±10%以内を検証 |\n| AC-03: 統合テストがパスすること | TC-E-01~TC-E-05, TC-EH-01~TC-EH-03, TC-BV-01~TC-BV-03 | 11ケースすべてパス |\n| AC-04: アーキテクチャ図が作成されていること | （テスト対象外） | ドキュメント成果物 |\n| AC-05: クラス図が作成されていること | （テスト対象外） | ドキュメント成果物 |\n| AC-06: READMEが最新の状態に更新されていること | （テスト対象外） | ドキュメント成果物 |\n| AC-07: Phase 4完了レポートが作成されていること | （テスト対象外） | レポート成果物 |\n\n---\n\n## 11. 参考情報\n\n### 11.1 既存テストケース\n\nPhase 1~3で作成された既存テストケース（114ケース）：\n\n| Phase | ファイル | テストケース数 | 説明 |\n|-------|---------|---------------|------|\n| Phase 1 | `test_urn_processor.py` | 24ケース | URN処理のユニットテスト |\n| Phase 2 | `test_node_label_generator.py` | 29ケース | ノードラベル生成のユニットテスト |\n| Phase 3 | `test_resource_dependency_builder.py` | 37ケース | リソース依存関係のユニットテスト |\n| Phase 3 | `test_dot_processor.py` | 24ケース | DotFileProcessorの統合テスト |\n\n### 11.2 テストマーカー\n\npytestマーカーを使用してテストを分類します：\n\n```python\n@pytest.mark.integration       # 統合テスト\n@pytest.mark.performance       # パフォーマンステスト\n@pytest.mark.characterization  # 既存の特性記述テスト\n@pytest.mark.unit              # ユニットテスト（Phase 1~3）\n```\n\n### 11.3 技術スタック\n\n- **言語**: Python 3.8以上\n- **テストフレームワーク**: pytest 7.4.3\n- **カバレッジツール**: pytest-cov 4.1.0\n- **パフォーマンステスト**: timeitモジュール、pytest-benchmark（オプション）\n- **並列実行**: pytest-xdist\n\n---\n\n## 12. 変更履歴\n\n| 日付 | バージョン | 変更内容 | 作成者 |\n|------|-----------|----------|--------|\n| 2025-10-17 | 1.0 | 初版作成 | Claude Code |\n\n---\n\n**以上、テストシナリオを完了しました。**\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":152,"cache_read_input_tokens":58723,"cache_creation":{"ephemeral_5m_input_tokens":152,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"8dd03756-8692-4fc6-8a36-432d08640ede"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EDtzkyfp4JvoYb7Vjk566p","type":"tool_result","content":"File created successfully at: /tmp/ai-workflow-repos-1/infrastructure-as-code/.ai-workflow/issue-465/03_test_scenario/output/test-scenario.md"}]},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"8d8e4079-02dd-447c-b5a4-7cb3cbdf9833"}
{"type":"assistant","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01A6x3uad4sxXHo13qALhu2x","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I've successfully created a comprehensive test scenario document for Issue #465. Let me summarize what has been completed:\n\n## 📋 テストシナリオ作成完了\n\n### ✅ 作成内容\n\n**Phase 2で決定されたテスト戦略**: **INTEGRATION_BDD**に基づいて、以下のテストシナリオを作成しました：\n\n#### 1. **統合テストシナリオ (11ケース)**\n\n**エンドツーエンド統合テスト (5ケース)**:\n- TC-E-01: 基本的なPulumiグラフ処理（AWS）\n- TC-E-02: 複数プロバイダー（AWS + Azure）\n- TC-E-03: 複雑な依存関係\n- TC-E-04: 長いリソース名の処理\n- TC-E-05: 特殊文字を含むリソース名\n\n**エラーハンドリング統合テスト (3ケース)**:\n- TC-EH-01: 不正なURN形式\n- TC-EH-02: 空データ\n- TC-EH-03: Noneデータ\n\n**境界値統合テスト (3ケース)**:\n- TC-BV-01: 0リソース（空リソース）\n- TC-BV-02: 20リソース（最大値）\n- TC-BV-03: 21リソース（最大値超過）\n\n#### 2. **パフォーマンステストシナリオ (5ケース)**\n\n- TC-P-01: 1リソース処理時間\n- TC-P-02: 5リソース処理時間\n- TC-P-03: 10リソース処理時間\n- TC-P-04: 20リソース処理時間（境界値）\n- TC-P-05: グラフスタイル適用処理時間\n\n#### 3. **BDDシナリオ (5シナリオ)**\n\nGiven-When-Then形式で以下のユーザーストーリーを記述:\n- 基本的なAWSスタックの可視化\n- マルチクラウドスタックの可視化\n- 空スタックの適切な処理\n- 不正URNの適切な処理\n- 複雑な依存関係の可視化\n\n### ✅ 品質ゲート達成状況\n\nPhase 3の品質ゲート（必須要件）をすべて満たしています：\n\n- ✅ **Phase 2の戦略に沿ったテストシナリオである**: INTEGRATION_BDD戦略に完全準拠\n- ✅ **主要な正常系がカバーされている**: エンドツーエンド5ケースで網羅\n- ✅ **主要な異常系がカバーされている**: エラーハンドリング3ケースで網羅\n- ✅ **期待結果が明確である**: すべてのテストケースに詳細な検証項目を記載\n\n### 📊 テストケース統計\n\n| テスト種別 | ケース数 | 説明 |\n|-----------|---------|------|\n| 統合テスト - エンドツーエンド | 5 | 正常系の主要シナリオ |\n| 統合テスト - エラーハンドリング | 3 | 異常系の処理検証 |\n| 統合テスト - 境界値 | 3 | リソース数の境界値検証 |\n| パフォーマンステスト | 5 | 性能劣化の検証（±10%以内） |\n| **Phase 4新規追加** | **16** | - |\n| **既存テスト（Phase 1~3）** | **114** | - |\n| **合計** | **130** | - |\n\n### 📁 成果物の配置\n\nテストシナリオは以下に保存されました：\n\n```\n.ai-workflow/issue-465/03_test_scenario/output/test-scenario.md\n```\n\n### 🎯 次のステップ\n\nPhase 4: 実装フェーズに進み、以下を実施します：\n1. コードレビュー実施\n2. レビュー指摘事項の修正\n3. パフォーマンステストコード実装\n4. 統合テストケース実装\n5. テスト実行とカバレッジ確認\n\nテストシナリオの作成が完了しました！🎉"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":16642,"cache_read_input_tokens":58875,"cache_creation":{"ephemeral_5m_input_tokens":16642,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"parent_tool_use_id":null,"session_id":"9372c318-f402-4566-b686-9bcc506e3b73","uuid":"14e0d43c-2c17-4110-a024-da4be9a5e360"}
{"type":"result","subtype":"success","is_error":false,"duration_ms":247451,"duration_api_ms":250988,"num_turns":10,"result":"Perfect! I've successfully created a comprehensive test scenario document for Issue #465. Let me summarize what has been completed:\n\n## 📋 テストシナリオ作成完了\n\n### ✅ 作成内容\n\n**Phase 2で決定されたテスト戦略**: **INTEGRATION_BDD**に基づいて、以下のテストシナリオを作成しました：\n\n#### 1. **統合テストシナリオ (11ケース)**\n\n**エンドツーエンド統合テスト (5ケース)**:\n- TC-E-01: 基本的なPulumiグラフ処理（AWS）\n- TC-E-02: 複数プロバイダー（AWS + Azure）\n- TC-E-03: 複雑な依存関係\n- TC-E-04: 長いリソース名の処理\n- TC-E-05: 特殊文字を含むリソース名\n\n**エラーハンドリング統合テスト (3ケース)**:\n- TC-EH-01: 不正なURN形式\n- TC-EH-02: 空データ\n- TC-EH-03: Noneデータ\n\n**境界値統合テスト (3ケース)**:\n- TC-BV-01: 0リソース（空リソース）\n- TC-BV-02: 20リソース（最大値）\n- TC-BV-03: 21リソース（最大値超過）\n\n#### 2. **パフォーマンステストシナリオ (5ケース)**\n\n- TC-P-01: 1リソース処理時間\n- TC-P-02: 5リソース処理時間\n- TC-P-03: 10リソース処理時間\n- TC-P-04: 20リソース処理時間（境界値）\n- TC-P-05: グラフスタイル適用処理時間\n\n#### 3. **BDDシナリオ (5シナリオ)**\n\nGiven-When-Then形式で以下のユーザーストーリーを記述:\n- 基本的なAWSスタックの可視化\n- マルチクラウドスタックの可視化\n- 空スタックの適切な処理\n- 不正URNの適切な処理\n- 複雑な依存関係の可視化\n\n### ✅ 品質ゲート達成状況\n\nPhase 3の品質ゲート（必須要件）をすべて満たしています：\n\n- ✅ **Phase 2の戦略に沿ったテストシナリオである**: INTEGRATION_BDD戦略に完全準拠\n- ✅ **主要な正常系がカバーされている**: エンドツーエンド5ケースで網羅\n- ✅ **主要な異常系がカバーされている**: エラーハンドリング3ケースで網羅\n- ✅ **期待結果が明確である**: すべてのテストケースに詳細な検証項目を記載\n\n### 📊 テストケース統計\n\n| テスト種別 | ケース数 | 説明 |\n|-----------|---------|------|\n| 統合テスト - エンドツーエンド | 5 | 正常系の主要シナリオ |\n| 統合テスト - エラーハンドリング | 3 | 異常系の処理検証 |\n| 統合テスト - 境界値 | 3 | リソース数の境界値検証 |\n| パフォーマンステスト | 5 | 性能劣化の検証（±10%以内） |\n| **Phase 4新規追加** | **16** | - |\n| **既存テスト（Phase 1~3）** | **114** | - |\n| **合計** | **130** | - |\n\n### 📁 成果物の配置\n\nテストシナリオは以下に保存されました：\n\n```\n.ai-workflow/issue-465/03_test_scenario/output/test-scenario.md\n```\n\n### 🎯 次のステップ\n\nPhase 4: 実装フェーズに進み、以下を実施します：\n1. コードレビュー実施\n2. レビュー指摘事項の修正\n3. パフォーマンステストコード実装\n4. 統合テストケース実装\n5. テスト実行とカバレッジ確認\n\nテストシナリオの作成が完了しました！🎉","session_id":"9372c318-f402-4566-b686-9bcc506e3b73","total_cost_usd":0.54851525,"usage":{"input_tokens":13,"cache_creation_input_tokens":63315,"cache_read_input_tokens":129800,"output_tokens":17943,"server_tool_use":{"web_search_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":63315}},"modelUsage":{"claude-haiku-4-5-20251001":{"inputTokens":1845,"outputTokens":223,"cacheReadInputTokens":0,"cacheCreationInputTokens":0,"webSearchRequests":0,"costUSD":0.00296,"contextWindow":200000},"claude-sonnet-4-5-20250929":{"inputTokens":13,"outputTokens":17943,"cacheReadInputTokens":129800,"cacheCreationInputTokens":63315,"webSearchRequests":0,"costUSD":0.54555525,"contextWindow":200000}},"permission_denials":[],"uuid":"d3ab86e7-ad6d-4c43-af79-243abd21396f"}