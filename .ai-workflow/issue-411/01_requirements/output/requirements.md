# 要件定義書 - Issue #411

## ドキュメント情報

- **Issue番号**: #411
- **タイトル**: [TASK] AI Workflow V1 (Python版) の安全な削除計画
- **URL**: https://github.com/tielec/infrastructure-as-code/issues/411
- **作成日**: 2025年
- **対象環境**: infrastructure-as-code リポジトリ

---

## 0. Planning Documentの確認

本要件定義は、Planning Phase（`.ai-workflow/issue-411/00_planning/output/planning.md`）で策定された以下の開発計画に基づいて作成されています：

### 開発計画の概要

- **実装戦略**: REFACTOR
  - 新規コード作成は不要
  - 既存システムからV1 Python版を安全に削除し、V2 TypeScript版への移行を完了させる構造改善が目的

- **テスト戦略**: INTEGRATION_ONLY
  - ユニットテスト不要（削除作業のため）
  - インテグレーションテスト必須（Jenkins動作確認、リンク切れチェック、CI/CDパイプライン確認）

- **複雑度**: 中程度
  - 見積もり工数: 8~12時間
  - 複数カテゴリ（Jenkins、ドキュメント、依存関係）にまたがる作業

- **主要リスク**:
  1. 隠れた依存関係による削除後の障害（影響度: 中、確率: 中）
  2. ドキュメントのリンク切れ（影響度: 中、確率: 中）
  3. Jenkins環境でのトラブル（影響度: 高、確率: 低）

- **段階的削除戦略**:
  - Phase 1: Deprecated化（1週間の猶予期間）
  - Phase 2: Jenkinsジョブ更新
  - Phase 3: ドキュメント更新
  - Phase 4: 実際の削除

この開発計画を踏まえ、以下に詳細な要件定義を行います。

---

## 1. 概要

### 1.1 背景

AI Workflow V2 (TypeScript版) がおおよそ動作するようになり、実用段階に入った。V1 (Python版) は既に使用されておらず、メンテナンスコストとコードベースの複雑性を削減するため、安全に削除する必要がある。

### 1.2 目的

- **主目的**: AI Workflow V1 (Python版) を安全に削除し、V2 (TypeScript版) への完全移行を完了する
- **副次目的**:
  - コードベースの簡素化とメンテナンス負荷の軽減
  - 将来的な混乱の防止（V1とV2の混在による誤使用を回避）
  - リポジトリの整理と可読性の向上

### 1.3 ビジネス価値・技術的価値

- **ビジネス価値**:
  - メンテナンスコストの削減（V1のサポート不要）
  - 開発者の混乱防止（単一のワークフローシステムに統一）

- **技術的価値**:
  - コードベースの簡素化（不要なコードの削除）
  - 依存関係の整理（Python版特有の依存を削除）
  - ドキュメントの一貫性向上

### 1.4 成功基準

以下の6つの条件がすべて満たされた場合、本タスクは成功とみなされます：

1. `scripts/ai-workflow/` ディレクトリが完全に削除されている
2. `archive/ai-workflow-v1-python` ブランチが存在し、復元可能である
3. V1への参照が全ドキュメントから削除されている
4. V2を使用するJenkinsジョブが正常に動作する
5. ドキュメント内にリンク切れが存在しない
6. 問題発生時に即座に復元できる手順が確立されている

---

## 2. 機能要件

### FR-1: Deprecated化の実施（Phase 1）

**優先度**: 高

**詳細**:
- `scripts/ai-workflow/DEPRECATED.md` ファイルを作成し、以下の情報を記載する：
  - 非推奨理由
  - V2への移行方法
  - 削除予定日
  - 問い合わせ先
- `scripts/ai-workflow/README.md` の先頭に非推奨警告を追加する
- V1を使用しているJenkinsジョブがあれば、ジョブ説明欄に非推奨警告を追加する
- 1週間の猶予期間を設定する（Issueに記載の通り）

**検証方法**:
- DEPRECATED.md が存在し、必要な情報がすべて記載されている
- README.md に視覚的に目立つ警告が追加されている
- 猶予期間が経過するまで削除を実行しない

---

### FR-2: V1参照箇所の全数調査（Phase 1）

**優先度**: 高

**詳細**:
- 以下のファイル群から `scripts/ai-workflow` への参照を検索する：
  - 全markdownファイル（`*.md`）
  - Jenkinsジョブ定義（DSLファイル、Jenkinsfile、folder-config.yaml）
  - Ansibleプレイブック（`*.yml`）
  - スクリプト（`*.sh`, `*.py`, `*.ts`）
- 検索結果を一覧化し、更新・削除対象を特定する

**検証方法**:
- Grep検索結果が文書化されている
- 各参照箇所に対して「更新」「削除」「影響なし」の判定が記載されている

---

### FR-3: Jenkinsジョブの確認と更新（Phase 2）

**優先度**: 高

**詳細**:
- V1を使用しているJenkinsジョブを特定する
- 既にV2へ移行済みであることを確認する（Planning Documentによれば既にV2使用中）
- `jenkins/jobs/pipeline/_seed/job-creator/folder-config.yaml` にV1への参照がある場合は削除する

**検証方法**:
- V1を使用するJenkinsジョブが存在しないことを確認
- folder-config.yaml にV1への参照が残っていないことを確認
- V2ジョブが正常に動作することを確認

---

### FR-4: ドキュメント更新（Phase 3）

**優先度**: 高

**詳細**:
- 以下のドキュメントからV1への参照を削除する：
  - `jenkins/README.md`（line 547付近にV1への参照あり）
  - `CLAUDE.md`（V1への言及があれば削除）
  - `ARCHITECTURE.md`（V1への言及があれば削除）
  - その他のREADME、CONTRIBUTION.md等
- V2のREADMEに「V1から完全移行済み」の記載を追加する（必要に応じて）

**検証方法**:
- 全ドキュメントからV1への参照が削除されている
- リンク切れチェッカーで検証しエラーがない

---

### FR-5: バックアップ作成（Phase 4）

**優先度**: 高（必須）

**詳細**:
- Gitブランチとして `archive/ai-workflow-v1-python` を作成する：
  ```bash
  git checkout -b archive/ai-workflow-v1-python
  git push origin archive/ai-workflow-v1-python
  git checkout main
  ```
- バックアップブランチがリモートリポジトリに正常にプッシュされたことを確認する

**検証方法**:
- ブランチ `archive/ai-workflow-v1-python` がGitHubに存在する
- ブランチから `scripts/ai-workflow/` が復元可能であることを確認

---

### FR-6: 実際の削除実行（Phase 4）

**優先度**: 高

**詳細**:
- mainブランチで以下のコマンドを実行する：
  ```bash
  git rm -rf scripts/ai-workflow/
  git commit -m "[scripts] remove: AI Workflow V1 (Python版) を削除"
  ```
- コミットメッセージはプロジェクトの規約（CLAUDE.md）に従う
- Co-Authorクレジットは追加しない（CLAUDE.md line 364の規定）

**検証方法**:
- `scripts/ai-workflow/` ディレクトリが削除されている
- コミットメッセージが規約に従っている
- リポジトリに削除以外の意図しない変更が含まれていない

---

### FR-7: 削除後の動作確認（Phase 4）

**優先度**: 高

**詳細**:
- 以下の動作確認を実施する：
  - Jenkinsジョブ `AI_Workflow/ai_workflow_orchestrator` が正常に動作する（V2使用）
  - ドキュメントのリンク切れがない（自動チェックツール使用）
  - V2ワークフローの全機能が動作する（簡易テスト）
  - CI/CDパイプラインが正常に動作する

**検証方法**:
- 各確認項目の結果を文書化
- すべての確認項目でエラーがない

---

### FR-8: ロールバック手順の検証（Phase 4）

**優先度**: 中

**詳細**:
- バックアップブランチからファイルが復元できることを事前検証する
- 以下のコマンドで復元可能であることを確認：
  ```bash
  git checkout archive/ai-workflow-v1-python -- scripts/ai-workflow/
  ```

**検証方法**:
- 復元コマンドが正常に動作する
- 復元後のファイルが元の状態と一致する

---

### FR-9: 変更履歴の記録（Phase 4完了後）

**優先度**: 中

**詳細**:
- CHANGELOGまたはREADMEに以下の情報を記載する：
  - V1削除完了の記載
  - バックアップブランチの場所（`archive/ai-workflow-v1-python`）
  - V2への移行完了の記載
  - 削除日

**検証方法**:
- 変更履歴が適切に記録されている
- バックアップブランチへのリンクが記載されている

---

## 3. 非機能要件

### NFR-1: 安全性（Safety）

- **要件**: 削除操作は可逆的でなければならない
- **基準**: バックアップブランチから5分以内に復元可能であること
- **検証**: ロールバック手順の実行テストで確認

### NFR-2: 信頼性（Reliability）

- **要件**: 削除後もJenkins環境が正常に動作すること
- **基準**: 全Jenkinsジョブが削除前と同様に動作すること
- **検証**: Jenkins動作確認テストで確認

### NFR-3: 保守性（Maintainability）

- **要件**: 削除後のコードベースは保守しやすい状態であること
- **基準**:
  - V1への参照が完全に削除されている
  - ドキュメントに矛盾がない
  - リンク切れが存在しない
- **検証**: ドキュメントレビューとリンクチェックツールで確認

### NFR-4: 完全性（Completeness）

- **要件**: V1に関連するすべてのファイルとドキュメント参照が削除されること
- **基準**: Grep検索で `scripts/ai-workflow` への参照がゼロ件であること
- **検証**: 全ファイル対象のGrep検索で確認

### NFR-5: 透明性（Transparency）

- **要件**: 削除作業の記録が残されていること
- **基準**:
  - Gitコミット履歴に削除が明確に記録されている
  - Issue #411に完了報告が投稿されている
  - 変更履歴（CHANGELOG/README）に記載されている
- **検証**: Git履歴とIssueコメントで確認

---

## 4. 制約事項

### 4.1 技術的制約

- **Git管理**: バックアップはGitブランチとして管理する（tar.gzではなく）
- **コミットメッセージ規約**: `[scripts] remove: ...` 形式で記述（CLAUDE.md準拠）
- **Co-Author禁止**: Gitコミットに `Co-Authored-By: Claude` を追加しない（CLAUDE.md line 364）
- **猶予期間**: Deprecated化後、最低1週間の猶予期間を設ける

### 4.2 運用制約

- **段階的実行**: 4フェーズの順序を守る（Phase 1→2→3→4）
- **確認必須**: 各フェーズ完了後、次フェーズに進む前に確認を実施
- **ロールバック準備**: 削除前に必ずバックアップブランチを作成

### 4.3 ポリシー制約

- **Infrastructure as Code**: 削除もコード（Git操作）で管理
- **ドキュメントファースト**: ドキュメント更新を削除前に完了させる
- **レビュー必須**: 削除前にGrep検索結果をレビュー

---

## 5. 前提条件

### 5.1 システム環境

- AI Workflow V2 (TypeScript版) が正常に動作している
- Jenkinsジョブが既にV2を使用している
- Gitリポジトリ `infrastructure-as-code` へのアクセス権限がある

### 5.2 依存コンポーネント

- V2が提供する機能はV1と同等以上である
- V1を使用している外部システムやスクリプトが存在しない

### 5.3 外部システム連携

- GitHub（バックアップブランチのプッシュ先）
- Jenkins（動作確認の対象）

---

## 6. 受け入れ基準

### AC-1: Deprecated化の受け入れ基準

**Given**: V1が存在し、まだ使用可能な状態である
**When**: Deprecated化を実施する
**Then**:
- `scripts/ai-workflow/DEPRECATED.md` が作成されている
- `scripts/ai-workflow/README.md` の先頭に非推奨警告がある
- 警告には削除予定日が明記されている

---

### AC-2: V1参照箇所調査の受け入れ基準

**Given**: リポジトリに複数のファイルが存在する
**When**: `scripts/ai-workflow` への参照を検索する
**Then**:
- 全markdownファイルが検索対象に含まれている
- Jenkinsジョブ定義（DSL、Jenkinsfile、folder-config.yaml）が検索対象に含まれている
- 検索結果が一覧化され、各参照箇所に判定が記載されている

---

### AC-3: Jenkinsジョブ更新の受け入れ基準

**Given**: Jenkinsジョブが存在する
**When**: V1使用ジョブを確認する
**Then**:
- V1を使用するJenkinsジョブがゼロ件である
- すべてのジョブがV2を使用している
- folder-config.yaml にV1への参照が残っていない

---

### AC-4: ドキュメント更新の受け入れ基準

**Given**: ドキュメントにV1への参照がある
**When**: ドキュメントを更新する
**Then**:
- `jenkins/README.md` からV1への参照が削除されている
- 全ドキュメントからV1への参照が削除されている
- リンク切れチェックでエラーがゼロ件である

---

### AC-5: バックアップ作成の受け入れ基準

**Given**: V1が削除される前の状態である
**When**: バックアップブランチを作成する
**Then**:
- ブランチ `archive/ai-workflow-v1-python` がGitHubに存在する
- ブランチから `scripts/ai-workflow/` ディレクトリが復元可能である
- リモートリポジトリに正常にプッシュされている

---

### AC-6: 削除実行の受け入れ基準

**Given**: バックアップブランチが作成済みである
**When**: V1を削除する
**Then**:
- `scripts/ai-workflow/` ディレクトリが存在しない
- コミットメッセージが `[scripts] remove: AI Workflow V1 (Python版) を削除` である
- コミットに削除以外の意図しない変更が含まれていない
- Co-Authorクレジットが含まれていない

---

### AC-7: 削除後動作確認の受け入れ基準

**Given**: V1が削除された状態である
**When**: Jenkins動作確認を実施する
**Then**:
- Jenkinsジョブ `AI_Workflow/ai_workflow_orchestrator` が正常に実行される
- V2ワークフローの全機能が正常に動作する
- CI/CDパイプラインがエラーなく完了する
- ドキュメントにリンク切れがない

---

### AC-8: ロールバック手順検証の受け入れ基準

**Given**: バックアップブランチが存在する
**When**: ロールバック手順を実行する
**Then**:
- 5分以内に `scripts/ai-workflow/` が復元される
- 復元されたファイルが削除前の状態と一致する
- 復元後にJenkinsが正常に動作する

---

### AC-9: 変更履歴記録の受け入れ基準

**Given**: V1の削除が完了している
**When**: 変更履歴を記録する
**Then**:
- CHANGELOGまたはREADMEに削除完了が記載されている
- バックアップブランチ名 `archive/ai-workflow-v1-python` が記載されている
- V2への移行完了が記載されている
- Issue #411に完了報告が投稿されている

---

## 7. スコープ外

以下の事項は本タスクのスコープ外とします：

### 7.1 明確にスコープ外とする事項

- **V2の機能改修**: V2の不具合修正や機能追加は別Issueで対応
- **V2のパフォーマンス改善**: V1削除とは独立したタスク
- **新規ドキュメントの作成**: 既存ドキュメントの更新のみ実施（新規作成は不要）
- **他のスクリプトの削除**: V1以外のスクリプト整理は対象外
- **Jenkins環境の大規模変更**: V1削除に伴う影響確認のみ実施

### 7.2 将来的な拡張候補

- V2のドキュメント充実化（別タスクとして検討）
- V2の機能拡張（Issue #369, #405等で対応）
- CI/CDパイプラインの最適化（別タスクとして検討）

---

## 8. リスク分析（Planning Documentより）

| リスクID | リスク内容 | 影響度 | 確率 | 軽減策 |
|---------|-----------|--------|------|--------|
| R-1 | 隠れた依存関係による削除後の障害 | 中 | 中 | Grep検索による徹底的な参照調査、1週間の猶予期間 |
| R-2 | ドキュメントのリンク切れ | 中 | 中 | 全markdownファイルの検索、リンクチェッカー使用 |
| R-3 | Jenkins環境でのトラブル | 高 | 低 | 既にV2移行済み確認、削除前に動作テスト |
| R-4 | ロールバックの失敗 | 高 | 低 | バックアップブランチ必須化、事前検証 |
| R-5 | スコープクリープ（作業範囲拡大） | 低 | 中 | Issue #411に厳密に従う、追加作業は別Issue化 |

---

## 9. スケジュール

Planning Documentの見積もりに基づくスケジュール：

| フェーズ | 期間 | 内容 |
|---------|------|------|
| Week 1 | Phase 1 | Deprecated化 + 1週間の猶予期間 |
| Week 2 | Phase 2-3 | Jenkinsジョブ更新 + ドキュメント更新 |
| Week 3 | Phase 4 | 削除実行 + 動作確認 + 完了報告 |

**合計見積もり**: 8~12時間（実作業時間）

---

## 10. 品質ゲート

本要件定義書は以下の品質ゲートを満たしています：

- [x] **機能要件が明確に記載されている**: FR-1～FR-9で9つの機能要件を定義
- [x] **受け入れ基準が定義されている**: AC-1～AC-9でGiven-When-Then形式で記述
- [x] **スコープが明確である**: セクション7で明確にスコープ外を定義
- [x] **論理的な矛盾がない**: Planning Documentと整合、各セクション間で矛盾なし

---

## 11. 関連ドキュメント

- **Planning Document**: `.ai-workflow/issue-411/00_planning/output/planning.md`
- **GitHub Issue**: https://github.com/tielec/infrastructure-as-code/issues/411
- **プロジェクトガイド**: `CLAUDE.md`, `ARCHITECTURE.md`, `CONTRIBUTION.md`, `README.md`
- **関連Issue**: #369 (AI Workflow V2 マルチリポジトリ対応), #405 (フェーズ依存関係のオプショナル化)

---

## 12. 承認

本要件定義書は次フェーズ（Phase 2: 設計）に進むための品質ゲートを満たしています。クリティカルシンキングレビューで承認されれば、設計フェーズへ進行します。
