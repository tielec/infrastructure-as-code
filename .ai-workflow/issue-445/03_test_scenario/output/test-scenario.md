# ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª: Issue #445

## æ–‡æ›¸æƒ…å ±

- **Issueç•ªå·**: #445
- **ã‚¿ã‚¤ãƒˆãƒ«**: [Refactor] ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å‰Šæ¸›: pr_comment_generator.py
- **çŠ¶æ…‹**: open
- **URL**: https://github.com/tielec/infrastructure-as-code/issues/445
- **ä½œæˆæ—¥**: 2025å¹´1æœˆ
- **æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´1æœˆ

---

## 0. Planning & Requirements & Design Documentã®ç¢ºèª

### Planning Phaseæˆæœç‰©ã®æ¦‚è¦

Planning Documentã§ç­–å®šã•ã‚ŒãŸä»¥ä¸‹ã®æˆ¦ç•¥ã‚’ç¢ºèªã—ã€æœ¬ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã«åæ˜ ã—ã¦ã„ã¾ã™ï¼š

#### ãƒ†ã‚¹ãƒˆæˆ¦ç•¥: ALL

**åˆ¤æ–­æ ¹æ‹ **:
- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: å„åˆ†å‰²ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆStatisticsã€Formatterã€OpenAIIntegrationï¼‰ã®ç‹¬ç«‹ã—ãŸæ©Ÿèƒ½ã‚’æ¤œè¨¼
- **ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®é€£æºï¼ˆStatisticsâ†’Formatterã€Generatorâ†’OpenAI APIï¼‰ã‚’æ¤œè¨¼
- **BDDãƒ†ã‚¹ãƒˆ**: ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆã€ŒPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆãŒè¿”ã•ã‚Œã‚‹ã€ï¼‰ã‚’æ¤œè¨¼
- **ç†ç”±**: å¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆé«˜ãƒªã‚¹ã‚¯ï¼‰ã®ãŸã‚ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«ã§å“è³ªã‚’ä¿è¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### Requirements Phaseæˆæœç‰©ã®æ¦‚è¦

è¦ä»¶å®šç¾©æ›¸ã§å®šç¾©ã•ã‚ŒãŸä»¥ä¸‹ã®æ©Ÿèƒ½è¦ä»¶ã‚’æœ¬ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§ã‚«ãƒãƒ¼ã—ã¦ã„ã¾ã™ï¼š

- **FR-001**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ï¼ˆPRCommentStatisticsã€CommentFormatterã€OpenAIIntegrationã€PRCommentGeneratorï¼‰
- **FR-002**: äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…ï¼ˆFacadeãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
- **FR-003**: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆã€çµ±åˆã€BDDï¼‰
- **FR-004**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆAPIä»•æ§˜æ›¸ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆå›³ã€ç§»è¡Œã‚¬ã‚¤ãƒ‰ï¼‰

### Design Phaseæˆæœç‰©ã®æ¦‚è¦

è¨­è¨ˆæ›¸ã§å®šç¾©ã•ã‚ŒãŸä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¹è¨­è¨ˆã‚’æœ¬ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§ã‚«ãƒãƒ¼ã—ã¦ã„ã¾ã™ï¼š

- `models.py`: PRInfoã€FileChange
- `token_estimator.py`: TokenEstimator
- `prompt_manager.py`: PromptTemplateManager
- `statistics.py`: PRCommentStatistics
- `formatter.py`: CommentFormatter
- `openai_integration.py`: OpenAIIntegration
- `generator.py`: PRCommentGenerator
- `__init__.py`: Facadeï¼ˆäº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰

---

## 1. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã‚µãƒãƒªãƒ¼

### é¸æŠã•ã‚ŒãŸãƒ†ã‚¹ãƒˆæˆ¦ç•¥

**ALL**ï¼ˆPhase 2ã§æ±ºå®šï¼‰

### ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ç¯„å›²

**ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå¯¾è±¡**:
- `models.py`: ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ï¼ˆPRInfoã€FileChangeï¼‰
- `token_estimator.py`: ãƒˆãƒ¼ã‚¯ãƒ³æ¨å®š
- `prompt_manager.py`: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
- `statistics.py`: çµ±è¨ˆè¨ˆç®—
- `formatter.py`: ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- `openai_integration.py`: OpenAI APIçµ±åˆï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
- `generator.py`: ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå¯¾è±¡**:
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºï¼ˆGenerator â†” Statisticsã€Generator â†” Formatterã€Generator â†” OpenAIIntegrationï¼‰
- äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆFacadeï¼‰

**BDDãƒ†ã‚¹ãƒˆå¯¾è±¡**:
- ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆãƒ•ãƒ­ãƒ¼å…¨ä½“ï¼‰

### ãƒ†ã‚¹ãƒˆã®ç›®çš„

1. **æ©Ÿèƒ½æ­£ç¢ºæ€§ã®ä¿è¨¼**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰å¾Œã§æ©Ÿèƒ½ãŒåŒä¸€ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼
2. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‹¬ç«‹æ€§ã®æ¤œè¨¼**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
3. **çµ±åˆæ™‚ã®å‹•ä½œä¿è¨¼**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®é€£æºãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®å……è¶³**: ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
5. **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®é˜²æ­¢**: æ—¢å­˜æ©Ÿèƒ½ãŒç ´å£Šã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ä¿è¨¼

---

## 2. Unitãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 2.1 models.py

#### 2.1.1 PRInfo.from_json_æ­£å¸¸ç³»

- **ç›®çš„**: JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰PRInfoã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: æœ‰åŠ¹ãªPRæƒ…å ±JSONãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  ```json
  {
    "title": "Add new feature",
    "number": 123,
    "body": "This is a test PR",
    "user": {"login": "testuser"},
    "base": {"ref": "main", "sha": "abc123"},
    "head": {"ref": "feature-branch", "sha": "def456"}
  }
  ```
- **æœŸå¾…çµæœ**:
  - `PRInfo`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹
  - `title == "Add new feature"`
  - `number == 123`
  - `author == "testuser"`
  - `base_branch == "main"`
  - `head_branch == "feature-branch"`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜JSON

#### 2.1.2 PRInfo.from_json_ç•°å¸¸ç³»ï¼ˆæ¬ æãƒ‡ãƒ¼ã‚¿ï¼‰

- **ç›®çš„**: ä¸€éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ æã—ã¦ã„ã‚‹JSONã‹ã‚‰PRInfoã‚’ç”Ÿæˆã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ä¸€éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ æã—ãŸJSONãƒ‡ãƒ¼ã‚¿
- **å…¥åŠ›**:
  ```json
  {
    "title": "Add new feature",
    "number": 123
  }
  ```
- **æœŸå¾…çµæœ**:
  - `PRInfo`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¨­å®šã•ã‚Œã‚‹ï¼‰
  - `body == ""`
  - `author == ""`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜JSON

#### 2.1.3 FileChange.from_json_æ­£å¸¸ç³»

- **ç›®çš„**: JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰FileChangeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´JSONãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  ```json
  {
    "filename": "src/main.py",
    "status": "modified",
    "additions": 10,
    "deletions": 5,
    "changes": 15,
    "patch": "@@ -1,3 +1,4 @@\n+new line\n old line"
  }
  ```
- **æœŸå¾…çµæœ**:
  - `FileChange`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹
  - `filename == "src/main.py"`
  - `additions == 10`
  - `deletions == 5`
  - `patch`ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜JSON

### 2.2 token_estimator.py

#### 2.2.1 estimate_tokens_æ­£å¸¸ç³»_è‹±èªãƒ†ã‚­ã‚¹ãƒˆ

- **ç›®çš„**: è‹±èªãƒ†ã‚­ã‚¹ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒæ­£ã—ãæ¨å®šã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: TokenEstimatorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `"Hello, this is a test."`ï¼ˆ23æ–‡å­—ï¼‰
- **æœŸå¾…çµæœ**: `int(23 * 0.25) = 5`ãƒˆãƒ¼ã‚¯ãƒ³å‰å¾Œ
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜æ–‡å­—åˆ—

#### 2.2.2 estimate_tokens_æ­£å¸¸ç³»_æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆ

- **ç›®çš„**: æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒæ­£ã—ãæ¨å®šã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: TokenEstimatorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `"ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã§ã™ã€‚"`ï¼ˆ9æ–‡å­—ï¼‰
- **æœŸå¾…çµæœ**: `int(9 * 0.6) = 5`ãƒˆãƒ¼ã‚¯ãƒ³å‰å¾Œ
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜æ–‡å­—åˆ—

#### 2.2.3 estimate_tokens_å¢ƒç•Œå€¤_ç©ºæ–‡å­—åˆ—

- **ç›®çš„**: ç©ºæ–‡å­—åˆ—ã®å ´åˆã€0ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: TokenEstimatorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `""`
- **æœŸå¾…çµæœ**: `0`ãƒˆãƒ¼ã‚¯ãƒ³
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ç©ºæ–‡å­—åˆ—

#### 2.2.4 truncate_text_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ†ã‚­ã‚¹ãƒˆãŒæŒ‡å®šã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³æ•°ä»¥ä¸‹ã«åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: TokenEstimatorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  - `text = "This is a very long text that needs to be truncated."`
  - `max_tokens = 5`
- **æœŸå¾…çµæœ**:
  - åˆ‡ã‚Šè©°ã‚ã‚‰ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒ5ä»¥ä¸‹
  - å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚ˆã‚ŠçŸ­ã„
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜textã€max_tokens

#### 2.2.5 truncate_text_å¢ƒç•Œå€¤_ãƒˆãƒ¼ã‚¯ãƒ³æ•°ä»¥ä¸‹

- **ç›®çš„**: ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒæ—¢ã«åˆ¶é™ä»¥ä¸‹ã®å ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆãŒãã®ã¾ã¾è¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: TokenEstimatorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  - `text = "Short."`
  - `max_tokens = 100`
- **æœŸå¾…çµæœ**: `text == "Short."`ï¼ˆå¤‰æ›´ãªã—ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜textã€max_tokens

### 2.3 prompt_manager.py

#### 2.3.1 PromptTemplateManager_åˆæœŸåŒ–_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: `templates/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**: `template_dir = "templates"`
- **æœŸå¾…çµæœ**:
  - `self.templates['base']`ãŒç©ºã§ãªã„
  - `self.templates['chunk']`ãŒç©ºã§ãªã„
  - `self.templates['summary']`ãŒç©ºã§ãªã„
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

#### 2.3.2 PromptTemplateManager_get_base_prompt_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæ­£ã—ãå–å¾—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PromptTemplateManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: ãªã—
- **æœŸå¾…çµæœ**: ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ–‡å­—åˆ—ãŒè¿”ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### 2.3.3 PromptTemplateManager_format_prompt_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PromptTemplateManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  - `template_key = "base"`
  - `kwargs = {"pr_number": 123, "author": "testuser"}`
- **æœŸå¾…çµæœ**: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒ`kwargs`ã®å€¤ã§ç½®æ›ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: `"PR #{pr_number} by {author}"`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### 2.3.4 PromptTemplateManager_format_prompt_ç•°å¸¸ç³»_ã‚­ãƒ¼æ¬ æ

- **ç›®çš„**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ•°ãŒæ¬ æã—ã¦ã„ã‚‹å ´åˆã€è­¦å‘ŠãŒå‡ºã‚‹ãŒå‡¦ç†ãŒç¶™ç¶šã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PromptTemplateManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  - `template_key = "base"`
  - `kwargs = {}`ï¼ˆã‚­ãƒ¼ãŒæ¬ æï¼‰
- **æœŸå¾…çµæœ**: è­¦å‘ŠãŒå‡ºåŠ›ã•ã‚Œã€å…ƒã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¿”ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: `"PR #{pr_number}"`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### 2.4 statistics.py

#### 2.4.1 calculate_optimal_chunk_size_æ­£å¸¸ç³»

- **ç›®çš„**: æœ€é©ãªãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PRCommentStatisticsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  - `files = [FileChange(patch="..." * 100), FileChange(patch="..." * 100), ...]`ï¼ˆ10ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
  - `max_tokens = 3000`
- **æœŸå¾…çµæœ**: `chunk_size`ãŒ1ä»¥ä¸Šã€ãƒ•ã‚¡ã‚¤ãƒ«æ•°ä»¥ä¸‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜filesãƒªã‚¹ãƒˆ

#### 2.4.2 calculate_optimal_chunk_size_å¢ƒç•Œå€¤_ç©ºãƒªã‚¹ãƒˆ

- **ç›®çš„**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã€æœ€å°ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PRCommentStatisticsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `files = []`
- **æœŸå¾…çµæœ**: `chunk_size == 1`ï¼ˆDEFAULT_MIN_CHUNK_SIZEï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ç©ºãƒªã‚¹ãƒˆ

#### 2.4.3 estimate_chunk_tokens_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒãƒ£ãƒ³ã‚¯ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒæ­£ã—ãæ¨å®šã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PRCommentStatisticsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `chunk = [FileChange(patch="test" * 50), FileChange(patch="test" * 50)]`
- **æœŸå¾…çµæœ**: æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒ0ã‚ˆã‚Šå¤§ãã„
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜chunk

#### 2.4.4 calculate_statistics_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã®çµ±è¨ˆæƒ…å ±ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: PRCommentStatisticsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  files = [
    FileChange(additions=10, deletions=5, changes=15),
    FileChange(additions=20, deletions=10, changes=30)
  ]
  ```
- **æœŸå¾…çµæœ**:
  - `file_count == 2`
  - `total_additions == 30`
  - `total_deletions == 15`
  - `total_changes == 45`
  - `avg_changes_per_file == 22.5`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜filesãƒªã‚¹ãƒˆ

### 2.5 formatter.py

#### 2.5.1 clean_markdown_format_æ­£å¸¸ç³»

- **ç›®çš„**: Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```markdown
  # Title



  Some text


  ```code```


  ```
- **æœŸå¾…çµæœ**:
  - 3è¡Œä»¥ä¸Šã®ç©ºè¡ŒãŒ2è¡Œã«å‰Šæ¸›ã•ã‚Œã‚‹
  - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å‰å¾Œã®ä½™åˆ†ãªç©ºè¡ŒãŒå‰Šé™¤ã•ã‚Œã‚‹
  - æœ«å°¾ã®ç©ºç™½ãŒå‰Šé™¤ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜Markdownãƒ†ã‚­ã‚¹ãƒˆ

#### 2.5.2 format_chunk_analyses_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒãƒ£ãƒ³ã‚¯åˆ†æçµæœãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  analyses = [
    "Analysis of chunk 1",
    "Analysis of chunk 2"
  ]
  ```
- **æœŸå¾…çµæœ**:
  - "## ãƒãƒ£ãƒ³ã‚¯ 1 ã®åˆ†æ"ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¿½åŠ ã•ã‚Œã‚‹
  - "## ãƒãƒ£ãƒ³ã‚¯ 2 ã®åˆ†æ"ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¿½åŠ ã•ã‚Œã‚‹
  - å„åˆ†æãŒ"\n\n"ã§åŒºåˆ‡ã‚‰ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜analysesãƒªã‚¹ãƒˆ

#### 2.5.3 format_chunk_analyses_å¢ƒç•Œå€¤_ç©ºãƒªã‚¹ãƒˆ

- **ç›®çš„**: åˆ†æçµæœãŒç©ºã®å ´åˆã€ç©ºæ–‡å­—åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `analyses = []`
- **æœŸå¾…çµæœ**: `""`ï¼ˆç©ºæ–‡å­—åˆ—ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ç©ºãƒªã‚¹ãƒˆ

#### 2.5.4 format_file_list_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  files = [
    FileChange(filename="src/main.py", status="modified", additions=10, deletions=5),
    FileChange(filename="src/utils.py", status="added", additions=50, deletions=0)
  ]
  ```
- **æœŸå¾…çµæœ**:
  - "## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«"ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã‚‹
  - "- ğŸ“ `src/main.py` (+10 -5)"ãŒå«ã¾ã‚Œã‚‹
  - "- âœ¨ `src/utils.py` (+50 -0)"ãŒå«ã¾ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜filesãƒªã‚¹ãƒˆ

#### 2.5.5 format_skipped_files_info_æ­£å¸¸ç³»

- **ç›®çš„**: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  skipped_files = [
    FileChange(filename="large_file.txt"),
    FileChange(filename="another_large.txt")
  ]
  reason = "ã‚µã‚¤ã‚ºåˆ¶é™"
  ```
- **æœŸå¾…çµæœ**:
  - "## âš ï¸ ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« (ã‚µã‚¤ã‚ºåˆ¶é™)"ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã‚‹
  - "- `large_file.txt`"ãŒå«ã¾ã‚Œã‚‹
  - "- `another_large.txt`"ãŒå«ã¾ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜skipped_filesã€reason

#### 2.5.6 format_skipped_files_info_å¢ƒç•Œå€¤_ç©ºãƒªã‚¹ãƒˆ

- **ç›®çš„**: ã‚¹ã‚­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã®å ´åˆã€ç©ºæ–‡å­—åˆ—ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `skipped_files = []`
- **æœŸå¾…çµæœ**: `""`ï¼ˆç©ºæ–‡å­—åˆ—ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ç©ºãƒªã‚¹ãƒˆ

#### 2.5.7 format_final_comment_æ­£å¸¸ç³»

- **ç›®çš„**: æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: CommentFormatterã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  summary = "This PR adds a new feature."
  chunk_analyses = ["Analysis 1", "Analysis 2"]
  files = [FileChange(filename="src/main.py", status="modified", additions=10, deletions=5)]
  skipped_files = []
  ```
- **æœŸå¾…çµæœ**:
  - "# å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼"ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã‚‹
  - ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹
  - ãƒãƒ£ãƒ³ã‚¯åˆ†æãŒå«ã¾ã‚Œã‚‹
  - ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### 2.6 openai_integration.py

#### 2.6.1 OpenAIIntegration_åˆæœŸåŒ–_æ­£å¸¸ç³»

- **ç›®çš„**: OpenAIIntegrationãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ç’°å¢ƒå¤‰æ•°`OPENAI_API_KEY`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  prompt_manager = PromptTemplateManager()
  token_estimator = TokenEstimator()
  ```
- **æœŸå¾…çµæœ**:
  - `self.client`ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹
  - `self.model`ãŒè¨­å®šã•ã‚Œã‚‹
  - `self.usage_stats`ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸPromptTemplateManagerã€TokenEstimator

#### 2.6.2 OpenAIIntegration_åˆæœŸåŒ–_ç•°å¸¸ç³»_APIã‚­ãƒ¼æ¬ æ

- **ç›®çš„**: APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ç’°å¢ƒå¤‰æ•°`OPENAI_API_KEY`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
- **å…¥åŠ›**: `PromptTemplateManager()`
- **æœŸå¾…çµæœ**: `ValueError("Missing required environment variable: OPENAI_API_KEY")`ãŒç™ºç”Ÿ
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãªã—

#### 2.6.3 analyze_chunk_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: ãƒãƒ£ãƒ³ã‚¯åˆ†æãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆAPIå‘¼ã³å‡ºã—ã¯ãƒ¢ãƒƒã‚¯ï¼‰
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  chunk = [FileChange(filename="src/main.py", additions=10, deletions=5)]
  chunk_index = 1
  ```
- **æœŸå¾…çµæœ**:
  - ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸAPIå¿œç­”ãŒè¿”ã•ã‚Œã‚‹
  - `_call_openai_api`ãŒ1å›å‘¼ã°ã‚Œã‚‹
  - ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜chunkã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸOpenAIãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.4 generate_summary_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: ã‚µãƒãƒªãƒ¼ç”ŸæˆãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆAPIå‘¼ã³å‡ºã—ã¯ãƒ¢ãƒƒã‚¯ï¼‰
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `chunk_analyses = ["Analysis 1", "Analysis 2"]`
- **æœŸå¾…çµæœ**:
  - ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸã‚µãƒãƒªãƒ¼ãŒè¿”ã•ã‚Œã‚‹
  - `_call_openai_api`ãŒ1å›å‘¼ã°ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜chunk_analysesã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.5 generate_title_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: ã‚¿ã‚¤ãƒˆãƒ«ç”ŸæˆãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆAPIå‘¼ã³å‡ºã—ã¯ãƒ¢ãƒƒã‚¯ï¼‰
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `summary = "This PR adds a new feature."`
- **æœŸå¾…çµæœ**:
  - ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ãŒè¿”ã•ã‚Œã‚‹
  - `_call_openai_api`ãŒ1å›å‘¼ã°ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜summaryã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.6 _call_openai_api_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: OpenAI APIå‘¼ã³å‡ºã—ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `prompt = "Test prompt"`
- **æœŸå¾…çµæœ**:
  - ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹
  - ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜promptã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.7 _call_openai_api_ç•°å¸¸ç³»_ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼æ™‚ã«è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `prompt = "Test prompt"`
- **æœŸå¾…çµæœ**:
  - 1å›ç›®: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
  - 2å›ç›®: æˆåŠŸï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
  - `usage_stats['retries'] == 1`
  - ãƒãƒƒã‚¯ã‚ªãƒ•æ™‚é–“ãŒçµŒéã™ã‚‹ï¼ˆ`time.sleep`ãŒå‘¼ã°ã‚Œã‚‹ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜promptã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼/æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.8 _call_openai_api_ç•°å¸¸ç³»_æœ€å¤§ãƒªãƒˆãƒ©ã‚¤è¶…éï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¶…ãˆãŸå ´åˆã€ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: `prompt = "Test prompt"`
- **æœŸå¾…çµæœ**:
  - 5å›ã™ã¹ã¦ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
  - `Exception("Max retries (5) exceeded")`ãŒç™ºç”Ÿ
  - `usage_stats['retries'] == 5`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜promptã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.9 _record_token_usage_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: OpenAIIntegrationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  ```python
  response = Mock(usage=Mock(prompt_tokens=100, completion_tokens=50))
  ```
- **æœŸå¾…çµæœ**:
  - `usage_stats['prompt_tokens'] == 100`
  - `usage_stats['completion_tokens'] == 50`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.6.10 get_usage_stats_æ­£å¸¸ç³»

- **ç›®çš„**: ä½¿ç”¨çµ±è¨ˆãŒæ­£ã—ãå–å¾—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**: ãªã—
- **æœŸå¾…çµæœ**:
  ```python
  {
    'prompt_tokens': 100,
    'completion_tokens': 50,
    'total_tokens': 150,
    'retries': 0,
    'skipped_files': 0
  }
  ```
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: äº‹å‰ã«è¨˜éŒ²ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡

### 2.7 generator.py

#### 2.7.1 PRCommentGenerator_åˆæœŸåŒ–_æ­£å¸¸ç³»

- **ç›®çš„**: PRCommentGeneratorãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**: `template_dir = "templates"`
- **æœŸå¾…çµæœ**:
  - ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆstatisticsã€formatterã€openai_integrationï¼‰ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹
  - `self.logger`ãŒè¨­å®šã•ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

#### 2.7.2 generate_comment_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã‚¿ã‚¤ãƒˆãƒ«ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã€ãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
- **å‰ææ¡ä»¶**: PRCommentGeneratorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **å…¥åŠ›**:
  - `pr_info_path = "test_pr_info.json"`
  - `diff_file_path = "test_diff.json"`
- **æœŸå¾…çµæœ**:
  - `(comment, title, metadata)`ã‚¿ãƒ—ãƒ«ãŒè¿”ã•ã‚Œã‚‹
  - `comment`ãŒç©ºã§ãªã„
  - `title`ãŒç©ºã§ãªã„
  - `metadata['pr_number'] == 123`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸPRæƒ…å ±ã€Diffãƒ•ã‚¡ã‚¤ãƒ«ã€OpenAI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### 2.7.3 _load_and_validate_data_æ­£å¸¸ç³»

- **ç›®çš„**: PRæƒ…å ±ã¨Diffãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  - `pr_info_path = "test_pr_info.json"`
  - `diff_file_path = "test_diff.json"`
- **æœŸå¾…çµæœ**:
  - `(pr_info, files)`ã‚¿ãƒ—ãƒ«ãŒè¿”ã•ã‚Œã‚‹
  - `pr_info.number == 123`
  - `len(files) > 0`
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«

#### 2.7.4 _load_and_validate_data_ç•°å¸¸ç³»_ãƒ•ã‚¡ã‚¤ãƒ«ä¸åœ¨

- **ç›®çš„**: JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
- **å…¥åŠ›**: `pr_info_path = "nonexistent.json"`
- **æœŸå¾…çµæœ**: `FileNotFoundError`ãŒç™ºç”Ÿ
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãªã—

#### 2.7.5 _preprocess_file_changes_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ãŒæ­£ã—ãå‰å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  ```python
  files = [
    FileChange(changes=100),
    FileChange(changes=2000),  # ã‚¹ã‚­ãƒƒãƒ—å¯¾è±¡
    FileChange(changes=50)
  ]
  ```
- **æœŸå¾…çµæœ**:
  - `processed`ã«2ãƒ•ã‚¡ã‚¤ãƒ«
  - `skipped`ã«1ãƒ•ã‚¡ã‚¤ãƒ«
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜filesãƒªã‚¹ãƒˆ

#### 2.7.6 _should_skip_file_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®šãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: FileChangeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**: `file = FileChange(changes=2000)`
- **æœŸå¾…çµæœ**: `True`ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã™ã¹ãï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜file

#### 2.7.7 _should_skip_file_å¢ƒç•Œå€¤_ã¡ã‚‡ã†ã©1000è¡Œ

- **ç›®çš„**: å¢ƒç•Œå€¤ï¼ˆ1000è¡Œï¼‰ã®ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®šãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: FileChangeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**: `file = FileChange(changes=1000)`
- **æœŸå¾…çµæœ**: `False`ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ï¼‰
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜file

#### 2.7.8 _split_into_chunks_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ããƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  ```python
  files = [FileChange() for _ in range(10)]
  chunk_size = 3
  ```
- **æœŸå¾…çµæœ**:
  - ãƒãƒ£ãƒ³ã‚¯æ•° = 4ï¼ˆ3, 3, 3, 1ï¼‰
  - å„ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒæ­£ã—ã„
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜filesã€chunk_size

#### 2.7.9 _perform_chunk_analyses_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: å„ãƒãƒ£ãƒ³ã‚¯ãŒæ­£ã—ãåˆ†æã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãƒãƒ£ãƒ³ã‚¯ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  ```python
  chunks = [
    [FileChange()],
    [FileChange()]
  ]
  ```
- **æœŸå¾…çµæœ**:
  - `analyses`ã«2ã¤ã®åˆ†æçµæœ
  - `openai_integration.analyze_chunk`ãŒ2å›å‘¼ã°ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜chunksã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸAPIå¿œç­”

#### 2.7.10 _generate_summary_and_title_æ­£å¸¸ç³»ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

- **ç›®çš„**: ã‚µãƒãƒªãƒ¼ã¨ã‚¿ã‚¤ãƒˆãƒ«ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãƒãƒ£ãƒ³ã‚¯åˆ†æçµæœãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**: `chunk_analyses = ["Analysis 1", "Analysis 2"]`
- **æœŸå¾…çµæœ**:
  - `(summary, title)`ã‚¿ãƒ—ãƒ«ãŒè¿”ã•ã‚Œã‚‹
  - `summary`ãŒç©ºã§ãªã„
  - `title`ãŒç©ºã§ãªã„
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜chunk_analysesã€ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸAPIå¿œç­”

#### 2.7.11 _build_metadata_æ­£å¸¸ç³»

- **ç›®çš„**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãæ§‹ç¯‰ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: å„ç¨®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹
- **å…¥åŠ›**:
  ```python
  pr_info = PRInfo(number=123)
  processed_files = [FileChange() for _ in range(5)]
  skipped_files = [FileChange()]
  start_time = time.time() - 10  # 10ç§’å‰
  ```
- **æœŸå¾…çµæœ**:
  ```python
  {
    'pr_number': 123,
    'file_count': 6,
    'processed_file_count': 5,
    'skipped_file_count': 1,
    'execution_time_seconds': 10å‰å¾Œ,
    'usage': {...},
    'statistics': {...}
  }
  ```
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ä¸Šè¨˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### 2.8 __init__.pyï¼ˆFacadeï¼‰

#### 2.8.1 Facade_éæ¨å¥¨è­¦å‘Š_è¡¨ç¤º

- **ç›®çš„**: æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ä½¿ç”¨æ™‚ã«éæ¨å¥¨è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãªã—
- **å…¥åŠ›**: `from pr_comment_generator import PRCommentGenerator`
- **æœŸå¾…çµæœ**:
  - `DeprecationWarning`ãŒç™ºç”Ÿ
  - è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ–°ã—ã„ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒå«ã¾ã‚Œã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãªã—

#### 2.8.2 Facade_å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ_æ­£å¸¸å‹•ä½œ

- **ç›®çš„**: æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã§å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**: ãªã—
- **å…¥åŠ›**: `from pr_comment_generator import PRCommentGenerator`
- **æœŸå¾…çµæœ**:
  - `PRCommentGenerator`ã‚¯ãƒ©ã‚¹ãŒå–å¾—ã§ãã‚‹
  - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ãŒå¯èƒ½
  - `generate_comment`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã›ã‚‹
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸPRæƒ…å ±

---

## 3. Integrationãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 3.1 Generator â†” Statistics é€£æº

#### ã‚·ãƒŠãƒªã‚ªå: ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºè¨ˆç®—ã¨çµ±è¨ˆæƒ…å ±ã®é€£æº

- **ç›®çš„**: PRCommentGeneratorãŒPRCommentStatisticsã‚’æ­£ã—ãå‘¼ã³å‡ºã—ã€æœ€é©ãªãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã‚’å–å¾—ã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**:
  - PRCommentGeneratorã¨PRCommentStatisticsãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
  - ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `PRCommentGenerator`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  2. `_preprocess_file_changes`ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰å‡¦ç†
  3. `statistics.calculate_optimal_chunk_size`ã‚’å‘¼ã³å‡ºã™
  4. è¿”ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã§`_split_into_chunks`ã‚’å®Ÿè¡Œ
- **æœŸå¾…çµæœ**:
  - ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒ1ä»¥ä¸Š
  - å„ãƒãƒ£ãƒ³ã‚¯ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒmax_tokensä»¥ä¸‹ï¼ˆ`statistics.estimate_chunk_tokens`ã§æ¤œè¨¼ï¼‰
  - ãƒ­ã‚°ã«"Calculated optimal chunk size"ãŒå‡ºåŠ›ã•ã‚Œã‚‹
- **ç¢ºèªé …ç›®**:
  - [ ] `calculate_optimal_chunk_size`ãŒæ­£ã—ãå‘¼ã°ã‚Œã‚‹
  - [ ] ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒå¦¥å½“ãªç¯„å›²
  - [ ] ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã‚‹

### 3.2 Generator â†” Formatter é€£æº

#### ã‚·ãƒŠãƒªã‚ªå: ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†ã®é€£æº

- **ç›®çš„**: PRCommentGeneratorãŒCommentFormatterã‚’æ­£ã—ãå‘¼ã³å‡ºã—ã€æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**:
  - PRCommentGeneratorã¨CommentFormatterãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
  - ãƒãƒ£ãƒ³ã‚¯åˆ†æçµæœãŒå­˜åœ¨ã™ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `PRCommentGenerator`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  2. ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯åˆ†æçµæœã‚’ç”¨æ„
  3. `formatter.format_final_comment`ã‚’å‘¼ã³å‡ºã™
  4. è¿”ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œè¨¼
- **æœŸå¾…çµæœ**:
  - ã‚³ãƒ¡ãƒ³ãƒˆã«Markdownãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ"# å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼"ï¼‰ãŒå«ã¾ã‚Œã‚‹
  - ãƒãƒ£ãƒ³ã‚¯åˆ†æãŒæ­£ã—ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹
  - ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹
  - ã‚¹ã‚­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- **ç¢ºèªé …ç›®**:
  - [ ] `format_final_comment`ãŒæ­£ã—ãå‘¼ã°ã‚Œã‚‹
  - [ ] Markdownå½¢å¼ãŒæ­£ã—ã„
  - [ ] ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã‚‹

### 3.3 Generator â†” OpenAIIntegration é€£æº

#### ã‚·ãƒŠãƒªã‚ªå: ãƒãƒ£ãƒ³ã‚¯åˆ†æã¨OpenAI APIå‘¼ã³å‡ºã—ã®é€£æº

- **ç›®çš„**: PRCommentGeneratorãŒOpenAIIntegrationã‚’æ­£ã—ãå‘¼ã³å‡ºã—ã€ãƒãƒ£ãƒ³ã‚¯åˆ†æã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
- **å‰ææ¡ä»¶**:
  - PRCommentGeneratorã¨OpenAIIntegrationãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
  - OpenAI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒ¢ãƒƒã‚¯åŒ–ã•ã‚Œã¦ã„ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `PRCommentGenerator`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  2. ãƒ†ã‚¹ãƒˆç”¨ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ç”¨æ„
  3. `_perform_chunk_analyses`ã‚’å‘¼ã³å‡ºã™
  4. ãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸAPIå¿œç­”ã‚’æ¤œè¨¼
- **æœŸå¾…çµæœ**:
  - å„ãƒãƒ£ãƒ³ã‚¯ã«å¯¾ã—ã¦`openai_integration.analyze_chunk`ãŒå‘¼ã°ã‚Œã‚‹
  - åˆ†æçµæœã®ãƒªã‚¹ãƒˆãŒè¿”ã•ã‚Œã‚‹
  - ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- **ç¢ºèªé …ç›®**:
  - [ ] `analyze_chunk`ãŒæ­£ã—ãå‘¼ã°ã‚Œã‚‹
  - [ ] ãƒãƒ£ãƒ³ã‚¯æ•°ã¨åˆ†æçµæœæ•°ãŒä¸€è‡´
  - [ ] ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒ0ã‚ˆã‚Šå¤§ãã„

### 3.4 OpenAIIntegration â†” PromptTemplateManager é€£æº

#### ã‚·ãƒŠãƒªã‚ªå: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ã®é€£æº

- **ç›®çš„**: OpenAIIntegrationãŒPromptTemplateManagerã‚’æ­£ã—ãå‘¼ã³å‡ºã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**:
  - OpenAIIntegrationã¨PromptTemplateManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
  - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `OpenAIIntegration`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  2. `_build_chunk_analysis_prompt`ã‚’å‘¼ã³å‡ºã™
  3. è¿”ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ¤œè¨¼
- **æœŸå¾…çµæœ**:
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†…å®¹ãŒå«ã¾ã‚Œã‚‹
  - ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ãŒæ­£ã—ãåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ãªã„
- **ç¢ºèªé …ç›®**:
  - [ ] `prompt_manager.get_chunk_analysis_prompt`ãŒå‘¼ã°ã‚Œã‚‹
  - [ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ãŒå«ã¾ã‚Œã‚‹

### 3.5 OpenAIIntegration â†” TokenEstimator é€£æº

#### ã‚·ãƒŠãƒªã‚ªå: ãƒˆãƒ¼ã‚¯ãƒ³æ¨å®šã¨APIå‘¼ã³å‡ºã—ã®é€£æº

- **ç›®çš„**: OpenAIIntegrationãŒTokenEstimatorã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æ¨å®šã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**:
  - OpenAIIntegrationã¨TokenEstimatorãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `OpenAIIntegration`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  2. é•·ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
  3. `token_estimator.estimate_tokens`ã§ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’æ¨å®š
  4. å¿…è¦ã«å¿œã˜ã¦`token_estimator.truncate_text`ã§åˆ‡ã‚Šè©°ã‚
- **æœŸå¾…çµæœ**:
  - ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒæ­£ã—ãæ¨å®šã•ã‚Œã‚‹
  - åˆ‡ã‚Šè©°ã‚å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆãŒmax_tokensä»¥ä¸‹
- **ç¢ºèªé …ç›®**:
  - [ ] `estimate_tokens`ãŒæ­£ã—ãå‘¼ã°ã‚Œã‚‹
  - [ ] åˆ‡ã‚Šè©°ã‚ãŒå¿…è¦ãªå ´åˆã€`truncate_text`ãŒå‘¼ã°ã‚Œã‚‹

### 3.6 ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

#### ã‚·ãƒŠãƒªã‚ªå: PRæƒ…å ±ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã¾ã§ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼

- **ç›®çš„**: ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒé€£æºã—ã¦ã€PRæƒ…å ±ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**:
  - ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
  - OpenAI APIãŒãƒ¢ãƒƒã‚¯åŒ–ã•ã‚Œã¦ã„ã‚‹
  - ãƒ†ã‚¹ãƒˆç”¨ã®PRæƒ…å ±ã¨Diffãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `PRCommentGenerator`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  2. ãƒ†ã‚¹ãƒˆç”¨ã®PRæƒ…å ±JSONã¨Diff JSONã‚’ç”¨æ„
  3. `generate_comment(pr_info_path, diff_file_path)`ã‚’å‘¼ã³å‡ºã™
  4. è¿”ã•ã‚ŒãŸ`(comment, title, metadata)`ã‚’æ¤œè¨¼
- **æœŸå¾…çµæœ**:
  - `comment`ãŒä»¥ä¸‹ã‚’å«ã‚€:
    - "# å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼"
    - ãƒãƒ£ãƒ³ã‚¯åˆ†æçµæœ
    - ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
  - `title`ãŒç©ºã§ãªã„
  - `metadata`ã«ä»¥ä¸‹ãŒå«ã¾ã‚Œã‚‹:
    - `pr_number`
    - `file_count`
    - `execution_time_seconds`
    - `usage`ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ï¼‰
- **ç¢ºèªé …ç›®**:
  - [ ] PRæƒ…å ±ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹
  - [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãå‰å‡¦ç†ã•ã‚Œã‚‹
  - [ ] ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒè¨ˆç®—ã•ã‚Œã‚‹
  - [ ] å„ãƒãƒ£ãƒ³ã‚¯ãŒåˆ†æã•ã‚Œã‚‹
  - [ ] ã‚µãƒãƒªãƒ¼ã¨ã‚¿ã‚¤ãƒˆãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹
  - [ ] æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹
  - [ ] ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ§‹ç¯‰ã•ã‚Œã‚‹
  - [ ] OpenAI APIå‘¼ã³å‡ºã—å›æ•°ãŒé©åˆ‡ï¼ˆãƒãƒ£ãƒ³ã‚¯æ•° + 2ï¼ˆã‚µãƒãƒªãƒ¼ã€ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ï¼‰

### 3.7 äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ªå: æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‹ã‚‰ã®å®Ÿè¡Œ

- **ç›®çš„**: æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ï¼ˆ`from pr_comment_generator import PRCommentGenerator`ï¼‰ã§ã‚‚æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
- **å‰ææ¡ä»¶**:
  - FacadeãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
  - éæ¨å¥¨è­¦å‘ŠãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- **ãƒ†ã‚¹ãƒˆæ‰‹é †**:
  1. `from pr_comment_generator import PRCommentGenerator`ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  2. éæ¨å¥¨è­¦å‘ŠãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  3. `PRCommentGenerator`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
  4. `generate_comment`ã‚’å‘¼ã³å‡ºã™
  5. æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- **æœŸå¾…çµæœ**:
  - éæ¨å¥¨è­¦å‘ŠãŒæ¨™æº–ã‚¨ãƒ©ãƒ¼ã«å‡ºåŠ›ã•ã‚Œã‚‹
  - è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ–°ã—ã„ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒå«ã¾ã‚Œã‚‹
  - `generate_comment`ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
  - æ–°ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã¨åŒã˜çµæœãŒå¾—ã‚‰ã‚Œã‚‹
- **ç¢ºèªé …ç›®**:
  - [ ] `DeprecationWarning`ãŒç™ºç”Ÿ
  - [ ] è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡
  - [ ] æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã§æ­£å¸¸å‹•ä½œ
  - [ ] æ–°æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã§çµæœãŒåŒä¸€

---

## 4. BDDã‚·ãƒŠãƒªã‚ª

### 4.1 Feature: PRã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½

**èƒŒæ™¯**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Pull Requestã®å¤‰æ›´å†…å®¹ã‚’è‡ªå‹•çš„ã«åˆ†æã—ã€
ã‚ã‹ã‚Šã‚„ã™ã„ã‚³ãƒ¡ãƒ³ãƒˆã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã—ãŸã„ã€‚
```

#### Scenario 4.1.1: å°è¦æ¨¡PRã®ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ

```gherkin
Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã‚‹
  And PRæƒ…å ±ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã‚‹:
    | field       | value              |
    | number      | 123                |
    | title       | Add new feature    |
    | author      | testuser           |
  And å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã¯3å€‹ã§ã€åˆè¨ˆ100è¡Œã®å¤‰æ›´ã§ã‚ã‚‹
  And OpenAI APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
  And ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®å¼•æ•°ã§å‘¼ã°ã‚Œã‚‹:
    """
    python pr_comment_generator.py \
      --pr-info test_pr_info.json \
      --pr-diff test_diff.json \
      --output output.json
    """

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚‹ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰0ï¼‰
  And å‡ºåŠ›JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹
  And å‡ºåŠ›JSONã«ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã‚‹:
    | field            | type   |
    | comment          | string |
    | suggested_title  | string |
    | pr_number        | number |
    | execution_time_seconds | number |
  And ã‚³ãƒ¡ãƒ³ãƒˆã«"# å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼"ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã‚‹
  And ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹
  And suggested_titleãŒç©ºã§ãªã„
  And å®Ÿè¡Œæ™‚é–“ãŒ60ç§’ä»¥å†…ã§ã‚ã‚‹
```

#### Scenario 4.1.2: å¤§è¦æ¨¡PRã®ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ï¼‰

```gherkin
Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã‚‹
  And PRæƒ…å ±ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã‚‹:
    | field       | value                     |
    | number      | 456                       |
    | title       | Major refactoring         |
    | author      | developer                 |
  And å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã¯50å€‹ã§ã€åˆè¨ˆ5000è¡Œã®å¤‰æ›´ã§ã‚ã‚‹
  And ä¸€éƒ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯1000è¡Œã‚’è¶…ãˆã‚‹å¤‰æ›´ãŒã‚ã‚‹
  And OpenAI APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚‹ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰0ï¼‰
  And ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¤‡æ•°ã®ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã•ã‚Œã‚‹
  And å„ãƒãƒ£ãƒ³ã‚¯ãŒå€‹åˆ¥ã«åˆ†æã•ã‚Œã‚‹
  And ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ãŒã‚³ãƒ¡ãƒ³ãƒˆã«å«ã¾ã‚Œã‚‹
  And ã‚³ãƒ¡ãƒ³ãƒˆã«"## ãƒãƒ£ãƒ³ã‚¯ X ã®åˆ†æ"ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¤‡æ•°å«ã¾ã‚Œã‚‹
  And ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«skipped_file_countãŒå«ã¾ã‚Œã‚‹
  And skipped_file_count > 0ã§ã‚ã‚‹
```

#### Scenario 4.1.3: API ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤

```gherkin
Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã‚‹
  And OpenAI APIãŒãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã‚’1å›è¿”ã™
  And 2å›ç›®ã®å‘¼ã³å‡ºã—ã§ã¯æˆåŠŸã™ã‚‹
  And OpenAI APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚‹ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰0ï¼‰
  And ãƒ­ã‚°ã«"Rate limit error"è­¦å‘ŠãŒå«ã¾ã‚Œã‚‹
  And ãƒ­ã‚°ã«"Retrying in X seconds"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã‚‹
  And OpenAI APIãŒ2å›å‘¼ã°ã‚Œã‚‹
  And æœ€çµ‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹
  And ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®retries > 0ã§ã‚ã‚‹
```

#### Scenario 4.1.4: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨çµæœã®ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰

```gherkin
Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã‚‹
  And ç’°å¢ƒå¤‰æ•°SAVE_PROMPTSãŒtrueã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
  And ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒ/promptsã§ã‚ã‚‹
  And OpenAI APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚‹ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰0ï¼‰
  And /promptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹
  And /promptsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹
  And ãƒ­ã‚°ã«"Saved prompt and result"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã‚‹
```

#### Scenario 4.1.5: APIã‚­ãƒ¼æœªè¨­å®šæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```gherkin
Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã‚‹
  And ç’°å¢ƒå¤‰æ•°OPENAI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒPRã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã™ã‚‹ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰1ï¼‰
  And ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«"Missing required environment variable: OPENAI_API_KEY"ãŒå«ã¾ã‚Œã‚‹
  And ãƒ­ã‚°ã«ERRORãƒ¬ãƒ™ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã‚‹
```

### 4.2 Feature: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²å¾Œã®äº’æ›æ€§ç¶­æŒ

#### Scenario 4.2.1: æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã§ã®å®Ÿè¡Œ

```gherkin
Given æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
  And ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ãŒå«ã¾ã‚Œã‚‹:
    """
    from pr_comment_generator import PRCommentGenerator
    """
  And PRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹

When æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
  And æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«éæ¨å¥¨è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹
  And è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ–°ã—ã„ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒå«ã¾ã‚Œã‚‹:
    """
    from pr_comment_generator.generator import PRCommentGenerator
    """
  And PRã‚³ãƒ¡ãƒ³ãƒˆãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹
```

#### Scenario 4.2.2: æ–°ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã§ã®å®Ÿè¡Œ

```gherkin
Given ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
  And ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ãŒå«ã¾ã‚Œã‚‹:
    """
    from pr_comment_generator.generator import PRCommentGenerator
    from pr_comment_generator.models import PRInfo, FileChange
    """
  And PRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹

When æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

Then ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
  And éæ¨å¥¨è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œãªã„
  And PRComãƒ¡ãƒ³ãƒˆãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹
  And æ–°æ—§ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã§åŒã˜çµæœãŒå¾—ã‚‰ã‚Œã‚‹
```

### 4.3 Feature: Jenkinsfileã‹ã‚‰ã®å®Ÿè¡Œ

#### Scenario 4.3.1: Jenkins ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®å®Ÿè¡Œ

```gherkin
Given JenkinsfileãŒä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹:
  """
  python pr_comment_generator.py \
    --pr-info ${PR_INFO_FILE} \
    --pr-diff ${DIFF_FILE} \
    --output ${OUTPUT_FILE} \
    --template-dir templates \
    --log-level INFO
  """
  And Jenkinsç’°å¢ƒã§ç’°å¢ƒå¤‰æ•°OPENAI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
  And PRæƒ…å ±ã¨Diffãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

When Jenkinsãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹

Then ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹
  And å‡ºåŠ›JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹
  And Jenkinsãƒ­ã‚°ã«"Comment generation completed"ãŒå«ã¾ã‚Œã‚‹
  And å‡ºåŠ›JSONã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã‚¿ã‚¤ãƒˆãƒ«ãŒå«ã¾ã‚Œã‚‹
  And Jenkinsç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹
```

### 4.4 Feature: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®é”æˆ

#### Scenario 4.4.1: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```gherkin
Given ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
  And pytest-covãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹:
  """
  pytest tests/unit --cov=pr_comment_generator --cov-report=term
  """

Then ã™ã¹ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
  And ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Šã§ã‚ã‚‹
  And ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
  And å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Šã§ã‚ã‚‹
```

#### Scenario 4.4.2: çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```gherkin
Given ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
  And OpenAI APIãŒãƒ¢ãƒƒã‚¯åŒ–ã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹:
  """
  pytest tests/integration
  """

Then ã™ã¹ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
  And ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºãŒæ­£ã—ãå‹•ä½œã™ã‚‹
  And äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
```

#### Scenario 4.4.3: BDDãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```gherkin
Given ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«BDDãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

When ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹:
  """
  pytest tests/bdd
  """

Then ã™ã¹ã¦ã®BDDãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
  And ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¬ãƒ™ãƒ«ã®è¦ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹
```

---

## 5. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

### 5.1 æ­£å¸¸ãƒ‡ãƒ¼ã‚¿

#### 5.1.1 PRæƒ…å ±JSONï¼ˆå°è¦æ¨¡PRï¼‰

```json
{
  "title": "Add new feature",
  "number": 123,
  "body": "This PR adds a new feature to the system.",
  "user": {
    "login": "testuser"
  },
  "base": {
    "ref": "main",
    "sha": "abc123def456"
  },
  "head": {
    "ref": "feature-branch",
    "sha": "def456abc123"
  }
}
```

#### 5.1.2 Diff JSONï¼ˆå°è¦æ¨¡PRï¼‰

```json
[
  {
    "filename": "src/main.py",
    "status": "modified",
    "additions": 10,
    "deletions": 5,
    "changes": 15,
    "patch": "@@ -1,3 +1,4 @@\n import sys\n+import os\n def main():\n     pass"
  },
  {
    "filename": "src/utils.py",
    "status": "added",
    "additions": 50,
    "deletions": 0,
    "changes": 50,
    "patch": "@@ -0,0 +1,50 @@\n+def helper():\n+    pass"
  },
  {
    "filename": "README.md",
    "status": "modified",
    "additions": 5,
    "deletions": 2,
    "changes": 7,
    "patch": "@@ -1,2 +1,5 @@\n # Project\n+## New Section"
  }
]
```

#### 5.1.3 PRæƒ…å ±JSONï¼ˆå¤§è¦æ¨¡PRï¼‰

```json
{
  "title": "Major refactoring",
  "number": 456,
  "body": "This PR refactors the entire codebase.",
  "user": {
    "login": "developer"
  },
  "base": {
    "ref": "develop",
    "sha": "xyz789"
  },
  "head": {
    "ref": "refactor-branch",
    "sha": "uvw012"
  }
}
```

#### 5.1.4 Diff JSONï¼ˆå¤§è¦æ¨¡PRã€50ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```json
[
  {
    "filename": "src/module1.py",
    "status": "modified",
    "additions": 500,
    "deletions": 300,
    "changes": 800,
    "patch": "... (çœç•¥: å¤§é‡ã®diff)"
  },
  {
    "filename": "src/module2.py",
    "status": "modified",
    "additions": 1200,
    "deletions": 800,
    "changes": 2000,
    "patch": "... (çœç•¥: å¤§é‡ã®diffã€ã‚¹ã‚­ãƒƒãƒ—å¯¾è±¡)"
  }
  // ... æ®‹ã‚Š48ãƒ•ã‚¡ã‚¤ãƒ«
]
```

### 5.2 ç•°å¸¸ãƒ‡ãƒ¼ã‚¿

#### 5.2.1 ä¸æ­£ãªJSONï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼‰

```json
{
  "title": "Invalid JSON"
  "number": 999
  // ã‚«ãƒ³ãƒæ¬ æ
}
```

#### 5.2.2 å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ æ

```json
{
  "body": "Missing title and number"
}
```

#### 5.2.3 ç©ºã®Diff

```json
[]
```

### 5.3 å¢ƒç•Œå€¤ãƒ‡ãƒ¼ã‚¿

#### 5.3.1 ã¡ã‚‡ã†ã©1000è¡Œå¤‰æ›´ã®ãƒ•ã‚¡ã‚¤ãƒ«

```json
{
  "filename": "boundary_file.py",
  "status": "modified",
  "additions": 500,
  "deletions": 500,
  "changes": 1000,
  "patch": "... (çœç•¥: 1000è¡Œåˆ†ã®diff)"
}
```

#### 5.3.2 0è¡Œå¤‰æ›´ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®ã¿ï¼‰

```json
{
  "filename": "renamed_file.py",
  "status": "renamed",
  "additions": 0,
  "deletions": 0,
  "changes": 0,
  "patch": null
}
```

### 5.4 ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆOpenAI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰

#### 5.4.1 ãƒãƒ£ãƒ³ã‚¯åˆ†æãƒ¬ã‚¹ãƒãƒ³ã‚¹

```python
{
  "id": "chatcmpl-123",
  "object": "chat.completion",
  "created": 1234567890,
  "model": "gpt-4-turbo",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "ã“ã®ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€main.pyã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ãŒè¿½åŠ ã•ã‚Œã€utils.pyã«æ–°ã—ã„ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 150,
    "completion_tokens": 50,
    "total_tokens": 200
  }
}
```

#### 5.4.2 ã‚µãƒãƒªãƒ¼ç”Ÿæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹

```python
{
  "id": "chatcmpl-456",
  "object": "chat.completion",
  "created": 1234567891,
  "model": "gpt-4-turbo",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "ã“ã®PRã¯ã€æ–°æ©Ÿèƒ½ã®è¿½åŠ ã¨ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚ä¸»ãªå¤‰æ›´ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n- main.pyã¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¿½åŠ \n- utils.pyã¸ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°è¿½åŠ \n- READMEã®æ›´æ–°"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 300,
    "completion_tokens": 80,
    "total_tokens": 380
  }
}
```

#### 5.4.3 ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹

```python
{
  "id": "chatcmpl-789",
  "object": "chat.completion",
  "created": 1234567892,
  "model": "gpt-4-turbo",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "æ–°æ©Ÿèƒ½è¿½åŠ ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®Ÿè£…"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 50,
    "completion_tokens": 10,
    "total_tokens": 60
  }
}
```

#### 5.4.4 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹

```python
{
  "error": {
    "message": "Rate limit exceeded. Please try again later.",
    "type": "rate_limit_error",
    "code": "rate_limit_exceeded"
  }
}
```

---

## 6. ãƒ†ã‚¹ãƒˆç’°å¢ƒè¦ä»¶

### 6.1 ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

**OS**: Amazon Linux 2023ï¼ˆã¾ãŸã¯äº’æ›ç’°å¢ƒï¼‰

**Python**: 3.8ä»¥ä¸Š

**å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**:
```
openai>=1.0.0
pytest>=7.0.0
pytest-cov>=4.0.0
pytest-mock>=3.10.0
responses>=0.23.0  # OpenAI APIã®ãƒ¢ãƒƒã‚¯ç”¨
```

**ç’°å¢ƒå¤‰æ•°**:
- `OPENAI_API_KEY`: OpenAI APIã‚­ãƒ¼ï¼ˆãƒ†ã‚¹ãƒˆæ™‚ã¯ãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
- `OPENAI_MODEL_NAME`: ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: gpt-4-turboï¼‰
- `SAVE_PROMPTS`: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰

### 6.2 CI/CDç’°å¢ƒï¼ˆJenkinsï¼‰

**Jenkinsç’°å¢ƒå¤‰æ•°**:
- `OPENAI_API_KEY`: SSMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
- `GITHUB_AUTH_METHOD`: GitHubèªè¨¼æ–¹æ³•
- `PR_INFO_FILE`: PRæƒ…å ±JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
- `DIFF_FILE`: Diff JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
- `OUTPUT_FILE`: å‡ºåŠ›JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

**å¿…è¦ãªJenkinsãƒ—ãƒ©ã‚°ã‚¤ãƒ³**:
- Pipeline
- GitHub Branch Source
- Credentials Binding

### 6.3 ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ãƒƒã‚¯/ã‚¹ã‚¿ãƒ–

**OpenAI APIã®ãƒ¢ãƒƒã‚¯**:
- `responses`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¢ãƒƒã‚¯
- `unittest.mock`ã‚’ä½¿ç”¨ã—ã¦OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ãƒ¢ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¢ãƒƒã‚¯**:
- `unittest.mock.mock_open`ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’ãƒ¢ãƒƒã‚¯
- `tempfile`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

**ãƒ­ã‚¬ãƒ¼ã®ãƒ¢ãƒƒã‚¯**:
- `unittest.mock.Mock`ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚¬ãƒ¼ã‚’ãƒ¢ãƒƒã‚¯
- ãƒ­ã‚°å‡ºåŠ›ã‚’æ¤œè¨¼å¯èƒ½ã«ã™ã‚‹

### 6.4 ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
tests/
â”œâ”€â”€ unit/                                    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_models.py
â”‚   â”œâ”€â”€ test_token_estimator.py
â”‚   â”œâ”€â”€ test_prompt_manager.py
â”‚   â”œâ”€â”€ test_statistics.py
â”‚   â”œâ”€â”€ test_formatter.py
â”‚   â”œâ”€â”€ test_openai_integration.py
â”‚   â””â”€â”€ test_generator.py
â”œâ”€â”€ integration/                             # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_generator_statistics.py
â”‚   â”œâ”€â”€ test_generator_formatter.py
â”‚   â”œâ”€â”€ test_generator_openai.py
â”‚   â””â”€â”€ test_compatibility_layer.py
â”œâ”€â”€ bdd/                                     # BDDãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ test_bdd_pr_comment_generation.py
â”œâ”€â”€ fixtures/                                # ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
â”‚   â”œâ”€â”€ pr_info_small.json
â”‚   â”œâ”€â”€ pr_info_large.json
â”‚   â”œâ”€â”€ diff_small.json
â”‚   â””â”€â”€ diff_large.json
â”œâ”€â”€ conftest.py                              # pytestå…±é€šè¨­å®š
â””â”€â”€ __init__.py
```

---

## 7. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨ˆç”»

### 7.1 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé †åº

1. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**ï¼ˆPhase 5-1ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤ï¼ˆmodels.pyï¼‰
   - ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å±¤ï¼ˆtoken_estimator.pyã€prompt_manager.pyï¼‰
   - çµ±è¨ˆãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå±¤ï¼ˆstatistics.pyã€formatter.pyï¼‰
   - APIçµ±åˆå±¤ï¼ˆopenai_integration.pyï¼‰
   - ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆgenerator.pyï¼‰

2. **çµ±åˆãƒ†ã‚¹ãƒˆ**ï¼ˆPhase 5-2ï¼‰
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æº
   - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰çµ±åˆ
   - äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼

3. **BDDãƒ†ã‚¹ãƒˆ**ï¼ˆPhase 5-3ï¼‰
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¬ãƒ™ãƒ«ã®ã‚·ãƒŠãƒªã‚ª

### 7.2 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

**ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ**:
```bash
pytest tests/ --cov=pr_comment_generator --cov-report=term --cov-report=html
```

**ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿**:
```bash
pytest tests/unit/ --cov=pr_comment_generator --cov-report=term
```

**çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿**:
```bash
pytest tests/integration/
```

**BDDãƒ†ã‚¹ãƒˆã®ã¿**:
```bash
pytest tests/bdd/
```

**ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ**:
```bash
pytest tests/unit/test_statistics.py -v
```

**ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šã‚’ç¢ºèª**:
```bash
pytest tests/ --cov=pr_comment_generator --cov-fail-under=80
```

### 7.3 ãƒ†ã‚¹ãƒˆåˆæ ¼åŸºæº–

**ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**:
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆ0 failedï¼‰
- [ ] å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Š
- [ ] å®Ÿè¡Œæ™‚é–“ãŒ5åˆ†ä»¥å†…

**çµ±åˆãƒ†ã‚¹ãƒˆ**:
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆ0 failedï¼‰
- [ ] ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºãŒæ­£ã—ãå‹•ä½œ
- [ ] äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
- [ ] å®Ÿè¡Œæ™‚é–“ãŒ10åˆ†ä»¥å†…

**BDDãƒ†ã‚¹ãƒˆ**:
- [ ] ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªãŒæˆåŠŸ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹
- [ ] å®Ÿè¡Œæ™‚é–“ãŒ10åˆ†ä»¥å†…

**å…¨ä½“**:
- [ ] ç·åˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Š
- [ ] å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆãŒ0ä»¶
- [ ] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ

---

## 8. å“è³ªã‚²ãƒ¼ãƒˆç¢ºèª

æœ¬ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã¯ã€Phase 3ã®å“è³ªã‚²ãƒ¼ãƒˆã‚’æº€ãŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸï¼š

- [x] **Phase 2ã®æˆ¦ç•¥ã«æ²¿ã£ãŸãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§ã‚ã‚‹**: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã€ŒALLã€ã«åŸºã¥ãã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆã€BDDãƒ†ã‚¹ãƒˆã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆ
- [x] **ä¸»è¦ãªæ­£å¸¸ç³»ãŒã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹**:
  - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã®æ­£å¸¸ç³»ï¼ˆè¨ˆ40+ã‚±ãƒ¼ã‚¹ï¼‰
  - çµ±åˆãƒ†ã‚¹ãƒˆ: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºã®æ­£å¸¸ãƒ•ãƒ­ãƒ¼ï¼ˆ7ã‚·ãƒŠãƒªã‚ªï¼‰
  - BDDãƒ†ã‚¹ãƒˆ: ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æ­£å¸¸ç³»ï¼ˆ11ã‚·ãƒŠãƒªã‚ªï¼‰
- [x] **ä¸»è¦ãªç•°å¸¸ç³»ãŒã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹**:
  - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: APIã‚­ãƒ¼æ¬ æã€ãƒ•ã‚¡ã‚¤ãƒ«ä¸åœ¨ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ç­‰ï¼ˆè¨ˆ10+ã‚±ãƒ¼ã‚¹ï¼‰
  - BDDãƒ†ã‚¹ãƒˆ: APIã‚­ãƒ¼æœªè¨­å®šæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç­‰ï¼ˆ2ã‚·ãƒŠãƒªã‚ªï¼‰
- [x] **æœŸå¾…çµæœãŒæ˜ç¢ºã§ã‚ã‚‹**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒ»ã‚·ãƒŠãƒªã‚ªã«å…·ä½“çš„ãªæœŸå¾…çµæœã‚’è¨˜è¼‰

---

## 9. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Phase 4ï¼ˆå®Ÿè£…ï¼‰ã®é–‹å§‹**: æœ¬ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã«åŸºã¥ãã€å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…ã‚’é–‹å§‹
2. **ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…**: Phase 5ã§ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã«åŸºã¥ã„ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…
3. **ç¶™ç¶šçš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼**: å®Ÿè£…ä¸­ã«ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®å¦¥å½“æ€§ã‚’ç¶™ç¶šçš„ã«æ¤œè¨¼ã—ã€å¿…è¦ã«å¿œã˜ã¦æ›´æ–°

---

## 10. æ‰¿èª

- **ä½œæˆè€…**: Claude Code
- **ä½œæˆæ—¥**: 2025å¹´1æœˆ
- **ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½å¾Œã«è¨˜è¼‰ï¼‰
- **æ‰¿èªæ—¥**: ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰¿èªå¾Œã«è¨˜è¼‰ï¼‰
