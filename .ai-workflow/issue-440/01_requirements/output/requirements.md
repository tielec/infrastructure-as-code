# 要件定義書 - Issue #440

## 0. Planning Documentの確認

Planning Phase（00_planning）で策定された開発計画を確認しました：

### 開発計画の全体像
- **実装戦略**: EXTEND - 既存の`component-arm.yml`と`component-x86.yml`にPullDockerImagesステップを追加
- **テスト戦略**: INTEGRATION_ONLY - AMIビルド実行とDockerイメージ存在確認の統合テスト
- **テストコード戦略**: CREATE_TEST - 新規にテストスクリプトを作成
- **見積もり工数**: 6~10時間
- **リスク評価**: 低（既存機能への影響なし、ロールバック容易）

### 主要な技術選定
- EC2 Image Builderの既存コンポーネント定義構造を踏襲
- ExecuteBashアクションでdocker pullコマンドを順次実行
- ARM64/x86_64両アーキテクチャで同一イメージリストを使用

### スケジュール概要
- Phase 1（要件定義）: 0.5~1h
- Phase 2（設計）: 1~1.5h
- Phase 3（テストシナリオ）: 0.5~1h
- Phase 4（実装）: 1~2h
- Phase 5（テストコード実装）: 1~1.5h
- Phase 6（テスト実行）: 3~5h
- Phase 7（ドキュメント）: 1~2h
- Phase 8（レポート）: 0.5~1h

この開発計画を踏まえて、以下の要件定義を実施します。

---

## 1. 概要

### 背景

Jenkins CI/CDパイプラインでは、現在12種類のDockerイメージを使用しています（`jenkins/DOCKER_IMAGES.md`に記載）。これらのイメージは、ジョブ実行時にDocker Hubから毎回プルされるため、以下の課題が発生しています：

1. **起動時間の遅延**: 小さいイメージ（130MB）で10-20秒、大きいイメージ（850MB）で1-2分のダウンロード時間が発生
2. **ネットワーク帯域の消費**: ジョブ実行ごとに数百MB〜数GBのダウンロードが発生
3. **安定性リスク**: Docker Hubのレート制限（匿名ユーザー: 6時間あたり100回）や一時的なネットワーク障害の影響を受ける

### 目的

Jenkins Agent AMIのビルド時に頻繁に使用されるDockerイメージを事前にプルし、AMI内にキャッシュとして格納します。これにより、ジョブ実行時のイメージプル時間を劇的に短縮し、パイプライン全体の高速化と安定性向上を実現します。

### ビジネス価値

1. **開発者の生産性向上**: ジョブ起動待ち時間が数十秒〜数分短縮され、開発サイクルが高速化
2. **インフラコスト削減**: ネットワーク帯域使用量の削減（ジョブ実行ごとのダウンロード不要）
3. **サービス信頼性向上**: Docker Hubの外部依存性を減らし、安定したCI/CD環境を提供

### 技術的価値

1. **パフォーマンス改善**: ジョブ起動時間が数十秒〜数分から数秒に短縮
2. **レート制限回避**: Docker Hubのレート制限を回避し、大規模並列実行時も安定動作
3. **オフライン動作**: ネットワーク障害時もキャッシュされたイメージで継続動作可能

---

## 2. 機能要件

### FR-1: Dockerイメージ事前プル機能（優先度: 高）

**要件**: EC2 Image BuilderのコンポーネントYAMLファイルに、Dockerイメージを事前にプルするステップを追加する。

**詳細**:
- `pulumi/jenkins-agent-ami/component-arm.yml` にPullDockerImagesステップを追加
- `pulumi/jenkins-agent-ami/component-x86.yml` にPullDockerImagesステップを追加
- 両ファイルで同一のイメージリストを使用
- EnableCloudWatchAgentステップの直後に挿入

**対象イメージ（12種類、合計約2.9GB）**:

| イメージ | タグ | サイズ（概算） | 使用箇所 |
|---------|------|--------------|----------|
| python | 3.11-slim | 130MB | diagram-generator, pull-request-comment-builder |
| node | 18-slim | 180MB | mermaid-generator |
| rust | 1.76-slim | 850MB | pr-complexity-analyzer |
| rust | slim | 850MB | (バックアップ用) |
| amazon/aws-cli | latest | 400MB | ssm-dashboard, pulumi-dashboard |
| pulumi/pulumi | latest | 100MB | pulumi-dashboard |
| ubuntu | 22.04 | 77MB | (汎用用途) |
| nikolaik/python-nodejs | python3.11-nodejs20 | 400MB | auto-insert-doxygen-comment, technical-docs-writer, etc. |

### FR-2: Docker Daemon起動確認（優先度: 高）

**要件**: Dockerイメージをプルする前に、Docker Daemonが正常に起動していることを確認する。

**詳細**:
- `systemctl start docker` でDockerサービスを起動
- 起動完了を待機（`sleep 5` または `systemctl is-active docker`）
- Docker Daemonが起動していない場合はステップを失敗させる

### FR-3: プル成功確認とログ出力（優先度: 中）

**要件**: Dockerイメージのプル成功を確認し、ビルドログに記録する。

**詳細**:
- 各イメージプル前にイメージ名をログ出力
- プル完了後に `docker images` でプルされたイメージ一覧を表示
- プル失敗時のエラーメッセージをログ出力（個別イメージの失敗でビルド全体を失敗させるかは設計フェーズで決定）

### FR-4: マルチアーキテクチャ対応（優先度: 高）

**要件**: ARM64（Graviton）とx86_64の両アーキテクチャでDockerイメージが正常に動作することを保証する。

**詳細**:
- すべてのイメージがマルチアーキテクチャ対応であることを事前確認
- アーキテクチャ固有のイメージが必要な場合は、component-arm.ymlとcomponent-x86.ymlで別のイメージを指定

### FR-5: AMIビルドプロセスへの統合（優先度: 高）

**要件**: 既存のAMIビルドプロセス（EC2 Image Builder）にシームレスに統合する。

**詳細**:
- 既存のコンポーネント定義構造（ExecuteBashアクション）を踏襲
- 他のステップ（InstallDocker、EnableCloudWatchAgentなど）との依存関係を考慮
- ビルド失敗時のロールバック戦略を明確化

---

## 3. 非機能要件

### NFR-1: パフォーマンス要件

- **ジョブ起動時間短縮**: 小さいイメージ（130MB）で10-20秒→1-2秒、大きいイメージ（850MB）で1-2分→1-2秒
- **AMIビルド時間増加**: 現在30-45分から+5-10分以内（合計35-50分以内）
- **ネットワーク帯域**: AMIビルド時の追加ダウンロード約3GB、ジョブ実行時のダウンロードはゼロ

### NFR-2: セキュリティ要件

- **イメージ検証**: Docker Hub公式イメージまたは信頼できるソースのイメージのみを使用
- **タグ管理**: `latest`タグは予期しない変更を引き起こす可能性があるため、可能な限りバージョン固定を推奨（例: `python:3.11-slim`は既にバージョン固定）
- **レート制限対策**: Docker Hub認証を使用してレート制限を緩和（200回/6時間）

### NFR-3: 可用性・信頼性要件

- **冪等性**: AMIビルドを複数回実行しても同じ結果を得られること
- **エラーハンドリング**: 一部イメージのプル失敗時の挙動を明確化（継続 or 停止）
- **ロールバック**: 変更前のAMIに簡単に戻せること

### NFR-4: 保守性・拡張性要件

- **イメージリスト管理**: 新しいイメージの追加・削除が容易であること
- **ドキュメント化**: プルされたイメージ一覧、AMIサイズ、ビルド時間をドキュメントに記載
- **モニタリング**: AMIビルドログでイメージプル状況を確認可能

---

## 4. 制約事項

### 技術的制約

1. **EC2 Image Builder制約**:
   - コンポーネント定義はYAML形式
   - ExecuteBashアクションでシェルコマンドを実行
   - ビルド環境はインターネット接続が必要

2. **Docker制約**:
   - Docker Hubのレート制限（匿名: 100回/6時間、認証済み: 200回/6時間）
   - マルチアーキテクチャ対応イメージの使用必須

3. **既存システム整合性**:
   - 既存のInstallDockerステップでDockerがインストール済み
   - EnableCloudWatchAgentステップの後に挿入

### リソース制約

1. **AMIサイズ**: 約2-3GB増加（EBSコスト: 約$0.24/月増加）
2. **ビルド時間**: +5-10分程度の増加（許容範囲: +10分以内）
3. **開発工数**: 6-10時間（Planning Documentより）

### ポリシー制約

1. **コーディング規約**: CLAUDE.mdに従う（日本語コメント、kebab-case命名など）
2. **セキュリティポリシー**: クレデンシャルのハードコーディング禁止
3. **ドキュメント更新**: `ansible/README.md`にAMI関連情報を追加

---

## 5. 前提条件

### システム環境

1. **EC2 Image Builder**: AWS環境でイメージビルドが実行可能
2. **Docker**: AMIビルド環境にDockerがインストール済み（InstallDockerステップ）
3. **インターネット接続**: AMIビルド時にDocker Hubへのアクセスが可能

### 依存コンポーネント

1. **pulumi/jenkins-agent-ami**: Pulumiスタックが正常にデプロイ可能
2. **InstallDockerステップ**: Dockerが事前にインストールされている
3. **SSMパラメータストア**: Docker Hub認証情報の保存（オプション）

### 外部システム連携

1. **Docker Hub**: イメージプル元（レート制限に注意）
2. **AWS S3**: AMI成果物の保存先
3. **CloudWatch Logs**: ビルドログの出力先

---

## 6. 受け入れ基準

### AC-1: Dockerイメージ事前プル機能

**Given**: component-arm.ymlとcomponent-x86.ymlにPullDockerImagesステップが追加されている
**When**: dev環境でAMIビルドを実行する
**Then**:
- AMIビルドが成功すること
- ビルドログにPullDockerImagesステップの実行ログが記録されていること
- 12種類すべてのイメージのプルログが出力されていること

### AC-2: Dockerイメージ存在確認

**Given**: 新しくビルドされたAMIからEC2インスタンスを起動する
**When**: SSH/SSM接続して `docker images` コマンドを実行する
**Then**:
- 12種類すべてのDockerイメージが存在すること
- 各イメージのタグが要件通りであること（python:3.11-slim、node:18-slimなど）

### AC-3: ジョブ起動時間短縮

**Given**: 変更前のAMIと変更後のAMIを用意する
**When**: 同じJenkinsジョブを両方のAMIで実行し、Dockerイメージプル時間を測定する
**Then**:
- 小さいイメージ（130MB）: プル時間が10秒未満に短縮されること
- 大きいイメージ（850MB）: プル時間が10秒未満に短縮されること
- ジョブ全体の実行時間が短縮されること

### AC-4: AMIサイズとビルド時間

**Given**: 変更前のAMIのサイズとビルド時間を記録する
**When**: 新しくAMIをビルドする
**Then**:
- AMIサイズ増加が3GB以内であること
- AMIビルド時間増加が10分以内であること
- ビルドログに各イメージのプル完了が記録されていること

### AC-5: マルチアーキテクチャ対応

**Given**: ARM64とx86_64の両方のコンポーネント定義を用意する
**When**: 両アーキテクチャでAMIビルドを実行する
**Then**:
- 両方のビルドが成功すること
- 両方のAMIで12種類すべてのイメージが存在すること
- アーキテクチャに応じた正しいイメージ（arm64/amd64）がプルされていること

### AC-6: エラーハンドリング

**Given**: Docker Daemonが起動していない状態でPullDockerImagesステップを実行する
**When**: AMIビルドを実行する
**Then**:
- ステップが適切にエラーハンドリングすること（設計フェーズで決定した挙動に従う）
- エラーログが明確に出力されること

### AC-7: ドキュメント更新

**Given**: `ansible/README.md`を開く
**When**: Jenkins Agent AMIセクションを確認する
**Then**:
- 事前プルされるDockerイメージ一覧が記載されていること
- AMIビルド時間の更新（30-45分 → 35-50分）が記載されていること
- AMIサイズ増加（約2-3GB）が記載されていること

---

## 7. スコープ外

### 明確にスコープ外とする事項

1. **イメージバージョン自動更新**: イメージタグの自動更新機能は含まない（手動管理）
2. **イメージ脆弱性スキャン**: セキュリティスキャンは既存のプロセスに従う
3. **Docker Hubミラーリング**: プライベートレジストリへのミラーリングは対象外
4. **イメージクリーンアップ**: 古いイメージの自動削除機能は含まない
5. **カスタムイメージビルド**: 公式イメージのみを対象とし、カスタムビルドは対象外

### 将来的な拡張候補

1. **イメージバージョン管理**:
   - SSMパラメータストアでイメージタグを一元管理
   - バージョン更新時の自動AMI再作成

2. **プライベートレジストリ連携**:
   - Amazon ECRへのイメージミラーリング
   - レート制限の完全回避

3. **イメージ最適化**:
   - 使用頻度の低いイメージは除外
   - イメージの軽量化（Alpine Linuxベースへの移行検討）

4. **並列プル**:
   - バックグラウンドプロセスでイメージを並列プル
   - AMIビルド時間のさらなる短縮

---

## 8. 成功基準

本要件定義は、以下の基準をすべて満たすことで完了とします：

1. ✅ **機能要件が明確に記載されている**: FR-1〜FR-5で5つの機能要件を定義
2. ✅ **受け入れ基準が定義されている**: AC-1〜AC-7で7つの受け入れ基準をGiven-When-Then形式で定義
3. ✅ **スコープが明確である**: スコープ内（機能要件）とスコープ外を明確に区別
4. ✅ **論理的な矛盾がない**: Planning Documentの開発計画と整合性を確認済み

---

## 9. 次フェーズへの引き継ぎ事項

Phase 2（設計）で検討すべき事項：

1. **エラーハンドリング方針**: 一部イメージのプル失敗時の挙動（継続 or 停止）
2. **ステップ挿入位置**: EnableCloudWatchAgentの直後で問題ないか確認
3. **Docker Hub認証**: レート制限緩和のための認証情報の管理方法
4. **ログ出力内容**: 各イメージプル前後のログ形式とレベル
5. **テストスクリプト設計**: AMI起動後のイメージ存在確認スクリプトの詳細設計

---

**作成日**: 2025-01-XX
**作成者**: AI Workflow System
**承認者**: TBD（レビュー後に決定）
